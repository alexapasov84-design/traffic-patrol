<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–æ–ª–∏—Ü–∏—è –ú–∞–π–∞–º–∏üëÆ‚Äç‚ôÇÔ∏èüöîüëÆ‚Äç‚ôÇÔ∏è</title>
    
    <!-- Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Firebase SDK –≤–µ—Ä—Å–∏–∏ 8.10.0 -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://api-maps.yandex.ru/2.1/?apikey=365e247d-d853-4425-b9cc-13bfa1169a49&lang=ru_RU"></script>
    
    <style>
        :root {
            --tg-theme-bg-color: #0a1931;
            --tg-theme-text-color: #ffffff;
            --tg-theme-hint-color: #aaaaaa;
            --tg-theme-link-color: #4fc3f7;
            --tg-theme-button-color: #2196f3;
            --tg-theme-button-text-color: #ffffff;
        }
        
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent;
        }
        
        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }
        
        body {
            background: var(--tg-theme-bg-color, #0a1931);
            color: var(--tg-theme-text-color, white);
            max-width: 100vw;
            max-height: 100vh;
            touch-action: none;
            overscroll-behavior: none;
        }
        
        .splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            max-width: 100vw;
            max-height: 100vh;
        }
        
        .splash-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 1;
        }
        
        .image-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                to bottom,
                rgba(10, 25, 49, 0.9) 0%,
                rgba(10, 25, 49, 0.7) 30%,
                rgba(10, 25, 49, 0.5) 50%,
                rgba(10, 25, 49, 0.8) 100%
            );
            z-index: 2;
        }
        
        .splash-content {
            position: relative;
            z-index: 3;
            text-align: center;
            padding: 20px;
            display: flex;
            flex-direction: column;
            height: 100%;
            justify-content: space-between;
            max-width: 100%;
            box-sizing: border-box;
        }
        
        .splash-header {
            margin-top: 20px;
            animation: fadeInDown 0.8s ease;
        }
        
        .splash-title {
            font-size: 2.5rem;
            color: #4fc3f7;
            margin-bottom: 10px;
            text-shadow: 0 0 20px rgba(79, 195, 247, 0.5);
            word-wrap: break-word;
        }
        
        .splash-subtitle {
            color: #81c784;
            font-size: 1.2rem;
            word-wrap: break-word;
        }
        
        .splash-center {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            animation: fadeIn 1s ease;
            width: 100%;
            max-width: 100%;
        }
        
        .menu-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 90%;
            max-width: 400px;
            animation: fadeIn 1s ease;
        }
        
        .menu-btn {
            padding: 18px 25px;
            background: rgba(33, 150, 243, 0.2);
            border: 2px solid rgba(33, 150, 243, 0.5);
            border-radius: 15px;
            color: white;
            font-size: 1.1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            transition: all 0.3s;
            backdrop-filter: blur(5px);
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
        }
        
        .menu-btn:hover {
            background: rgba(33, 150, 243, 0.3);
            border-color: #2196f3;
            transform: translateY(-2px);
        }
        
        .splash-buttons {
            position: relative;
            z-index: 3;
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 100%;
            max-width: 400px;
            margin: 0 auto 15px;
            animation: fadeInUp 0.8s ease;
        }
        
        .start-btn {
            padding: 18px 35px;
            background: linear-gradient(90deg, #2196f3, #1976d2);
            border: none;
            border-radius: 30px;
            color: white;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            box-shadow: 0 10px 30px rgba(33, 150, 243, 0.6);
            transition: all 0.3s;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
        }
        
        .start-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 12px 35px rgba(33, 150, 243, 0.8);
        }
        
        .skip-intro-btn {
            padding: 14px 25px;
            background: rgba(255, 255, 255, 0.15);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 25px;
            color: rgba(255, 255, 255, 0.9);
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
        }
        
        .skip-intro-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.5);
        }
        
        .tg-badge-bottom {
            margin-top: 5px;
            padding: 8px 16px;
            background: rgba(33, 150, 243, 0.2);
            border-radius: 20px;
            font-size: 0.9rem;
            color: #4fc3f7;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
            word-wrap: break-word;
        }
        
        .auto-start-timer {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: #81c784;
            padding: 10px 18px;
            border-radius: 25px;
            font-size: 0.95rem;
            z-index: 4;
            border: 1px solid rgba(129, 199, 132, 0.4);
            backdrop-filter: blur(5px);
            animation: fadeIn 1s ease;
            max-width: calc(100% - 40px);
            word-wrap: break-word;
        }
        
        .app { 
            display: flex; 
            flex-direction: column; 
            height: 100vh;
            width: 100vw;
            opacity: 0;
            transition: opacity 0.5s ease;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overflow: hidden;
            max-width: 100vw;
            max-height: 100vh;
        }
        
        .app.active {
            opacity: 1;
        }
        
        .header { 
            padding: 15px 20px;
            text-align: center;
            background: rgba(13, 27, 42, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 3px solid #2196f3;
            position: relative;
            width: 100%;
            box-sizing: border-box;
            flex-shrink: 0;
        }
        
        .header h1 { 
            color: #4fc3f7; 
            margin: 0 0 8px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            font-size: 1.5rem;
            word-wrap: break-word;
        }
        
        .header-stats {
            color: #81c784;
            font-size: 0.9rem;
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .map-container {
            flex: 1;
            margin: 10px;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            border: 3px solid #2196f3;
            min-height: 0;
            max-width: calc(100vw - 20px);
        }
        
        #yandex-map {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
        }
        
        .tools {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            padding: 12px;
            background: rgba(13, 27, 42, 0.95);
            backdrop-filter: blur(10px);
            flex-shrink: 0;
            width: 100%;
            box-sizing: border-box;
        }
        
        .tool-btn {
            padding: 10px 5px;
            background: rgba(33, 150, 243, 0.2);
            border: 2px solid #2196f3;
            border-radius: 8px;
            color: white;
            font-size: 0.75rem;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            transition: all 0.2s;
            max-width: 100%;
            box-sizing: border-box;
        }
        
        .tool-btn.active {
            background: #2196f3;
            box-shadow: 0 0 15px #2196f3;
        }
        
        .tool-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            border-color: #666;
        }
        
        .marker-limit {
            position: absolute;
            top: 5px;
            left: 5px;
            background: rgba(255, 152, 0, 0.9);
            color: white;
            padding: 5px 10px;
            border-radius: 10px;
            font-size: 0.8rem;
            z-index: 1000;
            animation: pulse 2s infinite;
            max-width: calc(100% - 20px);
            word-wrap: break-word;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            padding: 10px;
            background: rgba(13, 27, 42, 0.9);
            border-top: 2px solid #2196f3;
            text-align: center;
            font-size: 0.85rem;
            flex-shrink: 0;
            width: 100%;
            box-sizing: border-box;
        }
        
        .stat-value {
            font-size: 1.3rem;
            font-weight: bold;
            color: #4fc3f7;
        }
        
        /* –ù–û–í–´–ô –î–ò–ó–ê–ô–ù –ß–ê–¢–ê - –∫–Ω–æ–ø–∫–∞ –∏ –æ—Ç–¥–µ–ª—å–Ω–æ–µ –æ–∫–Ω–æ */
        .chat-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: #2196f3;
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 999;
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.4);
            transition: all 0.3s;
        }
        
        .chat-button:hover {
            background: #1976d2;
            transform: scale(1.1);
        }
        
        .chat-button .chat-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #f44336;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .chat-window {
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 320px;
            max-width: 90vw;
            height: 400px;
            max-height: 60vh;
            background: rgba(13, 27, 42, 0.98);
            border-radius: 15px;
            border: 2px solid #2196f3;
            backdrop-filter: blur(10px);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            display: none;
        }
        
        .chat-window.active {
            display: flex;
            animation: slideUp 0.3s ease;
        }
        
        .chat-header {
            padding: 15px;
            background: rgba(33, 150, 243, 0.2);
            border-bottom: 1px solid rgba(33, 150, 243, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        
        .chat-header h3 {
            color: #4fc3f7;
            margin: 0;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .chat-close {
            background: rgba(255, 0, 0, 0.2);
            border: 1px solid rgba(255, 0, 0, 0.5);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            color: white;
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        
        .chat-close:hover {
            background: rgba(255, 0, 0, 0.3);
            transform: rotate(90deg);
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            min-height: 0;
        }
        
        .chat-message {
            margin-bottom: 10px;
            padding: 10px 12px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.05);
            font-size: 0.85rem;
            line-height: 1.4;
            word-wrap: break-word;
            max-width: 100%;
        }
        
        .chat-message.system {
            background: rgba(33, 150, 243, 0.15);
            border-left: 3px solid #2196f3;
        }
        
        .chat-message.user {
            background: rgba(76, 175, 80, 0.15);
            border-left: 3px solid #4CAF50;
        }
        
        .chat-message.marker {
            background: rgba(255, 193, 7, 0.15);
            border-left: 3px solid #FFC107;
        }
        
        .message-author {
            font-weight: bold;
            color: #4fc3f7;
            margin-right: 8px;
            font-size: 0.8rem;
        }
        
        .message-time {
            font-size: 0.7rem;
            color: #aaa;
            float: right;
            margin-left: 10px;
        }
        
        .message-text {
            display: block;
            margin-top: 5px;
            word-break: break-word;
        }
        
        .chat-input-container {
            padding: 12px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            gap: 10px;
            flex-shrink: 0;
            background: rgba(13, 27, 42, 0.9);
        }
        
        .chat-input {
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(33, 150, 243, 0.3);
            border-radius: 20px;
            color: white;
            padding: 10px 15px;
            font-size: 0.9rem;
            max-width: calc(100% - 50px);
        }
        
        .chat-input:focus {
            outline: none;
            border-color: #2196f3;
            box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.2);
        }
        
        .chat-send {
            background: #2196f3;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .chat-send:hover {
            background: #1976d2;
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 20000;
            backdrop-filter: blur(5px);
        }
        
        .modal-content {
            background: linear-gradient(135deg, #0d1b2a, #1b3a4b);
            border-radius: 20px;
            padding: 25px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            border: 3px solid #2196f3;
            position: relative;
            margin: 20px;
            box-sizing: border-box;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(33, 150, 243, 0.3);
        }
        
        .modal-header h2 {
            color: #4fc3f7;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .modal-close {
            background: rgba(255, 0, 0, 0.2);
            border: 2px solid rgba(255, 0, 0, 0.5);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        
        .modal-close:hover {
            background: rgba(255, 0, 0, 0.3);
            border-color: #ff4444;
            transform: rotate(90deg);
        }
        
        .players-list {
            max-height: 300px;
            overflow-y: auto;
            margin: 20px 0;
        }
        
        .player-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 15px;
            margin-bottom: 10px;
            background: rgba(33, 150, 243, 0.1);
            border-radius: 10px;
            border-left: 4px solid #4CAF50;
        }
        
        .player-item.rank-1 {
            background: linear-gradient(90deg, rgba(255, 215, 0, 0.1), rgba(33, 150, 243, 0.1));
            border-left-color: #FFD700;
        }
        
        .player-item.rank-2 {
            background: linear-gradient(90deg, rgba(192, 192, 192, 0.1), rgba(33, 150, 243, 0.1));
            border-left-color: #C0C0C0;
        }
        
        .player-item.rank-3 {
            background: linear-gradient(90deg, rgba(205, 127, 50, 0.1), rgba(33, 150, 243, 0.1));
            border-left-color: #CD7F32;
        }
        
        .player-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .player-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #2196f3, #1976d2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            position: relative;
        }
        
        .player-rank-badge {
            position: absolute;
            bottom: -5px;
            right: -5px;
            background: #FF9800;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .player-details {
            display: flex;
            flex-direction: column;
        }
        
        .player-name {
            font-weight: bold;
            font-size: 1rem;
        }
        
        .player-stats {
            font-size: 0.75rem;
            color: #81c784;
            display: flex;
            gap: 8px;
        }
        
        .player-score {
            color: #FFD700;
        }
        
        /* –£–ª—É—á—à–µ–Ω–Ω–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è */
        .comment-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 20000;
            backdrop-filter: blur(5px);
        }
        
        .comment-modal-content {
            background: linear-gradient(135deg, #0d1b2a, #1b3a4b);
            border-radius: 20px;
            padding: 20px;
            width: 90%;
            max-width: 350px;
            border: 3px solid #2196f3;
        }
        
        .comment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(33, 150, 243, 0.3);
        }
        
        .comment-header h2 {
            color: #4fc3f7;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .comment-input-container {
            margin-bottom: 20px;
        }
        
        .comment-input {
            width: 100%;
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid #2196f3;
            border-radius: 10px;
            color: white;
            padding: 12px 15px;
            font-size: 1rem;
            resize: none;
            min-height: 50px;
            max-height: 50px;
            box-sizing: border-box;
        }
        
        .comment-input::placeholder {
            color: #aaa;
        }
        
        .comment-chars {
            text-align: right;
            font-size: 0.8rem;
            color: #aaa;
            margin-top: 5px;
        }
        
        .comment-chars.warning {
            color: #ff9800;
        }
        
        .comment-chars.error {
            color: #f44336;
        }
        
        .comment-buttons {
            display: flex;
            gap: 10px;
        }
        
        .comment-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .comment-btn.add {
            background: #2196f3;
            color: white;
        }
        
        .comment-btn.add:hover {
            background: #1976d2;
        }
        
        .comment-btn.add:disabled {
            background: #666;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .comment-btn.skip {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        
        .comment-btn.skip:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .comment-info {
            color: #aaa;
            font-size: 0.85rem;
            text-align: center;
            margin-top: 15px;
        }
        
        .fa-siren::before {
            content: "üö®";
            animation: siren 1s infinite alternate;
        }
        
        @keyframes siren {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes pulse {
            0% { opacity: 0.7; }
            50% { opacity: 1; }
            100% { opacity: 0.7; }
        }
        
        /* –£–ª—É—á—à–µ–Ω–Ω–∞—è –∞–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-height: 700px) {
            .splash-title { font-size: 2rem; }
            .splash-subtitle { font-size: 1rem; }
            .menu-buttons { gap: 10px; }
            .menu-btn { padding: 14px 20px; font-size: 1rem; }
            .start-btn { padding: 16px 30px; font-size: 1.1rem; }
            .skip-intro-btn { padding: 12px 20px; font-size: 0.95rem; }
            .chat-window { height: 350px; }
        }
        
        @media (max-width: 768px) {
            .chat-window {
                width: 300px;
                right: 10px;
                bottom: 80px;
            }
            
            .chat-button {
                right: 10px;
                bottom: 15px;
            }
            
            .splash-title {
                font-size: 2rem;
            }
            
            .header h1 {
                font-size: 1.3rem;
            }
        }
        
        @media (max-width: 480px) {
            .chat-window {
                width: calc(100% - 20px);
                right: 10px;
                left: 10px;
                bottom: 80px;
            }
            
            .chat-button {
                right: 10px;
                bottom: 15px;
                width: 50px;
                height: 50px;
                font-size: 1.3rem;
            }
            
            .tools {
                grid-template-columns: repeat(5, 1fr);
                gap: 5px;
                padding: 8px;
            }
            
            .tool-btn {
                font-size: 0.7rem;
                padding: 8px 3px;
            }
            
            .header-stats {
                font-size: 0.8rem;
                gap: 10px;
            }
            
            .stats {
                font-size: 0.8rem;
            }
            
            .stat-value {
                font-size: 1.1rem;
            }
        }
        
        @media (max-height: 600px) {
            .chat-window {
                height: 300px;
            }
            
            .splash-header {
                margin-top: 10px;
            }
            
            .splash-title {
                font-size: 1.8rem;
            }
            
            .splash-center {
                justify-content: flex-start;
                padding-top: 20px;
            }
            
            .tg-badge-bottom {
                margin-bottom: 5px;
            }
        }
        
        /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ —Ä–∞—Å—Ç—è–≥–∏–≤–∞–Ω–∏—è –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–∞—Ö */
        @media (min-width: 1024px) {
            .app {
                max-width: 500px;
                margin: 0 auto;
                left: 50%;
                transform: translateX(-50%);
                border-left: 1px solid rgba(255, 255, 255, 0.1);
                border-right: 1px solid rgba(255, 255, 255, 0.1);
            }
            
            .chat-window {
                right: calc(50% - 250px + 20px);
            }
            
            .chat-button {
                right: calc(50% - 250px + 20px);
            }
        }
    </style>
</head>
<body>
    <!-- –ó–∞—Å—Ç–∞–≤–∫–∞ -->
    <div id="splashScreen" class="splash-screen">
        <img src="https://static.craftum.com/9F-qvclCZh6dtPwdnNtlBy-tW_0=/380x0/filters:no_upscale()/https://274418.selcdn.ru/cv08300-33250f0d-0664-43fc-9dbf-9d89738d114e/uploads/655846/14f3a178-0a4b-4df5-bf77-949d65a34e3a.jpg" 
             class="splash-image" 
             alt="–ü–æ–ª–∏—Ü–∏—è –ú–∞–π–∞–º–∏"
             onerror="this.style.display='none'; document.querySelector('.image-overlay').style.background='#0a1931';">
        
        <div class="image-overlay"></div>
        
        <div class="splash-content">
            <div class="auto-start-timer" id="autoStartTimer">
                –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑: <span id="countdown">20</span> —Å–µ–∫
            </div>
            
            <div class="splash-header">
                <h1 class="splash-title">üëÆ‚Äç‚ôÇÔ∏è –ü–æ–ª–∏—Ü–∏—è –ú–∞–π–∞–º–∏ üöî</h1>
                <p class="splash-subtitle" id="userWelcome">–ú—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä–Ω–∞—è –∏–≥—Ä–∞</p>
            </div>
            
            <div class="splash-center">
                <div class="menu-buttons">
                    <button class="menu-btn" onclick="openRulesModal()">
                        <i class="fas fa-book"></i> –ü—Ä–∞–≤–∏–ª–∞ –∏–≥—Ä—ã
                    </button>
                    <button class="menu-btn" onclick="openPlayersModal()">
                        <i class="fas fa-users"></i> –ú—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä
                    </button>
                    <button class="menu-btn" onclick="openControlsModal()">
                        <i class="fas fa-gamepad"></i> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
                    </button>
                </div>
            </div>
            
            <div class="splash-buttons">
                <button class="start-btn" onclick="startGame()">
                    <i class="fas fa-play-circle"></i>
                    –ù–ê–ß–ê–¢–¨ –ò–ì–†–£
                </button>
                
                <button class="skip-intro-btn" onclick="skipIntro()">
                    <i class="fas fa-forward"></i>
                    –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –∑–∞—Å—Ç–∞–≤–∫—É
                </button>
                
                <div class="tg-badge-bottom">
                    <i class="fab fa-telegram"></i> Telegram Mini App
                </div>
            </div>
        </div>
    </div>
    
    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∏–≥—Ä–æ–≤–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å -->
    <div class="app" id="mainApp">
        <div class="header">
            <h1><i class="fas fa-police-car"></i> –ü–æ–ª–∏—Ü–∏—è –ú–∞–π–∞–º–∏ üëÆ‚Äç‚ôÇÔ∏èüöî</h1>
            <div class="header-stats">
                <span>–ú–µ—Ç–æ–∫: <span id="markerCount">0</span>/<span id="maxMarkers">40</span></span>
                <span>–û—á–∫–∏: <span id="points">100</span></span>
                <span>–û–Ω–ª–∞–π–Ω: <span id="onlineCount">1</span></span>
            </div>
        </div>
        
        <div class="map-container">
            <div id="yandex-map"></div>
            <div id="loading" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                <i class="fas fa-sync fa-spin" style="font-size: 2.5rem; margin-bottom: 20px; color: #4fc3f7;"></i>
                <p style="color: #81c784; font-size: 1.1rem;">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç...</p>
                <p id="syncStatus" style="color: #4fc3f7; font-size: 0.9rem; margin-top: 10px;">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Firebase...</p>
            </div>
            <div class="marker-limit" id="markerLimit" style="display: none;">
                üî¥ –õ–∏–º–∏—Ç: 40 –º–µ—Ç–æ–∫
            </div>
        </div>
        
        <div class="tools">
            <button class="tool-btn active" onclick="selectTool('police')">
                <i class="fas fa-siren" style="font-size: 1.2em;"></i>
                <span>–ü–∞—Ç—Ä—É–ª—å</span>
            </button>
            <button class="tool-btn" onclick="selectTool('accident')">
                <i class="fas fa-car-crash"></i>
                <span>–î–¢–ü</span>
            </button>
            <button class="tool-btn" onclick="selectTool('help')">
                <i class="fas fa-flag"></i>
                <span>–ü–æ–º–æ—â—å</span>
            </button>
            <button class="tool-btn" onclick="selectTool('hazard')">
                <i class="fas fa-traffic-light"></i>
                <span>–ü—Ä–æ–±–∫–∞</span>
            </button>
            <button class="tool-btn" onclick="selectTool('clear')">
                <i class="fas fa-trash-alt"></i>
                <span>–£–¥–∞–ª–∏—Ç—å</span>
            </button>
        </div>
        
        <div class="stats">
            <div>
                <div class="stat-value" id="activity">0</div>
                <div>–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</div>
            </div>
            <div>
                <div class="stat-value" id="rankPoints">100%</div>
                <div>–ü—Ä–æ–≥—Ä–µ—Å—Å</div>
            </div>
            <div>
                <div class="stat-value" id="userRank">–ù–æ–≤–∏—á–æ–∫</div>
                <div>–†–∞–Ω–≥</div>
            </div>
        </div>
        
        <!-- –ö–Ω–æ–ø–∫–∞ —á–∞—Ç–∞ -->
        <button id="chatButton" class="chat-button" onclick="toggleChatWindow()">
            <i class="fas fa-comments"></i>
            <div class="chat-badge" id="chatBadge" style="display: none;">0</div>
        </button>
        
        <!-- –û–∫–Ω–æ —á–∞—Ç–∞ -->
        <div id="chatWindow" class="chat-window">
            <div class="chat-header">
                <h3><i class="fas fa-comments"></i> –ß–∞—Ç –∏–≥—Ä—ã</h3>
                <button class="chat-close" onclick="toggleChatWindow()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="chat-messages" id="chatMessages">
                <div class="chat-message system">
                    <span class="message-author">üö® –°–∏—Å—Ç–µ–º–∞:</span>
                    <span class="message-text">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –∏–≥—Ä—É!</span>
                    <span class="message-time" id="systemMessageTime"></span>
                </div>
            </div>
            <div class="chat-input-container">
                <input type="text" 
                       class="chat-input" 
                       id="chatInput" 
                       placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (–¥–æ 30 —Å–∏–º–≤–æ–ª–æ–≤)..."
                       maxlength="30"
                       onkeypress="handleChatKeyPress(event)">
                <button class="chat-send" onclick="sendChatMessage()">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ -->
    <div id="rulesModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-book"></i> –ü—Ä–∞–≤–∏–ª–∞ –∏–≥—Ä—ã</h2>
                <button class="modal-close" onclick="closeModal('rulesModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="rules-section">
                    <h3><i class="fas fa-exclamation-triangle"></i> –í–ê–ñ–ù–û–ï –£–í–ï–î–û–ú–õ–ï–ù–ò–ï</h3>
                    <p>–î–∞–Ω–Ω–∞—è –∏–≥—Ä–∞ —Å–æ–∑–¥–∞–Ω–∞ <strong>–∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ –≤ –æ–∑–Ω–∞–∫–æ–º–∏—Ç–µ–ª—å–Ω—ã—Ö —Ü–µ–ª—è—Ö –∏ –¥–ª—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π –ø–æ–º–æ—â–∏ –Ω–∞ –¥–æ—Ä–æ–≥–µ</strong>.</p>
                    <p style="color: #ff9800; margin-top: 10px;">
                        <strong>–ó–∞ –ª—é–±—ã–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ —Å–∏—Ç—É–∞—Ü–∏—è–º–∏, —Å–æ–±—ã—Ç–∏—è–º–∏ –∏–ª–∏ –ª–∏—Ü–∞–º–∏ –∞–≤—Ç–æ—Ä –∏–≥—Ä—ã –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –Ω–µ –Ω–µ—Å—ë—Ç.</strong>
                    </p>
                    <p style="margin-top: 10px;">–ò–≥—Ä–∞ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º –ø–æ–ª–∏—Ü–∏–∏ –∏ –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏ —ç–∫—Å—Ç—Ä–µ–Ω–Ω—ã—Ö —Å–ª—É–∂–±.</p>
                </div>
                
                <div class="rules-section">
                    <h3><i class="fas fa-users"></i> –ú—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä</h3>
                    <p>–í—Å–µ –∏–≥—Ä–æ–∫–∏ –≤–∏–¥—è—Ç –æ–¥–Ω–∏ –∏ —Ç–µ –∂–µ –º–µ—Ç–∫–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ —á–µ—Ä–µ–∑ Firebase Cloud.</p>
                    <p>–°–æ–∑–¥–∞–≤–∞–π—Ç–µ –º–µ—Ç–∫–∏, —á—Ç–æ–±—ã –ø—Ä–µ–¥—É–ø—Ä–µ–¥–∏—Ç—å –¥—Ä—É–≥–∏—Ö –∏–≥—Ä–æ–∫–æ–≤ –æ —Å–∏—Ç—É–∞—Ü–∏–∏ –Ω–∞ –¥–æ—Ä–æ–≥–µ.</p>
                </div>
                
                <div class="rules-section">
                    <h3><i class="fas fa-sync"></i> –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è</h3>
                    <p>–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –±–ª–∞–≥–æ–¥–∞—Ä—è Firebase Realtime Database.</p>
                    <p>–ù–æ–≤—ã–µ –º–µ—Ç–∫–∏ –ø–æ—è–≤–ª—è—é—Ç—Å—è —É –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤ –≤ —Ç–µ—á–µ–Ω–∏–µ 1-2 —Å–µ–∫—É–Ω–¥.</p>
                </div>
                
                <div class="rules-section">
                    <h3><i class="fas fa-database"></i> –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è</h3>
                    <p>–ú–∞–∫—Å–∏–º—É–º <span id="rulesMaxMarkers">40</span> –º–µ—Ç–æ–∫ –Ω–∞ –≤—Å—é –∏–≥—Ä—É.</p>
                    <p><strong>–ú–µ—Ç–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ 3 —á–∞—Å–∞!</strong></p>
                    <p>–≠—Ç–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–∞ Firebase –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.</p>
                </div>
                
                <div class="rules-section">
                    <h3><i class="fas fa-trophy"></i> –†–µ–π—Ç–∏–Ω–≥</h3>
                    <p>–ó–∞—Ä–∞–±–∞—Ç—ã–≤–∞–π—Ç–µ –æ—á–∫–∏ –∑–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª–µ–∑–Ω—ã—Ö –º–µ—Ç–æ–∫.</p>
                    <p>–ß–µ–º –∞–∫—Ç–∏–≤–Ω–µ–µ –≤—ã –ø–æ–º–æ–≥–∞–µ—Ç–µ –¥—Ä—É–≥–∏–º –∏–≥—Ä–æ–∫–∞–º - —Ç–µ–º –≤—ã—à–µ –≤–∞—à —Ä–∞–Ω–≥!</p>
                    <p>–†–∞–Ω–≥–∏: –ù–æ–≤–∏—á–æ–∫ ‚Üí –ü–∞—Ç—Ä—É–ª—å–Ω—ã–π ‚Üí –°–µ—Ä–∂–∞–Ω—Ç ‚Üí –î–µ—Ç–µ–∫—Ç–∏–≤ ‚Üí –ö–æ–º–∏—Å—Å–∞—Ä</p>
                </div>
                
                <div class="rules-section">
                    <h3><i class="fas fa-comments"></i> –ò–≥—Ä–æ–≤–æ–π —á–∞—Ç</h3>
                    <p>1. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —á–∞—Ç –¥–ª—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏–∏ –¥–µ–π—Å—Ç–≤–∏–π</p>
                    <p>2. –°–æ–æ–±—â–∞–π—Ç–µ –æ –Ω–æ–≤—ã—Ö –º–µ—Ç–∫–∞—Ö –∏ —É–¥–∞–ª–µ–Ω–∏—è—Ö</p>
                    <p>3. –ù–µ —Å–ø–∞–º—å—Ç–µ –∏ –Ω–µ –Ω–∞—Ä—É—à–∞–π—Ç–µ –ø—Ä–∞–≤–∏–ª–∞ –æ–±—â–µ–Ω–∏—è</p>
                    <p>4. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è: 30 —Å–∏–º–≤–æ–ª–æ–≤</p>
                </div>
                
                <div class="rules-section">
                    <h3><i class="fas fa-phone"></i> –†–µ–∞–ª—å–Ω–∞—è –ø–æ–º–æ—â—å</h3>
                    <p>–í —Å–ª—É—á–∞–µ —Ä–µ–∞–ª—å–Ω–æ–π –∞–≤–∞—Ä–∏–∏ –∏–ª–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø–æ–º–æ—â–∏:</p>
                    <p style="color: #f44336;"><strong>–ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ –∑–≤–æ–Ω–∏—Ç–µ –ø–æ –Ω–æ–º–µ—Ä—É 112!</strong></p>
                    <p>–≠—Ç–∞ –∏–≥—Ä–∞ –ù–ï –∑–∞–º–µ–Ω—è–µ—Ç –≤—ã–∑–æ–≤ —Ä–µ–∞–ª—å–Ω—ã—Ö —ç–∫—Å—Ç—Ä–µ–Ω–Ω—ã—Ö —Å–ª—É–∂–±.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏–≥—Ä–æ–∫–æ–≤ -->
    <div id="playersModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-users"></i> –ú—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä</h2>
                <button class="modal-close" onclick="closeModal('playersModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="players-list" id="playersList">
                    <p style="text-align: center; color: #aaa;">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –∏–≥—Ä–æ–∫–æ–≤...</p>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <p><i class="fas fa-info-circle"></i> –ò–≥—Ä–æ–∫–æ–≤ –æ–Ω–ª–∞–π–Ω: <span id="modalOnlineCount">1</span></p>
                    <p style="color: #aaa; font-size: 0.9rem; margin-top: 10px;">
                        –¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
    <div id="controlsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-gamepad"></i> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h2>
                <button class="modal-close" onclick="closeModal('controlsModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="rules-section">
                    <h3><i class="fas fa-mouse-pointer"></i> –û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</h3>
                    <p>1. –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –º–µ—Ç–∫–∏ –≤ –ø–∞–Ω–µ–ª–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤</p>
                    <p>2. –ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –º–µ—Ç–∫–∏</p>
                    <p>3. –î–ª—è —É–¥–∞–ª–µ–Ω–∏—è: –≤—ã–±–µ—Ä–∏—Ç–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç "–£–¥–∞–ª–∏—Ç—å" –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ –∫—Ä–µ—Å—Ç–∏–∫ –Ω–∞ –º–µ—Ç–∫–µ</p>
                    <p>4. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –Ω–∞ –∫–∞—Ä—Ç–µ –¥–ª—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –∫ —Å–≤–æ–µ–º—É –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—é</p>
                    <p>5. –ú–µ—Ç–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ –≤—Å–µ–º–∏ –∏–≥—Ä–æ–∫–∞–º–∏</p>
                </div>
                
                <div class="rules-section">
                    <h3><i class="fas fa-comments"></i> –ò–≥—Ä–æ–≤–æ–π —á–∞—Ç</h3>
                    <p>‚Ä¢ –ù–∞–∂–º–∏—Ç–µ –Ω–∞ —Å–∏–Ω—é—é –∫–Ω–æ–ø–∫—É –≤ –ø—Ä–∞–≤–æ–º –Ω–∏–∂–Ω–µ–º —É–≥–ª—É</p>
                    <p>‚Ä¢ –ö—Ä–∞—Å–Ω—ã–π –∑–Ω–∞—á–æ–∫ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è</p>
                    <p>‚Ä¢ –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è: 30 —Å–∏–º–≤–æ–ª–æ–≤</p>
                </div>
                
                <div class="rules-section">
                    <h3><i class="fas fa-bell"></i> –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h3>
                    <p>–ß–∞—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç:</p>
                    <p>‚Ä¢ –ù–æ–≤—ã–µ –º–µ—Ç–∫–∏ –Ω–∞ –∫–∞—Ä—Ç–µ</p>
                    <p>‚Ä¢ –£–¥–∞–ª–µ–Ω–∏—è –º–µ—Ç–æ–∫</p>
                    <p>‚Ä¢ –°–æ–æ–±—â–µ–Ω–∏—è –¥—Ä—É–≥–∏—Ö –∏–≥—Ä–æ–∫–æ–≤</p>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è -->
    <div id="commentModal" class="comment-modal">
        <div class="comment-modal-content">
            <div class="comment-header">
                <h2><i class="fas fa-comment"></i> –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –º–µ—Ç–∫–µ</h2>
                <button class="modal-close" onclick="closeCommentModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="comment-input-container">
                    <input type="text" 
                           class="comment-input" 
                           id="commentText" 
                           placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–¥–æ 30 —Å–∏–º–≤–æ–ª–æ–≤)..."
                           maxlength="30"
                           oninput="updateCommentChars()">
                    <div class="comment-chars" id="commentChars">0/30</div>
                </div>
                <div class="comment-buttons">
                    <button class="comment-btn skip" onclick="addMarkerWithoutComment()">
                        –ë–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
                    </button>
                    <button class="comment-btn add" id="addWithCommentBtn" onclick="addMarkerWithComment()" disabled>
                        –î–æ–±–∞–≤–∏—Ç—å
                    </button>
                </div>
                <div class="comment-info">
                    –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –±—É–¥–µ—Ç –≤–∏–¥–µ–Ω –≤—Å–µ–º –∏–≥—Ä–æ–∫–∞–º –Ω–∞ –∫–∞—Ä—Ç–µ
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============ –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø FIREBASE ============
        const firebaseConfig = {
            apiKey: "AIzaSyD0zwcRZs7mI0RzPq3O18WOIWjhUO6yKZQ",
            authDomain: "miami-police-game.firebaseapp.com",
            databaseURL: "https://miami-police-game-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "miami-police-game",
            storageBucket: "miami-police-game.firebasestorage.app",
            messagingSenderId: "4861394604",
            appId: "1:4861394604:web:f2acb3a189f99396a66909"
        };
        
        // ============ –ö–û–ù–°–¢–ê–ù–¢–´ –ò–ì–†–´ ============
        const tg = window.Telegram.WebApp;
        const MAX_MARKERS = 40;
        const MARKER_LIFETIME = 3 * 60 * 60 * 1000;
        const ONLINE_TIMEOUT = 30000;
        const MAX_CHAT_CHARS = 30;
        const MAX_COMMENT_CHARS = 30;
        
        // –¢–∏–ø—ã –º–µ—Ç–æ–∫, –∫–æ—Ç–æ—Ä—ã–µ —Ç—Ä–µ–±—É—é—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
        const TOOLS_WITH_COMMENT = ['police', 'accident', 'help'];
        
        // ============ –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ============
        let telegramUser = null;
        let firebaseApp = null;
        let firebaseDatabase = null;
        let ymap = null;
        
        let markers = {};
        let selectedTool = 'police';
        let points = 100;
        let activity = 0;
        let pendingMarkerData = null;
        
        let onlinePlayers = {};
        let currentUserId = null;
        let currentUserName = '–ì–æ—Å—Ç—å';
        
        let chatWindowOpen = false;
        let unreadMessages = 0;
        let autoStartInterval = null;
        let countdownSeconds = 20;
        
        // ============ –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø TELEGRAM ============
        function initTelegram() {
            console.log('Initializing Telegram Web App...');
            
            const version = parseFloat(tg.version) || 6.0;
            console.log('Telegram WebApp version:', version);
            
            if (version >= 6.1) {
                tg.expand();
            }
            
            telegramUser = tg.initDataUnsafe?.user;
            
            if (telegramUser) {
                currentUserName = telegramUser.first_name || telegramUser.username || '–ò–≥—Ä–æ–∫';
                currentUserId = telegramUser.id.toString();
                document.getElementById('userWelcome').textContent = `–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${currentUserName}!`;
            } else {
                currentUserName = '–ì–æ—Å—Ç—å_' + Math.random().toString(36).substr(2, 6);
                currentUserId = 'guest_' + Math.random().toString(36).substr(2, 9);
                document.getElementById('userWelcome').textContent = '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –∏–≥—Ä—É!';
            }
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Ä–µ–º—è –¥–ª—è —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
            const now = new Date();
            document.getElementById('systemMessageTime').textContent = 
                now.getHours().toString().padStart(2, '0') + ':' + 
                now.getMinutes().toString().padStart(2, '0');
            
            startAutoStartTimer();
            initFirebase();
        }
        
        // ============ –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø FIREBASE ============
        function initFirebase() {
            try {
                if (typeof firebase === 'undefined') {
                    console.error('Firebase –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω!');
                    document.getElementById('syncStatus').textContent = 'Firebase –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω';
                    document.getElementById('syncStatus').style.color = '#f44336';
                    return;
                }
                
                firebaseApp = firebase.initializeApp(firebaseConfig);
                firebaseDatabase = firebase.database();
                
                console.log('‚úÖ Firebase —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω!');
                
                const syncStatus = document.getElementById('syncStatus');
                if (syncStatus) {
                    syncStatus.textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ Firebase ‚úì';
                    syncStatus.style.color = '#4CAF50';
                }
                
                // –§–ò–ö–°: –ó–∞–≥—Ä—É–∂–∞–µ–º –í–°–ï –º–µ—Ç–∫–∏ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
                loadAllMarkers();
                setupFirebaseListeners();
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ Firebase:', error);
                
                const syncStatus = document.getElementById('syncStatus');
                if (syncStatus) {
                    syncStatus.textContent = 'Firebase –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω';
                    syncStatus.style.color = '#FF9800';
                }
                
                addChatMessage('system', '‚ö†Ô∏è –†–∞–±–æ—Ç–∞–µ–º –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º —Ä–µ–∂–∏–º–µ (Firebase –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)');
            }
        }
        
        // –§–ò–ö–°: –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –í–°–ï–• –º–µ—Ç–æ–∫ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        function loadAllMarkers() {
            const markersRef = firebaseDatabase.ref('markers');
            
            markersRef.once('value').then((snapshot) => {
                const allMarkers = snapshot.val() || {};
                const now = Date.now();
                
                console.log(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${Object.keys(allMarkers).length} –º–µ—Ç–æ–∫ –∏–∑ Firebase`);
                
                Object.entries(allMarkers).forEach(([markerId, markerData]) => {
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ –º–µ—Ç–∫–∏
                    if (markerData.isActive && now - markerData.timestamp < MARKER_LIFETIME) {
                        if (!markers[markerId]) {
                            addMarkerToMap(markerId, markerData);
                            markers[markerId] = markerData;
                        }
                    }
                });
                
                updateMarkerCount();
                console.log(`–û—Ç–æ–±—Ä–∞–∂–µ–Ω–æ ${Object.keys(markers).length} –∞–∫—Ç–∏–≤–Ω—ã—Ö –º–µ—Ç–æ–∫`);
                
            }).catch(error => {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ—Ç–æ–∫:', error);
            });
        }
        
        // ============ –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø FIREBASE ============
        function setupFirebaseListeners() {
            const markersRef = firebaseDatabase.ref('markers');
            
            // –°–ª—É—à–∞–µ–º –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –º–µ—Ç–æ–∫
            markersRef.on('child_added', (snapshot) => {
                const markerId = snapshot.key;
                const markerData = snapshot.val();
                
                if (markerData.isActive && !markers[markerId]) {
                    addMarkerToMap(markerId, markerData);
                    markers[markerId] = markerData;
                    updateMarkerCount();
                    
                    if (markerData.authorId !== currentUserId) {
                        addChatMessage('system', `üìç ${markerData.author} –¥–æ–±–∞–≤–∏–ª(–∞) –º–µ—Ç–∫—É: ${getMarkerTypeName(markerData.type)}`);
                    }
                }
            });
            
            // –°–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –º–µ—Ç–æ–∫
            markersRef.on('child_changed', (snapshot) => {
                const markerId = snapshot.key;
                const markerData = snapshot.val();
                
                if (!markerData.isActive && markers[markerId]) {
                    removeMarkerFromMap(markerId);
                    delete markers[markerId];
                    updateMarkerCount();
                    
                    if (markerData && markerData.type) {
                        addChatMessage('system', `üóëÔ∏è –ú–µ—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–∞: ${getMarkerTypeName(markerData.type)}`);
                    }
                }
            });
            
            // –°–ª—É—à–∞–µ–º –æ–Ω–ª–∞–π–Ω –∏–≥—Ä–æ–∫–æ–≤
            const onlineRef = firebaseDatabase.ref('online');
            onlineRef.on('value', (snapshot) => {
                const users = snapshot.val() || {};
                onlinePlayers = users;
                updateOnlinePlayers(users);
            });
            
            // –°–ª—É—à–∞–µ–º —á–∞—Ç
            const chatRef = firebaseDatabase.ref('chat');
            chatRef.limitToLast(20).on('child_added', (snapshot) => {
                const message = snapshot.val();
                if (message.authorId !== currentUserId || message.type === 'system') {
                    addChatMessage(message.type, `${message.author}: ${message.text}`);
                }
            });
            
            updateOnlineStatus();
            cleanupOldMarkers();
        }
        
        function updateOnlineStatus() {
            const userStatusRef = firebaseDatabase.ref('online/' + currentUserId);
            
            const userData = {
                name: currentUserName,
                userId: currentUserId,
                lastSeen: Date.now(),
                stats: {
                    markersCreated: activity,
                    points: points,
                    rank: calculateRank().name
                }
            };
            
            userStatusRef.set(userData);
            
            setInterval(() => {
                userData.lastSeen = Date.now();
                userData.stats.markersCreated = activity;
                userData.stats.points = points;
                userData.stats.rank = calculateRank().name;
                userStatusRef.update(userData);
            }, 10000);
            
            userStatusRef.onDisconnect().remove();
        }
        
        function updateOnlinePlayers(users) {
            const now = Date.now();
            const onlineUserIds = Object.keys(users).filter(id => {
                const user = users[id];
                return now - user.lastSeen < ONLINE_TIMEOUT;
            });
            
            const onlineCount = Math.max(1, onlineUserIds.length);
            
            document.getElementById('onlineCount').textContent = onlineCount;
            document.getElementById('modalOnlineCount').textContent = onlineCount;
            
            updatePlayersList(users);
        }
        
        function updatePlayersList(users) {
            const playersList = document.getElementById('playersList');
            if (!playersList) return;
            
            const now = Date.now();
            
            const playersArray = Object.entries(users)
                .filter(([id, user]) => now - user.lastSeen < ONLINE_TIMEOUT)
                .map(([id, user]) => ({
                    id,
                    ...user,
                    isOnline: now - user.lastSeen < ONLINE_TIMEOUT
                }))
                .sort((a, b) => b.stats.points - a.stats.points);
            
            playersList.innerHTML = '';
            
            if (playersArray.length === 0) {
                playersList.innerHTML = '<p style="text-align: center; color: #aaa;">–ù–µ—Ç –∏–≥—Ä–æ–∫–æ–≤ –æ–Ω–ª–∞–π–Ω</p>';
                return;
            }
            
            playersArray.forEach((player, index) => {
                const playerItem = document.createElement('div');
                const rankClass = index === 0 ? 'rank-1' : index === 1 ? 'rank-2' : index === 2 ? 'rank-3' : '';
                playerItem.className = `player-item ${rankClass}`;
                
                const initials = player.name.split(' ').map(n => n[0]).join('').toUpperCase() || '–ì';
                const isCurrentUser = player.id === currentUserId;
                
                playerItem.innerHTML = `
                    <div class="player-info">
                        <div class="player-avatar" style="${isCurrentUser ? 'background: linear-gradient(135deg, #FF9800, #F57C00);' : ''}">
                            ${initials}
                            ${isCurrentUser ? '‚≠ê' : ''}
                            ${index < 3 ? `<div class="player-rank-badge">${index + 1}</div>` : ''}
                        </div>
                        <div class="player-details">
                            <div class="player-name">
                                ${player.name} ${isCurrentUser ? '(–í—ã)' : ''}
                            </div>
                            <div class="player-stats">
                                <span>üèÜ ${player.stats.points} –æ—á–∫–æ–≤</span>
                                <span>üìç ${player.stats.markersCreated} –º–µ—Ç–æ–∫</span>
                                <span class="player-score">${player.stats.rank}</span>
                            </div>
                        </div>
                    </div>
                `;
                
                playersList.appendChild(playerItem);
            });
        }
        
        // ============ –†–ê–ë–û–¢–ê –° –ú–ï–¢–ö–ê–ú–ò ============
        function addMarker(coords, type, comment = null) {
            const activeMarkersCount = Object.values(markers).filter(m => m.isActive).length;
            if (activeMarkersCount >= MAX_MARKERS) {
                alert(`‚ùå –î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç –≤ ${MAX_MARKERS} –º–µ—Ç–æ–∫ –Ω–∞ –∫–∞—Ä—Ç–µ!`);
                return null;
            }
            
            const markerId = firebaseDatabase.ref('markers').push().key;
            const timestamp = Date.now();
            
            const markerData = {
                type: type,
                coords: {
                    lat: coords[0],
                    lng: coords[1]
                },
                comment: comment || '',
                author: currentUserName,
                authorId: currentUserId,
                timestamp: timestamp,
                isActive: true,
                expiresAt: timestamp + MARKER_LIFETIME
            };
            
            firebaseDatabase.ref('markers/' + markerId).set(markerData)
                .then(() => {
                    console.log('‚úÖ –ú–µ—Ç–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ Firebase');
                    
                    points += 10;
                    activity += 1;
                    updateUI();
                    
                    sendChatMessage(
                        `${currentUserName} –¥–æ–±–∞–≤–∏–ª(–∞) –º–µ—Ç–∫—É: ${getMarkerTypeName(type)}`,
                        'marker_added'
                    );
                    
                })
                .catch(error => {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –º–µ—Ç–∫–∏:', error);
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –º–µ—Ç–∫–∏');
                });
            
            return markerId;
        }
        
        function addMarkerToMap(markerId, markerData) {
            if (!ymap) return;
            
            const iconColor = {
                'police': '#2196F3',
                'accident': '#F44336',
                'help': '#4CAF50',
                'hazard': '#FF9800'
            }[markerData.type] || '#2196F3';
            
            const iconContent = {
                'police': 'üö®',
                'accident': 'üöó',
                'help': 'üÜò',
                'hazard': 'üö¶'
            }[markerData.type] || 'üìç';
            
            const placemark = new ymaps.Placemark(
                [markerData.coords.lat, markerData.coords.lng],
                {
                    balloonContent: `
                        <div style="padding: 10px; max-width: 250px;">
                            <h3 style="margin: 0 0 10px 0; color: ${iconColor}">
                                ${getMarkerTypeName(markerData.type)}
                            </h3>
                            ${markerData.comment ? `<p><strong>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</strong> ${markerData.comment}</p>` : ''}
                            <p><strong>–ê–≤—Ç–æ—Ä:</strong> ${markerData.author}</p>
                            <p><strong>–î–æ–±–∞–≤–ª–µ–Ω–æ:</strong> ${new Date(markerData.timestamp).toLocaleTimeString()}</p>
                            <p><strong>–£–¥–∞–ª–∏—Ç—Å—è —á–µ—Ä–µ–∑:</strong> ${formatTimeRemaining(markerData.expiresAt)}</p>
                            ${markerData.authorId === currentUserId ? `
                            <button onclick="deleteMarker('${markerId}')" 
                                    style="background: #f44336; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; margin-top: 10px;">
                                –£–¥–∞–ª–∏—Ç—å –º–æ—é –º–µ—Ç–∫—É
                            </button>
                            ` : ''}
                        </div>
                    `,
                    iconCaption: markerData.comment || ''
                },
                {
                    preset: 'islands#icon',
                    iconColor: iconColor,
                    iconLayout: 'default#imageWithContent',
                    iconImageHref: '',
                    iconImageSize: [50, 50],
                    iconImageOffset: [-25, -50],
                    iconContentOffset: [0, 0],
                    iconContentLayout: ymaps.templateLayoutFactory.createClass(
                        `<div style="width: 50px; height: 50px; border-radius: 50%; background: ${iconColor}; display: flex; align-items: center; justify-content: center; font-size: 20px; position: relative;">
                            ${iconContent}
                            ${markerData.authorId === currentUserId ? `
                            <button onclick="deleteMarker('${markerId}')" 
                                    style="position: absolute; top: -5px; right: -5px; background: #f44336; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                                √ó
                            </button>
                            ` : ''}
                        </div>`
                    )
                }
            );
            
            placemark.events.add('click', function() {
                placemark.balloon.open();
            });
            
            markerData.placemark = placemark;
            ymap.geoObjects.add(placemark);
        }
        
        function deleteMarker(markerId) {
            if (!markers[markerId]) {
                console.error('–ú–µ—Ç–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞:', markerId);
                alert('–ú–µ—Ç–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –∏–ª–∏ —É–∂–µ —É–¥–∞–ª–µ–Ω–∞');
                return;
            }
            
            const marker = markers[markerId];
            if (!marker) {
                console.error('–ú–µ—Ç–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ:', markerId);
                return;
            }
            
            if (marker.authorId !== currentUserId) {
                alert('–í—ã –º–æ–∂–µ—Ç–µ —É–¥–∞–ª—è—Ç—å —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –º–µ—Ç–∫–∏!');
                return;
            }
            
            const markerType = marker.type;
            
            firebaseDatabase.ref('markers/' + markerId).update({
                isActive: false
            })
            .then(() => {
                console.log('‚úÖ –ú–µ—Ç–∫–∞ –ø–æ–º–µ—á–µ–Ω–∞ –∫–∞–∫ —É–¥–∞–ª–µ–Ω–Ω–∞—è');
                
                points += 5;
                updateUI();
                
                sendChatMessage(
                    `${currentUserName} —É–¥–∞–ª–∏–ª(–∞) –º–µ—Ç–∫—É: ${getMarkerTypeName(markerType)}`,
                    'marker_deleted'
                );
            })
            .catch(error => {
                console.error('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –º–µ—Ç–∫–∏:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –º–µ—Ç–∫–∏');
            });
        }
        
        function removeMarkerFromMap(markerId) {
            if (markers[markerId] && markers[markerId].placemark && ymap) {
                ymap.geoObjects.remove(markers[markerId].placemark);
            }
        }
        
        function cleanupOldMarkers() {
            const now = Date.now();
            const markersRef = firebaseDatabase.ref('markers');
            
            markersRef.once('value').then((snapshot) => {
                const updates = {};
                snapshot.forEach((childSnapshot) => {
                    const marker = childSnapshot.val();
                    
                    if (now - marker.timestamp > MARKER_LIFETIME && marker.isActive) {
                        updates[childSnapshot.key + '/isActive'] = false;
                    }
                });
                
                if (Object.keys(updates).length > 0) {
                    markersRef.update(updates);
                    console.log(`–ê–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞: —É–¥–∞–ª–µ–Ω–æ ${Object.keys(updates).length / 2} —Å—Ç–∞—Ä—ã—Ö –º–µ—Ç–æ–∫`);
                }
            });
            
            setTimeout(cleanupOldMarkers, 5 * 60 * 1000);
        }
        
        // ============ –ß–ê–¢ ============
        function toggleChatWindow() {
            const chatWindow = document.getElementById('chatWindow');
            const chatButton = document.getElementById('chatButton');
            const chatBadge = document.getElementById('chatBadge');
            
            if (chatWindowOpen) {
                chatWindow.classList.remove('active');
                chatWindowOpen = false;
            } else {
                chatWindow.classList.add('active');
                chatWindowOpen = true;
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
                unreadMessages = 0;
                chatBadge.style.display = 'none';
                
                // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –≤–Ω–∏–∑
                setTimeout(() => {
                    const chatMessages = document.getElementById('chatMessages');
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }, 100);
            }
        }
        
        function sendChatMessage() {
            const chatInput = document.getElementById('chatInput');
            const text = chatInput.value.trim();
            
            if (!text) return;
            
            if (text.length > MAX_CHAT_CHARS) {
                alert(`–°–æ–æ–±—â–µ–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ! –ú–∞–∫—Å–∏–º—É–º ${MAX_CHAT_CHARS} —Å–∏–º–≤–æ–ª–æ–≤.`);
                return;
            }
            
            const messageId = firebaseDatabase.ref('chat').push().key;
            const messageData = {
                text: text,
                author: currentUserName,
                authorId: currentUserId,
                timestamp: Date.now(),
                type: 'user'
            };
            
            firebaseDatabase.ref('chat/' + messageId).set(messageData)
                .then(() => {
                    chatInput.value = '';
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
                    alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è');
                });
        }
        
        function addChatMessage(type, text) {
            const chatMessages = document.getElementById('chatMessages');
            const now = new Date();
            const messageTime = now.getHours().toString().padStart(2, '0') + ':' + 
                              now.getMinutes().toString().padStart(2, '0');
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${type}`;
            messageDiv.innerHTML = `
                <span class="message-author">${type === 'system' ? 'üö® –°–∏—Å—Ç–µ–º–∞:' : ''}</span>
                <span class="message-text">${text}</span>
                <span class="message-time">${messageTime}</span>
            `;
            
            chatMessages.appendChild(messageDiv);
            
            // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –≤–Ω–∏–∑ –µ—Å–ª–∏ —á–∞—Ç –æ—Ç–∫—Ä—ã—Ç
            if (chatWindowOpen) {
                setTimeout(() => {
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }, 100);
            } else {
                // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö
                unreadMessages++;
                const chatBadge = document.getElementById('chatBadge');
                chatBadge.textContent = unreadMessages > 9 ? '9+' : unreadMessages;
                chatBadge.style.display = 'flex';
            }
        }
        
        function handleChatKeyPress(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                sendChatMessage();
            }
        }
        
        // ============ –ö–û–ú–ú–ï–ù–¢–ê–†–ò–ò –ö –ú–ï–¢–ö–ê–ú ============
        function updateCommentChars() {
            const commentText = document.getElementById('commentText');
            const commentChars = document.getElementById('commentChars');
            const addButton = document.getElementById('addWithCommentBtn');
            
            const length = commentText.value.length;
            commentChars.textContent = `${length}/${MAX_COMMENT_CHARS}`;
            
            // –ò–∑–º–µ–Ω—è–µ–º —Ü–≤–µ—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –¥–ª–∏–Ω—ã
            commentChars.className = 'comment-chars';
            if (length > MAX_COMMENT_CHARS * 0.8) {
                commentChars.classList.add('warning');
            }
            if (length > MAX_COMMENT_CHARS) {
                commentChars.classList.add('error');
            }
            
            // –í–∫–ª—é—á–∞–µ–º/–≤—ã–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É
            addButton.disabled = length > MAX_COMMENT_CHARS;
        }
        
        // ============ –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ============
        function getMarkerTypeName(type) {
            const names = {
                'police': '–ü–∞—Ç—Ä—É–ª—å üö®',
                'accident': '–î–¢–ü üöó',
                'help': '–ü–æ–º–æ—â—å üÜò',
                'hazard': '–ü—Ä–æ–±–∫–∞ üö¶'
            };
            return names[type] || '–ú–µ—Ç–∫–∞';
        }
        
        function formatTimeRemaining(expiresAt) {
            const remaining = expiresAt - Date.now();
            const hours = Math.floor(remaining / (1000 * 60 * 60));
            const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
            
            if (hours > 0) {
                return `${hours} —á ${minutes} –º–∏–Ω`;
            } else {
                return `${minutes} –º–∏–Ω—É—Ç`;
            }
        }
        
        function updateMarkerCount() {
            const activeMarkersCount = Object.values(markers).filter(m => m.isActive).length;
            document.getElementById('markerCount').textContent = activeMarkersCount;
            
            const limitElement = document.getElementById('markerLimit');
            if (activeMarkersCount >= MAX_MARKERS * 0.9) {
                limitElement.style.display = 'block';
                limitElement.innerHTML = `üî¥ –õ–∏–º–∏—Ç: ${activeMarkersCount}/${MAX_MARKERS} –º–µ—Ç–æ–∫`;
            } else {
                limitElement.style.display = 'none';
            }
        }
        
        function updateUI() {
            updateMarkerCount();
            document.getElementById('points').textContent = points;
            document.getElementById('activity').textContent = activity;
            
            const rank = calculateRank();
            document.getElementById('userRank').textContent = rank.name;
            document.getElementById('rankPoints').textContent = rank.progress + '%';
        }
        
        function calculateRank() {
            if (activity >= 100) return { name: '–ö–æ–º–∏—Å—Å–∞—Ä', progress: 100 };
            if (activity >= 50) return { name: '–î–µ—Ç–µ–∫—Ç–∏–≤', progress: Math.min(100, (activity - 50) * 2) };
            if (activity >= 20) return { name: '–°–µ—Ä–∂–∞–Ω—Ç', progress: Math.min(100, (activity - 20) * 3.33) };
            if (activity >= 5) return { name: '–ü–∞—Ç—Ä—É–ª—å–Ω—ã–π', progress: Math.min(100, (activity - 5) * 6.67) };
            return { name: '–ù–æ–≤–∏—á–æ–∫', progress: Math.min(100, activity * 20) };
        }
        
        function selectTool(tool) {
            selectedTool = tool;
            document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
            event.target.closest('.tool-btn').classList.add('active');
        }
        
        // ============ –ö–ê–†–¢–ê –ò –ì–ï–û–õ–û–ö–ê–¶–ò–Ø ============
        function initMap() {
            try {
                // –¶–µ–Ω—Ç—Ä –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é - –ë–µ–ª–æ–æ–∑–µ—Ä—Å–∫–∏–π
                let center = [55.459619, 38.438920];
                let zoom = 15;
                let useGeolocation = false;
                
                // –§–ò–ö–°: –£–ª—É—á—à–µ–Ω–Ω–∞—è –≥–µ–æ–ª–æ–∫–∞—Ü–∏—è
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        function(position) {
                            center = [position.coords.latitude, position.coords.longitude];
                            zoom = 17;
                            useGeolocation = true;
                            createMap(center, zoom, useGeolocation);
                        },
                        function(error) {
                            console.warn('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ë–µ–ª–æ–æ–∑–µ—Ä—Å–∫–∏–π:', error);
                            addChatMessage('system', 'üìç –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞—Ä—Ç–∞ –ë–µ–ª–æ–æ–∑–µ—Ä—Å–∫–æ–≥–æ');
                            createMap(center, zoom, useGeolocation);
                        },
                        {
                            enableHighAccuracy: true,
                            timeout: 10000,
                            maximumAge: 60000
                        }
                    );
                } else {
                    console.log('Geolocation API –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
                    addChatMessage('system', 'üìç –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞—Ä—Ç–∞ –ë–µ–ª–æ–æ–∑–µ—Ä—Å–∫–æ–≥–æ');
                    createMap(center, zoom, useGeolocation);
                }
                
                function createMap(centerCoords, zoomLevel, hasGeolocation) {
                    ymap = new ymaps.Map('yandex-map', {
                        center: centerCoords,
                        zoom: zoomLevel,
                        controls: ['zoomControl', 'fullscreenControl', 'typeSelector']
                    });
                    
                    // –§–ò–ö–°: –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ
                    if (hasGeolocation) {
                        const geolocationControl = new ymaps.control.GeolocationControl({
                            options: {
                                noPlacemark: false,
                                position: { right: 10, top: 80 }
                            }
                        });
                        ymap.controls.add(geolocationControl);
                    }
                    
                    document.getElementById('loading').style.display = 'none';
                    
                    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–æ–≤ –ø–æ –∫–∞—Ä—Ç–µ
                    ymap.events.add('click', function(e) {
                        const coords = e.get('coords');
                        
                        if (selectedTool === 'clear') {
                            let closestMarker = null;
                            let minDistance = Infinity;
                            
                            Object.entries(markers).forEach(([id, marker]) => {
                                if (marker.authorId === currentUserId && marker.isActive) {
                                    const distance = Math.sqrt(
                                        Math.pow(marker.coords.lat - coords[0], 2) + 
                                        Math.pow(marker.coords.lng - coords[1], 2)
                                    ) * 111000;
                                    
                                    if (distance < 50 && distance < minDistance) {
                                        minDistance = distance;
                                        closestMarker = { id, marker };
                                    }
                                }
                            });
                            
                            if (closestMarker) {
                                deleteMarker(closestMarker.id);
                            } else {
                                alert('‚ùå –ù–µ—Ç –≤–∞—à–∏—Ö –º–µ—Ç–æ–∫ —Ä—è–¥–æ–º –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è');
                            }
                        } else {
                            pendingMarkerData = { coords, type: selectedTool };
                            
                            // –î–ª—è –º–µ—Ç–∫–∏ "–ü—Ä–æ–±–∫–∞" –Ω–µ —Å–ø—Ä–∞—à–∏–≤–∞–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
                            if (selectedTool === 'hazard') {
                                addMarker(pendingMarkerData.coords, pendingMarkerData.type, null);
                            } else {
                                openCommentModal();
                            }
                        }
                    });
                }
                
                updateUI();
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∫–∞—Ä—Ç—ã:', error);
                document.getElementById('loading').innerHTML = `
                    <i class="fas fa-exclamation-triangle" style="font-size: 2.5rem; margin-bottom: 20px; color: #f44336;"></i>
                    <p style="color: #f44336; font-size: 1.1rem;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç—ã</p>
                    <button onclick="location.reload()" 
                            style="background: #2196f3; color: white; border: none; padding: 10px 20px; border-radius: 10px; margin-top: 20px; cursor: pointer;">
                        –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å
                    </button>
                `;
            }
        }
        
        // ============ –ó–ê–°–¢–ê–í–ö–ê –ò –ó–ê–ü–£–°–ö ============
        function startAutoStartTimer() {
            const countdownElement = document.getElementById('countdown');
            countdownElement.textContent = countdownSeconds;
            
            autoStartInterval = setInterval(() => {
                countdownSeconds--;
                countdownElement.textContent = countdownSeconds;
                
                if (countdownSeconds <= 0) {
                    clearInterval(autoStartInterval);
                    if (document.getElementById('splashScreen').style.display !== 'none') {
                        startGame();
                    }
                }
            }, 1000);
        }
        
        function skipIntro() {
            clearInterval(autoStartInterval);
            transitionToGame();
        }
        
        function startGame() {
            clearInterval(autoStartInterval);
            transitionToGame();
        }
        
        function transitionToGame() {
            const splash = document.getElementById('splashScreen');
            const mainApp = document.getElementById('mainApp');
            
            splash.style.opacity = '0';
            splash.style.transition = 'opacity 0.5s ease';
            
            setTimeout(() => {
                splash.style.display = 'none';
                mainApp.classList.add('active');
                initGame();
            }, 500);
        }
        
        function initGame() {
            console.log('üöî –ó–∞–ø—É—Å–∫ –∏–≥—Ä—ã...');
            
            if (window.ymaps) {
                ymaps.ready(initMap);
            } else {
                document.getElementById('loading').innerHTML = `
                    <i class="fas fa-exclamation-triangle" style="font-size: 2.5rem; margin-bottom: 20px; color: #f44336;"></i>
                    <p style="color: #f44336; font-size: 1.1rem;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç</p>
                `;
            }
        }
        
        // ============ –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê ============
        function openRulesModal() {
            document.getElementById('rulesModal').style.display = 'flex';
        }
        
        function openPlayersModal() {
            document.getElementById('playersModal').style.display = 'flex';
        }
        
        function openControlsModal() {
            document.getElementById('controlsModal').style.display = 'flex';
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        function openCommentModal() {
            document.getElementById('commentText').value = '';
            document.getElementById('commentChars').textContent = '0/30';
            document.getElementById('commentChars').className = 'comment-chars';
            document.getElementById('addWithCommentBtn').disabled = false;
            document.getElementById('commentModal').style.display = 'flex';
        }
        
        function closeCommentModal() {
            document.getElementById('commentModal').style.display = 'none';
            pendingMarkerData = null;
        }
        
        function addMarkerWithComment() {
            if (pendingMarkerData) {
                const comment = document.getElementById('commentText').value.trim();
                if (comment.length > MAX_COMMENT_CHARS) {
                    alert(`–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π! –ú–∞–∫—Å–∏–º—É–º ${MAX_COMMENT_CHARS} —Å–∏–º–≤–æ–ª–æ–≤.`);
                    return;
                }
                addMarker(pendingMarkerData.coords, pendingMarkerData.type, comment || null);
                closeCommentModal();
            }
        }
        
        function addMarkerWithoutComment() {
            if (pendingMarkerData) {
                addMarker(pendingMarkerData.coords, pendingMarkerData.type, null);
                closeCommentModal();
            }
        }
        
        function cleanupBeforeExit() {
            if (firebaseDatabase) {
                firebaseDatabase.ref('markers').off();
                firebaseDatabase.ref('online').off();
                firebaseDatabase.ref('chat').off();
                
                firebaseDatabase.ref('online/' + currentUserId).remove();
            }
        }
        
        // ============ –ó–ê–ü–£–°–ö –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ============
        document.addEventListener('DOMContentLoaded', function() {
            initTelegram();
            
            // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ
            document.addEventListener('click', function(event) {
                const modals = ['rulesModal', 'playersModal', 'controlsModal', 'commentModal'];
                modals.forEach(modalId => {
                    const modal = document.getElementById(modalId);
                    if (event.target === modal) {
                        if (modalId === 'commentModal') {
                            closeCommentModal();
                        } else {
                            closeModal(modalId);
                        }
                    }
                });
                
                // –ó–∞–∫—Ä—ã—Ç–∏–µ —á–∞—Ç–∞ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ
                const chatWindow = document.getElementById('chatWindow');
                const chatButton = document.getElementById('chatButton');
                if (chatWindowOpen && 
                    !chatWindow.contains(event.target) && 
                    !chatButton.contains(event.target) &&
                    event.target !== chatButton) {
                    toggleChatWindow();
                }
            });
            
            // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Ä–∞—Å—Ç—è–≥–∏–≤–∞–Ω–∏–µ –æ–∫–Ω–∞
            document.addEventListener('touchmove', function(e) {
                if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
                    e.preventDefault();
                }
            }, { passive: false });
            
            // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ
            document.addEventListener('gesturestart', function(e) {
                e.preventDefault();
            });
        });
        
        // –≠–∫—Å–ø–æ—Ä—Ç —Ñ—É–Ω–∫—Ü–∏–π –¥–ª—è –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
        window.startGame = startGame;
        window.skipIntro = skipIntro;
        window.selectTool = selectTool;
        window.openRulesModal = openRulesModal;
        window.openPlayersModal = openPlayersModal;
        window.openControlsModal = openControlsModal;
        window.closeModal = closeModal;
        window.deleteMarker = deleteMarker;
        window.openCommentModal = openCommentModal;
        window.closeCommentModal = closeCommentModal;
        window.addMarkerWithComment = addMarkerWithComment;
        window.addMarkerWithoutComment = addMarkerWithoutComment;
        window.toggleChatWindow = toggleChatWindow;
        window.sendChatMessage = sendChatMessage;
        window.handleChatKeyPress = handleChatKeyPress;
        window.updateCommentChars = updateCommentChars;
    </script>
</body>
</html>
