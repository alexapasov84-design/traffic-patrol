<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üö® Traffic Patrol - –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç—ã</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://api-maps.yandex.ru/2.1/?apikey=365e247d-d853-4425-b9cc-13bfa1169a49&lang=ru_RU"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: Arial, sans-serif; 
            background: #1a237e; 
            color: white;
            height: 100vh;
            overflow: hidden;
        }
        
        .app { display: flex; flex-direction: column; height: 100vh; }
        
        /* –•–µ–¥–µ—Ä */
        .header { 
            background: #0d1b2a; 
            padding: 15px; 
            text-align: center;
            border-bottom: 3px solid #2196f3;
        }
        
        .header h1 { 
            color: #4fc3f7; 
            margin: 0 0 5px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .header-stats {
            color: #81c784;
            font-size: 0.9rem;
        }
        
        /* –ö–∞—Ä—Ç–∞ */
        .map-container {
            flex: 1;
            margin: 10px;
            border: 3px solid #2196f3;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }
        
        #yandex-map {
            width: 100%;
            height: 100%;
        }
        
        /* –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã */
        .tools {
            display: flex;
            justify-content: center;
            gap: 10px;
            padding: 15px;
            background: #0d1b2a;
            flex-wrap: wrap;
        }
        
        .tool-btn {
            padding: 12px 20px;
            background: #2196f3;
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .tool-btn:hover {
            background: #1976d2;
        }
        
        .tool-btn.active {
            background: #1976d2;
            box-shadow: 0 0 15px #2196f3;
            transform: translateY(-2px);
        }
        
        /* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */
        .stats {
            display: flex;
            justify-content: space-around;
            padding: 10px;
            background: rgba(0,0,0,0.5);
            font-size: 0.9rem;
        }
        
        .stat-value {
            font-size: 1.3rem;
            font-weight: bold;
            color: #4fc3f7;
        }
        
        /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4caf50;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            z-index: 1000;
            animation: slideIn 0.3s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .notification.error { background: #f44336; }
        .notification.warning { background: #ff9800; }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* –ó–∞–≥—Ä—É–∑–∫–∞ */
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            background: rgba(0,0,0,0.8);
            padding: 30px;
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <div class="app">
        <div class="header">
            <h1><i class="fas fa-traffic-light"></i> Traffic Patrol</h1>
            <div class="header-stats">
                –ú–µ—Ç–æ–∫: <span id="markerCount">0</span> | –û—á–∫–∏: <span id="points">100</span>
            </div>
        </div>
        
        <div class="map-container">
            <div id="yandex-map"></div>
            <div class="loading" id="loading">
                <i class="fas fa-sync fa-spin" style="font-size: 2rem; margin-bottom: 15px;"></i>
                <p>–ó–∞–≥—Ä—É–∑–∫–∞ –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç...</p>
                <p style="margin-top: 10px; font-size: 0.9rem; color: #81c784;">
                    API –∫–ª—é—á: 365e247d-d853-4425-b9cc-13bfa1169a49
                </p>
                <p style="margin-top: 5px; font-size: 0.85rem;">
                    –¶–µ–Ω—Ç—Ä: 55.459619, 38.438920
                </p>
            </div>
        </div>
        
        <div class="tools">
            <button class="tool-btn active" onclick="selectTool('police')">
                <i class="fas fa-car"></i> –ü–∞—Ç—Ä—É–ª—å
            </button>
            <button class="tool-btn" onclick="selectTool('accident')">
                <i class="fas fa-car-crash"></i> –î–¢–ü
            </button>
            <button class="tool-btn" onclick="selectTool('hazard')">
                <i class="fas fa-exclamation-triangle"></i> –û–ø–∞—Å–Ω–æ—Å—Ç—å
            </button>
            <button class="tool-btn" onclick="selectTool('clear')">
                <i class="fas fa-trash-alt"></i> –£–¥–∞–ª–∏—Ç—å
            </button>
            <button class="tool-btn" onclick="centerToUser()">
                <i class="fas fa-location-arrow"></i> –ú–æ—ë –º–µ—Å—Ç–æ
            </button>
        </div>
        
        <div class="stats">
            <div>
                <div class="stat-value" id="activity">0</div>
                <div>–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</div>
            </div>
            <div>
                <div class="stat-value" id="rankPoints">100%</div>
                <div>–ü—Ä–æ–≥—Ä–µ—Å—Å</div>
            </div>
            <div>
                <div class="stat-value" id="userRank">–ù–æ–≤–∏—á–æ–∫</div>
                <div>–†–∞–Ω–≥</div>
            </div>
        </div>
    </div>

    <script>
        // ============ –ò–ì–†–ê TRAFFIC PATROL ============
        
        let game = {
            // –°–æ—Å—Ç–æ—è–Ω–∏–µ
            map: null,
            markers: [],
            selectedTool: 'police',
            points: 100,
            activity: 0,
            userName: '–ò–≥—Ä–æ–∫',
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
            async init() {
                console.log('üéÆ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–≥—Ä—ã...');
                
                // Telegram
                if (window.Telegram?.WebApp) {
                    const tg = window.Telegram.WebApp;
                    tg.expand();
                    if (tg.initDataUnsafe?.user) {
                        this.userName = tg.initDataUnsafe.user.first_name || '–ò–≥—Ä–æ–∫';
                    }
                    console.log('ü§ñ Telegram –ø–æ–¥–∫–ª—é—á–µ–Ω');
                }
                
                // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–π
                this.load();
                
                // –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç—ã
                await this.initYandexMap();
                
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI
                this.updateUI();
                
                // –°–æ–æ–±—â–µ–Ω–∏–µ
                this.notify('‚úÖ –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã! –ö–ª–∏–∫–∞–π—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É', 'success');
            },
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç (–ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø)
            initYandexMap() {
                return new Promise((resolve, reject) => {
                    if (!window.ymaps) {
                        this.notify('–û—à–∏–±–∫–∞: –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç—ã –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∏—Å—å', 'error');
                        reject();
                        return;
                    }
                    
                    ymaps.ready(() => {
                        try {
                            console.log('üó∫Ô∏è –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ä—Ç—ã...');
                            
                            // –ü–†–û–°–¢–ê–Ø –ö–ê–†–¢–ê –ë–ï–ó –ü–†–û–ë–û–ö (—á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –æ—à–∏–±–∫–∏)
                            this.map = new ymaps.Map('yandex-map', {
                                center: [55.459619, 38.438920],
                                zoom: 15,
                                controls: ['zoomControl', 'fullscreenControl']
                            });
                            
                            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
                            this.map.controls.get('zoomControl').options.set({
                                size: 'small',
                                position: { right: 10, top: 100 }
                            });
                            
                            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
                            this.map.events.add('click', (e) => {
                                const coords = e.get('coords');
                                this.handleMapClick(coords);
                            });
                            
                            // –°–∫—Ä—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
                            setTimeout(() => {
                                document.getElementById('loading').style.display = 'none';
                            }, 500);
                            
                            // –ó–∞–≥—Ä—É–∂–∞–µ–º –º–µ—Ç–∫–∏
                            this.loadMarkers();
                            
                            console.log('‚úÖ –ö–∞—Ä—Ç–∞ —Å–æ–∑–¥–∞–Ω–∞');
                            resolve();
                            
                        } catch (error) {
                            console.error('‚ùå –û—à–∏–±–∫–∞ –∫–∞—Ä—Ç—ã:', error);
                            this.notify('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞—Ä—Ç—ã', 'error');
                            reject(error);
                        }
                    });
                });
            },
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ –ø–æ –∫–∞—Ä—Ç–µ
            handleMapClick(coords) {
                if (this.selectedTool === 'clear') {
                    this.removeNearestMarker(coords);
                } else {
                    this.addMarker(coords, this.selectedTool);
                }
            },
            
            // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–∞
            addMarker(coords, type) {
                const cost = this.getCost(type);
                if (this.points < cost) {
                    this.notify(`–ù—É–∂–Ω–æ ${cost} –æ—á–∫–æ–≤!`, 'error');
                    return;
                }
                
                const markerId = 'marker_' + Date.now();
                
                // –¶–≤–µ—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
                let iconColor;
                switch(type) {
                    case 'police': iconColor = '#2196F3'; break;
                    case 'accident': iconColor = '#F44336'; break;
                    case 'hazard': iconColor = '#FF9800'; break;
                }
                
                // –°–æ–∑–¥–∞–µ–º –º–µ—Ç–∫—É –Ø–Ω–¥–µ–∫—Å
                const placemark = new ymaps.Placemark(coords, {
                    hintContent: `${this.userName}: ${this.getToolName(type)}`,
                    balloonContent: `
                        <div style="padding: 10px;">
                            <strong>${this.getToolName(type)}</strong><br>
                            <small>–î–æ–±–∞–≤–∏–ª: ${this.userName}</small><br>
                            <button onclick="game.removeMarker('${markerId}')" 
                                    style="margin-top: 5px; padding: 5px 10px; background: #f44336; color: white; border: none; border-radius: 3px; cursor: pointer;">
                                –£–¥–∞–ª–∏—Ç—å
                            </button>
                        </div>
                    `
                }, {
                    preset: 'islands#icon',
                    iconColor: iconColor,
                    draggable: true
                });
                
                // –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ
                placemark.events.add('dragend', () => {
                    const newCoords = placemark.geometry.getCoordinates();
                    this.updateMarkerCoords(markerId, newCoords);
                    this.notify('–ú–µ—Ç–∫–∞ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∞! +2 –æ—á–∫–∞', 'success');
                    this.points += 2;
                    this.activity++;
                    this.updateUI();
                    this.save();
                });
                
                // –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞ –∫–∞—Ä—Ç—É
                this.map.geoObjects.add(placemark);
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º
                this.markers.push({
                    id: markerId,
                    type: type,
                    coords: coords,
                    placemark: placemark
                });
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –æ—á–∫–∏
                this.points -= cost;
                this.activity++;
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏ –æ–±–Ω–æ–≤–ª—è–µ–º
                this.save();
                this.updateUI();
                this.notify(`${this.getToolName(type)} –¥–æ–±–∞–≤–ª–µ–Ω! -${cost} –æ—á–∫–æ–≤`, 'success');
            },
            
            // –£–¥–∞–ª–µ–Ω–∏–µ –±–ª–∏–∂–∞–π—à–µ–π –º–µ—Ç–∫–∏
            removeNearestMarker(coords) {
                const objects = this.map.geoObjects;
                let closest = null;
                let minDist = 0.0005;
                
                objects.each((obj) => {
                    if (obj.geometry) {
                        const markerCoords = obj.geometry.getCoordinates();
                        const dist = Math.sqrt(
                            Math.pow(markerCoords[0] - coords[0], 2) +
                            Math.pow(markerCoords[1] - coords[1], 2)
                        );
                        
                        if (dist < minDist) {
                            minDist = dist;
                            closest = obj;
                        }
                    }
                });
                
                if (closest) {
                    this.map.geoObjects.remove(closest);
                    
                    // –ù–∞—Ö–æ–¥–∏–º –∏ —É–¥–∞–ª—è–µ–º –∏–∑ –º–∞—Å—Å–∏–≤–∞
                    const markerId = this.findMarkerIdByPlacemark(closest);
                    if (markerId) {
                        this.markers = this.markers.filter(m => m.id !== markerId);
                        this.points += 5;
                        this.activity++;
                        this.save();
                        this.updateUI();
                        this.notify('–ú–µ—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–∞! +5 –æ—á–∫–æ–≤', 'success');
                    }
                } else {
                    this.notify('–ö–ª–∏–∫–Ω–∏—Ç–µ –±–ª–∏–∂–µ –∫ –º–µ—Ç–∫–µ', 'warning');
                }
            },
            
            // –£–¥–∞–ª–µ–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–∞ –ø–æ ID (–∏–∑ –±–∞–ª—É–Ω–∞)
            removeMarker(markerId) {
                const marker = this.markers.find(m => m.id === markerId);
                if (marker && marker.placemark) {
                    this.map.geoObjects.remove(marker.placemark);
                    this.markers = this.markers.filter(m => m.id !== markerId);
                    this.points += 5;
                    this.activity++;
                    this.save();
                    this.updateUI();
                    this.notify('–ú–µ—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–∞! +5 –æ—á–∫–æ–≤', 'success');
                }
            },
            
            // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –º–∞—Ä–∫–µ—Ä–æ–≤
            loadMarkers() {
                this.markers.forEach(markerData => {
                    let iconColor;
                    switch(markerData.type) {
                        case 'police': iconColor = '#2196F3'; break;
                        case 'accident': iconColor = '#F44336'; break;
                        case 'hazard': iconColor = '#FF9800'; break;
                    }
                    
                    const placemark = new ymaps.Placemark(markerData.coords, {
                        hintContent: `${this.userName}: ${this.getToolName(markerData.type)}`,
                        balloonContent: `
                            <div style="padding: 10px;">
                                <strong>${this.getToolName(markerData.type)}</strong><br>
                                <button onclick="game.removeMarker('${markerData.id}')" 
                                        style="margin-top: 5px; padding: 5px 10px; background: #f44336; color: white; border: none; border-radius: 3px; cursor: pointer;">
                                    –£–¥–∞–ª–∏—Ç—å
                                </button>
                            </div>
                        `
                    }, {
                        preset: 'islands#icon',
                        iconColor: iconColor,
                        draggable: true
                    });
                    
                    placemark.events.add('dragend', () => {
                        const newCoords = placemark.geometry.getCoordinates();
                        this.updateMarkerCoords(markerData.id, newCoords);
                        this.notify('–ú–µ—Ç–∫–∞ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∞! +2 –æ—á–∫–∞', 'success');
                        this.points += 2;
                        this.activity++;
                        this.updateUI();
                        this.save();
                    });
                    
                    this.map.geoObjects.add(placemark);
                    markerData.placemark = placemark;
                });
            },
            
            // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã
            findMarkerIdByPlacemark(placemark) {
                const marker = this.markers.find(m => m.placemark === placemark);
                return marker ? marker.id : null;
            },
            
            updateMarkerCoords(markerId, newCoords) {
                const marker = this.markers.find(m => m.id === markerId);
                if (marker) {
                    marker.coords = newCoords;
                    this.save();
                }
            },
            
            // –í—ã–±–æ—Ä –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
            selectTool(tool) {
                this.selectedTool = tool;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏
                document.querySelectorAll('.tool-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                event.target.classList.add('active');
                
                this.notify(`–í—ã–±—Ä–∞–Ω: ${this.getToolName(tool)}`, 'success');
            },
            
            // –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
            centerToUser() {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (pos) => {
                            const coords = [pos.coords.latitude, pos.coords.longitude];
                            this.map.setCenter(coords, 16);
                            this.notify('–ö–∞—Ä—Ç–∞ —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∞ –Ω–∞ –≤–∞—Å', 'success');
                        },
                        () => {
                            this.notify('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ', 'warning');
                        }
                    );
                }
            },
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI
            updateUI() {
                document.getElementById('markerCount').textContent = this.markers.length;
                document.getElementById('points').textContent = this.points;
                document.getElementById('activity').textContent = this.activity;
                
                // –†–∞–Ω–≥
                const rank = this.getRank();
                document.getElementById('userRank').textContent = rank;
                
                // –ü—Ä–æ–≥—Ä–µ—Å—Å
                const progress = Math.min(this.points / 100, 1) * 100;
                document.getElementById('rankPoints').textContent = Math.round(progress) + '%';
            },
            
            // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–∞–Ω–≥–∞
            getRank() {
                if (this.points >= 1000) return '–ö–æ–º–∏—Å—Å–∞—Ä üëÆ‚Äç‚ôÇÔ∏è';
                if (this.points >= 500) return '–°–µ—Ä–∂–∞–Ω—Ç üëÆ';
                if (this.points >= 200) return '–û—Ñ–∏—Ü–µ—Ä üöî';
                if (this.points >= 100) return '–ü–∞—Ç—Ä—É–ª—å–Ω—ã–π üöì';
                return '–ù–æ–≤–∏—á–æ–∫ üö¶';
            },
            
            // –£—Ç–∏–ª–∏—Ç—ã
            getToolName(tool) {
                return {
                    police: '–ü–∞—Ç—Ä—É–ª—å üöì',
                    accident: '–î–¢–ü üí•',
                    hazard: '–û–ø–∞—Å–Ω–æ—Å—Ç—å ‚ö†Ô∏è',
                    clear: '–£–¥–∞–ª–µ–Ω–∏–µ'
                }[tool] || tool;
            },
            
            getCost(type) {
                return {
                    police: 10,
                    accident: 15,
                    hazard: 8
                }[type] || 10;
            },
            
            // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
            notify(message, type = 'success') {
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.textContent = message;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.style.opacity = '0';
                    setTimeout(() => notification.remove(), 300);
                }, 3000);
            },
            
            // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ/–∑–∞–≥—Ä—É–∑–∫–∞
            save() {
                try {
                    const data = {
                        markers: this.markers.map(m => ({
                            id: m.id,
                            type: m.type,
                            coords: m.coords
                        })),
                        points: this.points,
                        activity: this.activity
                    };
                    localStorage.setItem('traffic_game', JSON.stringify(data));
                } catch (e) {
                    console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', e);
                }
            },
            
            load() {
                try {
                    const saved = localStorage.getItem('traffic_game');
                    if (saved) {
                        const data = JSON.parse(saved);
                        this.markers = data.markers || [];
                        this.points = data.points || 100;
                        this.activity = data.activity || 0;
                    }
                } catch (e) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', e);
                }
            }
        };
        
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–π –¥–æ—Å—Ç—É–ø
        window.game = game;
        window.selectTool = (tool) => game.selectTool(tool);
        window.centerToUser = () => game.centerToUser();
        
        // –ó–∞–ø—É—Å–∫ –∏–≥—Ä—ã
        document.addEventListener('DOMContentLoaded', () => {
            game.init();
        });
    </script>
</body>
</html>
