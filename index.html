<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–æ–ª–∏—Ü–∏—è –ú–∞–π–∞–º–∏üëÆ‚Äç‚ôÇÔ∏èüöîüëÆ‚Äç‚ôÇÔ∏è</title>
    
    <!-- Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://api-maps.yandex.ru/2.1/?apikey=365e247d-d853-4425-b9cc-13bfa1169a49&lang=ru_RU"></script>
    
    <style>
        :root {
            --tg-theme-bg-color: #0a1931;
            --tg-theme-text-color: #ffffff;
            --tg-theme-hint-color: #aaaaaa;
            --tg-theme-link-color: #4fc3f7;
            --tg-theme-button-color: #2196f3;
            --tg-theme-button-text-color: #ffffff;
        }
        
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent;
        }
        
        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }
        
        body {
            background: var(--tg-theme-bg-color, #0a1931);
            color: var(--tg-theme-text-color, white);
            max-width: 100vw;
            max-height: 100vh;
            touch-action: none;
            overscroll-behavior: none;
        }
        
        /* === FULL-SCREEN MODE SUPPORT === */
        @media (orientation: landscape) {
            .app {
                transform: rotate(0deg);
            }
            
            .tools {
                grid-template-columns: repeat(5, 80px);
                justify-content: center;
            }
        }
        
        /* === LOADING SCREEN CUSTOMIZATION === */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0a1931 0%, #1b3a4b 100%);
            z-index: 100000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: opacity 0.5s ease;
        }
        
        .loading-logo {
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, #2196f3, #1976d2);
            border-radius: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 30px;
            animation: pulse 2s infinite;
        }
        
        .loading-logo i {
            font-size: 3rem;
            color: white;
        }
        
        .loading-progress {
            width: 200px;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 20px;
        }
        
        .loading-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #2196f3, #4fc3f7);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        /* === MOTION CONTROL INDICATOR === */
        .motion-indicator {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(33, 150, 243, 0.2);
            border: 2px solid #2196f3;
            border-radius: 15px;
            padding: 10px 15px;
            font-size: 0.9rem;
            display: none;
            align-items: center;
            gap: 10px;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }
        
        .motion-data {
            display: flex;
            gap: 15px;
        }
        
        /* === GEOLOCATION PERMISSION === */
        .geolocation-permission {
            position: fixed;
            bottom: 100px;
            left: 20px;
            right: 20px;
            background: rgba(13, 27, 42, 0.95);
            border: 2px solid #4CAF50;
            border-radius: 15px;
            padding: 20px;
            z-index: 1000;
            backdrop-filter: blur(10px);
            display: none;
            animation: slideUp 0.3s ease;
        }
        
        .geolocation-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        /* === ADD TO HOME SCREEN === */
        .add-to-home {
            position: fixed;
            bottom: 100px;
            right: 20px;
            background: rgba(76, 175, 80, 0.2);
            border: 2px solid #4CAF50;
            border-radius: 15px;
            padding: 15px;
            z-index: 1000;
            backdrop-filter: blur(10px);
            display: none;
            max-width: 300px;
            animation: slideUp 0.3s ease;
        }
        
        .add-to-home button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            margin-top: 10px;
            width: 100%;
        }
        
        /* === SHARE MEDIA BUTTON === */
        .share-media-btn {
            position: fixed;
            bottom: 90px;
            left: 20px;
            width: 50px;
            height: 50px;
            background: #FF9800;
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 999;
            box-shadow: 0 4px 15px rgba(255, 152, 0, 0.4);
            transition: all 0.3s;
        }
        
        .share-media-btn:hover {
            background: #F57C00;
            transform: scale(1.1);
        }
        
        /* === EMOJI STATUS SELECTOR === */
        .emoji-status {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(33, 150, 243, 0.2);
            border: 2px solid #2196f3;
            border-radius: 15px;
            padding: 8px 12px;
            font-size: 1.2rem;
            cursor: pointer;
            z-index: 1000;
            backdrop-filter: blur(10px);
            transition: all 0.3s;
        }
        
        .emoji-status:hover {
            background: rgba(33, 150, 243, 0.3);
            transform: scale(1.1);
        }
        
        .emoji-picker {
            position: fixed;
            top: 70px;
            right: 20px;
            background: rgba(13, 27, 42, 0.98);
            border: 2px solid #2196f3;
            border-radius: 15px;
            padding: 15px;
            z-index: 1001;
            backdrop-filter: blur(10px);
            display: none;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            max-width: 250px;
            animation: fadeIn 0.3s ease;
        }
        
        .emoji-option {
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px;
            border-radius: 10px;
            text-align: center;
            transition: all 0.2s;
        }
        
        .emoji-option:hover {
            background: rgba(33, 150, 243, 0.3);
            transform: scale(1.2);
        }
        
        /* === SUBSCRIPTION MODAL === */
        .subscription-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 20000;
            backdrop-filter: blur(5px);
        }
        
        .subscription-plans {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .plan-card {
            background: rgba(33, 150, 243, 0.1);
            border: 2px solid #2196f3;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .plan-card:hover {
            background: rgba(33, 150, 243, 0.2);
            transform: translateY(-5px);
        }
        
        .plan-card.recommended {
            border-color: #FFD700;
            background: rgba(255, 215, 0, 0.1);
        }
        
        .plan-card h3 {
            color: #4fc3f7;
            margin-bottom: 10px;
        }
        
        .plan-price {
            font-size: 2rem;
            color: #FFD700;
            margin: 15px 0;
        }
        
        .plan-features {
            list-style: none;
            padding: 0;
            margin: 15px 0;
            text-align: left;
        }
        
        .plan-features li {
            padding: 5px 0;
            color: #81c784;
        }
        
        /* === DEVICE INFO PANEL === */
        .device-info {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: #81c784;
            padding: 8px 12px;
            border-radius: 10px;
            font-size: 0.7rem;
            z-index: 1000;
            backdrop-filter: blur(5px);
            display: none;
            max-width: 200px;
        }
        
        /* === GIFT NOTIFICATION === */
        .gift-notification {
            position: fixed;
            top: 100px;
            right: 20px;
            background: linear-gradient(135deg, #FF9800, #F57C00);
            color: white;
            padding: 15px;
            border-radius: 15px;
            z-index: 1000;
            display: none;
            animation: slideInRight 0.5s ease;
            max-width: 300px;
        }
        
        .gift-icon {
            font-size: 2rem;
            margin-bottom: 10px;
            text-align: center;
        }
        
        /* === DOCUMENT GENERATOR === */
        .document-generator {
            position: fixed;
            bottom: 150px;
            right: 20px;
            background: rgba(76, 175, 80, 0.2);
            border: 2px solid #4CAF50;
            border-radius: 15px;
            padding: 15px;
            z-index: 1000;
            backdrop-filter: blur(10px);
            display: none;
            max-width: 300px;
        }
        
        /* === REST OF YOUR EXISTING STYLES === */
        .splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            max-width: 100vw;
            max-height: 100vh;
        }
        
        .splash-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 1;
        }
        
        .image-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                to bottom,
                rgba(10, 25, 49, 0.9) 0%,
                rgba(10, 25, 49, 0.7) 30%,
                rgba(10, 25, 49, 0.5) 50%,
                rgba(10, 25, 49, 0.8) 100%
            );
            z-index: 2;
        }
        
        .splash-content {
            position: relative;
            z-index: 3;
            text-align: center;
            padding: 20px;
            display: flex;
            flex-direction: column;
            height: 100%;
            justify-content: space-between;
            max-width: 100%;
            box-sizing: border-box;
        }
        
        .splash-header {
            margin-top: 20px;
            animation: fadeInDown 0.8s ease;
        }
        
        .splash-title {
            font-size: 2.5rem;
            color: #4fc3f7;
            margin-bottom: 10px;
            text-shadow: 0 0 20px rgba(79, 195, 247, 0.5);
            word-wrap: break-word;
        }
        
        .splash-subtitle {
            color: #81c784;
            font-size: 1.2rem;
            word-wrap: break-word;
        }
        
        .splash-center {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            animation: fadeIn 1s ease;
            width: 100%;
            max-width: 100%;
        }
        
        .menu-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 90%;
            max-width: 400px;
            animation: fadeIn 1s ease;
        }
        
        .menu-btn {
            padding: 18px 25px;
            background: rgba(33, 150, 243, 0.2);
            border: 2px solid rgba(33, 150, 243, 0.5);
            border-radius: 15px;
            color: white;
            font-size: 1.1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            transition: all 0.3s;
            backdrop-filter: blur(5px);
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
        }
        
        .menu-btn:hover {
            background: rgba(33, 150, 243, 0.3);
            border-color: #2196f3;
            transform: translateY(-2px);
        }
        
        .splash-buttons {
            position: relative;
            z-index: 3;
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 100%;
            max-width: 400px;
            margin: 0 auto 15px;
            animation: fadeInUp 0.8s ease;
        }
        
        .start-btn {
            padding: 18px 35px;
            background: linear-gradient(90deg, #2196f3, #1976d2);
            border: none;
            border-radius: 30px;
            color: white;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            box-shadow: 0 10px 30px rgba(33, 150, 243, 0.6);
            transition: all 0.3s;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
        }
        
        .start-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 12px 35px rgba(33, 150, 243, 0.8);
        }
        
        .skip-intro-btn {
            padding: 14px 25px;
            background: rgba(255, 255, 255, 0.15);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 25px;
            color: rgba(255, 255, 255, 0.9);
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
        }
        
        .skip-intro-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.5);
        }
        
        .tg-badge-bottom {
            margin-top: 5px;
            padding: 8px 16px;
            background: rgba(33, 150, 243, 0.2);
            border-radius: 20px;
            font-size: 0.9rem;
            color: #4fc3f7;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
            word-wrap: break-word;
        }
        
        .auto-start-timer {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: #81c784;
            padding: 10px 18px;
            border-radius: 25px;
            font-size: 0.95rem;
            z-index: 4;
            border: 1px solid rgba(129, 199, 132, 0.4);
            backdrop-filter: blur(5px);
            animation: fadeIn 1s ease;
            max-width: calc(100% - 40px);
            word-wrap: break-word;
        }
        
        .app { 
            display: flex; 
            flex-direction: column; 
            height: 100vh;
            width: 100vw;
            opacity: 0;
            transition: opacity 0.5s ease;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overflow: hidden;
            max-width: 100vw;
            max-height: 100vh;
        }
        
        .app.active {
            opacity: 1;
        }
        
        .header { 
            padding: 15px 20px;
            text-align: center;
            background: rgba(13, 27, 42, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 3px solid #2196f3;
            position: relative;
            width: 100%;
            box-sizing: border-box;
            flex-shrink: 0;
        }
        
        .header h1 { 
            color: #4fc3f7; 
            margin: 0 0 8px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            font-size: 1.5rem;
            word-wrap: break-word;
        }
        
        .header-stats {
            color: #81c784;
            font-size: 0.9rem;
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .map-container {
            flex: 1;
            margin: 10px;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            border: 3px solid #2196f3;
            min-height: 0;
            max-width: calc(100vw - 20px);
        }
        
        #yandex-map {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
        }
        
        .tools {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            padding: 12px;
            background: rgba(13, 27, 42, 0.95);
            backdrop-filter: blur(10px);
            flex-shrink: 0;
            width: 100%;
            box-sizing: border-box;
        }
        
        .tool-btn {
            padding: 10px 5px;
            background: rgba(33, 150, 243, 0.2);
            border: 2px solid #2196f3;
            border-radius: 8px;
            color: white;
            font-size: 0.75rem;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            transition: all 0.2s;
            max-width: 100%;
            box-sizing: border-box;
        }
        
        .tool-btn.active {
            background: #2196f3;
            box-shadow: 0 0 15px #2196f3;
        }
        
        .tool-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            border-color: #666;
        }
        
        .marker-limit {
            position: absolute;
            top: 5px;
            left: 5px;
            background: rgba(255, 152, 0, 0.9);
            color: white;
            padding: 5px 10px;
            border-radius: 10px;
            font-size: 0.8rem;
            z-index: 1000;
            animation: pulse 2s infinite;
            max-width: calc(100% - 20px);
            word-wrap: break-word;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            padding: 10px;
            background: rgba(13, 27, 42, 0.9);
            border-top: 2px solid #2196f3;
            text-align: center;
            font-size: 0.85rem;
            flex-shrink: 0;
            width: 100%;
            box-sizing: border-box;
        }
        
        .stat-value {
            font-size: 1.3rem;
            font-weight: bold;
            color: #4fc3f7;
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 20000;
            backdrop-filter: blur(5px);
        }
        
        .modal-content {
            background: linear-gradient(135deg, #0d1b2a, #1b3a4b);
            border-radius: 20px;
            padding: 25px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            border: 3px solid #2196f3;
            position: relative;
            margin: 20px;
            box-sizing: border-box;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(33, 150, 243, 0.3);
        }
        
        .modal-header h2 {
            color: #4fc3f7;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .modal-close {
            background: rgba(255, 0, 0, 0.2);
            border: 2px solid rgba(255, 0, 0, 0.5);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        
        .modal-close:hover {
            background: rgba(255, 0, 0, 0.3);
            border-color: #ff4444;
            transform: rotate(90deg);
        }
        
        .players-list {
            max-height: 300px;
            overflow-y: auto;
            margin: 20px 0;
        }
        
        .player-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 15px;
            margin-bottom: 10px;
            background: rgba(33, 150, 243, 0.1);
            border-radius: 10px;
            border-left: 4px solid #4CAF50;
        }
        
        .player-item.rank-1 {
            background: linear-gradient(90deg, rgba(255, 215, 0, 0.1), rgba(33, 150, 243, 0.1));
            border-left-color: #FFD700;
        }
        
        .player-item.rank-2 {
            background: linear-gradient(90deg, rgba(192, 192, 192, 0.1), rgba(33, 150, 243, 0.1));
            border-left-color: #C0C0C0;
        }
        
        .player-item.rank-3 {
            background: linear-gradient(90deg, rgba(205, 127, 50, 0.1), rgba(33, 150, 243, 0.1));
            border-left-color: #CD7F32;
        }
        
        .player-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .player-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #2196f3, #1976d2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            position: relative;
        }
        
        .player-rank-badge {
            position: absolute;
            bottom: -5px;
            right: -5px;
            background: #FF9800;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .player-details {
            display: flex;
            flex-direction: column;
        }
        
        .player-name {
            font-weight: bold;
            font-size: 1rem;
        }
        
        .player-stats {
            font-size: 0.75rem;
            color: #81c784;
            display: flex;
            gap: 8px;
        }
        
        .player-score {
            color: #FFD700;
        }
        
        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è */
        .comment-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 20000;
            backdrop-filter: blur(5px);
        }
        
        .comment-modal-content {
            background: linear-gradient(135deg, #0d1b2a, #1b3a4b);
            border-radius: 20px;
            padding: 20px;
            width: 90%;
            max-width: 350px;
            border: 3px solid #2196f3;
        }
        
        .comment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(33, 150, 243, 0.3);
        }
        
        .comment-header h2 {
            color: #4fc3f7;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .comment-input-container {
            margin-bottom: 20px;
        }
        
        .comment-input {
            width: 100%;
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid #2196f3;
            border-radius: 10px;
            color: white;
            padding: 12px 15px;
            font-size: 1rem;
            resize: none;
            min-height: 50px;
            max-height: 50px;
            box-sizing: border-box;
        }
        
        .comment-input::placeholder {
            color: #aaa;
        }
        
        .comment-chars {
            text-align: right;
            font-size: 0.8rem;
            color: #aaa;
            margin-top: 5px;
        }
        
        .comment-chars.warning {
            color: #ff9800;
        }
        
        .comment-chars.error {
            color: #f44336;
        }
        
        .comment-buttons {
            display: flex;
            gap: 10px;
        }
        
        .comment-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .comment-btn.add {
            background: #2196f3;
            color: white;
        }
        
        .comment-btn.add:hover {
            background: #1976d2;
        }
        
        .comment-btn.add:disabled {
            background: #666;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .comment-btn.skip {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        
        .comment-btn.skip:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .comment-info {
            color: #aaa;
            font-size: 0.85rem;
            text-align: center;
            margin-top: 15px;
        }
        
        .fa-siren::before {
            content: "üö®";
            animation: siren 1s infinite alternate;
        }
        
        @keyframes siren {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes pulse {
            0% { opacity: 0.7; }
            50% { opacity: 1; }
            100% { opacity: 0.7; }
        }
        
        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-height: 700px) {
            .splash-title { font-size: 2rem; }
            .splash-subtitle { font-size: 1rem; }
            .menu-buttons { gap: 10px; }
            .menu-btn { padding: 14px 20px; font-size: 1rem; }
            .start-btn { padding: 16px 30px; font-size: 1.1rem; }
            .skip-intro-btn { padding: 12px 20px; font-size: 0.95rem; }
        }
        
        @media (max-width: 768px) {
            .splash-title { font-size: 2rem; }
            .header h1 { font-size: 1.3rem; }
            .tools { grid-template-columns: repeat(5, 1fr); gap: 5px; padding: 8px; }
            .tool-btn { font-size: 0.7rem; padding: 8px 3px; }
            .header-stats { font-size: 0.8rem; gap: 10px; }
            .stats { font-size: 0.8rem; }
            .stat-value { font-size: 1.1rem; }
        }
        
        @media (max-height: 600px) {
            .splash-header { margin-top: 10px; }
            .splash-title { font-size: 1.8rem; }
            .splash-center { justify-content: flex-start; padding-top: 20px; }
            .tg-badge-bottom { margin-bottom: 5px; }
        }
        
        @media (min-width: 1024px) {
            .app {
                max-width: 500px;
                margin: 0 auto;
                left: 50%;
                transform: translateX(-50%);
                border-left: 1px solid rgba(255, 255, 255, 0.1);
                border-right: 1px solid rgba(255, 255, 255, 0.1);
            }
        }
    </style>
</head>
<body>
    <!-- –ö–∞—Å—Ç–æ–º–Ω—ã–π —ç–∫—Ä–∞–Ω –∑–∞–≥—Ä—É–∑–∫–∏ -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-logo">
            <i class="fas fa-police-car"></i>
        </div>
        <h2 style="color: #4fc3f7; margin-bottom: 10px;">–ü–æ–ª–∏—Ü–∏—è –ú–∞–π–∞–º–∏</h2>
        <p style="color: #81c784; margin-bottom: 20px;">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
        <div class="loading-progress">
            <div class="loading-progress-bar" id="loadingProgress"></div>
        </div>
    </div>

    <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ -->
    <div class="device-info" id="deviceInfo">
        <div>CPU: <span id="cpuInfo">-</span></div>
        <div>RAM: <span id="ramInfo">-</span></div>
        <div>GPU: <span id="gpuInfo">-</span></div>
    </div>

    <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä motion control -->
    <div class="motion-indicator" id="motionIndicator">
        <i class="fas fa-compass"></i>
        <div class="motion-data">
            <span>X: <span id="motionX">0</span></span>
            <span>Y: <span id="motionY">0</span></span>
            <span>Z: <span id="motionZ">0</span></span>
        </div>
    </div>

    <!-- Emoji —Å—Ç–∞—Ç—É—Å -->
    <div class="emoji-status" id="emojiStatus" onclick="toggleEmojiPicker()">
        üöî
    </div>
    
    <div class="emoji-picker" id="emojiPicker">
        <div class="emoji-option" onclick="setEmojiStatus('üöî')">üöî</div>
        <div class="emoji-option" onclick="setEmojiStatus('üëÆ‚Äç‚ôÇÔ∏è')">üëÆ‚Äç‚ôÇÔ∏è</div>
        <div class="emoji-option" onclick="setEmojiStatus('üö®')">üö®</div>
        <div class="emoji-option" onclick="setEmojiStatus('üÜò')">üÜò</div>
        <div class="emoji-option" onclick="setEmojiStatus('üöó')">üöó</div>
        <div class="emoji-option" onclick="setEmojiStatus('üéÆ')">üéÆ</div>
        <div class="emoji-option" onclick="setEmojiStatus('üèÜ')">üèÜ</div>
        <div class="emoji-option" onclick="setEmojiStatus('‚≠ê')">‚≠ê</div>
        <div class="emoji-option" onclick="setEmojiStatus('üî•')">üî•</div>
        <div class="emoji-option" onclick="setEmojiStatus('üíº')">üíº</div>
    </div>

    <!-- –ö–Ω–æ–ø–∫–∞ –ø–æ–¥–µ–ª–∏—Ç—å—Å—è –º–µ–¥–∏–∞ -->
    <button class="share-media-btn" onclick="shareGameResults()" title="–ü–æ–¥–µ–ª–∏—Ç—å—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏">
        <i class="fas fa-share-alt"></i>
    </button>

    <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ø–æ–¥–∞—Ä–∫–µ -->
    <div class="gift-notification" id="giftNotification">
        <div class="gift-icon">üéÅ</div>
        <h3>–ü–æ–¥–∞—Ä–æ–∫ –ø–æ–ª—É—á–µ–Ω!</h3>
        <p>–ó–∞ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ 100 –æ—á–∫–æ–≤ –≤—ã –ø–æ–ª—É—á–∏–ª–∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –±–µ–π–¥–∂!</p>
        <button onclick="closeGiftNotification()" style="background: white; color: #FF9800; border: none; padding: 8px 15px; border-radius: 10px; margin-top: 10px; cursor: pointer;">
            –û—Ç–ª–∏—á–Ω–æ!
        </button>
    </div>

    <!-- –ó–∞—Å—Ç–∞–≤–∫–∞ -->
    <div id="splashScreen" class="splash-screen">
        <img src="https://static.craftum.com/9F-qvclCZh6dtPwdnNtlBy-tW_0=/380x0/filters:no_upscale()/https://274418.selcdn.ru/cv08300-33250f0d-0664-43fc-9dbf-9d89738d114e/uploads/655846/14f3a178-0a4b-4df5-bf77-949d65a34e3a.jpg" 
             class="splash-image" 
             alt="–ü–æ–ª–∏—Ü–∏—è –ú–∞–π–∞–º–∏"
             onerror="this.style.display='none'; document.querySelector('.image-overlay').style.background='#0a1931';">
        
        <div class="image-overlay"></div>
        
        <div class="splash-content">
            <div class="auto-start-timer" id="autoStartTimer">
                –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑: <span id="countdown">5</span> —Å–µ–∫
            </div>
            
            <div class="splash-header">
                <h1 class="splash-title">üëÆ‚Äç‚ôÇÔ∏è –ü–æ–ª–∏—Ü–∏—è –ú–∞–π–∞–º–∏ üöî</h1>
                <p class="splash-subtitle" id="userWelcome">–û–¥–∏–Ω–æ—á–Ω–∞—è –∏–≥—Ä–∞</p>
            </div>
            
            <div class="splash-center">
                <div class="menu-buttons">
                    <button class="menu-btn" onclick="openRulesModal()">
                        <i class="fas fa-book"></i> –ü—Ä–∞–≤–∏–ª–∞ –∏–≥—Ä—ã
                    </button>
                    <button class="menu-btn" onclick="openSubscriptionModal()">
                        <i class="fas fa-crown"></i> –ü—Ä–µ–º–∏—É–º
                    </button>
                    <button class="menu-btn" onclick="openPlayersModal()">
                        <i class="fas fa-users"></i> –†–µ–π—Ç–∏–Ω–≥
                    </button>
                    <button class="menu-btn" onclick="openControlsModal()">
                        <i class="fas fa-gamepad"></i> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
                    </button>
                    <button class="menu-btn" onclick="showAddToHome()">
                        <i class="fas fa-home"></i> –ù–∞ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω
                    </button>
                </div>
            </div>
            
            <div class="splash-buttons">
                <button class="start-btn" onclick="startGame()">
                    <i class="fas fa-play-circle"></i>
                    –ù–ê–ß–ê–¢–¨ –ò–ì–†–£
                </button>
                
                <button class="skip-intro-btn" onclick="skipIntro()">
                    <i class="fas fa-forward"></i>
                    –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –∑–∞—Å—Ç–∞–≤–∫—É
                </button>
                
                <div class="tg-badge-bottom">
                    <i class="fab fa-telegram"></i> Telegram Mini App 2.0
                </div>
            </div>
        </div>
    </div>
    
    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∏–≥—Ä–æ–≤–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å -->
    <div class="app" id="mainApp">
        <div class="header">
            <h1><i class="fas fa-police-car"></i> –ü–æ–ª–∏—Ü–∏—è –ú–∞–π–∞–º–∏ üëÆ‚Äç‚ôÇÔ∏èüöî</h1>
            <div class="header-stats">
                <span>–ú–µ—Ç–æ–∫: <span id="markerCount">0</span>/<span id="maxMarkers">40</span></span>
                <span>–û—á–∫–∏: <span id="points">100</span></span>
                <span>–†–µ–∂–∏–º: <span id="onlineCount">–õ–æ–∫–∞–ª—å–Ω—ã–π</span></span>
            </div>
        </div>
        
        <div class="map-container">
            <div id="yandex-map"></div>
            <div id="loading" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                <i class="fas fa-sync fa-spin" style="font-size: 2.5rem; margin-bottom: 20px; color: #4fc3f7;"></i>
                <p style="color: #81c784; font-size: 1.1rem;">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç...</p>
                <p id="syncStatus" style="color: #4fc3f7; font-size: 0.9rem; margin-top: 10px;">–õ–æ–∫–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º</p>
            </div>
            <div class="marker-limit" id="markerLimit" style="display: none;">
                üî¥ –õ–∏–º–∏—Ç: 40 –º–µ—Ç–æ–∫
            </div>
        </div>
        
        <div class="tools">
            <button class="tool-btn active" onclick="selectTool('police')">
                <i class="fas fa-siren" style="font-size: 1.2em;"></i>
                <span>–ü–∞—Ç—Ä—É–ª—å</span>
            </button>
            <button class="tool-btn" onclick="selectTool('accident')">
                <i class="fas fa-car-crash"></i>
                <span>–î–¢–ü</span>
            </button>
            <button class="tool-btn" onclick="selectTool('help')">
                <i class="fas fa-flag"></i>
                <span>–ü–æ–º–æ—â—å</span>
            </button>
            <button class="tool-btn" onclick="selectTool('hazard')">
                <i class="fas fa-traffic-light"></i>
                <span>–ü—Ä–æ–±–∫–∞</span>
            </button>
            <button class="tool-btn" onclick="selectTool('clear')">
                <i class="fas fa-trash-alt"></i>
                <span>–£–¥–∞–ª–∏—Ç—å</span>
            </button>
        </div>
        
        <div class="stats">
            <div>
                <div class="stat-value" id="activity">0</div>
                <div>–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</div>
            </div>
            <div>
                <div class="stat-value" id="rankPoints">100%</div>
                <div>–ü—Ä–æ–≥—Ä–µ—Å—Å</div>
            </div>
            <div>
                <div class="stat-value" id="userRank">–ù–æ–≤–∏—á–æ–∫</div>
                <div>–†–∞–Ω–≥</div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥–ø–∏—Å–∫–∏ -->
    <div id="subscriptionModal" class="subscription-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-crown"></i> –ü—Ä–µ–º–∏—É–º –ø–æ–¥–ø–∏—Å–∫–∞</h2>
                <button class="modal-close" onclick="closeModal('subscriptionModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 20px; color: #81c784;">–†–∞–∑–±–ª–æ–∫–∏—Ä—É–π—Ç–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∏–≥—Ä—ã!</p>
                
                <div class="subscription-plans">
                    <div class="plan-card" onclick="selectPlan('basic')">
                        <h3>–ë–∞–∑–æ–≤—ã–π</h3>
                        <div class="plan-price">–ë–µ—Å–ø–ª–∞—Ç–Ω–æ</div>
                        <ul class="plan-features">
                            <li>‚úì 40 –º–µ—Ç–æ–∫ –Ω–∞ –∫–∞—Ä—Ç–µ</li>
                            <li>‚úì –í—Å–µ —Ç–∏–ø—ã –º–µ—Ç–æ–∫</li>
                            <li>‚úì –õ–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ</li>
                            <li>‚úì –°–∏—Å—Ç–µ–º–∞ —Ä–µ–π—Ç–∏–Ω–≥–∞</li>
                        </ul>
                    </div>
                    
                    <div class="plan-card recommended" onclick="selectPlan('premium')">
                        <h3>–ü—Ä–µ–º–∏—É–º</h3>
                        <div class="plan-price">‚òÖ 99 / –º–µ—Å</div>
                        <ul class="plan-features">
                            <li>‚úì –í—Å–µ –∏–∑ –ë–∞–∑–æ–≤–æ–≥–æ</li>
                            <li>‚úì 100 –º–µ—Ç–æ–∫ –Ω–∞ –∫–∞—Ä—Ç–µ</li>
                            <li>‚úì –ö–∞—Å—Ç–æ–º–Ω—ã–µ —ç–º–æ–¥–∑–∏ —Å—Ç–∞—Ç—É—Å—ã</li>
                            <li>‚úì –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</li>
                            <li>‚úì –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞</li>
                            <li>‚úì –ï–∂–µ–º–µ—Å—è—á–Ω—ã–µ –ø–æ–¥–∞—Ä–∫–∏</li>
                        </ul>
                    </div>
                    
                    <div class="plan-card" onclick="selectPlan('pro')">
                        <h3>Pro</h3>
                        <div class="plan-price">‚òÖ 299 / –º–µ—Å</div>
                        <ul class="plan-features">
                            <li>‚úì –í—Å–µ –∏–∑ –ü—Ä–µ–º–∏—É–º</li>
                            <li>‚úì –ù–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏</li>
                            <li>‚úì –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –≤ PDF</li>
                            <li>‚úì –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –∫–∞—Ä—Ç—ã</li>
                            <li>‚úì –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Ç–∏–ø—ã –º–µ—Ç–æ–∫</li>
                            <li>‚úì –†–∞–Ω–Ω–∏–π –¥–æ—Å—Ç—É–ø –∫ –Ω–æ–≤—ã–º —Ñ—É–Ω–∫—Ü–∏—è–º</li>
                        </ul>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button onclick="purchaseSubscription('premium')" 
                            style="background: linear-gradient(90deg, #FFD700, #FFC107); color: black; border: none; padding: 12px 30px; border-radius: 25px; font-weight: bold; cursor: pointer; margin: 10px;">
                        –ö—É–ø–∏—Ç—å –ü—Ä–µ–º–∏—É–º
                    </button>
                    <p style="color: #aaa; font-size: 0.9rem; margin-top: 15px;">
                        –ü–æ–¥–ø–∏—Å–∫–∞ –ø—Ä–æ–¥–ª–µ–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏. –û—Ç–º–µ–Ω–∏—Ç—å –º–æ–∂–Ω–æ –≤ –ª—é–±–æ–µ –≤—Ä–µ–º—è.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–∞ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω -->
    <div class="add-to-home" id="addToHome">
        <h3 style="color: #4CAF50; margin-bottom: 10px;">–î–æ–±–∞–≤–∏—Ç—å –Ω–∞ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω</h3>
        <p style="color: #81c784; font-size: 0.9rem;">–î–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –¥–æ–±–∞–≤—å—Ç–µ –∏–≥—Ä—É –Ω–∞ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω –≤–∞—à–µ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞.</p>
        <button onclick="addToHomeScreen()">
            <i class="fas fa-plus-circle"></i> –î–æ–±–∞–≤–∏—Ç—å —Å–µ–π—á–∞—Å
        </button>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ -->
    <div class="geolocation-permission" id="geolocationPermission">
        <h3 style="color: #4CAF50; margin-bottom: 10px;">–î–æ—Å—Ç—É–ø –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏</h3>
        <p style="color: #81c784; font-size: 0.9rem;">–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –≤–∞—à–µ–π –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞ –∫–∞—Ä—Ç–µ –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π.</p>
        <div class="geolocation-buttons">
            <button onclick="requestGeolocationPermission()" style="background: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 10px; flex: 1; cursor: pointer;">
                –†–∞–∑—Ä–µ—à–∏—Ç—å
            </button>
            <button onclick="denyGeolocation()" style="background: rgba(255, 255, 255, 0.1); color: white; border: 2px solid rgba(255, 255, 255, 0.3); padding: 10px 20px; border-radius: 10px; flex: 1; cursor: pointer;">
            </button>
        </div>
    </div>

    <!-- –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ -->
    <div class="document-generator" id="documentGenerator">
        <h3 style="color: #4CAF50; margin-bottom: 10px;">–≠–∫—Å–ø–æ—Ä—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</h3>
        <p style="color: #81c784; font-size: 0.9rem;">–°–æ–∑–¥–∞–π—Ç–µ –æ—Ç—á–µ—Ç –æ –≤–∞—à–µ–π –∏–≥—Ä–æ–≤–æ–π —Å–µ—Å—Å–∏–∏.</p>
        <button onclick="generateReport()" style="background: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 10px; width: 100%; margin-top: 10px; cursor: pointer;">
            <i class="fas fa-file-pdf"></i> –°–æ–∑–¥–∞—Ç—å PDF –æ—Ç—á–µ—Ç
        </button>
    </div>

    <script>
        // ============ –ö–û–ù–°–¢–ê–ù–¢–´ –ò–ì–†–´ ============
        const tg = window.Telegram.WebApp;
        const MAX_MARKERS = 40;
        const MARKER_LIFETIME = 3 * 60 * 60 * 1000;
        const MAX_COMMENT_CHARS = 30;
        
        // –¢–∏–ø—ã –º–µ—Ç–æ–∫
        const TOOLS_WITH_COMMENT = ['police', 'accident', 'help'];
        
        // ============ –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ============
        let telegramUser = null;
        let ymap = null;
        
        let markers = {};
        let selectedTool = 'police';
        let points = 100;
        let activity = 0;
        let pendingMarkerData = null;
        
        let currentUserName = '–ì–æ—Å—Ç—å';
        let currentUserStatus = 'üöî';
        let isPremiumUser = false;
        let geolocationEnabled = false;
        let motionEnabled = false;
        
        let autoStartInterval = null;
        let countdownSeconds = 5;
        
        // ============ MINI APPS 2.0 –§–£–ù–ö–¶–ò–ò ============
        
        // 1. FULL-SCREEN MODE
        function enableFullScreen() {
            if (tg.platform !== 'unknown') {
                tg.expand();
                tg.requestFullscreen();
                console.log('Full-screen mode enabled');
            }
        }
        
        // 2. DEVICE MOTION TRACKING
        function initMotionTracking() {
            if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                DeviceMotionEvent.requestPermission()
                    .then(permissionState => {
                        if (permissionState === 'granted') {
                            startMotionTracking();
                        }
                    })
                    .catch(console.error);
            } else {
                startMotionTracking();
            }
        }
        
        function startMotionTracking() {
            window.addEventListener('devicemotion', handleDeviceMotion);
            motionEnabled = true;
            document.getElementById('motionIndicator').style.display = 'flex';
        }
        
        function handleDeviceMotion(event) {
            const acceleration = event.accelerationIncludingGravity;
            document.getElementById('motionX').textContent = acceleration.x.toFixed(2);
            document.getElementById('motionY').textContent = acceleration.y.toFixed(2);
            document.getElementById('motionZ').textContent = acceleration.z.toFixed(2);
            
            // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ motion –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è (–ø—Ä–∏–º–µ—Ä: –Ω–∞–∫–ª–æ–Ω –¥–ª—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –∫–∞—Ä—Ç—ã)
            if (ymap && Math.abs(acceleration.x) > 15) {
                const delta = acceleration.x > 0 ? 0.1 : -0.1;
                const center = ymap.getCenter();
                ymap.setCenter([center[0], center[1] + delta]);
            }
        }
        
        // 3. HOME SCREEN SHORTCUTS
        function showAddToHome() {
            const addToHome = document.getElementById('addToHome');
            addToHome.style.display = 'block';
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã—Ç—å —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥
            setTimeout(() => {
                addToHome.style.display = 'none';
            }, 10000);
        }
        
        function addToHomeScreen() {
            if (window.matchMedia('(display-mode: standalone)').matches) {
                alert('–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –Ω–∞ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω!');
                return;
            }
            
            if (window.navigator.standalone === true) {
                alert('–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –Ω–∞ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω!');
                return;
            }
            
            // –î–ª—è iOS
            if (tg.platform === 'ios') {
                showiOSInstallInstructions();
            }
            // –î–ª—è Android
            else if (tg.platform === 'android') {
                showAndroidInstallInstructions();
            }
            
            document.getElementById('addToHome').style.display = 'none';
        }
        
        function showiOSInstallInstructions() {
            alert('–î–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∞ iOS:\n1. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "–ü–æ–¥–µ–ª–∏—Ç—å—Å—è"\n2. –í—ã–±–µ—Ä–∏—Ç–µ "–ù–∞ —ç–∫—Ä–∞–Ω "–î–æ–º–æ–π"\n3. –ù–∞–∂–º–∏—Ç–µ "–î–æ–±–∞–≤–∏—Ç—å"');
        }
        
        function showAndroidInstallInstructions() {
            alert('–î–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∞ Android:\n1. –ù–∞–∂–º–∏—Ç–µ –º–µ–Ω—é (—Ç—Ä–∏ —Ç–æ—á–∫–∏)\n2. –í—ã–±–µ—Ä–∏—Ç–µ "–î–æ–±–∞–≤–∏—Ç—å –Ω–∞ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω"\n3. –ù–∞–∂–º–∏—Ç–µ "–î–æ–±–∞–≤–∏—Ç—å"');
        }
        
        // 4. GEOLOCATION ACCESS
        function checkGeolocationPermission() {
            if (!geolocationEnabled) {
                setTimeout(() => {
                    document.getElementById('geolocationPermission').style.display = 'block';
                }, 3000);
            }
        }
        
        function requestGeolocationPermission() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    () => {
                        geolocationEnabled = true;
                        document.getElementById('geolocationPermission').style.display = 'none';
                        console.log('Geolocation permission granted');
                        
                        // –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å Premium
                        if (isPremiumUser) {
                            setEmojiStatus('üìç');
                        }
                    },
                    (error) => {
                        console.warn('Geolocation permission denied:', error);
                        document.getElementById('geolocationPermission').style.display = 'none';
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            }
        }
        
        function denyGeolocation() {
            document.getElementById('geolocationPermission').style.display = 'none';
            console.log('Geolocation permission denied by user');
        }
        
        // 5. GIFTS FROM APPS
        function checkForGifts() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ–¥–∞—Ä–∫–æ–≤
            if (points >= 100 && !localStorage.getItem('gift_100_points')) {
                showGiftNotification('100 –æ—á–∫–æ–≤', '–°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –±–µ–π–¥–∂ "–°—Ç—Ä–∞–∂–∏ –ø–æ—Ä—è–¥–∫–∞"');
                localStorage.setItem('gift_100_points', 'true');
            }
            
            if (activity >= 10 && !localStorage.getItem('gift_10_markers')) {
                showGiftNotification('10 –º–µ—Ç–æ–∫', '–≠–∫—Å–∫–ª—é–∑–∏–≤–Ω—ã–π —ç–º–æ–¥–∑–∏ —Å—Ç–∞—Ç—É—Å üö®');
                localStorage.setItem('gift_10_markers', 'true');
            }
        }
        
        function showGiftNotification(achievement, gift) {
            const notification = document.getElementById('giftNotification');
            notification.querySelector('h3').textContent = `–î–æ—Å—Ç–∏–∂–µ–Ω–∏–µ: ${achievement}`;
            notification.querySelector('p').textContent = `–í—ã –ø–æ–ª—É—á–∏–ª–∏: ${gift}`;
            notification.style.display = 'block';
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã—Ç—å —á–µ—Ä–µ–∑ 8 —Å–µ–∫—É–Ω–¥
            setTimeout(() => {
                notification.style.display = 'none';
            }, 8000);
        }
        
        function closeGiftNotification() {
            document.getElementById('giftNotification').style.display = 'none';
        }
        
        // 6. EMOJI STATUSES FROM APPS
        function toggleEmojiPicker() {
            const picker = document.getElementById('emojiPicker');
            picker.style.display = picker.style.display === 'grid' ? 'none' : 'grid';
        }
        
        function setEmojiStatus(emoji) {
            currentUserStatus = emoji;
            document.getElementById('emojiStatus').textContent = emoji;
            document.getElementById('emojiPicker').style.display = 'none';
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
            localStorage.setItem('user_status', emoji);
            
            // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å Premium, –º–æ–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –≤ Telegram
            if (isPremiumUser && tg.setEmojiStatus) {
                try {
                    tg.setEmojiStatus(emoji);
                    console.log('Emoji status updated in Telegram');
                } catch (error) {
                    console.log('Cannot update emoji status:', error);
                }
            }
        }
        
        // 7. MEDIA SHARING
        function shareGameResults() {
            const results = `
üéÆ –ü–æ–ª–∏—Ü–∏—è –ú–∞–π–∞–º–∏ - –ú–æ–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:
üèÜ –û—á–∫–∏: ${points}
üìç –ú–µ—Ç–æ–∫ —Å–æ–∑–¥–∞–Ω–æ: ${activity}
‚≠ê –†–∞–Ω–≥: ${calculateRank().name}
üö® –õ—É—á—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å–µ–≥–æ–¥–Ω—è!
            
–ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Å—è –∫ –∏–≥—Ä–µ!`;
            
            if (tg.shareMessage) {
                tg.shareMessage(results);
            } else if (navigator.share) {
                navigator.share({
                    title: '–ú–æ–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ –ü–æ–ª–∏—Ü–∏—è –ú–∞–π–∞–º–∏',
                    text: results,
                    url: window.location.href
                });
            } else {
                navigator.clipboard.writeText(results).then(() => {
                    alert('–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
                });
            }
        }
        
        // 8. CREATING DOCUMENTS
        function generateReport() {
            const reportContent = `
–û–¢–ß–ï–¢ –û–ë –ò–ì–†–û–í–û–ô –°–ï–°–°–ò–ò
–ò–≥—Ä–∞: –ü–æ–ª–∏—Ü–∏—è –ú–∞–π–∞–º–∏
–ò–≥—Ä–æ–∫: ${currentUserName}
–î–∞—Ç–∞: ${new Date().toLocaleDateString()}
–í—Ä–µ–º—è: ${new Date().toLocaleTimeString()}

–°–¢–ê–¢–ò–°–¢–ò–ö–ê:
‚Ä¢ –í—Å–µ–≥–æ –æ—á–∫–æ–≤: ${points}
‚Ä¢ –ú–µ—Ç–æ–∫ —Å–æ–∑–¥–∞–Ω–æ: ${activity}
‚Ä¢ –¢–µ–∫—É—â–∏–π —Ä–∞–Ω–≥: ${calculateRank().name}
‚Ä¢ –ê–∫—Ç–∏–≤–Ω—ã—Ö –º–µ—Ç–æ–∫: ${Object.values(markers).filter(m => m.isActive).length}

–î–û–°–¢–ò–ñ–ï–ù–ò–Ø:
${points >= 100 ? '‚úì –ù–∞–±—Ä–∞–ª 100 –æ—á–∫–æ–≤\n' : ''}
${activity >= 10 ? '‚úì –°–æ–∑–¥–∞–ª 10 –º–µ—Ç–æ–∫\n' : ''}
${activity >= 50 ? '‚úì –î–æ—Å—Ç–∏–≥ —Ä–∞–Ω–≥–∞ –î–µ—Ç–µ–∫—Ç–∏–≤\n' : ''}

–î–ï–¢–ê–õ–ò –ú–ï–¢–û–ö:
${Object.values(markers)
    .filter(m => m.isActive)
    .map(m => `‚Ä¢ ${getMarkerTypeName(m.type)} - ${m.comment || '–±–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è'}`)
    .join('\n') || '–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –º–µ—Ç–æ–∫'}

–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ –≤ –∏–≥—Ä–µ "–ü–æ–ª–∏—Ü–∏—è –ú–∞–π–∞–º–∏"
            `;
            
            // –°–æ–∑–¥–∞–µ–º Blob –∏ —Å—Å—ã–ª–∫—É –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
            const blob = new Blob([reportContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `police_miami_report_${Date.now()}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('–û—Ç—á–µ—Ç —É—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∏ —Å–∫–∞—á–∞–Ω!');
        }
        
        // 9. SUBSCRIPTION PLANS
        function openSubscriptionModal() {
            document.getElementById('subscriptionModal').style.display = 'flex';
        }
        
        function selectPlan(plan) {
            console.log(`Selected plan: ${plan}`);
            // –ó–¥–µ—Å—å –±—É–¥–µ—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Telegram Stars
        }
        
        function purchaseSubscription(plan) {
            if (tg.openInvoice) {
                // –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Telegram Stars
                const invoice = {
                    title: `–ü—Ä–µ–º–∏—É–º –ø–æ–¥–ø–∏—Å–∫–∞ - ${plan}`,
                    description: '–ï–∂–µ–º–µ—Å—è—á–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –ø—Ä–µ–º–∏—É–º —Ñ—É–Ω–∫—Ü–∏–∏ –∏–≥—Ä—ã',
                    payload: `subscription_${plan}_${Date.now()}`,
                    currency: 'XTR',
                    prices: plan === 'premium' ? [{ label: 'Premium', amount: 9900 }] : 
                            plan === 'pro' ? [{ label: 'Pro', amount: 29900 }] : []
                };
                
                tg.openInvoice(invoice, (status) => {
                    if (status === 'paid') {
                        isPremiumUser = true;
                        alert('–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã —Å—Ç–∞–ª–∏ –ø—Ä–µ–º–∏—É–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º!');
                        closeModal('subscriptionModal');
                        
                        // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –ø—Ä–µ–º–∏—É–º —Ñ—É–Ω–∫—Ü–∏–∏
                        MAX_MARKERS = plan === 'premium' ? 100 : Infinity;
                        updateMarkerCount();
                    }
                });
            } else {
                alert('–ü–æ–∫—É–ø–∫–∏ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
            }
        }
        
        // 10. LOADING SCREEN CUSTOMIZATION
        function showCustomLoadingScreen() {
            const loadingScreen = document.getElementById('loadingScreen');
            loadingScreen.style.display = 'flex';
            
            // –ò–º–∏—Ç–∞—Ü–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∑–∞–≥—Ä—É–∑–∫–∏
            let progress = 0;
            const interval = setInterval(() => {
                progress += Math.random() * 20;
                if (progress > 100) progress = 100;
                
                document.getElementById('loadingProgress').style.width = `${progress}%`;
                
                if (progress >= 100) {
                    clearInterval(interval);
                    setTimeout(() => {
                        loadingScreen.style.opacity = '0';
                        setTimeout(() => {
                            loadingScreen.style.display = 'none';
                        }, 500);
                    }, 500);
                }
            }, 100);
        }
        
        // 11. DEVICE HARDWARE INFO
        function getDeviceInfo() {
            const info = {
                cores: navigator.hardwareConcurrency || 'unknown',
                memory: navigator.deviceMemory || 'unknown',
                platform: navigator.platform,
                userAgent: navigator.userAgent
            };
            
            document.getElementById('cpuInfo').textContent = info.cores + ' —è–¥–µ—Ä';
            document.getElementById('ramInfo').textContent = info.memory + ' GB';
            document.getElementById('gpuInfo').textContent = getGPUInfo();
            
            // –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é —Ç–æ–ª—å–∫–æ –≤ development —Ä–µ–∂–∏–º–µ
            if (localStorage.getItem('show_device_info') === 'true') {
                document.getElementById('deviceInfo').style.display = 'block';
            }
        }
        
        function getGPUInfo() {
            const canvas = document.createElement('canvas');
            const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
            if (gl) {
                const debugInfo = gl.getExtension('WEBGL_debug_renderer_info');
                if (debugInfo) {
                    return gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL).split('/')[0];
                }
            }
            return 'WebGL –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è';
        }
        
        // 12. APP VISIBILITY TRACKING
        function initVisibilityTracking() {
            document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    console.log('App minimized');
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏ —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–∏
                    saveLocalMarkers();
                } else {
                    console.log('App restored');
                    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏ —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–∏
                    if (ymap) {
                        displayLocalMarkers();
                    }
                }
            });
        }
        
        // ============ –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø TELEGRAM ============
        function initTelegram() {
            console.log('Initializing Telegram Web App 2.0...');
            
            const version = parseFloat(tg.version) || 6.0;
            console.log('Telegram WebApp version:', version);
            
            // –í–∫–ª—é—á–∞–µ–º full-screen mode
            enableFullScreen();
            
            telegramUser = tg.initDataUnsafe?.user;
            
            if (telegramUser) {
                currentUserName = telegramUser.first_name || telegramUser.username || '–ò–≥—Ä–æ–∫';
                document.getElementById('userWelcome').textContent = `–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${currentUserName}!`;
                document.getElementById('modalPlayerName').textContent = currentUserName;
            } else {
                currentUserName = '–ì–æ—Å—Ç—å_' + Math.random().toString(36).substr(2, 6);
                document.getElementById('userWelcome').textContent = '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –∏–≥—Ä—É!';
                document.getElementById('modalPlayerName').textContent = currentUserName;
            }
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π —Å—Ç–∞—Ç—É—Å
            const savedStatus = localStorage.getItem('user_status');
            if (savedStatus) {
                setEmojiStatus(savedStatus);
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞—Å—Ç–æ–º–Ω—ã–π —ç–∫—Ä–∞–Ω –∑–∞–≥—Ä—É–∑–∫–∏
            showCustomLoadingScreen();
            
            // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ
            getDeviceInfo();
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –≤–∏–¥–∏–º–æ—Å—Ç–∏
            initVisibilityTracking();
            
            startAutoStartTimer();
            loadLocalMarkers();
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∞—Ä–∫–∏
            setTimeout(checkForGifts, 2000);
        }
        
        // ============ –û–°–¢–ê–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò –ò–ì–†–´ ============
        // (–û—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ –æ—Å—Ç–∞–µ—Ç—Å—è —Ç–∞–∫–∏–º –∂–µ –∫–∞–∫ –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏, –≤–∫–ª—é—á–∞—è:
        // - –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–µ—Ç–æ–∫
        // - –†–∞–±–æ—Ç—É —Å –∫–∞—Ä—Ç–æ–π
        // - –°–∏—Å—Ç–µ–º—É —Ä–µ–π—Ç–∏–Ω–≥–∞
        // - –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ –∏ —Ç.–¥.)
        
        function startAutoStartTimer() {
            const countdownElement = document.getElementById('countdown');
            countdownElement.textContent = countdownSeconds;
            
            autoStartInterval = setInterval(() => {
                countdownSeconds--;
                countdownElement.textContent = countdownSeconds;
                
                if (countdownSeconds <= 0) {
                    clearInterval(autoStartInterval);
                    if (document.getElementById('splashScreen').style.display !== 'none') {
                        startGame();
                    }
                }
            }, 1000);
        }
        
        function skipIntro() {
            clearInterval(autoStartInterval);
            transitionToGame();
        }
        
        function startGame() {
            clearInterval(autoStartInterval);
            transitionToGame();
        }
        
        function transitionToGame() {
            const splash = document.getElementById('splashScreen');
            const mainApp = document.getElementById('mainApp');
            
            splash.style.opacity = '0';
            splash.style.transition = 'opacity 0.5s ease';
            
            setTimeout(() => {
                splash.style.display = 'none';
                mainApp.classList.add('active');
                initGame();
            }, 500);
        }
        
        function initGame() {
            console.log('üöî –ó–∞–ø—É—Å–∫ –∏–≥—Ä—ã —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π Mini Apps 2.0...');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é
            checkGeolocationPermission();
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º motion tracking
            initMotionTracking();
            
            if (window.ymaps) {
                ymaps.ready(initMap);
            } else {
                document.getElementById('loading').innerHTML = `
                    <i class="fas fa-exclamation-triangle" style="font-size: 2.5rem; margin-bottom: 20px; color: #f44336;"></i>
                    <p style="color: #f44336; font-size: 1.1rem;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç</p>
                `;
            }
        }
        
        // ============ –õ–û–ö–ê–õ–¨–ù–û–ï –•–†–ê–ù–ï–ù–ò–ï –ú–ï–¢–û–ö ============
        function loadLocalMarkers() {
            try {
                const savedMarkers = localStorage.getItem('miami_police_markers');
                if (savedMarkers) {
                    markers = JSON.parse(savedMarkers);
                    console.log(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${Object.keys(markers).length} –º–µ—Ç–æ–∫ –∏–∑ localStorage`);
                    updateMarkerCount();
                    updateUI();
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ—Ç–æ–∫:', error);
                markers = {};
            }
        }
        
        function saveLocalMarkers() {
            try {
                localStorage.setItem('miami_police_markers', JSON.stringify(markers));
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –º–µ—Ç–æ–∫:', error);
            }
        }
        
        // ============ –ö–ê–†–¢–ê –ò –ì–ï–û–õ–û–ö–ê–¶–ò–Ø ============
        function initMap() {
            try {
                let center = [55.459619, 38.438920];
                let zoom = 15;
                let useGeolocation = false;
                
                if (navigator.geolocation && geolocationEnabled) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            center = [position.coords.latitude, position.coords.longitude];
                            zoom = 17;
                            useGeolocation = true;
                            createMap(center, zoom, useGeolocation);
                        },
                        (error) => {
                            console.warn('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞:', error);
                            createMap(center, zoom, useGeolocation);
                        },
                        {
                            enableHighAccuracy: true,
                            timeout: 10000,
                            maximumAge: 60000
                        }
                    );
                } else {
                    createMap(center, zoom, useGeolocation);
                }
                
                function createMap(centerCoords, zoomLevel, hasGeolocation) {
                    ymap = new ymaps.Map('yandex-map', {
                        center: centerCoords,
                        zoom: zoomLevel,
                        controls: ['zoomControl', 'fullscreenControl', 'typeSelector']
                    });
                    
                    if (hasGeolocation) {
                        const geolocationControl = new ymaps.control.GeolocationControl({
                            options: {
                                noPlacemark: false,
                                position: { right: 10, top: 80 }
                            }
                        });
                        ymap.controls.add(geolocationControl);
                    }
                    
                    document.getElementById('loading').style.display = 'none';
                    displayLocalMarkers();
                    
                    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–æ–≤ –ø–æ –∫–∞—Ä—Ç–µ
                    ymap.events.add('click', (e) => {
                        const coords = e.get('coords');
                        
                        if (selectedTool === 'clear') {
                            let closestMarker = null;
                            let minDistance = Infinity;
                            
                            Object.entries(markers).forEach(([id, marker]) => {
                                if (marker.isActive) {
                                    const distance = Math.sqrt(
                                        Math.pow(marker.coords.lat - coords[0], 2) + 
                                        Math.pow(marker.coords.lng - coords[1], 2)
                                    ) * 111000;
                                    
                                    if (distance < 50 && distance < minDistance) {
                                        minDistance = distance;
                                        closestMarker = { id, marker };
                                    }
                                }
                            });
                            
                            if (closestMarker) {
                                deleteMarker(closestMarker.id);
                            } else {
                                alert('‚ùå –ù–µ—Ç –º–µ—Ç–æ–∫ —Ä—è–¥–æ–º –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è');
                            }
                        } else {
                            pendingMarkerData = { coords, type: selectedTool };
                            
                            if (selectedTool === 'hazard') {
                                addMarker(pendingMarkerData.coords, pendingMarkerData.type, null);
                            } else {
                                openCommentModal();
                            }
                        }
                    });
                }
                
                updateUI();
                cleanupOldMarkers();
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∫–∞—Ä—Ç—ã:', error);
                document.getElementById('loading').innerHTML = `
                    <i class="fas fa-exclamation-triangle" style="font-size: 2.5rem; margin-bottom: 20px; color: #f44336;"></i>
                    <p style="color: #f44336; font-size: 1.1rem;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç—ã</p>
                    <button onclick="location.reload()" 
                            style="background: #2196f3; color: white; border: none; padding: 10px 20px; border-radius: 10px; margin-top: 20px; cursor: pointer;">
                        –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å
                    </button>
                `;
            }
        }
        
        function displayLocalMarkers() {
            if (!ymap) return;
            
            ymap.geoObjects.removeAll();
            
            Object.entries(markers).forEach(([markerId, markerData]) => {
                if (markerData.isActive) {
                    addLocalMarkerToMap(markerId, markerData);
                }
            });
        }
        
        function addLocalMarkerToMap(markerId, markerData) {
            if (!ymap) return;
            
            const iconColor = {
                'police': '#2196F3',
                'accident': '#F44336',
                'help': '#4CAF50',
                'hazard': '#FF9800'
            }[markerData.type] || '#2196F3';
            
            const iconContent = {
                'police': 'üö®',
                'accident': 'üöó',
                'help': 'üÜò',
                'hazard': 'üö¶'
            }[markerData.type] || 'üìç';
            
            const placemark = new ymaps.Placemark(
                [markerData.coords.lat, markerData.coords.lng],
                {
                    balloonContent: `
                        <div style="padding: 10px; max-width: 250px;">
                            <h3 style="margin: 0 0 10px 0; color: ${iconColor}">
                                ${getMarkerTypeName(markerData.type)}
                            </h3>
                            ${markerData.comment ? `<p><strong>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</strong> ${markerData.comment}</p>` : ''}
                            <p><strong>–ê–≤—Ç–æ—Ä:</strong> ${markerData.author}</p>
                            <p><strong>–î–æ–±–∞–≤–ª–µ–Ω–æ:</strong> ${new Date(markerData.timestamp).toLocaleTimeString()}</p>
                            <p><strong>–£–¥–∞–ª–∏—Ç—Å—è —á–µ—Ä–µ–∑:</strong> ${formatTimeRemaining(markerData.expiresAt)}</p>
                            <button onclick="deleteMarker('${markerId}')" 
                                    style="background: #f44336; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; margin-top: 10px;">
                                –£–¥–∞–ª–∏—Ç—å –º–µ—Ç–∫—É
                            </button>
                        </div>
                    `,
                    iconCaption: markerData.comment || ''
                },
                {
                    preset: 'islands#icon',
                    iconColor: iconColor,
                    iconLayout: 'default#imageWithContent',
                    iconImageHref: '',
                    iconImageSize: [50, 50],
                    iconImageOffset: [-25, -50],
                    iconContentOffset: [0, 0],
                    iconContentLayout: ymaps.templateLayoutFactory.createClass(
                        `<div style="width: 50px; height: 50px; border-radius: 50%; background: ${iconColor}; display: flex; align-items: center; justify-content: center; font-size: 20px; position: relative;">
                            ${iconContent}
                            <button onclick="deleteMarker('${markerId}')" 
                                    style="position: absolute; top: -5px; right: -5px; background: #f44336; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                                √ó
                            </button>
                        </div>`
                    )
                }
            );
            
            placemark.events.add('click', function() {
                placemark.balloon.open();
            });
            
            markerData.placemark = placemark;
            ymap.geoObjects.add(placemark);
        }
        
        function addMarker(coords, type, comment = null) {
            const activeMarkersCount = Object.values(markers).filter(m => m.isActive).length;
            const maxMarkers = isPremiumUser ? 100 : MAX_MARKERS;
            
            if (activeMarkersCount >= maxMarkers) {
                alert(`‚ùå –î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç –≤ ${maxMarkers} –º–µ—Ç–æ–∫ –Ω–∞ –∫–∞—Ä—Ç–µ!`);
                if (!isPremiumUser) {
                    openSubscriptionModal();
                }
                return null;
            }
            
            const markerId = 'marker_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            const timestamp = Date.now();
            
            const markerData = {
                type: type,
                coords: {
                    lat: coords[0],
                    lng: coords[1]
                },
                comment: comment || '',
                author: currentUserName,
                timestamp: timestamp,
                isActive: true,
                expiresAt: timestamp + MARKER_LIFETIME
            };
            
            markers[markerId] = markerData;
            addLocalMarkerToMap(markerId, markerData);
            saveLocalMarkers();
            
            console.log('‚úÖ –ú–µ—Ç–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞');
            
            points += 10;
            activity += 1;
            updateUI();
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∞—Ä–∫–∏
            checkForGifts();
            
            return markerId;
        }
        
        function deleteMarker(markerId) {
            if (!markers[markerId]) {
                console.error('–ú–µ—Ç–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞:', markerId);
                alert('–ú–µ—Ç–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –∏–ª–∏ —É–∂–µ —É–¥–∞–ª–µ–Ω–∞');
                return;
            }
            
            const marker = markers[markerId];
            
            if (marker.placemark && ymap) {
                ymap.geoObjects.remove(marker.placemark);
            }
            
            markers[markerId].isActive = false;
            saveLocalMarkers();
            
            console.log('‚úÖ –ú–µ—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–∞');
            
            points += 5;
            updateUI();
        }
        
        // ============ –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ============
        function getMarkerTypeName(type) {
            const names = {
                'police': '–ü–∞—Ç—Ä—É–ª—å üö®',
                'accident': '–î–¢–ü üöó',
                'help': '–ü–æ–º–æ—â—å üÜò',
                'hazard': '–ü—Ä–æ–±–∫–∞ üö¶'
            };
            return names[type] || '–ú–µ—Ç–∫–∞';
        }
        
        function formatTimeRemaining(expiresAt) {
            const remaining = expiresAt - Date.now();
            const hours = Math.floor(remaining / (1000 * 60 * 60));
            const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
            
            if (hours > 0) {
                return `${hours} —á ${minutes} –º–∏–Ω`;
            } else {
                return `${minutes} –º–∏–Ω—É—Ç`;
            }
        }
        
        function updateMarkerCount() {
            const activeMarkersCount = Object.values(markers).filter(m => m.isActive).length;
            const maxMarkers = isPremiumUser ? 100 : MAX_MARKERS;
            
            document.getElementById('markerCount').textContent = activeMarkersCount;
            document.getElementById('maxMarkers').textContent = maxMarkers;
            
            const limitElement = document.getElementById('markerLimit');
            if (activeMarkersCount >= maxMarkers * 0.9) {
                limitElement.style.display = 'block';
                limitElement.innerHTML = `üî¥ –õ–∏–º–∏—Ç: ${activeMarkersCount}/${maxMarkers} –º–µ—Ç–æ–∫`;
            } else {
                limitElement.style.display = 'none';
            }
        }
        
        function updateUI() {
            updateMarkerCount();
            document.getElementById('points').textContent = points;
            document.getElementById('activity').textContent = activity;
            
            const rank = calculateRank();
            document.getElementById('userRank').textContent = rank.name;
            document.getElementById('rankPoints').textContent = rank.progress + '%';
            
            document.getElementById('modalPlayerPoints').textContent = points;
            document.getElementById('modalPlayerMarkers').textContent = activity;
            document.getElementById('modalPlayerRank').textContent = rank.name;
        }
        
        function calculateRank() {
            if (activity >= 100) return { name: '–ö–æ–º–∏—Å—Å–∞—Ä', progress: 100 };
            if (activity >= 50) return { name: '–î–µ—Ç–µ–∫—Ç–∏–≤', progress: Math.min(100, (activity - 50) * 2) };
            if (activity >= 20) return { name: '–°–µ—Ä–∂–∞–Ω—Ç', progress: Math.min(100, (activity - 20) * 3.33) };
            if (activity >= 5) return { name: '–ü–∞—Ç—Ä—É–ª—å–Ω—ã–π', progress: Math.min(100, (activity - 5) * 6.67) };
            return { name: '–ù–æ–≤–∏—á–æ–∫', progress: Math.min(100, activity * 20) };
        }
        
        function selectTool(tool) {
            selectedTool = tool;
            document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
            event.target.closest('.tool-btn').classList.add('active');
        }
        
        function cleanupOldMarkers() {
            const now = Date.now();
            let removedCount = 0;
            
            Object.entries(markers).forEach(([markerId, markerData]) => {
                if (markerData.isActive && now - markerData.timestamp > MARKER_LIFETIME) {
                    if (markerData.placemark && ymap) {
                        ymap.geoObjects.remove(markerData.placemark);
                    }
                    markers[markerId].isActive = false;
                    removedCount++;
                }
            });
            
            if (removedCount > 0) {
                saveLocalMarkers();
                updateMarkerCount();
                console.log(`–ê–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞: —É–¥–∞–ª–µ–Ω–æ ${removedCount} —Å—Ç–∞—Ä—ã—Ö –º–µ—Ç–æ–∫`);
            }
            
            setTimeout(cleanupOldMarkers, 5 * 60 * 1000);
        }
        
        // ============ –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê ============
        function openRulesModal() {
            document.getElementById('rulesModal').style.display = 'flex';
            document.getElementById('rulesMaxMarkers').textContent = isPremiumUser ? '100' : '40';
        }
        
        function openPlayersModal() {
            document.getElementById('playersModal').style.display = 'flex';
        }
        
        function openControlsModal() {
            document.getElementById('controlsModal').style.display = 'flex';
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        function openCommentModal() {
            document.getElementById('commentText').value = '';
            document.getElementById('commentChars').textContent = '0/30';
            document.getElementById('commentChars').className = 'comment-chars';
            document.getElementById('addWithCommentBtn').disabled = false;
            document.getElementById('commentModal').style.display = 'flex';
        }
        
        function closeCommentModal() {
            document.getElementById('commentModal').style.display = 'none';
            pendingMarkerData = null;
        }
        
        function addMarkerWithComment() {
            if (pendingMarkerData) {
                const comment = document.getElementById('commentText').value.trim();
                if (comment.length > MAX_COMMENT_CHARS) {
                    alert(`–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π! –ú–∞–∫—Å–∏–º—É–º ${MAX_COMMENT_CHARS} —Å–∏–º–≤–æ–ª–æ–≤.`);
                    return;
                }
                addMarker(pendingMarkerData.coords, pendingMarkerData.type, comment || null);
                closeCommentModal();
            }
        }
        
        function addMarkerWithoutComment() {
            if (pendingMarkerData) {
                addMarker(pendingMarkerData.coords, pendingMarkerData.type, null);
                closeCommentModal();
            }
        }
        
        // ============ –ó–ê–ü–£–°–ö –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ============
        document.addEventListener('DOMContentLoaded', function() {
            initTelegram();
            
            // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ
            document.addEventListener('click', function(event) {
                const modals = ['rulesModal', 'playersModal', 'controlsModal', 'commentModal', 'subscriptionModal'];
                modals.forEach(modalId => {
                    const modal = document.getElementById(modalId);
                    if (event.target === modal) {
                        if (modalId === 'commentModal') {
                            closeCommentModal();
                        } else {
                            closeModal(modalId);
                        }
                    }
                });
                
                // –ó–∞–∫—Ä—ã—Ç–∏–µ emoji picker
                const emojiPicker = document.getElementById('emojiPicker');
                const emojiStatus = document.getElementById('emojiStatus');
                if (emojiPicker.style.display === 'grid' && 
                    !emojiPicker.contains(event.target) && 
                    !emojiStatus.contains(event.target)) {
                    emojiPicker.style.display = 'none';
                }
            });
            
            // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Ä–∞—Å—Ç—è–≥–∏–≤–∞–Ω–∏–µ –æ–∫–Ω–∞
            document.addEventListener('touchmove', function(e) {
                if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
                    e.preventDefault();
                }
            }, { passive: false });
            
            // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ
            document.addEventListener('gesturestart', function(e) {
                e.preventDefault();
            });
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã—Ç–∏–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            window.addEventListener('beforeunload', function() {
                saveLocalMarkers();
            });
        });
        
        // –≠–∫—Å–ø–æ—Ä—Ç —Ñ—É–Ω–∫—Ü–∏–π –¥–ª—è –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
        window.startGame = startGame;
        window.skipIntro = skipIntro;
        window.selectTool = selectTool;
        window.openRulesModal = openRulesModal;
        window.openPlayersModal = openPlayersModal;
        window.openControlsModal = openControlsModal;
        window.openSubscriptionModal = openSubscriptionModal;
        window.closeModal = closeModal;
        window.deleteMarker = deleteMarker;
        window.openCommentModal = openCommentModal;
        window.closeCommentModal = closeCommentModal;
        window.addMarkerWithComment = addMarkerWithComment;
        window.addMarkerWithoutComment = addMarkerWithoutComment;
        window.updateCommentChars = updateCommentChars;
        window.setEmojiStatus = setEmojiStatus;
        window.toggleEmojiPicker = toggleEmojiPicker;
        window.shareGameResults = shareGameResults;
        window.generateReport = generateReport;
        window.showAddToHome = showAddToHome;
        window.addToHomeScreen = addToHomeScreen;
        window.requestGeolocationPermission = requestGeolocationPermission;
        window.denyGeolocation = denyGeolocation;
        window.closeGiftNotification = closeGiftNotification;
    </script>
</body>
</html>
