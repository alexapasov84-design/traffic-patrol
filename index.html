<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üö® Traffic Patrol - –†–µ–∞–ª—å–Ω–∞—è –∫–∞—Ä—Ç–∞ –î–¢–ü –∏ –ü–∞—Ç—Ä—É–ª–µ–π</title>
    
    <!-- Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- –ò–∫–æ–Ω–∫–∏ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç—ã API —Å –≤–∞—à–∏–º –∫–ª—é—á–æ–º -->
    <script src="https://api-maps.yandex.ru/2.1/?apikey=365e247d-d853-4425-b9cc-13bfa1169a49&lang=ru_RU" type="text/javascript"></script>
    
    <style>
        /* –°–±—Ä–æ—Å –∏ –±–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            touch-action: manipulation;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #1a237e 0%, #311b92 100%);
            color: white;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            position: fixed;
        }
        
        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è */
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100vw;
        }
        
        /* –•–µ–¥–µ—Ä */
        .app-header {
            background: rgba(13, 27, 42, 0.95);
            padding: 12px 16px;
            border-bottom: 3px solid #2196f3;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(10px);
            flex-shrink: 0;
            z-index: 1000;
        }
        
        .header-left h1 {
            color: #4fc3f7;
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .header-left h1 i {
            animation: pulse 2s infinite;
        }
        
        .online-stats {
            font-size: 0.85rem;
            color: #81c784;
            margin-top: 4px;
            display: flex;
            gap: 15px;
        }
        
        .user-info {
            text-align: right;
        }
        
        .user-name {
            font-weight: 600;
            font-size: 1.1rem;
            color: #bb86fc;
        }
        
        .user-rank {
            background: rgba(33, 150, 243, 0.2);
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            margin-top: 4px;
            border: 1px solid #2196f3;
            display: inline-block;
        }
        
        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∫–∞—Ä—Ç—ã */
        .map-container {
            flex: 1;
            position: relative;
            margin: 10px;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 3px solid #2196f3;
            background: #0d47a1;
            min-height: 0;
        }
        
        #yandexMap {
            width: 100%;
            height: 100%;
        }
        
        /* –ó–∞–≥—Ä—É–∑–æ—á–Ω—ã–π —ç–∫—Ä–∞–Ω */
        .map-loading {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(13, 27, 42, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 500;
            backdrop-filter: blur(10px);
        }
        
        .map-loading i {
            font-size: 3rem;
            color: #4fc3f7;
            margin-bottom: 20px;
            animation: spin 2s linear infinite;
        }
        
        .map-loading p {
            font-size: 1.2rem;
            margin-bottom: 10px;
        }
        
        .map-loading small {
            color: #81c784;
            font-size: 0.9rem;
        }
        
        /* –ü–∞–Ω–µ–ª—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ */
        .toolbar {
            display: flex;
            gap: 8px;
            padding: 12px;
            background: rgba(13, 27, 42, 0.95);
            border-top: 2px solid #2196f3;
            flex-shrink: 0;
            overflow-x: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
            backdrop-filter: blur(10px);
        }
        
        .toolbar::-webkit-scrollbar {
            display: none;
        }
        
        .tool-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            padding: 10px 12px;
            background: rgba(255, 255, 255, 0.08);
            border: 2px solid transparent;
            border-radius: 12px;
            color: white;
            cursor: pointer;
            min-width: 75px;
            transition: all 0.25s ease;
            flex-shrink: 0;
        }
        
        .tool-btn:hover {
            background: rgba(255, 255, 255, 0.12);
            transform: translateY(-2px);
        }
        
        .tool-btn.active {
            background: rgba(33, 150, 243, 0.25);
            border-color: #2196f3;
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(33, 150, 243, 0.4);
        }
        
        .tool-btn i {
            font-size: 1.4rem;
        }
        
        .tool-btn span {
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        /* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */
        .stats {
            display: flex;
            justify-content: space-around;
            padding: 10px 12px;
            background: rgba(0, 0, 0, 0.4);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            flex-shrink: 0;
            font-size: 0.85rem;
        }
        
        .stat-item {
            text-align: center;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .stat-value {
            font-size: 1.3rem;
            font-weight: 700;
            color: #4fc3f7;
        }
        
        .stat-label {
            opacity: 0.85;
            font-size: 0.75rem;
        }
        
        /* –ß–∞—Ç */
        .chat-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            z-index: 2000;
            display: none;
            align-items: flex-end;
            padding: 0;
        }
        
        .chat-modal {
            background: linear-gradient(135deg, #1a237e 0%, #311b92 100%);
            width: 100%;
            max-height: 70vh;
            border-radius: 24px 24px 0 0;
            display: flex;
            flex-direction: column;
            box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.5);
            border-top: 3px solid #2196f3;
        }
        
        .chat-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chat-header h3 {
            color: #4fc3f7;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .close-chat {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.2s;
        }
        
        .close-chat:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .message {
            padding: 12px 16px;
            border-radius: 12px;
            max-width: 85%;
            word-wrap: break-word;
        }
        
        .message.system {
            background: rgba(33, 150, 243, 0.15);
            border-left: 4px solid #2196f3;
            align-self: center;
            max-width: 90%;
        }
        
        .message.user {
            background: rgba(76, 175, 80, 0.15);
            border-left: 4px solid #4caf50;
            align-self: flex-end;
        }
        
        .message.other {
            background: rgba(255, 152, 0, 0.15);
            border-left: 4px solid #ff9800;
            align-self: flex-start;
        }
        
        .message-sender {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 4px;
            color: #bb86fc;
        }
        
        .message-text {
            font-size: 0.95rem;
            line-height: 1.4;
        }
        
        .message-time {
            font-size: 0.7rem;
            opacity: 0.7;
            margin-top: 4px;
            text-align: right;
        }
        
        .chat-input {
            padding: 15px 20px;
            display: flex;
            gap: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .chat-input input {
            flex: 1;
            padding: 12px 18px;
            border: 2px solid #2196f3;
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 0.95rem;
            outline: none;
        }
        
        .chat-input input:focus {
            background: rgba(255, 255, 255, 0.15);
        }
        
        .chat-input input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }
        
        .send-btn {
            background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
            border: none;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            font-size: 1.1rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .send-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.4);
        }
        
        /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            z-index: 3000;
            animation: slideIn 0.3s ease-out;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            gap: 12px;
            max-width: 320px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .notification.error {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
        }
        
        .notification.warning {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
        }
        
        .notification.info {
            background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-30px) translateX(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0) translateX(0);
            }
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        
        /* –ü–æ–¥—Å–∫–∞–∑–∫–∞ */
        .hint-box {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(13, 27, 42, 0.85);
            padding: 12px 16px;
            border-radius: 12px;
            font-size: 0.85rem;
            border-left: 4px solid #4fc3f7;
            max-width: 260px;
            backdrop-filter: blur(10px);
            z-index: 50;
        }
        
        .hint-box i {
            color: #4fc3f7;
            margin-right: 8px;
        }
        
        /* –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã */
        .coords-box {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(13, 27, 42, 0.85);
            padding: 10px 15px;
            border-radius: 12px;
            font-size: 0.8rem;
            backdrop-filter: blur(10px);
            z-index: 50;
            text-align: center;
        }
        
        .coords-box .coord-value {
            color: #4fc3f7;
            font-weight: 600;
        }
        
        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 768px) {
            .app-header {
                padding: 10px 14px;
            }
            
            .header-left h1 {
                font-size: 1.2rem;
            }
            
            .map-container {
                margin: 8px;
                border-width: 2px;
                border-radius: 14px;
            }
            
            .toolbar {
                padding: 10px;
                gap: 6px;
            }
            
            .tool-btn {
                min-width: 70px;
                padding: 8px 10px;
            }
            
            .tool-btn i {
                font-size: 1.2rem;
            }
            
            .tool-btn span {
                font-size: 0.75rem;
            }
            
            .stats {
                padding: 8px 10px;
            }
            
            .stat-value {
                font-size: 1.2rem;
            }
            
            .hint-box, .coords-box {
                bottom: 15px;
                left: 15px;
                font-size: 0.8rem;
                max-width: 220px;
            }
            
            .coords-box {
                top: 15px;
                right: 15px;
            }
        }
        
        @media (max-width: 480px) {
            .toolbar {
                gap: 4px;
            }
            
            .tool-btn {
                min-width: 65px;
                padding: 6px 8px;
            }
            
            .online-stats {
                font-size: 0.75rem;
                gap: 10px;
            }
            
            .coords-box {
                display: none;
            }
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –º–µ—Ç–æ–∫ –Ø–Ω–¥–µ–∫—Å */
        .ymaps-2-1-79-balloon__content {
            background: rgba(13, 27, 42, 0.95) !important;
            color: white !important;
            border-radius: 10px !important;
            padding: 15px !important;
            font-family: inherit !important;
            backdrop-filter: blur(10px) !important;
        }
        
        .ymaps-2-1-79-balloon__tail {
            background: rgba(13, 27, 42, 0.95) !important;
        }
        
        .ymaps-2-1-79-balloon__close-button {
            background: #2196f3 !important;
            border-radius: 50% !important;
        }
        
        /* –ö–∞—Å—Ç–æ–º–Ω—ã–µ –∏–∫–æ–Ω–∫–∏ –º–µ—Ç–æ–∫ */
        .custom-marker {
            cursor: move !important;
        }
        
        .custom-marker:hover {
            filter: brightness(1.2);
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- –•–µ–¥–µ—Ä -->
        <header class="app-header">
            <div class="header-left">
                <h1><i class="fas fa-traffic-light"></i> Traffic Patrol</h1>
                <div class="online-stats">
                    <span><i class="fas fa-users"></i> –û–Ω–ª–∞–π–Ω: <span id="onlineCount">1</span></span>
                    <span><i class="fas fa-map-marker-alt"></i> –ú–µ—Ç–æ–∫: <span id="markerCount">0</span></span>
                </div>
            </div>
            <div class="user-info">
                <div class="user-name" id="userName">–ò–≥—Ä–æ–∫</div>
                <div class="user-rank" id="userRank">–ù–æ–≤–∏—á–æ–∫ üö¶</div>
            </div>
        </header>

        <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç—ã -->
        <div class="map-container">
            <div id="yandexMap"></div>
            
            <!-- –≠–∫—Ä–∞–Ω –∑–∞–≥—Ä—É–∑–∫–∏ -->
            <div class="map-loading" id="mapLoading">
                <i class="fas fa-sync fa-spin"></i>
                <p>–ó–∞–≥—Ä—É–∑–∫–∞ –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç...</p>
                <small id="mapStatus">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ API...</small>
                <small>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: 55.459619, 38.438920</small>
            </div>
            
            <!-- –ü–æ–¥—Å–∫–∞–∑–∫–∞ -->
            <div class="hint-box" id="hintBox">
                <i class="fas fa-lightbulb"></i>
                <span id="hintText">–í—ã–±–µ—Ä–∏—Ç–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –∏ –∫–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É</span>
            </div>
            
            <!-- –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã -->
            <div class="coords-box" id="coordsBox">
                <div>–¶–µ–Ω—Ç—Ä –∫–∞—Ä—Ç—ã:</div>
                <div class="coord-value">55.459619, 38.438920</div>
            </div>
        </div>

        <!-- –ü–∞–Ω–µ–ª—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ -->
        <div class="toolbar">
            <button class="tool-btn active" onclick="Game.selectTool('police')" id="toolPolice">
                <i class="fas fa-car"></i>
                <span>–ü–∞—Ç—Ä—É–ª—å</span>
            </button>
            
            <button class="tool-btn" onclick="Game.selectTool('accident')" id="toolAccident">
                <i class="fas fa-car-crash"></i>
                <span>–î–¢–ü</span>
            </button>
            
            <button class="tool-btn" onclick="Game.selectTool('hazard')" id="toolHazard">
                <i class="fas fa-exclamation-triangle"></i>
                <span>–û–ø–∞—Å–Ω–æ—Å—Ç—å</span>
            </button>
            
            <button class="tool-btn" onclick="Game.selectTool('clear')" id="toolClear">
                <i class="fas fa-trash-alt"></i>
                <span>–£–¥–∞–ª–∏—Ç—å</span>
            </button>
            
            <button class="tool-btn" onclick="Game.showChat()" id="toolChat">
                <i class="fas fa-comments"></i>
                <span>–ß–∞—Ç</span>
            </button>
            
            <button class="tool-btn" onclick="Game.centerToUser()" id="toolLocation">
                <i class="fas fa-location-arrow"></i>
                <span>–ú–æ—ë –º–µ—Å—Ç–æ</span>
            </button>
        </div>

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="stats">
            <div class="stat-item">
                <span class="stat-value" id="statPoints">100</span>
                <span class="stat-label">–û—á–∫–∏</span>
            </div>
            <div class="stat-item">
                <span class="stat-value" id="statActivity">0</span>
                <span class="stat-label">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</span>
            </div>
            <div class="stat-item">
                <span class="stat-value" id="statProgress">100%</span>
                <span class="stat-label">–ü—Ä–æ–≥—Ä–µ—Å—Å</span>
            </div>
        </div>

        <!-- –ß–∞—Ç (—Å–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
        <div class="chat-overlay" id="chatOverlay">
            <div class="chat-modal">
                <div class="chat-header">
                    <h3><i class="fas fa-comments"></i> –ß–∞—Ç –ø–∞—Ç—Ä—É–ª—è</h3>
                    <button class="close-chat" onclick="Game.hideChat()">√ó</button>
                </div>
                <div class="chat-messages" id="chatMessages">
                    <div class="message system">
                        <div class="message-sender"><i class="fas fa-info-circle"></i> –°–∏—Å—Ç–µ–º–∞</div>
                        <div class="message-text">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Traffic Patrol —Å –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç–∞–º–∏!</div>
                        <div class="message-text">–î–æ–±–∞–≤–ª—è–π—Ç–µ –º–µ—Ç–∫–∏ –Ω–∞ —Ä–µ–∞–ª—å–Ω—É—é –∫–∞—Ä—Ç—É</div>
                        <div class="message-time">–¢–æ–ª—å–∫–æ —á—Ç–æ</div>
                    </div>
                </div>
                <div class="chat-input">
                    <input type="text" id="chatInput" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." maxlength="200">
                    <button class="send-btn" onclick="Game.sendMessage()">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // TRAFFIC PATROL –° –Ø–ù–î–ï–ö–°.–ö–ê–†–¢–ê–ú–ò
        // ============================================
        
        const Game = {
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∏
            config: {
                center: [55.459619, 38.438920], // –í–∞—à–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
                zoom: 15,
                minZoom: 10,
                maxZoom: 19,
                apiKey: '365e247d-d853-4425-b9cc-13bfa1169a49'
            },
            
            // –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã
            state: {
                yandexMap: null,
                markers: [], // {id, type, user, coords, yandexPlacemark}
                selectedTool: 'police',
                userPoints: 100,
                userActivity: 0,
                totalMarkersAdded: 0,
                totalMarkersRemoved: 0,
                userName: '–ò–≥—Ä–æ–∫',
                chatMessages: [],
                isInitialized: false
            },
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
            async init() {
                console.log('üö¶ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Traffic Patrol —Å –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç–∞–º–∏...');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞–≥—Ä—É–∑–∫–∏
                document.getElementById('mapStatus').textContent = '–ü—Ä–æ–≤–µ—Ä–∫–∞ API –∫–ª—é—á–∞...';
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Telegram
                this.initTelegram();
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                this.loadGameData();
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç—ã
                await this.initYandexMap();
                
                // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
                this.setupEventListeners();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º UI
                this.updateUI();
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞
                this.loadChatHistory();
                
                console.log('‚úÖ –ò–≥—Ä–∞ –≥–æ—Ç–æ–≤–∞ —Å –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç–∞–º–∏!');
                this.showNotification('–Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã! –î–æ–±–∞–≤–ª—è–π—Ç–µ –º–µ—Ç–∫–∏ –Ω–∞ —Ä–µ–∞–ª—å–Ω—É—é –∫–∞—Ä—Ç—É üó∫Ô∏è', 'success');
            },
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
            initTelegram() {
                if (window.Telegram && window.Telegram.WebApp) {
                    const tg = window.Telegram.WebApp;
                    
                    tg.expand();
                    tg.enableClosingConfirmation();
                    tg.ready();
                    
                    if (tg.initDataUnsafe.user) {
                        const user = tg.initDataUnsafe.user;
                        this.state.userName = user.first_name || '–ò–≥—Ä–æ–∫';
                        document.getElementById('userName').textContent = this.state.userName;
                    }
                    
                    tg.BackButton.show();
                    tg.BackButton.onClick(() => {
                        this.saveGameData();
                        tg.close();
                    });
                    
                    console.log('ü§ñ Telegram Web App –ø–æ–¥–∫–ª—é—á–µ–Ω');
                }
            },
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç
            initYandexMap() {
                return new Promise((resolve, reject) => {
                    if (!window.ymaps) {
                        document.getElementById('mapStatus').textContent = '–û—à–∏–±–∫–∞: –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç—ã –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∏—Å—å';
                        this.showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç', 'error');
                        reject(new Error('Yandex Maps not loaded'));
                        return;
                    }
                    
                    ymaps.ready(() => {
                        try {
                            document.getElementById('mapStatus').textContent = '–°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ä—Ç—ã...';
                            
                            // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç—É
                            this.state.yandexMap = new ymaps.Map('yandexMap', {
                                center: this.config.center,
                                zoom: this.config.zoom,
                                controls: ['zoomControl', 'fullscreenControl', 'typeSelector', 'searchControl']
                            }, {
                                suppressMapOpenBlock: true
                            });
                            
                            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
                            this.state.yandexMap.controls.get('zoomControl').options.set({
                                size: 'small',
                                position: { right: 10, top: 150 }
                            });
                            
                            this.state.yandexMap.controls.get('fullscreenControl').options.set({
                                position: { right: 10, top: 100 }
                            });
                            
                            // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª–æ–π –ø—Ä–æ–±–æ–∫
                            const trafficLayer = new ymaps.layer.TrafficLayer();
                            this.state.yandexMap.layers.add(trafficLayer);
                            
                            // –°–∫—Ä—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –∑–∞–≥—Ä—É–∑–∫–∏
                            setTimeout(() => {
                                document.getElementById('mapLoading').style.display = 'none';
                                document.getElementById('mapStatus').textContent = '–ö–∞—Ä—Ç–∞ –≥–æ—Ç–æ–≤–∞!';
                            }, 500);
                            
                            // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –∫–∞—Ä—Ç—ã
                            this.setupMapEvents();
                            
                            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏ –Ω–∞ –∫–∞—Ä—Ç—É
                            this.loadMarkersToMap();
                            
                            this.state.isInitialized = true;
                            resolve();
                            
                        } catch (error) {
                            console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞—Ä—Ç—ã:', error);
                            document.getElementById('mapStatus').textContent = '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞—Ä—Ç—ã';
                            this.showNotification('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç', 'error');
                            reject(error);
                        }
                    });
                });
            },
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–æ–±—ã—Ç–∏–π –∫–∞—Ä—Ç—ã
            setupMapEvents() {
                const map = this.state.yandexMap;
                
                // –ö–ª–∏–∫ –ø–æ –∫–∞—Ä—Ç–µ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –º–µ—Ç–æ–∫
                map.events.add('click', (e) => {
                    const coords = e.get('coords');
                    
                    if (this.state.selectedTool === 'clear') {
                        this.findAndRemoveMarker(coords);
                    } else {
                        this.addMarkerToMap(coords, this.state.selectedTool);
                    }
                });
                
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –ø—Ä–∏ –¥–≤–∏–∂–µ–Ω–∏–∏ –∫–∞—Ä—Ç—ã
                map.events.add('boundschange', () => {
                    const center = map.getCenter();
                    document.getElementById('coordsBox').innerHTML = `
                        <div>–¶–µ–Ω—Ç—Ä –∫–∞—Ä—Ç—ã:</div>
                        <div class="coord-value">${center[0].toFixed(6)}, ${center[1].toFixed(6)}</div>
                    `;
                });
            },
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
            setupEventListeners() {
                // –ß–∞—Ç
                const chatInput = document.getElementById('chatInput');
                if (chatInput) {
                    chatInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') this.sendMessage();
                    });
                }
            },
            
            // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–µ—Ç–∫–∏ –Ω–∞ –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç—É
            addMarkerToMap(coords, type) {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–æ–∏–º–æ—Å—Ç—å
                const cost = this.getMarkerCost(type);
                if (this.state.userPoints < cost) {
                    this.showNotification(`–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –æ—á–∫–æ–≤! –ù—É–∂–Ω–æ ${cost}`, 'error');
                    return;
                }
                
                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º ID
                const markerId = `marker_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                
                // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –º–µ—Ç–∫–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
                let preset, iconColor, iconGlyph;
                switch(type) {
                    case 'police':
                        preset = 'islands#blueStretchyIcon';
                        iconColor = '#2196F3';
                        iconGlyph = 'car';
                        break;
                    case 'accident':
                        preset = 'islands#redStretchyIcon';
                        iconColor = '#F44336';
                        iconGlyph = 'crash';
                        break;
                    case 'hazard':
                        preset = 'islands#orangeStretchyIcon';
                        iconColor = '#FF9800';
                        iconGlyph = 'triangle';
                        break;
                }
                
                // –°–æ–∑–¥–∞–µ–º –º–µ—Ç–∫—É –Ø–Ω–¥–µ–∫—Å
                const placemark = new ymaps.Placemark(coords, {
                    hintContent: `${this.state.userName}: ${this.getToolName(type)}`,
                    balloonContent: `
                        <div style="color: white; font-family: inherit; padding: 10px; max-width: 250px;">
                            <strong style="color: #4fc3f7; font-size: 1.1rem;">${this.getToolName(type)}</strong><br>
                            <small>–î–æ–±–∞–≤–∏–ª: ${this.state.userName}</small><br>
                            <small>–í—Ä–µ–º—è: ${new Date().toLocaleTimeString()}</small><br>
                            <small>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${coords[0].toFixed(6)}, ${coords[1].toFixed(6)}</small><br>
                            <div style="margin-top: 10px;">
                                <button onclick="window.Game.removeMarker('${markerId}')" 
                                        style="background: #f44336; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 14px; width: 100%;">
                                    <i class="fas fa-trash-alt"></i> –£–¥–∞–ª–∏—Ç—å —ç—Ç—É –º–µ—Ç–∫—É
                                </button>
                            </div>
                        </div>
                    `,
                    markerId: markerId,
                    type: type,
                    user: this.state.userName
                }, {
                    preset: preset,
                    iconColor: iconColor,
                    draggable: true, // –†–∞–∑—Ä–µ—à–∞–µ–º –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ
                    hasBalloon: true,
                    hasHint: true
                });
                
                // –°–æ–±—ã—Ç–∏–µ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
                placemark.events.add('dragend', (e) => {
                    const newCoords = placemark.geometry.getCoordinates();
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
                    const marker = this.state.markers.find(m => m.id === markerId);
                    if (marker) {
                        marker.coords = newCoords;
                        this.saveGameData();
                        this.showNotification('–ú–µ—Ç–∫–∞ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∞! +2 –æ—á–∫–∞', 'info');
                        
                        // –ù–∞—á–∏—Å–ª—è–µ–º –æ—á–∫–∏ –∑–∞ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ
                        this.state.userPoints += 2;
                        this.state.userActivity++;
                        this.updateUI();
                    }
                });
                
                // –î–æ–±–∞–≤–ª—è–µ–º –º–µ—Ç–∫—É –Ω–∞ –∫–∞—Ä—Ç—É
                this.state.yandexMap.geoObjects.add(placemark);
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏
                this.state.markers.push({
                    id: markerId,
                    type: type,
                    user: this.state.userName,
                    coords: coords,
                    timestamp: Date.now(),
                    yandexPlacemark: placemark
                });
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                this.state.userPoints -= cost;
                this.state.userActivity++;
                this.state.totalMarkersAdded++;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                this.updateUI();
                this.saveGameData();
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                this.showNotification(`${this.getToolName(type)} –¥–æ–±–∞–≤–ª–µ–Ω –Ω–∞ –∫–∞—Ä—Ç—É! -${cost} –æ—á–∫–æ–≤`, 'success');
                
                // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç
                this.addChatMessage('system', `${this.state.userName} –¥–æ–±–∞–≤–∏–ª ${this.getToolName(type)} –Ω–∞ –∫–∞—Ä—Ç—É`);
            },
            
            // –ü–æ–∏—Å–∫ –∏ —É–¥–∞–ª–µ–Ω–∏–µ –±–ª–∏–∂–∞–π—à–µ–π –º–µ—Ç–∫–∏
            findAndRemoveMarker(coords) {
                // –ò—â–µ–º –±–ª–∏–∂–∞–π—à—É—é –º–µ—Ç–∫—É –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö 50 –º–µ—Ç—Ä–æ–≤
                const objects = this.state.yandexMap.geoObjects;
                let closestMarker = null;
                let minDistance = 0.0005; // ~50 –º–µ—Ç—Ä–æ–≤ –≤ –≥—Ä–∞–¥—É—Å–∞—Ö
                
                objects.each((object) => {
                    if (object.geometry && object.properties) {
                        const markerCoords = object.geometry.getCoordinates();
                        const distance = Math.sqrt(
                            Math.pow(markerCoords[0] - coords[0], 2) +
                            Math.pow(markerCoords[1] - coords[1], 2)
                        );
                        
                        if (distance < minDistance) {
                            minDistance = distance;
                            closestMarker = object;
                        }
                    }
                });
                
                if (closestMarker) {
                    const markerId = closestMarker.properties.get('markerId');
                    this.removeMarker(markerId);
                } else {
                    this.showNotification('–ú–µ—Ç–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ —Ä—è–¥–æ–º. –ü–æ–¥–≤–∏–Ω—å—Ç–µ—Å—å –±–ª–∏–∂–µ –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –º–µ—Ç–∫—É —Ç–æ—á–Ω–µ–µ.', 'warning');
                }
            },
            
            // –£–¥–∞–ª–µ–Ω–∏–µ –º–µ—Ç–∫–∏ –ø–æ ID
            removeMarker(markerId) {
                // –ù–∞—Ö–æ–¥–∏–º –º–∞—Ä–∫–µ—Ä –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏
                const markerIndex = this.state.markers.findIndex(m => m.id === markerId);
                if (markerIndex === -1) return;
                
                const marker = this.state.markers[markerIndex];
                
                // –£–¥–∞–ª—è–µ–º —Å –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç—ã
                if (marker.yandexPlacemark) {
                    this.state.yandexMap.geoObjects.remove(marker.yandexPlacemark);
                }
                
                // –£–¥–∞–ª—è–µ–º –∏–∑ —Å–æ—Å—Ç–æ—è–Ω–∏—è
                this.state.markers.splice(markerIndex, 1);
                
                // –ù–∞—á–∏—Å–ª—è–µ–º –æ—á–∫–∏
                this.state.userPoints += 5;
                this.state.userActivity++;
                this.state.totalMarkersRemoved++;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                this.updateUI();
                this.saveGameData();
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                this.showNotification('–ú–µ—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–∞ —Å –∫–∞—Ä—Ç—ã! +5 –æ—á–∫–æ–≤', 'success');
                
                // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç
                this.addChatMessage('system', `${this.state.userName} —É–¥–∞–ª–∏–ª ${this.getToolName(marker.type)} —Å –∫–∞—Ä—Ç—ã`);
            },
            
            // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –º–µ—Ç–æ–∫ –Ω–∞ –∫–∞—Ä—Ç—É
            loadMarkersToMap() {
                this.state.markers.forEach(markerData => {
                    // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
                    let preset, iconColor;
                    switch(markerData.type) {
                        case 'police':
                            preset = 'islands#blueStretchyIcon';
                            iconColor = '#2196F3';
                            break;
                        case 'accident':
                            preset = 'islands#redStretchyIcon';
                            iconColor = '#F44336';
                            break;
                        case 'hazard':
                            preset = 'islands#orangeStretchyIcon';
                            iconColor = '#FF9800';
                            break;
                    }
                    
                    // –°–æ–∑–¥–∞–µ–º –º–µ—Ç–∫—É –Ø–Ω–¥–µ–∫—Å
                    const placemark = new ymaps.Placemark(markerData.coords, {
                        hintContent: `${markerData.user}: ${this.getToolName(markerData.type)}`,
                        balloonContent: `
                            <div style="color: white; font-family: inherit; padding: 10px; max-width: 250px;">
                                <strong style="color: #4fc3f7; font-size: 1.1rem;">${this.getToolName(markerData.type)}</strong><br>
                                <small>–î–æ–±–∞–≤–∏–ª: ${markerData.user}</small><br>
                                <small>–í—Ä–µ–º—è: ${new Date(markerData.timestamp).toLocaleTimeString()}</small><br>
                                <small>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${markerData.coords[0].toFixed(6)}, ${markerData.coords[1].toFixed(6)}</small><br>
                                <div style="margin-top: 10px;">
                                    <button onclick="window.Game.removeMarker('${markerData.id}')" 
                                            style="background: #f44336; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 14px; width: 100%;">
                                        <i class="fas fa-trash-alt"></i> –£–¥–∞–ª–∏—Ç—å —ç—Ç—É –º–µ—Ç–∫—É
                                    </button>
                                </div>
                            </div>
                        `,
                        markerId: markerData.id,
                        type: markerData.type,
                        user: markerData.user
                    }, {
                        preset: preset,
                        iconColor: iconColor,
                        draggable: true,
                        hasBalloon: true,
                        hasHint: true
                    });
                    
                    // –°–æ–±—ã—Ç–∏–µ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
                    placemark.events.add('dragend', (e) => {
                        const newCoords = placemark.geometry.getCoordinates();
                        markerData.coords = newCoords;
                        this.saveGameData();
                        this.showNotification('–ú–µ—Ç–∫–∞ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∞! +2 –æ—á–∫–∞', 'info');
                        
                        this.state.userPoints += 2;
                        this.state.userActivity++;
                        this.updateUI();
                    });
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞ –∫–∞—Ä—Ç—É –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Å—ã–ª–∫—É
                    this.state.yandexMap.geoObjects.add(placemark);
                    markerData.yandexPlacemark = placemark;
                });
            },
            
            // –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
            centerToUser() {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            const userCoords = [position.coords.latitude, position.coords.longitude];
                            this.state.yandexMap.setCenter(userCoords, 16);
                            this.showNotification('–ö–∞—Ä—Ç–∞ —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∞ –Ω–∞ –≤–∞—à–µ–º –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–∏', 'info');
                            
                            // –î–æ–±–∞–≤–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –º–µ—Ç–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                            const userMarker = new ymaps.Placemark(userCoords, {
                                hintContent: '–í–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ',
                                balloonContent: '–í—ã –∑–¥–µ—Å—å!'
                            }, {
                                preset: 'islands#blueCircleDotIcon',
                                draggable: false
                            });
                            
                            this.state.yandexMap.geoObjects.add(userMarker);
                            
                            // –£–±–∏—Ä–∞–µ–º —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥
                            setTimeout(() => {
                                this.state.yandexMap.geoObjects.remove(userMarker);
                            }, 10000);
                        },
                        (error) => {
                            this.showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è.', 'warning');
                            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –Ω–∞ —Ü–µ–Ω—Ç—Ä –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                            this.state.yandexMap.setCenter(this.config.center, this.config.zoom);
                        }
                    );
                } else {
                    this.showNotification('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤–∞—à–∏–º –±—Ä–∞—É–∑–µ—Ä–æ–º', 'warning');
                    this.state.yandexMap.setCenter(this.config.center, this.config.zoom);
                }
            },
            
            // –í—ã–±–æ—Ä –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
            selectTool(tool) {
                this.state.selectedTool = tool;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
                document.querySelectorAll('.tool-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                const toolButtons = {
                    police: 'toolPolice',
                    accident: 'toolAccident',
                    hazard: 'toolHazard',
                    clear: 'toolClear'
                };
                
                const activeButton = document.getElementById(toolButtons[tool]);
                if (activeButton) {
                    activeButton.classList.add('active');
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É
                const hintText = document.getElementById('hintText');
                if (tool === 'clear') {
                    hintText.textContent = '–ö–ª–∏–∫–Ω–∏—Ç–µ –ø–æ –º–µ—Ç–∫–µ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è';
                } else {
                    hintText.textContent = '–ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–µ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –º–µ—Ç–∫–∏';
                }
                
                this.showNotification(`–í—ã–±—Ä–∞–Ω: ${this.getToolName(tool)}`, 'info');
            },
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI
            updateUI() {
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏
                document.getElementById('markerCount').textContent = this.state.markers.length;
                document.getElementById('statPoints').textContent = this.state.userPoints;
                document.getElementById('statActivity').textContent = this.state.userActivity;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
                const progress = Math.min(Math.max(this.state.userPoints / 100, 0), 1) * 100;
                document.getElementById('statProgress').textContent = Math.round(progress) + '%';
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–Ω–≥
                const rank = this.calculateRank();
                document.getElementById('userRank').textContent = rank;
            },
            
            // –†–∞—Å—á–µ—Ç —Ä–∞–Ω–≥–∞
            calculateRank() {
                const points = this.state.userPoints;
                if (points >= 1000) return '–ö–æ–º–∏—Å—Å–∞—Ä üëÆ‚Äç‚ôÇÔ∏è';
                if (points >= 500) return '–°–µ—Ä–∂–∞–Ω—Ç üëÆ';
                if (points >= 200) return '–û—Ñ–∏—Ü–µ—Ä üöî';
                if (points >= 100) return '–ü–∞—Ç—Ä—É–ª—å–Ω—ã–π üöì';
                return '–ù–æ–≤–∏—á–æ–∫ üö¶';
            },
            
            // –ü–æ–ª—É—á–µ–Ω–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
            getToolName(tool) {
                const names = {
                    police: '–ü–∞—Ç—Ä—É–ª—å üöì',
                    accident: '–î–¢–ü üí•',
                    hazard: '–û–ø–∞—Å–Ω–æ—Å—Ç—å ‚ö†Ô∏è',
                    clear: '–£–¥–∞–ª–µ–Ω–∏–µ üóëÔ∏è'
                };
                return names[tool] || tool;
            },
            
            // –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –º–∞—Ä–∫–µ—Ä–∞
            getMarkerCost(type) {
                const costs = {
                    police: 10,
                    accident: 15,
                    hazard: 8
                };
                return costs[type] || 10;
            },
            
            // –†–∞–±–æ—Ç–∞ —Å —á–∞—Ç–æ–º
            showChat() {
                document.getElementById('chatOverlay').style.display = 'flex';
                setTimeout(() => {
                    document.getElementById('chatInput').focus();
                }, 300);
            },
            
            hideChat() {
                document.getElementById('chatOverlay').style.display = 'none';
            },
            
            sendMessage() {
                const input = document.getElementById('chatInput');
                const message = input.value.trim();
                
                if (message) {
                    this.addChatMessage('user', message);
                    input.value = '';
                    this.saveChatHistory();
                }
            },
            
            addChatMessage(sender, text) {
                const messagesDiv = document.getElementById('chatMessages');
                
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${sender}`;
                
                const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                if (sender === 'system') {
                    messageDiv.innerHTML = `
                        <div class="message-sender"><i class="fas fa-info-circle"></i> –°–∏—Å—Ç–µ–º–∞</div>
                        <div class="message-text">${text}</div>
                        <div class="message-time">${time}</div>
                    `;
                } else {
                    messageDiv.innerHTML = `
                        <div class="message-sender">${this.state.userName}</div>
                        <div class="message-text">${text}</div>
                        <div class="message-time">${time}</div>
                    `;
                }
                
                messagesDiv.appendChild(messageDiv);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
                this.state.chatMessages.push({
                    sender: sender,
                    text: text,
                    time: Date.now(),
                    user: sender === 'user' ? this.state.userName : '–°–∏—Å—Ç–µ–º–∞'
                });
                
                // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é 100 —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
                if (this.state.chatMessages.length > 100) {
                    this.state.chatMessages.shift();
                }
            },
            
            // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
            saveGameData() {
                try {
                    // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è (–±–µ–∑ –æ–±—ä–µ–∫—Ç–æ–≤ –Ø–Ω–¥–µ–∫—Å)
                    const saveData = this.state.markers.map(marker => ({
                        id: marker.id,
                        type: marker.type,
                        user: marker.user,
                        coords: marker.coords,
                        timestamp: marker.timestamp
                    }));
                    
                    const gameData = {
                        markers: saveData,
                        userPoints: this.state.userPoints,
                        userActivity: this.state.userActivity,
                        totalMarkersAdded: this.state.totalMarkersAdded,
                        totalMarkersRemoved: this.state.totalMarkersRemoved,
                        userName: this.state.userName,
                        lastSave: Date.now()
                    };
                    
                    localStorage.setItem('traffic_patrol_yandex_data', JSON.stringify(gameData));
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–≥—Ä—ã:', error);
                }
            },
            
            loadGameData() {
                try {
                    const savedData = localStorage.getItem('traffic_patrol_yandex_data');
                    if (savedData) {
                        const data = JSON.parse(savedData);
                        
                        // –ó–∞–≥—Ä—É–∂–∞–µ–º –º–∞—Ä–∫–µ—Ä—ã (–æ–±—ä–µ–∫—Ç—ã –Ø–Ω–¥–µ–∫—Å –±—É–¥—É—Ç —Å–æ–∑–¥–∞–Ω—ã –ø–æ–∑–∂–µ)
                        this.state.markers = data.markers || [];
                        
                        this.state.userPoints = data.userPoints || 100;
                        this.state.userActivity = data.userActivity || 0;
                        this.state.totalMarkersAdded = data.totalMarkersAdded || 0;
                        this.state.totalMarkersRemoved = data.totalMarkersRemoved || 0;
                        this.state.userName = data.userName || '–ò–≥—Ä–æ–∫';
                        
                        document.getElementById('userName').textContent = this.state.userName;
                        
                        console.log('‚úÖ –ò–≥—Ä–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –∏–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–≥—Ä—ã:', error);
                }
            },
            
            saveChatHistory() {
                try {
                    localStorage.setItem('traffic_patrol_chat_history', JSON.stringify(this.state.chatMessages));
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —á–∞—Ç–∞:', error);
                }
            },
            
            loadChatHistory() {
                try {
                    const savedChat = localStorage.getItem('traffic_patrol_chat_history');
                    if (savedChat) {
                        this.state.chatMessages = JSON.parse(savedChat);
                        
                        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç–µ
                        const messagesDiv = document.getElementById('chatMessages');
                        messagesDiv.innerHTML = '';
                        
                        this.state.chatMessages.forEach(msg => {
                            const messageDiv = document.createElement('div');
                            messageDiv.className = `message ${msg.sender}`;
                            
                            const time = new Date(msg.time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                            
                            if (msg.sender === 'system') {
                                messageDiv.innerHTML = `
                                    <div class="message-sender"><i class="fas fa-info-circle"></i> ${msg.user}</div>
                                    <div class="message-text">${msg.text}</div>
                                    <div class="message-time">${time}</div>
                                `;
                            } else {
                                messageDiv.innerHTML = `
                                    <div class="message-sender">${msg.user}</div>
                                    <div class="message-text">${msg.text}</div>
                                    <div class="message-time">${time}</div>
                                `;
                            }
                            
                            messagesDiv.appendChild(messageDiv);
                        });
                        
                        messagesDiv.scrollTop = messagesDiv.scrollHeight;
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–∞:', error);
                }
            },
            
            // –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            showNotification(message, type = 'success') {
                // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
                const oldNotifications = document.querySelectorAll('.notification');
                oldNotifications.forEach(n => n.remove());
                
                // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.innerHTML = `
                    <i class="fas fa-${type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'check-circle'}"></i>
                    <span>${message}</span>
                `;
                
                document.body.appendChild(notification);
                
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–∫—Ä—ã—Ç–∏–µ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
                setTimeout(() => {
                    notification.style.opacity = '0';
                    notification.style.transform = 'translateY(-30px) translateX(30px)';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                }, 3000);
            }
        };
        
        // –°–¥–µ–ª–∞–µ–º Game –¥–æ—Å—Ç—É–ø–Ω–æ–π –≥–ª–æ–±–∞–ª—å–Ω–æ –¥–ª—è –∫–Ω–æ–ø–æ–∫ —É–¥–∞–ª–µ–Ω–∏—è
        window.Game = Game;
        
        // ============================================
        // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–†–ò –ó–ê–ì–†–£–ó–ö–ï –°–¢–†–ê–ù–ò–¶–´
        // ============================================
        
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await Game.init();
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ä—Ç–æ–≤—É—é –ø–æ–¥—Å–∫–∞–∑–∫—É
                setTimeout(() => {
                    Game.showNotification('üó∫Ô∏è –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã! –ö–ª–∏–∫–∞–π—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –º–µ—Ç–æ–∫', 'info');
                    Game.addChatMessage('system', '–Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã. –¶–µ–Ω—Ç—Ä –∫–∞—Ä—Ç—ã: 55.459619, 38.438920');
                }, 1000);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
                document.getElementById('mapStatus').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.';
                Game.showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.', 'error');
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                document.getElementById('mapLoading').innerHTML = `
                    <i class="fas fa-exclamation-triangle"></i>
                    <p>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç—ã</p>
                    <small>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ API –∫–ª—é—á</small>
                    <button onclick="location.reload()" style="margin-top: 20px; padding: 10px 20px; background: #2196f3; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É
                    </button>
                `;
            }
        });
    </script>
</body>
</html>
