<script>
    // ============ –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø FIREBASE ============
    const firebaseConfig = {
        apiKey: "AIzaSyD0zwcRZs7mI0RzPq3O18WOIWjhUO6yKZQ",
        authDomain: "miami-police-game.firebaseapp.com",
        databaseURL: "https://miami-police-game-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "miami-police-game",
        storageBucket: "miami-police-game.firebasestorage.app",
        messagingSenderId: "4861394604",
        appId: "1:4861394604:web:f2acb3a189f99396a66909"
    };
    
    // ============ –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ============
    const tg = window.Telegram.WebApp;
    let telegramUser = null;
    const EXPIRATION_TIME = 24 * 60 * 60 * 1000; // 24 —á–∞—Å–∞
    let MAX_MARKERS = 40;
    let autoDeleteInterval = null;
    let autoStartInterval = null;
    let countdownSeconds = 20;
    
    // –ò–≥—Ä–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    let ymap = null;
    let markers = [];
    let selectedTool = 'police';
    let points = 100;
    let activity = 0;
    let pendingCommentData = null;
    
    // Firebase
    let firebaseApp = null;
    let firebaseDatabase = null;
    let syncInterval = null;
    let isFirebaseReady = false;
    
    // ============ –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ============
    function getIconContent(type) {
        const icons = {
            'police': 'üö®',
            'accident': 'üöó',
            'help': 'üÜò',
            'hazard': 'üö¶'
        };
        return icons[type] || 'üìç';
    }
    
    function getIconColor(type) {
        const colors = {
            'police': '#2196F3',
            'accident': '#F44336',
            'help': '#4CAF50',
            'hazard': '#FF9800'
        };
        return colors[type] || '#2196F3';
    }
    
    function getBalloonTitle(type) {
        const titles = {
            'police': 'üö® –ü–∞—Ç—Ä—É–ª—å',
            'accident': 'üöó –î–¢–ü',
            'help': 'üÜò –ü–æ–º–æ—â—å',
            'hazard': 'üö¶ –ü—Ä–æ–±–∫–∞'
        };
        return titles[type] || 'üìç –ú–µ—Ç–∫–∞';
    }
    
    // ============ –ü–†–û–í–ï–†–ö–ê FIREBASE ============
    function checkFirebase() {
        if (typeof firebase === 'undefined') {
            console.error('Firebase –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω!');
            document.getElementById('syncStatus').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ Firebase';
            document.getElementById('syncStatus').style.color = '#f44336';
            return false;
        }
        return true;
    }
    
    // ============ –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø TELEGRAM ============
    function initTelegram() {
        console.log('Initializing Telegram Web App...');
        
        tg.expand();
        
        telegramUser = tg.initDataUnsafe?.user;
        
        if (telegramUser) {
            const userName = telegramUser.first_name || telegramUser.username || '–ò–≥—Ä–æ–∫';
            document.getElementById('userWelcome').textContent = `–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${userName}!`;
            window.userId = telegramUser.id.toString();
            window.userName = userName;
        } else {
            document.getElementById('userWelcome').textContent = '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –∏–≥—Ä—É!';
            window.userId = 'guest_' + Math.random().toString(36).substr(2, 9);
            window.userName = '–ì–æ—Å—Ç—å';
        }
        
        startAutoStartTimer();
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º Firebase –ø–µ—Ä–µ–¥ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–µ–π
        if (checkFirebase()) {
            initFirebase();
        } else {
            // –ñ–¥–µ–º –∏ –ø—Ä–æ–±—É–µ–º —Å–Ω–æ–≤–∞
            setTimeout(() => {
                if (checkFirebase()) {
                    initFirebase();
                } else {
                    document.getElementById('syncStatus').textContent = 'Firebase –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ';
                    document.getElementById('syncStatus').style.color = '#FF9800';
                    useLocalStorage();
                }
            }, 2000);
        }
    }
    
    // ============ –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø FIREBASE ============
    function initFirebase() {
        try {
            console.log('–ü—Ä–æ–≤–µ—Ä—è–µ–º Firebase:', typeof firebase, typeof firebase.initializeApp);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –ª–∏ Firebase —É–∂–µ
            if (!firebase.apps.length) {
                firebaseApp = firebase.initializeApp(firebaseConfig);
            } else {
                firebaseApp = firebase.apps[0];
            }
            
            firebaseDatabase = firebase.database();
            
            console.log('‚úÖ Firebase —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω!');
            isFirebaseReady = true;
            
            const syncStatus = document.getElementById('syncStatus');
            if (syncStatus) {
                syncStatus.textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ Firebase ‚úì';
                syncStatus.style.color = '#4CAF50';
            }
            
            startFirebaseSync();
            
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ Firebase:', error);
            isFirebaseReady = false;
            
            const syncStatus = document.getElementById('syncStatus');
            if (syncStatus) {
                syncStatus.textContent = 'Firebase –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ';
                syncStatus.style.color = '#FF9800';
            }
            
            useLocalStorage();
        }
    }
    
    // ============ –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø –° FIREBASE ============
    function startFirebaseSync() {
        loadMarkersFromFirebase();
        syncInterval = setInterval(syncToFirebase, 5000);
    }
    
    function loadMarkersFromFirebase() {
        if (!isFirebaseReady || !firebaseDatabase) {
            console.log('Firebase –Ω–µ –≥–æ—Ç–æ–≤, –∑–∞–≥—Ä—É–∂–∞–µ–º –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞');
            useLocalStorage();
            return;
        }
        
        try {
            console.log('–ó–∞–≥—Ä—É–∑–∫–∞ –º–µ—Ç–æ–∫ –∏–∑ Firebase...');
            
            const markersRef = firebaseDatabase.ref('markers');
            
            markersRef.once('value', function(snapshot) {
                try {
                    const firebaseData = snapshot.val();
                    const firebaseMarkers = [];
                    
                    // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –æ–±—ä–µ–∫—Ç –≤ –º–∞—Å—Å–∏–≤
                    if (firebaseData) {
                        Object.keys(firebaseData).forEach(key => {
                            firebaseMarkers.push({
                                id: key,
                                ...firebaseData[key]
                            });
                        });
                    }
                    
                    console.log('–ó–∞–≥—Ä—É–∂–µ–Ω–æ –º–µ—Ç–æ–∫ –∏–∑ Firebase:', firebaseMarkers.length);
                    
                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–ª—É—à–∞—Ç–µ–ª—å –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
                    markersRef.on('value', function(snapshot) {
                        const updatedData = snapshot.val();
                        const updatedMarkers = [];
                        
                        if (updatedData) {
                            Object.keys(updatedData).forEach(key => {
                                updatedMarkers.push({
                                    id: key,
                                    ...updatedData[key]
                                });
                            });
                        }
                        
                        console.log('–ü–æ–ª—É—á–µ–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ Firebase:', updatedMarkers.length, '–º–µ—Ç–æ–∫');
                        updateMarkersFromCloud(updatedMarkers);
                    });
                    
                    updateMarkersFromCloud(firebaseMarkers);
                    
                } catch (innerError) {
                    console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö Firebase:', innerError);
                    useLocalStorage();
                }
            }, function(error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ Firebase:', error);
                useLocalStorage();
            });
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ Firebase:', error);
            useLocalStorage();
        }
    }
    
    function updateMarkersFromCloud(cloudMarkers) {
        if (!ymap) {
            console.log('–ö–∞—Ä—Ç–∞ –µ—â–µ –Ω–µ –≥–æ—Ç–æ–≤–∞, –æ—Ç–∫–ª–∞–¥—ã–≤–∞—é –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ...');
            setTimeout(() => updateMarkersFromCloud(cloudMarkers), 1000);
            return;
        }
        
        const now = Date.now();
        const activeCloudMarkers = cloudMarkers.filter(marker => 
            marker && marker.timestamp && (now - marker.timestamp <= EXPIRATION_TIME)
        );
        
        console.log(`–ê–∫—Ç–∏–≤–Ω—ã—Ö –º–µ—Ç–æ–∫ –≤ –æ–±–ª–∞–∫–µ: ${activeCloudMarkers.length}`);
        
        // –£–¥–∞–ª—è–µ–º –º–µ—Ç–∫–∏, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ –æ–±–ª–∞–∫–µ
        markers.forEach(marker => {
            const existsInCloud = activeCloudMarkers.some(cm => cm && cm.id === marker.id);
            if (!existsInCloud && marker.placemark) {
                ymap.geoObjects.remove(marker.placemark);
            }
        });
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–ª–∏ –¥–æ–±–∞–≤–ª—è–µ–º –º–µ—Ç–∫–∏ –∏–∑ –æ–±–ª–∞–∫–∞
        markers = activeCloudMarkers.map(markerData => {
            if (!markerData || !markerData.id) return null;
            
            const existingIndex = markers.findIndex(m => m.id === markerData.id);
            
            if (existingIndex !== -1 && markers[existingIndex].placemark) {
                ymap.geoObjects.remove(markers[existingIndex].placemark);
            }
            
            // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –º–µ—Ç–∫—É
            const placemark = createPlacemark(markerData);
            ymap.geoObjects.add(placemark);
            
            return {
                ...markerData,
                placemark: placemark
            };
        }).filter(m => m !== null); // –£–¥–∞–ª—è–µ–º null –∑–Ω–∞—á–µ–Ω–∏—è
        
        updateUI();
        checkMarkerLimit();
        
        console.log(`–û–±–Ω–æ–≤–ª–µ–Ω–æ ${markers.length} –º–µ—Ç–æ–∫ –Ω–∞ –∫–∞—Ä—Ç–µ`);
    }
    
    function syncToFirebase() {
        if (!isFirebaseReady || !firebaseDatabase) {
            console.log('Firebase –Ω–µ –≥–æ—Ç–æ–≤, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ');
            saveToLocalStorage();
            return;
        }
        
        console.log('syncToFirebase –≤—ã–∑–≤–∞–Ω, –º–µ—Ç–æ–∫:', markers.length);
        
        try {
            // –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç–æ–π –æ–±—ä–µ–∫—Ç –¥–ª—è Firebase
            const markersObject = {};
            
            markers.forEach(marker => {
                if (marker && marker.id) {
                    markersObject[marker.id] = {
                        type: marker.type || 'police',
                        coords: marker.coords || [55.75, 37.61],
                        comment: marker.comment || '',
                        timestamp: marker.timestamp || Date.now(),
                        author: marker.author || window.userName || '–ì–æ—Å—Ç—å',
                        authorId: marker.authorId || window.userId || 'guest',
                        iconType: marker.type || 'police',
                        iconContent: getIconContent(marker.type || 'police'),
                        iconColor: getIconColor(marker.type || 'police')
                    };
                }
            });
            
            console.log('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Firebase:', Object.keys(markersObject).length, '–º–µ—Ç–æ–∫');
            
            // –û–ß–ï–ù–¨ –ü–†–û–°–¢–ê–Ø –ó–ê–ü–ò–°–¨ –í FIREBASE
            const markersRef = firebaseDatabase.ref('markers');
            
            // –ü—Ä–æ–±—É–µ–º –∑–∞–ø–∏—Å–∞—Ç—å –¥–∞–Ω–Ω—ã–µ
            markersRef.set(markersObject, function(error) {
                if (error) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ –≤ Firebase:', error);
                    console.log('–ü—Ä–æ–±—É–µ–º —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ...');
                    saveToLocalStorage();
                } else {
                    console.log('‚úÖ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–ø–∏—Å–∞–Ω—ã –≤ Firebase');
                }
            });
            
        } catch (error) {
            console.error('‚ùå –û–±—â–∞—è –æ—à–∏–±–∫–∞ syncToFirebase:', error);
            saveToLocalStorage();
        }
    }
    
    // ============ –õ–û–ö–ê–õ–¨–ù–û–ï –•–†–ê–ù–ò–õ–ò–©–ï ============
    function useLocalStorage() {
        console.log('–ò—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ...');
        isFirebaseReady = false;
        
        try {
            const saved = localStorage.getItem('miami_police_shared');
            if (saved) {
                const data = JSON.parse(saved);
                if (data.markers) {
                    updateMarkersFromCloud(data.markers);
                }
            }
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞:', e);
        }
    }
    
    function saveToLocalStorage() {
        try {
            const data = {
                markers: markers.map(m => ({
                    id: m.id,
                    type: m.type,
                    coords: m.coords,
                    comment: m.comment,
                    timestamp: m.timestamp,
                    author: m.author || window.userName
                })).filter(m => m !== null),
                lastUpdate: Date.now()
            };
            
            localStorage.setItem('miami_police_shared', JSON.stringify(data));
            console.log('‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –ª–æ–∫–∞–ª—å–Ω–æ:', data.markers.length, '–º–µ—Ç–æ–∫');
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', e);
        }
    }
    
    // ============ –¢–ê–ô–ú–ï–† –ê–í–¢–û–ó–ê–ü–£–°–ö–ê ============
    function startAutoStartTimer() {
        const countdownElement = document.getElementById('countdown');
        countdownElement.textContent = countdownSeconds;
        
        autoStartInterval = setInterval(() => {
            countdownSeconds--;
            countdownElement.textContent = countdownSeconds;
            
            if (countdownSeconds <= 0) {
                clearInterval(autoStartInterval);
                if (document.getElementById('splashScreen').style.display !== 'none') {
                    startGame();
                }
            }
        }, 1000);
    }
    
    // ============ –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê ============
    function openRulesModal() {
        document.getElementById('rulesModal').style.display = 'flex';
    }
    
    function openPlayersModal() {
        document.getElementById('playersModal').style.display = 'flex';
    }
    
    function openControlsModal() {
        document.getElementById('controlsModal').style.display = 'flex';
    }
    
    function closeModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
    }
    
    // ============ –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò –ò–ì–†–´ ============
    function skipIntro() {
        clearInterval(autoStartInterval);
        const splash = document.getElementById('splashScreen');
        const mainApp = document.getElementById('mainApp');
        
        splash.style.opacity = '0';
        splash.style.transition = 'opacity 0.3s ease';
        
        setTimeout(() => {
            splash.style.display = 'none';
            mainApp.classList.add('active');
            initGame();
        }, 300);
    }
    
    function startGame() {
        clearInterval(autoStartInterval);
        const splash = document.getElementById('splashScreen');
        const mainApp = document.getElementById('mainApp');
        
        splash.style.opacity = '0';
        splash.style.transition = 'opacity 0.5s ease';
        
        setTimeout(() => {
            splash.style.display = 'none';
            mainApp.classList.add('active');
            initGame();
        }, 500);
    }
    
    function initGame() {
        console.log('üöî –ó–∞–ø—É—Å–∫ –∏–≥—Ä—ã...');
        
        loadUserData();
        startAutoDeleteChecker();
        
        if (window.ymaps) {
            ymaps.ready(initMap);
        } else {
            showError('‚ùå –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç—ã –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∏—Å—å');
        }
    }
    
    // ============ –ö–ê–†–¢–ê –ò –ì–ï–û–õ–û–ö–ê–¶–ò–Ø ============
    function initMap() {
        try {
            let center = [55.459619, 38.438920];
            let zoom = 15;
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        center = [position.coords.latitude, position.coords.longitude];
                        zoom = 17;
                        createMap(center, zoom);
                    },
                    function(error) {
                        console.warn('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞:', error);
                        createMap(center, zoom);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 5000,
                        maximumAge: 0
                    }
                );
            } else {
                createMap(center, zoom);
            }
            
            function createMap(centerCoords, zoomLevel) {
                ymap = new ymaps.Map('yandex-map', {
                    center: centerCoords,
                    zoom: zoomLevel,
                    controls: ['zoomControl', 'fullscreenControl', 'typeSelector']
                });
                
                const geolocationControl = new ymaps.control.GeolocationControl({
                    options: {
                        noPlacemark: true,
                        position: { right: 10, top: 80 }
                    }
                });
                ymap.controls.add(geolocationControl);
                
                document.getElementById('loading').style.display = 'none';
                
                ymap.events.add('click', function(e) {
                    const coords = e.get('coords');
                    
                    if (selectedTool === 'clear') {
                        removeNearMarker(coords);
                    } else if (selectedTool === 'help') {
                        pendingCommentData = { coords, type: selectedTool };
                        showCommentModal();
                    } else {
                        addMarker(coords, selectedTool, null);
                    }
                });
            }
            
            updateUI();
            checkMarkerLimit();
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∫–∞—Ä—Ç—ã:', error);
            showError('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç—ã');
        }
    }
    
    // ============ –°–û–ó–î–ê–ù–ò–ï –ú–ï–¢–û–ö ============
    function createPlacemark(markerData) {
        if (!markerData) return null;
        
        const iconContent = getIconContent(markerData.type || 'police');
        const iconColor = getIconColor(markerData.type || 'police');
        const balloonTitle = getBalloonTitle(markerData.type || 'police');
        const isMyMarker = markerData.authorId === window.userId;
        
        const placemark = new ymaps.Placemark(
            markerData.coords || [55.75, 37.61],
            {
                balloonContent: `
                    <div style="padding: 10px; max-width: 250px;">
                        <h3 style="margin: 0 0 10px 0; color: ${iconColor}">
                            ${balloonTitle}
                        </h3>
                        ${markerData.comment ? `<p><strong>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</strong> ${markerData.comment}</p>` : ''}
                        <p><strong>–ê–≤—Ç–æ—Ä:</strong> ${markerData.author || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</p>
                        <p><strong>–í—Ä–µ–º—è:</strong> ${new Date(markerData.timestamp || Date.now()).toLocaleString()}</p>
                        ${isMyMarker ? `
                            <button onclick="deleteMarkerFromBalloon('${markerData.id}')" 
                                    style="background: #f44336; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; margin-top: 10px;">
                                –£–¥–∞–ª–∏—Ç—å –º–æ—é –º–µ—Ç–∫—É
                            </button>
                        ` : ''}
                    </div>
                `,
                iconCaption: markerData.comment || ''
            },
            {
                preset: 'islands#circleIcon',
                iconColor: iconColor,
                iconLayout: 'default#imageWithContent',
                iconImageHref: '',
                iconImageSize: [40, 40],
                iconImageOffset: [-20, -40],
                iconContentOffset: [0, 10],
                iconContentLayout: ymaps.templateLayoutFactory.createClass(
                    `<div style="
                        font-size: 24px;
                        text-align: center;
                        width: 40px;
                        height: 40px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        background-color: ${iconColor};
                        border-radius: 50%;
                        border: 3px solid white;
                        box-shadow: 0 2px 5px rgba(0,0,0,0.3);
                        color: white;
                        position: relative;
                    ">
                        ${iconContent}
                        ${isMyMarker ? `
                        <div style="
                            position: absolute;
                            top: -5px;
                            right: -5px;
                            background: #f44336;
                            color: white;
                            border-radius: 50%;
                            width: 20px;
                            height: 20px;
                            font-size: 12px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            cursor: pointer;
                            border: 1px solid white;
                        " onclick="deleteMarker('${markerData.id}'); event.stopPropagation();">
                            √ó
                        </div>
                        ` : ''}
                    </div>`
                )
            }
        );
        
        placemark.events.add('click', function() {
            placemark.balloon.open();
        });
        
        return placemark;
    }
    
    function addMarker(coords, type, comment = null) {
        if (markers.length >= MAX_MARKERS) {
            alert(`‚ùå –î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç –≤ ${MAX_MARKERS} –º–µ—Ç–æ–∫!`);
            return;
        }
        
        const markerId = Date.now().toString() + Math.random().toString(36).substr(2, 9);
        const markerData = {
            id: markerId,
            type: type,
            coords: coords,
            comment: comment,
            timestamp: Date.now(),
            author: window.userName,
            authorId: window.userId,
            iconType: type,
            iconContent: getIconContent(type),
            iconColor: getIconColor(type)
        };
        
        const placemark = createPlacemark(markerData);
        if (!placemark) {
            console.error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –º–µ—Ç–∫—É');
            return;
        }
        
        const markerWithPlacemark = {
            ...markerData,
            placemark: placemark
        };
        
        markers.push(markerWithPlacemark);
        ymap.geoObjects.add(placemark);
        
        points += 10;
        activity += 1;
        
        updateUI();
        checkMarkerLimit();
        
        // –ü—ã—Ç–∞–µ–º—Å—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å Firebase
        if (isFirebaseReady) {
            syncToFirebase();
        } else {
            saveToLocalStorage();
        }
        
        console.log(`‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –º–µ—Ç–∫–∞: ${type}`);
    }
    
    function deleteMarker(markerId) {
        const markerIndex = markers.findIndex(m => m.id === markerId);
        if (markerIndex !== -1) {
            const marker = markers[markerIndex];
            if (marker.placemark) {
                ymap.geoObjects.remove(marker.placemark);
            }
            
            markers.splice(markerIndex, 1);
            
            points += 5;
            updateUI();
            checkMarkerLimit();
            
            // –ü—ã—Ç–∞–µ–º—Å—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å Firebase
            if (isFirebaseReady) {
                syncToFirebase();
            } else {
                saveToLocalStorage();
            }
            
            alert('üóëÔ∏è –ú–µ—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–∞');
        }
    }
    
    function deleteMarkerFromBalloon(markerId) {
        deleteMarker(markerId);
    }
    
    function removeNearMarker(coords) {
        if (!markers.length) {
            alert('–ù–µ—Ç –º–µ—Ç–æ–∫ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è');
            return;
        }
        
        let closestMarker = null;
        let minDistance = Infinity;
        
        markers.forEach(marker => {
            const distance = Math.sqrt(
                Math.pow(marker.coords[0] - coords[0], 2) + 
                Math.pow(marker.coords[1] - coords[1], 2)
            ) * 111000;
            
            if (distance < 50 && distance < minDistance) {
                minDistance = distance;
                closestMarker = marker;
            }
        });
        
        if (closestMarker) {
            deleteMarker(closestMarker.id);
        } else {
            alert('‚ùå –ù–µ—Ç –º–µ—Ç–æ–∫ —Ä—è–¥–æ–º');
        }
    }
    
    // ============ –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ============
    function selectTool(tool) {
        selectedTool = tool;
        document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
        event.target.closest('.tool-btn').classList.add('active');
    }
    
    function showCommentModal() {
        const comment = prompt('–í–≤–µ–¥–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –º–µ—Ç–∫–µ (–Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):', '');
        if (comment !== null) {
            addMarker(pendingCommentData.coords, pendingCommentData.type, comment.trim());
        }
        pendingCommentData = null;
    }
    
    function updateUI() {
        document.getElementById('markerCount').textContent = markers.length;
        document.getElementById('points').textContent = points;
        document.getElementById('activity').textContent = activity;
        
        const rank = calculateRank();
        document.getElementById('userRank').textContent = rank.name;
        document.getElementById('rankPoints').textContent = rank.progress + '%';
        
        // –í—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º 1 –æ–Ω–ª–∞–π–Ω (—Ç–∞–∫ –∫–∞–∫ –æ–Ω–ª–∞–π–Ω —Å—Ç–∞—Ç—É—Å –≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–µ–Ω)
        document.getElementById('onlineCount').textContent = "1";
        document.getElementById('playersOnline').textContent = "1";
        document.getElementById('modalOnlineCount').textContent = "1";
        document.getElementById('onlineIndicator').innerHTML = '<i class="fas fa-wifi"></i> 1';
    }
    
    function calculateRank() {
        if (activity >= 100) return { name: '–ö–æ–º–∏—Å—Å–∞—Ä', progress: 100 };
        if (activity >= 50) return { name: '–î–µ—Ç–µ–∫—Ç–∏–≤', progress: Math.min(100, (activity - 50) * 2) };
        if (activity >= 20) return { name: '–°–µ—Ä–∂–∞–Ω—Ç', progress: Math.min(100, (activity - 20) * 3.33) };
        if (activity >= 5) return { name: '–ü–∞—Ç—Ä—É–ª—å–Ω—ã–π', progress: Math.min(100, (activity - 5) * 6.67) };
        return { name: '–ù–æ–≤–∏—á–æ–∫', progress: Math.min(100, activity * 20) };
    }
    
    function checkMarkerLimit() {
        const limitElement = document.getElementById('markerLimit');
        if (markers.length >= MAX_MARKERS * 0.9) {
            limitElement.style.display = 'block';
        } else {
            limitElement.style.display = 'none';
        }
    }
    
    function startAutoDeleteChecker() {
        if (autoDeleteInterval) clearInterval(autoDeleteInterval);
        
        autoDeleteInterval = setInterval(() => {
            const now = Date.now();
            const initialCount = markers.length;
            
            markers = markers.filter(marker => {
                if (now - marker.timestamp > EXPIRATION_TIME) {
                    if (marker.placemark && ymap) {
                        ymap.geoObjects.remove(marker.placemark);
                    }
                    return false;
                }
                return true;
            });
            
            if (markers.length < initialCount) {
                updateUI();
                checkMarkerLimit();
                
                if (isFirebaseReady) {
                    syncToFirebase();
                } else {
                    saveToLocalStorage();
                }
                
                console.log(`–ê–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏–µ: —É–¥–∞–ª–µ–Ω–æ ${initialCount - markers.length} —Å—Ç–∞—Ä—ã—Ö –º–µ—Ç–æ–∫`);
            }
        }, 60000);
    }
    
    function loadUserData() {
        try {
            const savedData = localStorage.getItem('user_data_' + window.userId);
            if (savedData) {
                const data = JSON.parse(savedData);
                points = data.points || points;
                activity = data.activity || activity;
                updateUI();
            }
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', e);
        }
    }
    
    function showError(message) {
        document.getElementById('loading').innerHTML = `
            <i class="fas fa-exclamation-triangle" style="font-size: 2.5rem; margin-bottom: 20px; color: #f44336;"></i>
            <p style="color: #f44336; font-size: 1.1rem;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p>
            <p style="color: #ff9800; font-size: 0.9rem; margin-top: 10px;">${message}</p>
        `;
    }
    
    // ============ –¢–ï–°–¢ FIREBASE ============
    function testFirebase() {
        if (!firebaseDatabase) {
            console.error('Firebase –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
            return;
        }
        
        const testRef = firebaseDatabase.ref('test');
        const testData = {
            testTime: Date.now(),
            message: '–¢–µ—Å—Ç –æ—Ç ' + window.userName,
            status: 'working'
        };
        
        testRef.set(testData, function(error) {
            if (error) {
                console.error('‚ùå –¢–µ—Å—Ç Firebase –Ω–µ –ø—Ä–æ–π–¥–µ–Ω:', error);
                alert('Firebase –æ—à–∏–±–∫–∞: ' + error.message);
            } else {
                console.log('‚úÖ Firebase —Ç–µ—Å—Ç –ø—Ä–æ–π–¥–µ–Ω!');
                alert('Firebase —Ä–∞–±–æ—Ç–∞–µ—Ç! –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã.');
            }
        });
    }
    
    // ============ –ó–ê–ü–£–°–ö –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ============
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM –∑–∞–≥—Ä—É–∂–µ–Ω, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Telegram...');
        initTelegram();
    });
    
    // –≠–∫—Å–ø–æ—Ä—Ç —Ñ—É–Ω–∫—Ü–∏–π –¥–ª—è –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
    window.startGame = startGame;
    window.skipIntro = skipIntro;
    window.selectTool = selectTool;
    window.openRulesModal = openRulesModal;
    window.openPlayersModal = openPlayersModal;
    window.openControlsModal = openControlsModal;
    window.closeModal = closeModal;
    window.deleteMarker = deleteMarker;
    window.deleteMarkerFromBalloon = deleteMarkerFromBalloon;
    window.testFirebase = testFirebase;
</script>
