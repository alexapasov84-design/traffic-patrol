<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–æ–ª–∏—Ü–∏—è –ú–∞–π–∞–º–∏üëÆ‚Äç‚ôÇÔ∏èüöîüëÆ‚Äç‚ôÇÔ∏è</title>
    
    <!-- Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Firebase SDK –≤–µ—Ä—Å–∏–∏ 8.10.0 -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://api-maps.yandex.ru/2.1/?apikey=365e247d-d853-4425-b9cc-13bfa1169a49&lang=ru_RU"></script>
    
    <style>
        /* ... –í–°–ï –°–¢–ò–õ–ò –û–°–¢–ê–Æ–¢–°–Ø –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô ... */
        /* (–ø–æ–ª–Ω—ã–µ —Å—Ç–∏–ª–∏ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –∫–æ–¥–∞) */
    </style>
</head>
<body>
    <!-- –ó–∞—Å—Ç–∞–≤–∫–∞ -->
    <div id="splashScreen" class="splash-screen">
        <img src="https://static.craftum.com/9F-qvclCZh6dtPwdnNtlBy-tW_0=/380x0/filters:no_upscale()/https://274418.selcdn.ru/cv08300-33250f0d-0664-43fc-9dbf-9d89738d114e/uploads/655846/14f3a178-0a4b-4df5-bf77-949d65a34e3a.jpg" 
             class="splash-image" 
             alt="–ü–æ–ª–∏—Ü–∏—è –ú–∞–π–∞–º–∏"
             onerror="this.style.display='none'; document.querySelector('.image-overlay').style.background='#0a1931';">
        
        <div class="image-overlay"></div>
        
        <div class="splash-content">
            <div class="auto-start-timer" id="autoStartTimer">
                –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑: <span id="countdown">20</span> —Å–µ–∫
            </div>
            
            <div class="splash-header">
                <h1 class="splash-title">üëÆ‚Äç‚ôÇÔ∏è –ü–æ–ª–∏—Ü–∏—è –ú–∞–π–∞–º–∏ üöî</h1>
                <p class="splash-subtitle" id="userWelcome">–ú—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä–Ω–∞—è –∏–≥—Ä–∞</p>
            </div>
            
            <div class="splash-center">
                <div class="menu-buttons">
                    <button class="menu-btn" onclick="openRulesModal()">
                        <i class="fas fa-book"></i> –ü—Ä–∞–≤–∏–ª–∞ –∏–≥—Ä—ã
                    </button>
                    <button class="menu-btn" onclick="openPlayersModal()">
                        <i class="fas fa-users"></i> –ú—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä
                    </button>
                    <button class="menu-btn" onclick="openControlsModal()">
                        <i class="fas fa-gamepad"></i> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
                    </button>
                </div>
            </div>
            
            <div class="splash-buttons">
                <button class="start-btn" onclick="startGame()">
                    <i class="fas fa-play-circle"></i>
                    –ù–ê–ß–ê–¢–¨ –ò–ì–†–£
                </button>
                
                <button class="skip-intro-btn" onclick="skipIntro()">
                    <i class="fas fa-forward"></i>
                    –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –∑–∞—Å—Ç–∞–≤–∫—É
                </button>
                
                <div class="tg-badge-bottom">
                    <i class="fab fa-telegram"></i> Telegram Mini App
                </div>
            </div>
        </div>
    </div>
    
    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∏–≥—Ä–æ–≤–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å -->
    <div class="app" id="mainApp">
        <div class="header">
            <h1><i class="fas fa-police-car"></i> –ü–æ–ª–∏—Ü–∏—è –ú–∞–π–∞–º–∏ üëÆ‚Äç‚ôÇÔ∏èüöî</h1>
            <div class="header-stats">
                <span>–ú–µ—Ç–æ–∫: <span id="markerCount">0</span>/<span id="maxMarkers">40</span></span>
                <span>–û—á–∫–∏: <span id="points">100</span></span>
                <span>–û–Ω–ª–∞–π–Ω: <span id="onlineCount">1</span></span>
            </div>
        </div>
        
        <div class="map-container">
            <div id="yandex-map"></div>
            <div id="loading" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                <i class="fas fa-sync fa-spin" style="font-size: 2.5rem; margin-bottom: 20px; color: #4fc3f7;"></i>
                <p style="color: #81c784; font-size: 1.1rem;">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç...</p>
                <p id="syncStatus" style="color: #4fc3f7; font-size: 0.9rem; margin-top: 10px;">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Firebase...</p>
            </div>
            <div class="marker-limit" id="markerLimit" style="display: none;">
                üî¥ –õ–∏–º–∏—Ç: 40 –º–µ—Ç–æ–∫
            </div>
        </div>
        
        <div class="tools">
            <button class="tool-btn active" onclick="selectTool('police')">
                <i class="fas fa-siren" style="font-size: 1.2em;"></i>
                <span>–ü–∞—Ç—Ä—É–ª—å</span>
            </button>
            <button class="tool-btn" onclick="selectTool('accident')">
                <i class="fas fa-car-crash"></i>
                <span>–î–¢–ü</span>
            </button>
            <button class="tool-btn" onclick="selectTool('help')">
                <i class="fas fa-flag"></i>
                <span>–ü–æ–º–æ—â—å</span>
            </button>
            <button class="tool-btn" onclick="selectTool('hazard')">
                <i class="fas fa-traffic-light"></i>
                <span>–ü—Ä–æ–±–∫–∞</span>
            </button>
            <button class="tool-btn" onclick="selectTool('clear')">
                <i class="fas fa-trash-alt"></i>
                <span>–£–¥–∞–ª–∏—Ç—å</span>
            </button>
        </div>
        
        <div class="stats">
            <div>
                <div class="stat-value" id="activity">0</div>
                <div>–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</div>
            </div>
            <div>
                <div class="stat-value" id="rankPoints">100%</div>
                <div>–ü—Ä–æ–≥—Ä–µ—Å—Å</div>
            </div>
            <div>
                <div class="stat-value" id="userRank">–ù–æ–≤–∏—á–æ–∫</div>
                <div>–†–∞–Ω–≥</div>
            </div>
        </div>
        
        <!-- –ö–Ω–æ–ø–∫–∞ —á–∞—Ç–∞ -->
        <button id="chatButton" class="chat-button" onclick="toggleChatWindow()">
            <i class="fas fa-comments"></i>
            <div class="chat-badge" id="chatBadge" style="display: none;">0</div>
        </button>
        
        <!-- –û–∫–Ω–æ —á–∞—Ç–∞ -->
        <div id="chatWindow" class="chat-window">
            <div class="chat-header">
                <h3><i class="fas fa-comments"></i> –ß–∞—Ç –∏–≥—Ä—ã</h3>
                <button class="chat-close" onclick="toggleChatWindow()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="chat-messages" id="chatMessages">
                <div class="chat-message system">
                    <span class="message-author">üö® –°–∏—Å—Ç–µ–º–∞:</span>
                    <span class="message-text">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –∏–≥—Ä—É!</span>
                    <span class="message-time" id="systemMessageTime"></span>
                </div>
            </div>
            <div class="chat-input-container">
                <input type="text" 
                       class="chat-input" 
                       id="chatInput" 
                       placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (–¥–æ 30 —Å–∏–º–≤–æ–ª–æ–≤)..."
                       maxlength="30"
                       onkeypress="handleChatKeyPress(event)">
                <button class="chat-send" onclick="sendChatMessage()">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ -->
    <div id="rulesModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-book"></i> –ü—Ä–∞–≤–∏–ª–∞ –∏–≥—Ä—ã</h2>
                <button class="modal-close" onclick="closeModal('rulesModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="rules-section">
                    <h3><i class="fas fa-exclamation-triangle"></i> –í–ê–ñ–ù–û–ï –£–í–ï–î–û–ú–õ–ï–ù–ò–ï</h3>
                    <p>–î–∞–Ω–Ω–∞—è –∏–≥—Ä–∞ —Å–æ–∑–¥–∞–Ω–∞ <strong>–∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ –≤ –æ–∑–Ω–∞–∫–æ–º–∏—Ç–µ–ª—å–Ω—ã—Ö —Ü–µ–ª—è—Ö –∏ –¥–ª—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π –ø–æ–º–æ—â–∏ –Ω–∞ –¥–æ—Ä–æ–≥–µ</strong>.</p>
                    <p style="color: #ff9800; margin-top: 10px;">
                        <strong>–ó–∞ –ª—é–±—ã–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ —Å–∏—Ç—É–∞—Ü–∏—è–º–∏, —Å–æ–±—ã—Ç–∏—è–º–∏ –∏–ª–∏ –ª–∏—Ü–∞–º–∏ –∞–≤—Ç–æ—Ä –∏–≥—Ä—ã –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –Ω–µ –Ω–µ—Å—ë—Ç.</strong>
                    </p>
                    <p style="margin-top: 10px;">–ò–≥—Ä–∞ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º –ø–æ–ª–∏—Ü–∏–∏ –∏ –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏ —ç–∫—Å—Ç—Ä–µ–Ω–Ω—ã—Ö —Å–ª—É–∂–±.</p>
                </div>
                
                <div class="rules-section">
                    <h3><i class="fas fa-users"></i> –ú—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä</h3>
                    <p>–í—Å–µ –∏–≥—Ä–æ–∫–∏ –≤–∏–¥—è—Ç –æ–¥–Ω–∏ –∏ —Ç–µ –∂–µ –º–µ—Ç–∫–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ —á–µ—Ä–µ–∑ Firebase Cloud.</p>
                    <p>–°–æ–∑–¥–∞–≤–∞–π—Ç–µ –º–µ—Ç–∫–∏, —á—Ç–æ–±—ã –ø—Ä–µ–¥—É–ø—Ä–µ–¥–∏—Ç—å –¥—Ä—É–≥–∏—Ö –∏–≥—Ä–æ–∫–æ–≤ –æ —Å–∏—Ç—É–∞—Ü–∏–∏ –Ω–∞ –¥–æ—Ä–æ–≥–µ.</p>
                </div>
                
                <div class="rules-section">
                    <h3><i class="fas fa-sync"></i> –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è</h3>
                    <p>–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –±–ª–∞–≥–æ–¥–∞—Ä—è Firebase Realtime Database.</p>
                    <p>–ù–æ–≤—ã–µ –º–µ—Ç–∫–∏ –ø–æ—è–≤–ª—è—é—Ç—Å—è —É –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤ –≤ —Ç–µ—á–µ–Ω–∏–µ 1-2 —Å–µ–∫—É–Ω–¥.</p>
                </div>
                
                <div class="rules-section">
                    <h3><i class="fas fa-database"></i> –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è</h3>
                    <p>–ú–∞–∫—Å–∏–º—É–º <span id="rulesMaxMarkers">40</span> –º–µ—Ç–æ–∫ –Ω–∞ –≤—Å—é –∏–≥—Ä—É.</p>
                    <p><strong>–ú–µ—Ç–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ 3 —á–∞—Å–∞!</strong></p>
                    <p>–≠—Ç–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–∞ Firebase –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.</p>
                </div>
                
                <div class="rules-section">
                    <h3><i class="fas fa-trophy"></i> –†–µ–π—Ç–∏–Ω–≥</h3>
                    <p>–ó–∞—Ä–∞–±–∞—Ç—ã–≤–∞–π—Ç–µ –æ—á–∫–∏ –∑–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª–µ–∑–Ω—ã—Ö –º–µ—Ç–æ–∫.</p>
                    <p>–ß–µ–º –∞–∫—Ç–∏–≤–Ω–µ–µ –≤—ã –ø–æ–º–æ–≥–∞–µ—Ç–µ –¥—Ä—É–≥–∏–º –∏–≥—Ä–æ–∫–∞–º - —Ç–µ–º –≤—ã—à–µ –≤–∞—à —Ä–∞–Ω–≥!</p>
                    <p>–†–∞–Ω–≥–∏: –ù–æ–≤–∏—á–æ–∫ ‚Üí –ü–∞—Ç—Ä—É–ª—å–Ω—ã–π ‚Üí –°–µ—Ä–∂–∞–Ω—Ç ‚Üí –î–µ—Ç–µ–∫—Ç–∏–≤ ‚Üí –ö–æ–º–∏—Å—Å–∞—Ä</p>
                </div>
                
                <div class="rules-section">
                    <h3><i class="fas fa-comments"></i> –ò–≥—Ä–æ–≤–æ–π —á–∞—Ç</h3>
                    <p>1. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —á–∞—Ç –¥–ª—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏–∏ –¥–µ–π—Å—Ç–≤–∏–π</p>
                    <p>2. –°–æ–æ–±—â–∞–π—Ç–µ –æ –Ω–æ–≤—ã—Ö –º–µ—Ç–∫–∞—Ö –∏ —É–¥–∞–ª–µ–Ω–∏—è—Ö</p>
                    <p>3. –ù–µ —Å–ø–∞–º—å—Ç–µ –∏ –Ω–µ –Ω–∞—Ä—É—à–∞–π—Ç–µ –ø—Ä–∞–≤–∏–ª–∞ –æ–±—â–µ–Ω–∏—è</p>
                    <p>4. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è: 30 —Å–∏–º–≤–æ–ª–æ–≤</p>
                </div>
                
                <div class="rules-section">
                    <h3><i class="fas fa-phone"></i> –†–µ–∞–ª—å–Ω–∞—è –ø–æ–º–æ—â—å</h3>
                    <p>–í —Å–ª—É—á–∞–µ —Ä–µ–∞–ª—å–Ω–æ–π –∞–≤–∞—Ä–∏–∏ –∏–ª–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø–æ–º–æ—â–∏:</p>
                    <p style="color: #f44336;"><strong>–ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ –∑–≤–æ–Ω–∏—Ç–µ –ø–æ –Ω–æ–º–µ—Ä—É 112!</strong></p>
                    <p>–≠—Ç–∞ –∏–≥—Ä–∞ –ù–ï –∑–∞–º–µ–Ω—è–µ—Ç –≤—ã–∑–æ–≤ —Ä–µ–∞–ª—å–Ω—ã—Ö —ç–∫—Å—Ç—Ä–µ–Ω–Ω—ã—Ö —Å–ª—É–∂–±.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏–≥—Ä–æ–∫–æ–≤ -->
    <div id="playersModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-users"></i> –ú—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä</h2>
                <button class="modal-close" onclick="closeModal('playersModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="players-list" id="playersList">
                    <p style="text-align: center; color: #aaa;">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –∏–≥—Ä–æ–∫–æ–≤...</p>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <p><i class="fas fa-info-circle"></i> –ò–≥—Ä–æ–∫–æ–≤ –æ–Ω–ª–∞–π–Ω: <span id="modalOnlineCount">1</span></p>
                    <p style="color: #aaa; font-size: 0.9rem; margin-top: 10px;">
                        –¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
    <div id="controlsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-gamepad"></i> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h2>
                <button class="modal-close" onclick="closeModal('controlsModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="rules-section">
                    <h3><i class="fas fa-mouse-pointer"></i> –û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</h3>
                    <p>1. –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –º–µ—Ç–∫–∏ –≤ –ø–∞–Ω–µ–ª–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤</p>
                    <p>2. –ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –º–µ—Ç–∫–∏</p>
                    <p>3. –î–ª—è —É–¥–∞–ª–µ–Ω–∏—è: –≤—ã–±–µ—Ä–∏—Ç–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç "–£–¥–∞–ª–∏—Ç—å" –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ –∫—Ä–µ—Å—Ç–∏–∫ –Ω–∞ –º–µ—Ç–∫–µ</p>
                    <p>4. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –Ω–∞ –∫–∞—Ä—Ç–µ –¥–ª—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –∫ —Å–≤–æ–µ–º—É –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—é</p>
                    <p>5. –ú–µ—Ç–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ –≤—Å–µ–º–∏ –∏–≥—Ä–æ–∫–∞–º–∏</p>
                </div>
                
                <div class="rules-section">
                    <h3><i class="fas fa-comments"></i> –ò–≥—Ä–æ–≤–æ–π —á–∞—Ç</h3>
                    <p>‚Ä¢ –ù–∞–∂–º–∏—Ç–µ –Ω–∞ —Å–∏–Ω—é—é –∫–Ω–æ–ø–∫—É –≤ –ø—Ä–∞–≤–æ–º –Ω–∏–∂–Ω–µ–º —É–≥–ª—É</p>
                    <p>‚Ä¢ –ö—Ä–∞—Å–Ω—ã–π –∑–Ω–∞—á–æ–∫ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è</p>
                    <p>‚Ä¢ –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è: 30 —Å–∏–º–≤–æ–ª–æ–≤</p>
                </div>
                
                <div class="rules-section">
                    <h3><i class="fas fa-bell"></i> –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h3>
                    <p>–ß–∞—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç:</p>
                    <p>‚Ä¢ –ù–æ–≤—ã–µ –º–µ—Ç–∫–∏ –Ω–∞ –∫–∞—Ä—Ç–µ</p>
                    <p>‚Ä¢ –£–¥–∞–ª–µ–Ω–∏—è –º–µ—Ç–æ–∫</p>
                    <p>‚Ä¢ –°–æ–æ–±—â–µ–Ω–∏—è –¥—Ä—É–≥–∏—Ö –∏–≥—Ä–æ–∫–æ–≤</p>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è -->
    <div id="commentModal" class="comment-modal">
        <div class="comment-modal-content">
            <div class="comment-header">
                <h2><i class="fas fa-comment"></i> –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –º–µ—Ç–∫–µ</h2>
                <button class="modal-close" onclick="closeCommentModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="comment-input-container">
                    <input type="text" 
                           class="comment-input" 
                           id="commentText" 
                           placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–¥–æ 30 —Å–∏–º–≤–æ–ª–æ–≤)..."
                           maxlength="30"
                           oninput="updateCommentChars()">
                    <div class="comment-chars" id="commentChars">0/30</div>
                </div>
                <div class="comment-buttons">
                    <button class="comment-btn skip" onclick="addMarkerWithoutComment()">
                        –ë–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
                    </button>
                    <button class="comment-btn add" id="addWithCommentBtn" onclick="addMarkerWithComment()" disabled>
                        –î–æ–±–∞–≤–∏—Ç—å
                    </button>
                </div>
                <div class="comment-info">
                    –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –±—É–¥–µ—Ç –≤–∏–¥–µ–Ω –≤—Å–µ–º –∏–≥—Ä–æ–∫–∞–º –Ω–∞ –∫–∞—Ä—Ç–µ
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============ –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø FIREBASE ============
        const firebaseConfig = {
            apiKey: "AIzaSyD0zwcRZs7mI0RzPq3O18WOIWjhUO6yKZQ",
            authDomain: "miami-police-game.firebaseapp.com",
            databaseURL: "https://miami-police-game-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "miami-police-game",
            storageBucket: "miami-police-game.firebasestorage.app",
            messagingSenderId: "4861394604",
            appId: "1:4861394604:web:f2acb3a189f99396a66909"
        };
        
        // ============ –ö–û–ù–°–¢–ê–ù–¢–´ –ò–ì–†–´ ============
        const tg = window.Telegram.WebApp;
        const MAX_MARKERS = 40;
        const MARKER_LIFETIME = 3 * 60 * 60 * 1000;
        const ONLINE_TIMEOUT = 30000;
        const MAX_CHAT_CHARS = 30;
        const MAX_COMMENT_CHARS = 30;
        const CACHE_KEY = 'miami_police_markers_cache';
        const CACHE_EXPIRY = 5 * 60 * 1000; // 5 –º–∏–Ω—É—Ç –∫—ç—à
        
        // –¢–∏–ø—ã –º–µ—Ç–æ–∫, –∫–æ—Ç–æ—Ä—ã–µ —Ç—Ä–µ–±—É—é—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
        const TOOLS_WITH_COMMENT = ['police', 'accident', 'help'];
        
        // ============ –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ============
        let telegramUser = null;
        let firebaseApp = null;
        let firebaseDatabase = null;
        let ymap = null;
        
        let markers = {};
        let selectedTool = 'police';
        let points = 100;
        let activity = 0;
        let pendingMarkerData = null;
        
        let onlinePlayers = {};
        let currentUserId = null;
        let currentUserName = '–ì–æ—Å—Ç—å';
        
        let chatWindowOpen = false;
        let unreadMessages = 0;
        let autoStartInterval = null;
        let countdownSeconds = 20;
        
        // ============ LOCALSTORAGE –ö–≠–® ============
        function saveMarkersToCache() {
            try {
                const cacheData = {
                    markers: markers,
                    timestamp: Date.now(),
                    userId: currentUserId
                };
                localStorage.setItem(CACHE_KEY, JSON.stringify(cacheData));
                console.log('‚úÖ –ú–µ—Ç–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –∫—ç—à');
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –∫—ç—à:', error);
            }
        }
        
        function loadMarkersFromCache() {
            try {
                const cachedData = localStorage.getItem(CACHE_KEY);
                if (!cachedData) return false;
                
                const data = JSON.parse(cachedData);
                const now = Date.now();
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ä–æ–∫ –≥–æ–¥–Ω–æ—Å—Ç–∏ –∫—ç—à–∞ (5 –º–∏–Ω—É—Ç)
                if (now - data.timestamp > CACHE_EXPIRY) {
                    console.log('–ö—ç—à —É—Å—Ç–∞—Ä–µ–ª, —É–¥–∞–ª—è–µ–º');
                    localStorage.removeItem(CACHE_KEY);
                    return false;
                }
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –º–µ—Ç–∫–∏ –∏–∑ –∫—ç—à–∞
                markers = data.markers || {};
                console.log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${Object.keys(markers).length} –º–µ—Ç–æ–∫ –∏–∑ –∫—ç—à–∞`);
                
                // –ï—Å–ª–∏ –∫–∞—Ä—Ç–∞ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞, –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –º–µ—Ç–∫–∏
                if (ymap) {
                    displayCachedMarkers();
                }
                
                updateMarkerCount();
                return true;
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ –∫—ç—à–∞:', error);
                return false;
            }
        }
        
        function displayCachedMarkers() {
            const now = Date.now();
            let displayedCount = 0;
            
            Object.entries(markers).forEach(([markerId, markerData]) => {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∏—Å—Ç–µ–∫–ª–æ –ª–∏ –≤—Ä–µ–º—è –º–µ—Ç–∫–∏
                if (markerData.isActive && now - markerData.timestamp < MARKER_LIFETIME) {
                    addMarkerToMap(markerId, markerData);
                    displayedCount++;
                }
            });
            
            console.log(`–û—Ç–æ–±—Ä–∞–∂–µ–Ω–æ ${displayedCount} –º–µ—Ç–æ–∫ –∏–∑ –∫—ç—à–∞`);
        }
        
        function clearOldCache() {
            try {
                const cachedData = localStorage.getItem(CACHE_KEY);
                if (!cachedData) return;
                
                const data = JSON.parse(cachedData);
                const now = Date.now();
                
                // –£–¥–∞–ª—è–µ–º –∫—ç—à —Å—Ç–∞—Ä—à–µ 1 –¥–Ω—è
                if (now - data.timestamp > 24 * 60 * 60 * 1000) {
                    localStorage.removeItem(CACHE_KEY);
                    console.log('–£–¥–∞–ª–µ–Ω —Å—Ç–∞—Ä—ã–π –∫—ç—à');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –∫—ç—à–∞:', error);
            }
        }
        
        // ============ –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø TELEGRAM ============
        function initTelegram() {
            console.log('Initializing Telegram Web App...');
            
            const version = parseFloat(tg.version) || 6.0;
            console.log('Telegram WebApp version:', version);
            
            if (version >= 6.1) {
                tg.expand();
            }
            
            telegramUser = tg.initDataUnsafe?.user;
            
            if (telegramUser) {
                currentUserName = telegramUser.first_name || telegramUser.username || '–ò–≥—Ä–æ–∫';
                currentUserId = telegramUser.id.toString();
                document.getElementById('userWelcome').textContent = `–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${currentUserName}!`;
            } else {
                currentUserName = '–ì–æ—Å—Ç—å_' + Math.random().toString(36).substr(2, 6);
                currentUserId = 'guest_' + Math.random().toString(36).substr(2, 9);
                document.getElementById('userWelcome').textContent = '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –∏–≥—Ä—É!';
            }
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Ä–µ–º—è –¥–ª—è —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
            const now = new Date();
            document.getElementById('systemMessageTime').textContent = 
                now.getHours().toString().padStart(2, '0') + ':' + 
                now.getMinutes().toString().padStart(2, '0');
            
            startAutoStartTimer();
            initFirebase();
            
            // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–π –∫—ç—à –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
            clearOldCache();
        }
        
        // ============ –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø FIREBASE ============
        function initFirebase() {
            try {
                if (typeof firebase === 'undefined') {
                    console.error('Firebase –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω!');
                    document.getElementById('syncStatus').textContent = 'Firebase –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω';
                    document.getElementById('syncStatus').style.color = '#f44336';
                    
                    // –ü—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ –∫—ç—à–∞ –µ—Å–ª–∏ Firebase –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
                    const loadedFromCache = loadMarkersFromCache();
                    if (loadedFromCache) {
                        document.getElementById('syncStatus').textContent = '–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫—ç—à';
                    }
                    return;
                }
                
                firebaseApp = firebase.initializeApp(firebaseConfig);
                firebaseDatabase = firebase.database();
                
                console.log('‚úÖ Firebase —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω!');
                
                const syncStatus = document.getElementById('syncStatus');
                if (syncStatus) {
                    syncStatus.textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ Firebase ‚úì';
                    syncStatus.style.color = '#4CAF50';
                }
                
                // –°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∂–∞–µ–º –∏–∑ –∫—ç—à–∞ –¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                const loadedFromCache = loadMarkersFromCache();
                
                // –ó–∞—Ç–µ–º –∑–∞–≥—Ä—É–∂–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ Firebase
                loadAllMarkers();
                setupFirebaseListeners();
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ Firebase:', error);
                
                const syncStatus = document.getElementById('syncStatus');
                if (syncStatus) {
                    syncStatus.textContent = 'Firebase –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω';
                    syncStatus.style.color = '#FF9800';
                }
                
                // –ü—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ –∫—ç—à–∞ –µ—Å–ª–∏ Firebase —É–ø–∞–ª
                const loadedFromCache = loadMarkersFromCache();
                if (loadedFromCache) {
                    addChatMessage('system', '‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è –∫–∞—Ä—Ç—ã');
                } else {
                    addChatMessage('system', '‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ');
                }
            }
        }
        
        // –§–ò–ö–°: –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –í–°–ï–• –º–µ—Ç–æ–∫ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        function loadAllMarkers() {
            const markersRef = firebaseDatabase.ref('markers');
            
            markersRef.once('value').then((snapshot) => {
                const allMarkers = snapshot.val() || {};
                const now = Date.now();
                let loadedCount = 0;
                
                console.log(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${Object.keys(allMarkers).length} –º–µ—Ç–æ–∫ –∏–∑ Firebase`);
                
                // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –º–µ—Ç–∫–∏ —Å –∫–∞—Ä—Ç—ã
                if (ymap) {
                    ymap.geoObjects.removeAll();
                }
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
                markers = {};
                
                Object.entries(allMarkers).forEach(([markerId, markerData]) => {
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ –º–µ—Ç–∫–∏, –Ω–µ —Å—Ç–∞—Ä—à–µ 3 —á–∞—Å–æ–≤
                    if (markerData.isActive && now - markerData.timestamp < MARKER_LIFETIME) {
                        markers[markerId] = markerData;
                        loadedCount++;
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞ –∫–∞—Ä—Ç—É –µ—Å–ª–∏ –æ–Ω–∞ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞
                        if (ymap) {
                            addMarkerToMap(markerId, markerData);
                        }
                    }
                });
                
                updateMarkerCount();
                console.log(`–û—Ç–æ–±—Ä–∞–∂–µ–Ω–æ ${loadedCount} –∞–∫—Ç–∏–≤–Ω—ã—Ö –º–µ—Ç–æ–∫`);
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à
                saveMarkersToCache();
                
            }).catch(error => {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ—Ç–æ–∫ –∏–∑ Firebase:', error);
            });
        }
        
        // ============ –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø FIREBASE ============
        function setupFirebaseListeners() {
            const markersRef = firebaseDatabase.ref('markers');
            
            // –°–ª—É—à–∞–µ–º –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –º–µ—Ç–æ–∫
            markersRef.on('child_added', (snapshot) => {
                const markerId = snapshot.key;
                const markerData = snapshot.val();
                const now = Date.now();
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º–µ—Ç–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞ –∏ –Ω–µ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–∞
                if (markerData.isActive && now - markerData.timestamp < MARKER_LIFETIME) {
                    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é –≤–µ—Ä—Å–∏—é –º–µ—Ç–∫–∏ –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å
                    if (markers[markerId]) {
                        removeMarkerFromMap(markerId);
                    }
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é –º–µ—Ç–∫—É
                    markers[markerId] = markerData;
                    addMarkerToMap(markerId, markerData);
                    updateMarkerCount();
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à
                    saveMarkersToCache();
                    
                    if (markerData.authorId !== currentUserId) {
                        addChatMessage('system', `üìç ${markerData.author} –¥–æ–±–∞–≤–∏–ª(–∞) –º–µ—Ç–∫—É: ${getMarkerTypeName(markerData.type)}`);
                    }
                }
            });
            
            // –°–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –º–µ—Ç–æ–∫
            markersRef.on('child_changed', (snapshot) => {
                const markerId = snapshot.key;
                const markerData = snapshot.val();
                const now = Date.now();
                
                if (!markerData.isActive && markers[markerId]) {
                    // –ú–µ—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–∞
                    removeMarkerFromMap(markerId);
                    delete markers[markerId];
                    updateMarkerCount();
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à
                    saveMarkersToCache();
                    
                    if (markerData && markerData.type) {
                        addChatMessage('system', `üóëÔ∏è –ú–µ—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–∞: ${getMarkerTypeName(markerData.type)}`);
                    }
                } else if (markerData.isActive && now - markerData.timestamp < MARKER_LIFETIME) {
                    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–µ—Ç–∫–∏
                    if (markers[markerId]) {
                        removeMarkerFromMap(markerId);
                    }
                    markers[markerId] = markerData;
                    addMarkerToMap(markerId, markerData);
                    saveMarkersToCache();
                }
            });
            
            // –°–ª—É—à–∞–µ–º —É–¥–∞–ª–µ–Ω–∏–µ –º–µ—Ç–æ–∫
            markersRef.on('child_removed', (snapshot) => {
                const markerId = snapshot.key;
                if (markers[markerId]) {
                    removeMarkerFromMap(markerId);
                    delete markers[markerId];
                    updateMarkerCount();
                    saveMarkersToCache();
                }
            });
            
            // –°–ª—É—à–∞–µ–º –æ–Ω–ª–∞–π–Ω –∏–≥—Ä–æ–∫–æ–≤
            const onlineRef = firebaseDatabase.ref('online');
            onlineRef.on('value', (snapshot) => {
                const users = snapshot.val() || {};
                onlinePlayers = users;
                updateOnlinePlayers(users);
            });
            
            // –°–ª—É—à–∞–µ–º —á–∞—Ç
            const chatRef = firebaseDatabase.ref('chat');
            chatRef.limitToLast(20).on('child_added', (snapshot) => {
                const message = snapshot.val();
                if (message.authorId !== currentUserId || message.type === 'system') {
                    addChatMessage(message.type, `${message.author}: ${message.text}`);
                }
            });
            
            updateOnlineStatus();
            startCleanupInterval();
        }
        
        function startCleanupInterval() {
            // –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –º–µ—Ç–æ–∫ –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
            setInterval(() => {
                cleanupOldMarkers();
            }, 5 * 60 * 1000);
        }
        
        function updateOnlineStatus() {
            const userStatusRef = firebaseDatabase.ref('online/' + currentUserId);
            
            const userData = {
                name: currentUserName,
                userId: currentUserId,
                lastSeen: Date.now(),
                stats: {
                    markersCreated: activity,
                    points: points,
                    rank: calculateRank().name
                }
            };
            
            userStatusRef.set(userData);
            
            setInterval(() => {
                userData.lastSeen = Date.now();
                userData.stats.markersCreated = activity;
                userData.stats.points = points;
                userData.stats.rank = calculateRank().name;
                userStatusRef.update(userData);
            }, 10000);
            
            userStatusRef.onDisconnect().remove();
        }
        
        function updateOnlinePlayers(users) {
            const now = Date.now();
            const onlineUserIds = Object.keys(users).filter(id => {
                const user = users[id];
                return now - user.lastSeen < ONLINE_TIMEOUT;
            });
            
            const onlineCount = Math.max(1, onlineUserIds.length);
            
            document.getElementById('onlineCount').textContent = onlineCount;
            document.getElementById('modalOnlineCount').textContent = onlineCount;
            
            updatePlayersList(users);
        }
        
        function updatePlayersList(users) {
            const playersList = document.getElementById('playersList');
            if (!playersList) return;
            
            const now = Date.now();
            
            const playersArray = Object.entries(users)
                .filter(([id, user]) => now - user.lastSeen < ONLINE_TIMEOUT)
                .map(([id, user]) => ({
                    id,
                    ...user,
                    isOnline: now - user.lastSeen < ONLINE_TIMEOUT
                }))
                .sort((a, b) => b.stats.points - a.stats.points);
            
            playersList.innerHTML = '';
            
            if (playersArray.length === 0) {
                playersList.innerHTML = '<p style="text-align: center; color: #aaa;">–ù–µ—Ç –∏–≥—Ä–æ–∫–æ–≤ –æ–Ω–ª–∞–π–Ω</p>';
                return;
            }
            
            playersArray.forEach((player, index) => {
                const playerItem = document.createElement('div');
                const rankClass = index === 0 ? 'rank-1' : index === 1 ? 'rank-2' : index === 2 ? 'rank-3' : '';
                playerItem.className = `player-item ${rankClass}`;
                
                const initials = player.name.split(' ').map(n => n[0]).join('').toUpperCase() || '–ì';
                const isCurrentUser = player.id === currentUserId;
                
                playerItem.innerHTML = `
                    <div class="player-info">
                        <div class="player-avatar" style="${isCurrentUser ? 'background: linear-gradient(135deg, #FF9800, #F57C00);' : ''}">
                            ${initials}
                            ${isCurrentUser ? '‚≠ê' : ''}
                            ${index < 3 ? `<div class="player-rank-badge">${index + 1}</div>` : ''}
                        </div>
                        <div class="player-details">
                            <div class="player-name">
                                ${player.name} ${isCurrentUser ? '(–í—ã)' : ''}
                            </div>
                            <div class="player-stats">
                                <span>üèÜ ${player.stats.points} –æ—á–∫–æ–≤</span>
                                <span>üìç ${player.stats.markersCreated} –º–µ—Ç–æ–∫</span>
                                <span class="player-score">${player.stats.rank}</span>
                            </div>
                        </div>
                    </div>
                `;
                
                playersList.appendChild(playerItem);
            });
        }
        
        // ============ –†–ê–ë–û–¢–ê –° –ú–ï–¢–ö–ê–ú–ò ============
        function addMarker(coords, type, comment = null) {
            const activeMarkersCount = Object.values(markers).filter(m => m.isActive).length;
            if (activeMarkersCount >= MAX_MARKERS) {
                alert(`‚ùå –î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç –≤ ${MAX_MARKERS} –º–µ—Ç–æ–∫ –Ω–∞ –∫–∞—Ä—Ç–µ!`);
                return null;
            }
            
            const markerId = firebaseDatabase.ref('markers').push().key;
            const timestamp = Date.now();
            
            const markerData = {
                type: type,
                coords: {
                    lat: coords[0],
                    lng: coords[1]
                },
                comment: comment || '',
                author: currentUserName,
                authorId: currentUserId,
                timestamp: timestamp,
                isActive: true,
                expiresAt: timestamp + MARKER_LIFETIME
            };
            
            firebaseDatabase.ref('markers/' + markerId).set(markerData)
                .then(() => {
                    console.log('‚úÖ –ú–µ—Ç–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ Firebase');
                    
                    points += 10;
                    activity += 1;
                    updateUI();
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ª–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
                    markers[markerId] = markerData;
                    saveMarkersToCache();
                    
                    sendChatMessage(
                        `${currentUserName} –¥–æ–±–∞–≤–∏–ª(–∞) –º–µ—Ç–∫—É: ${getMarkerTypeName(type)}`,
                        'marker_added'
                    );
                    
                })
                .catch(error => {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –º–µ—Ç–∫–∏:', error);
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –º–µ—Ç–∫–∏');
                });
            
            return markerId;
        }
        
        function addMarkerToMap(markerId, markerData) {
            if (!ymap) return;
            
            const iconColor = {
                'police': '#2196F3',
                'accident': '#F44336',
                'help': '#4CAF50',
                'hazard': '#FF9800'
            }[markerData.type] || '#2196F3';
            
            const iconContent = {
                'police': 'üö®',
                'accident': 'üöó',
                'help': 'üÜò',
                'hazard': 'üö¶'
            }[markerData.type] || 'üìç';
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ª–∏ —É–∂–µ —ç—Ç–∞ –º–µ—Ç–∫–∞
            if (markerData.placemark) {
                try {
                    ymap.geoObjects.remove(markerData.placemark);
                } catch (e) {
                    // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫—É –µ—Å–ª–∏ –º–µ—Ç–∫–∏ –Ω–µ—Ç –Ω–∞ –∫–∞—Ä—Ç–µ
                }
            }
            
            const placemark = new ymaps.Placemark(
                [markerData.coords.lat, markerData.coords.lng],
                {
                    balloonContent: `
                        <div style="padding: 10px; max-width: 250px;">
                            <h3 style="margin: 0 0 10px 0; color: ${iconColor}">
                                ${getMarkerTypeName(markerData.type)}
                            </h3>
                            ${markerData.comment ? `<p><strong>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</strong> ${markerData.comment}</p>` : ''}
                            <p><strong>–ê–≤—Ç–æ—Ä:</strong> ${markerData.author}</p>
                            <p><strong>–î–æ–±–∞–≤–ª–µ–Ω–æ:</strong> ${new Date(markerData.timestamp).toLocaleTimeString()}</p>
                            <p><strong>–£–¥–∞–ª–∏—Ç—Å—è —á–µ—Ä–µ–∑:</strong> ${formatTimeRemaining(markerData.expiresAt)}</p>
                            ${markerData.authorId === currentUserId ? `
                            <button onclick="deleteMarker('${markerId}')" 
                                    style="background: #f44336; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; margin-top: 10px;">
                                –£–¥–∞–ª–∏—Ç—å –º–æ—é –º–µ—Ç–∫—É
                            </button>
                            ` : ''}
                        </div>
                    `,
                    iconCaption: markerData.comment || ''
                },
                {
                    preset: 'islands#icon',
                    iconColor: iconColor,
                    iconLayout: 'default#imageWithContent',
                    iconImageHref: '',
                    iconImageSize: [50, 50],
                    iconImageOffset: [-25, -50],
                    iconContentOffset: [0, 0],
                    iconContentLayout: ymaps.templateLayoutFactory.createClass(
                        `<div style="width: 50px; height: 50px; border-radius: 50%; background: ${iconColor}; display: flex; align-items: center; justify-content: center; font-size: 20px; position: relative;">
                            ${iconContent}
                            ${markerData.authorId === currentUserId ? `
                            <button onclick="deleteMarker('${markerId}')" 
                                    style="position: absolute; top: -5px; right: -5px; background: #f44336; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                                √ó
                            </button>
                            ` : ''}
                        </div>`
                    )
                }
            );
            
            placemark.events.add('click', function() {
                placemark.balloon.open();
            });
            
            markerData.placemark = placemark;
            ymap.geoObjects.add(placemark);
        }
        
        function deleteMarker(markerId) {
            if (!markers[markerId]) {
                console.error('–ú–µ—Ç–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞:', markerId);
                alert('–ú–µ—Ç–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –∏–ª–∏ —É–∂–µ —É–¥–∞–ª–µ–Ω–∞');
                return;
            }
            
            const marker = markers[markerId];
            if (!marker) {
                console.error('–ú–µ—Ç–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ:', markerId);
                return;
            }
            
            if (marker.authorId !== currentUserId) {
                alert('–í—ã –º–æ–∂–µ—Ç–µ —É–¥–∞–ª—è—Ç—å —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –º–µ—Ç–∫–∏!');
                return;
            }
            
            const markerType = marker.type;
            
            firebaseDatabase.ref('markers/' + markerId).update({
                isActive: false
            })
            .then(() => {
                console.log('‚úÖ –ú–µ—Ç–∫–∞ –ø–æ–º–µ—á–µ–Ω–∞ –∫–∞–∫ —É–¥–∞–ª–µ–Ω–Ω–∞—è');
                
                points += 5;
                updateUI();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
                markers[markerId].isActive = false;
                saveMarkersToCache();
                
                sendChatMessage(
                    `${currentUserName} —É–¥–∞–ª–∏–ª(–∞) –º–µ—Ç–∫—É: ${getMarkerTypeName(markerType)}`,
                    'marker_deleted'
                );
            })
            .catch(error => {
                console.error('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –º–µ—Ç–∫–∏:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –º–µ—Ç–∫–∏');
            });
        }
        
        function removeMarkerFromMap(markerId) {
            if (markers[markerId] && markers[markerId].placemark && ymap) {
                try {
                    ymap.geoObjects.remove(markers[markerId].placemark);
                } catch (e) {
                    console.warn('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –º–µ—Ç–∫–∏ —Å –∫–∞—Ä—Ç—ã:', e);
                }
                markers[markerId].placemark = null;
            }
        }
        
        function cleanupOldMarkers() {
            const now = Date.now();
            const markersRef = firebaseDatabase.ref('markers');
            
            markersRef.once('value').then((snapshot) => {
                const updates = {};
                snapshot.forEach((childSnapshot) => {
                    const marker = childSnapshot.val();
                    
                    if (now - marker.timestamp > MARKER_LIFETIME && marker.isActive) {
                        updates[childSnapshot.key + '/isActive'] = false;
                    }
                });
                
                if (Object.keys(updates).length > 0) {
                    markersRef.update(updates);
                    console.log(`–ê–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞: —É–¥–∞–ª–µ–Ω–æ ${Object.keys(updates).length / 2} —Å—Ç–∞—Ä—ã—Ö –º–µ—Ç–æ–∫`);
                }
            });
        }
        
        // ============ –ß–ê–¢ ============
        function toggleChatWindow() {
            const chatWindow = document.getElementById('chatWindow');
            const chatButton = document.getElementById('chatButton');
            const chatBadge = document.getElementById('chatBadge');
            
            if (chatWindowOpen) {
                chatWindow.classList.remove('active');
                chatWindowOpen = false;
            } else {
                chatWindow.classList.add('active');
                chatWindowOpen = true;
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
                unreadMessages = 0;
                chatBadge.style.display = 'none';
                
                // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –≤–Ω–∏–∑
                setTimeout(() => {
                    const chatMessages = document.getElementById('chatMessages');
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }, 100);
            }
        }
        
        function sendChatMessage() {
            const chatInput = document.getElementById('chatInput');
            const text = chatInput.value.trim();
            
            if (!text) return;
            
            if (text.length > MAX_CHAT_CHARS) {
                alert(`–°–æ–æ–±—â–µ–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ! –ú–∞–∫—Å–∏–º—É–º ${MAX_CHAT_CHARS} —Å–∏–º–≤–æ–ª–æ–≤.`);
                return;
            }
            
            const messageId = firebaseDatabase.ref('chat').push().key;
            const messageData = {
                text: text,
                author: currentUserName,
                authorId: currentUserId,
                timestamp: Date.now(),
                type: 'user'
            };
            
            firebaseDatabase.ref('chat/' + messageId).set(messageData)
                .then(() => {
                    chatInput.value = '';
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
                    alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è');
                });
        }
        
        function addChatMessage(type, text) {
            const chatMessages = document.getElementById('chatMessages');
            const now = new Date();
            const messageTime = now.getHours().toString().padStart(2, '0') + ':' + 
                              now.getMinutes().toString().padStart(2, '0');
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${type}`;
            messageDiv.innerHTML = `
                <span class="message-author">${type === 'system' ? 'üö® –°–∏—Å—Ç–µ–º–∞:' : ''}</span>
                <span class="message-text">${text}</span>
                <span class="message-time">${messageTime}</span>
            `;
            
            chatMessages.appendChild(messageDiv);
            
            // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –≤–Ω–∏–∑ –µ—Å–ª–∏ —á–∞—Ç –æ—Ç–∫—Ä—ã—Ç
            if (chatWindowOpen) {
                setTimeout(() => {
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }, 100);
            } else {
                // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö
                unreadMessages++;
                const chatBadge = document.getElementById('chatBadge');
                chatBadge.textContent = unreadMessages > 9 ? '9+' : unreadMessages;
                chatBadge.style.display = 'flex';
            }
        }
        
        function handleChatKeyPress(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                sendChatMessage();
            }
        }
        
        // ============ –ö–û–ú–ú–ï–ù–¢–ê–†–ò–ò –ö –ú–ï–¢–ö–ê–ú ============
        function updateCommentChars() {
            const commentText = document.getElementById('commentText');
            const commentChars = document.getElementById('commentChars');
            const addButton = document.getElementById('addWithCommentBtn');
            
            const length = commentText.value.length;
            commentChars.textContent = `${length}/${MAX_COMMENT_CHARS}`;
            
            // –ò–∑–º–µ–Ω—è–µ–º —Ü–≤–µ—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –¥–ª–∏–Ω—ã
            commentChars.className = 'comment-chars';
            if (length > MAX_COMMENT_CHARS * 0.8) {
                commentChars.classList.add('warning');
            }
            if (length > MAX_COMMENT_CHARS) {
                commentChars.classList.add('error');
            }
            
            // –í–∫–ª—é—á–∞–µ–º/–≤—ã–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É
            addButton.disabled = length > MAX_COMMENT_CHARS;
        }
        
        // ============ –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ============
        function getMarkerTypeName(type) {
            const names = {
                'police': '–ü–∞—Ç—Ä—É–ª—å üö®',
                'accident': '–î–¢–ü üöó',
                'help': '–ü–æ–º–æ—â—å üÜò',
                'hazard': '–ü—Ä–æ–±–∫–∞ üö¶'
            };
            return names[type] || '–ú–µ—Ç–∫–∞';
        }
        
        function formatTimeRemaining(expiresAt) {
            const remaining = expiresAt - Date.now();
            const hours = Math.floor(remaining / (1000 * 60 * 60));
            const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
            
            if (hours > 0) {
                return `${hours} —á ${minutes} –º–∏–Ω`;
            } else {
                return `${minutes} –º–∏–Ω—É—Ç`;
            }
        }
        
        function updateMarkerCount() {
            const activeMarkersCount = Object.values(markers).filter(m => m.isActive).length;
            document.getElementById('markerCount').textContent = activeMarkersCount;
            
            const limitElement = document.getElementById('markerLimit');
            if (activeMarkersCount >= MAX_MARKERS * 0.9) {
                limitElement.style.display = 'block';
                limitElement.innerHTML = `üî¥ –õ–∏–º–∏—Ç: ${activeMarkersCount}/${MAX_MARKERS} –º–µ—Ç–æ–∫`;
            } else {
                limitElement.style.display = 'none';
            }
        }
        
        function updateUI() {
            updateMarkerCount();
            document.getElementById('points').textContent = points;
            document.getElementById('activity').textContent = activity;
            
            const rank = calculateRank();
            document.getElementById('userRank').textContent = rank.name;
            document.getElementById('rankPoints').textContent = rank.progress + '%';
        }
        
        function calculateRank() {
            if (activity >= 100) return { name: '–ö–æ–º–∏—Å—Å–∞—Ä', progress: 100 };
            if (activity >= 50) return { name: '–î–µ—Ç–µ–∫—Ç–∏–≤', progress: Math.min(100, (activity - 50) * 2) };
            if (activity >= 20) return { name: '–°–µ—Ä–∂–∞–Ω—Ç', progress: Math.min(100, (activity - 20) * 3.33) };
            if (activity >= 5) return { name: '–ü–∞—Ç—Ä—É–ª—å–Ω—ã–π', progress: Math.min(100, (activity - 5) * 6.67) };
            return { name: '–ù–æ–≤–∏—á–æ–∫', progress: Math.min(100, activity * 20) };
        }
        
        function selectTool(tool) {
            selectedTool = tool;
            document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
            event.target.closest('.tool-btn').classList.add('active');
        }
        
        // ============ –ö–ê–†–¢–ê –ò –ì–ï–û–õ–û–ö–ê–¶–ò–Ø ============
        function initMap() {
            try {
                // –¶–µ–Ω—Ç—Ä –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é - –ë–µ–ª–æ–æ–∑–µ—Ä—Å–∫–∏–π
                let center = [55.459619, 38.438920];
                let zoom = 15;
                let useGeolocation = false;
                
                // –§–ò–ö–°: –£–ª—É—á—à–µ–Ω–Ω–∞—è –≥–µ–æ–ª–æ–∫–∞—Ü–∏—è
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        function(position) {
                            center = [position.coords.latitude, position.coords.longitude];
                            zoom = 17;
                            useGeolocation = true;
                            createMap(center, zoom, useGeolocation);
                        },
                        function(error) {
                            console.warn('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ë–µ–ª–æ–æ–∑–µ—Ä—Å–∫–∏–π:', error);
                            addChatMessage('system', 'üìç –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞—Ä—Ç–∞ –ë–µ–ª–æ–æ–∑–µ—Ä—Å–∫–æ–≥–æ');
                            createMap(center, zoom, useGeolocation);
                        },
                        {
                            enableHighAccuracy: true,
                            timeout: 10000,
                            maximumAge: 60000
                        }
                    );
                } else {
                    console.log('Geolocation API –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
                    addChatMessage('system', 'üìç –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞—Ä—Ç–∞ –ë–µ–ª–æ–æ–∑–µ—Ä—Å–∫–æ–≥–æ');
                    createMap(center, zoom, useGeolocation);
                }
                
                function createMap(centerCoords, zoomLevel, hasGeolocation) {
                    ymap = new ymaps.Map('yandex-map', {
                        center: centerCoords,
                        zoom: zoomLevel,
                        controls: ['zoomControl', 'fullscreenControl', 'typeSelector']
                    });
                    
                    // –§–ò–ö–°: –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ
                    if (hasGeolocation) {
                        const geolocationControl = new ymaps.control.GeolocationControl({
                            options: {
                                noPlacemark: false,
                                position: { right: 10, top: 80 }
                            }
                        });
                        ymap.controls.add(geolocationControl);
                    }
                    
                    document.getElementById('loading').style.display = 'none';
                    
                    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –º–µ—Ç–∫–∏ –∏–∑ –∫—ç—à–∞ –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
                    displayCachedMarkers();
                    
                    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–æ–≤ –ø–æ –∫–∞—Ä—Ç–µ
                    ymap.events.add('click', function(e) {
                        const coords = e.get('coords');
                        
                        if (selectedTool === 'clear') {
                            let closestMarker = null;
                            let minDistance = Infinity;
                            
                            Object.entries(markers).forEach(([id, marker]) => {
                                if (marker.authorId === currentUserId && marker.isActive) {
                                    const distance = Math.sqrt(
                                        Math.pow(marker.coords.lat - coords[0], 2) + 
                                        Math.pow(marker.coords.lng - coords[1], 2)
                                    ) * 111000;
                                    
                                    if (distance < 50 && distance < minDistance) {
                                        minDistance = distance;
                                        closestMarker = { id, marker };
                                    }
                                }
                            });
                            
                            if (closestMarker) {
                                deleteMarker(closestMarker.id);
                            } else {
                                alert('‚ùå –ù–µ—Ç –≤–∞—à–∏—Ö –º–µ—Ç–æ–∫ —Ä—è–¥–æ–º –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è');
                            }
                        } else {
                            pendingMarkerData = { coords, type: selectedTool };
                            
                            // –î–ª—è –º–µ—Ç–∫–∏ "–ü—Ä–æ–±–∫–∞" –Ω–µ —Å–ø—Ä–∞—à–∏–≤–∞–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
                            if (selectedTool === 'hazard') {
                                addMarker(pendingMarkerData.coords, pendingMarkerData.type, null);
                            } else {
                                openCommentModal();
                            }
                        }
                    });
                }
                
                updateUI();
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∫–∞—Ä—Ç—ã:', error);
                document.getElementById('loading').innerHTML = `
                    <i class="fas fa-exclamation-triangle" style="font-size: 2.5rem; margin-bottom: 20px; color: #f44336;"></i>
                    <p style="color: #f44336; font-size: 1.1rem;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç—ã</p>
                    <button onclick="location.reload()" 
                            style="background: #2196f3; color: white; border: none; padding: 10px 20px; border-radius: 10px; margin-top: 20px; cursor: pointer;">
                        –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å
                    </button>
                `;
            }
        }
        
        // ============ –ó–ê–°–¢–ê–í–ö–ê –ò –ó–ê–ü–£–°–ö ============
        function startAutoStartTimer() {
            const countdownElement = document.getElementById('countdown');
            countdownElement.textContent = countdownSeconds;
            
            autoStartInterval = setInterval(() => {
                countdownSeconds--;
                countdownElement.textContent = countdownSeconds;
                
                if (countdownSeconds <= 0) {
                    clearInterval(autoStartInterval);
                    if (document.getElementById('splashScreen').style.display !== 'none') {
                        startGame();
                    }
                }
            }, 1000);
        }
        
        function skipIntro() {
            clearInterval(autoStartInterval);
            transitionToGame();
        }
        
        function startGame() {
            clearInterval(autoStartInterval);
            transitionToGame();
        }
        
        function transitionToGame() {
            const splash = document.getElementById('splashScreen');
            const mainApp = document.getElementById('mainApp');
            
            splash.style.opacity = '0';
            splash.style.transition = 'opacity 0.5s ease';
            
            setTimeout(() => {
                splash.style.display = 'none';
                mainApp.classList.add('active');
                initGame();
            }, 500);
        }
        
        function initGame() {
            console.log('üöî –ó–∞–ø—É—Å–∫ –∏–≥—Ä—ã...');
            
            if (window.ymaps) {
                ymaps.ready(initMap);
            } else {
                document.getElementById('loading').innerHTML = `
                    <i class="fas fa-exclamation-triangle" style="font-size: 2.5rem; margin-bottom: 20px; color: #f44336;"></i>
                    <p style="color: #f44336; font-size: 1.1rem;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç</p>
                `;
            }
        }
        
        // ============ –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê ============
        function openRulesModal() {
            document.getElementById('rulesModal').style.display = 'flex';
        }
        
        function openPlayersModal() {
            document.getElementById('playersModal').style.display = 'flex';
        }
        
        function openControlsModal() {
            document.getElementById('controlsModal').style.display = 'flex';
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        function openCommentModal() {
            document.getElementById('commentText').value = '';
            document.getElementById('commentChars').textContent = '0/30';
            document.getElementById('commentChars').className = 'comment-chars';
            document.getElementById('addWithCommentBtn').disabled = false;
            document.getElementById('commentModal').style.display = 'flex';
        }
        
        function closeCommentModal() {
            document.getElementById('commentModal').style.display = 'none';
            pendingMarkerData = null;
        }
        
        function addMarkerWithComment() {
            if (pendingMarkerData) {
                const comment = document.getElementById('commentText').value.trim();
                if (comment.length > MAX_COMMENT_CHARS) {
                    alert(`–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π! –ú–∞–∫—Å–∏–º—É–º ${MAX_COMMENT_CHARS} —Å–∏–º–≤–æ–ª–æ–≤.`);
                    return;
                }
                addMarker(pendingMarkerData.coords, pendingMarkerData.type, comment || null);
                closeCommentModal();
            }
        }
        
        function addMarkerWithoutComment() {
            if (pendingMarkerData) {
                addMarker(pendingMarkerData.coords, pendingMarkerData.type, null);
                closeCommentModal();
            }
        }
        
        function cleanupBeforeExit() {
            if (firebaseDatabase) {
                firebaseDatabase.ref('markers').off();
                firebaseDatabase.ref('online').off();
                firebaseDatabase.ref('chat').off();
                
                firebaseDatabase.ref('online/' + currentUserId).remove();
            }
        }
        
        // ============ –ó–ê–ü–£–°–ö –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ============
        document.addEventListener('DOMContentLoaded', function() {
            initTelegram();
            
            // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ
            document.addEventListener('click', function(event) {
                const modals = ['rulesModal', 'playersModal', 'controlsModal', 'commentModal'];
                modals.forEach(modalId => {
                    const modal = document.getElementById(modalId);
                    if (event.target === modal) {
                        if (modalId === 'commentModal') {
                            closeCommentModal();
                        } else {
                            closeModal(modalId);
                        }
                    }
                });
                
                // –ó–∞–∫—Ä—ã—Ç–∏–µ —á–∞—Ç–∞ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ
                const chatWindow = document.getElementById('chatWindow');
                const chatButton = document.getElementById('chatButton');
                if (chatWindowOpen && 
                    !chatWindow.contains(event.target) && 
                    !chatButton.contains(event.target) &&
                    event.target !== chatButton) {
                    toggleChatWindow();
                }
            });
            
            // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Ä–∞—Å—Ç—è–≥–∏–≤–∞–Ω–∏–µ –æ–∫–Ω–∞
            document.addEventListener('touchmove', function(e) {
                if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
                    e.preventDefault();
                }
            }, { passive: false });
            
            // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ
            document.addEventListener('gesturestart', function(e) {
                e.preventDefault();
            });
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –º–µ—Ç–∫–∏ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –≤–∫–ª–∞–¥–∫–∏
            window.addEventListener('beforeunload', function() {
                saveMarkersToCache();
            });
        });
        
        // –≠–∫—Å–ø–æ—Ä—Ç —Ñ—É–Ω–∫—Ü–∏–π –¥–ª—è –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
        window.startGame = startGame;
        window.skipIntro = skipIntro;
        window.selectTool = selectTool;
        window.openRulesModal = openRulesModal;
        window.openPlayersModal = openPlayersModal;
        window.openControlsModal = openControlsModal;
        window.closeModal = closeModal;
        window.deleteMarker = deleteMarker;
        window.openCommentModal = openCommentModal;
        window.closeCommentModal = closeCommentModal;
        window.addMarkerWithComment = addMarkerWithComment;
        window.addMarkerWithoutComment = addMarkerWithoutComment;
        window.toggleChatWindow = toggleChatWindow;
        window.sendChatMessage = sendChatMessage;
        window.handleChatKeyPress = handleChatKeyPress;
        window.updateCommentChars = updateCommentChars;
    </script>
</body>
</html>
