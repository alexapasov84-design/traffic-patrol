<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üö® Traffic Patrol - –ö–∞—Ä—Ç–∞ –î–¢–ü –∏ –ü–∞—Ç—Ä—É–ª–µ–π</title>
    
    <!-- Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- –ò–∫–æ–Ω–∫–∏ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* –°–±—Ä–æ—Å –∏ –±–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            touch-action: manipulation;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #1a237e 0%, #311b92 100%);
            color: white;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            position: fixed;
        }
        
        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è */
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100vw;
        }
        
        /* –•–µ–¥–µ—Ä */
        .app-header {
            background: rgba(13, 27, 42, 0.95);
            padding: 12px 16px;
            border-bottom: 3px solid #2196f3;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(10px);
            flex-shrink: 0;
            z-index: 100;
        }
        
        .header-left h1 {
            color: #4fc3f7;
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .header-left h1 i {
            animation: pulse 2s infinite;
        }
        
        .online-stats {
            font-size: 0.85rem;
            color: #81c784;
            margin-top: 4px;
            display: flex;
            gap: 15px;
        }
        
        .user-info {
            text-align: right;
        }
        
        .user-name {
            font-weight: 600;
            font-size: 1.1rem;
            color: #bb86fc;
        }
        
        .user-rank {
            background: rgba(33, 150, 243, 0.2);
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            margin-top: 4px;
            border: 1px solid #2196f3;
            display: inline-block;
        }
        
        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∫–∞—Ä—Ç—ã */
        .map-container {
            flex: 1;
            position: relative;
            margin: 10px;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 3px solid #2196f3;
            background: #0d47a1;
            min-height: 0;
        }
        
        /* Canvas –∫–∞—Ä—Ç—ã */
        #mapCanvas {
            width: 100%;
            height: 100%;
            display: block;
            cursor: crosshair;
        }
        
        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –º–∞—Ä–∫–µ—Ä–æ–≤ */
        #markersContainer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }
        
        /* –°—Ç–∏–ª–∏ –º–∞—Ä–∫–µ—Ä–æ–≤ */
        .marker {
            position: absolute;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.6rem;
            cursor: move;
            transform: translate(-50%, -50%);
            transition: all 0.2s ease;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
            z-index: 20;
            pointer-events: auto;
            touch-action: none;
            user-drag: none;
            -webkit-user-drag: none;
        }
        
        .marker:hover {
            transform: translate(-50%, -50%) scale(1.12);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5);
            z-index: 30;
        }
        
        .marker.police {
            background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
            animation: policePulse 1.5s infinite;
        }
        
        .marker.accident {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
        }
        
        .marker.hazard {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
        }
        
        .marker.dragging {
            opacity: 0.9;
            transform: translate(-50%, -50%) scale(1.25);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6);
            z-index: 1000;
        }
        
        @keyframes policePulse {
            0%, 100% { 
                box-shadow: 0 0 0 0 rgba(33, 150, 243, 0.7);
            }
            50% { 
                box-shadow: 0 0 0 12px rgba(33, 150, 243, 0);
            }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        
        /* –ü–∞–Ω–µ–ª—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ */
        .toolbar {
            display: flex;
            gap: 8px;
            padding: 12px;
            background: rgba(13, 27, 42, 0.95);
            border-top: 2px solid #2196f3;
            flex-shrink: 0;
            overflow-x: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
            backdrop-filter: blur(10px);
        }
        
        .toolbar::-webkit-scrollbar {
            display: none;
        }
        
        .tool-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            padding: 10px 12px;
            background: rgba(255, 255, 255, 0.08);
            border: 2px solid transparent;
            border-radius: 12px;
            color: white;
            cursor: pointer;
            min-width: 75px;
            transition: all 0.25s ease;
            flex-shrink: 0;
        }
        
        .tool-btn:hover {
            background: rgba(255, 255, 255, 0.12);
            transform: translateY(-2px);
        }
        
        .tool-btn.active {
            background: rgba(33, 150, 243, 0.25);
            border-color: #2196f3;
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(33, 150, 243, 0.4);
        }
        
        .tool-btn i {
            font-size: 1.4rem;
        }
        
        .tool-btn span {
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        /* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */
        .stats {
            display: flex;
            justify-content: space-around;
            padding: 10px 12px;
            background: rgba(0, 0, 0, 0.4);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            flex-shrink: 0;
            font-size: 0.85rem;
        }
        
        .stat-item {
            text-align: center;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .stat-value {
            font-size: 1.3rem;
            font-weight: 700;
            color: #4fc3f7;
        }
        
        .stat-label {
            opacity: 0.85;
            font-size: 0.75rem;
        }
        
        /* –ß–∞—Ç */
        .chat-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            z-index: 1000;
            display: none;
            align-items: flex-end;
            padding: 0;
        }
        
        .chat-modal {
            background: linear-gradient(135deg, #1a237e 0%, #311b92 100%);
            width: 100%;
            max-height: 70vh;
            border-radius: 24px 24px 0 0;
            display: flex;
            flex-direction: column;
            box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.5);
            border-top: 3px solid #2196f3;
        }
        
        .chat-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chat-header h3 {
            color: #4fc3f7;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .close-chat {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.2s;
        }
        
        .close-chat:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .message {
            padding: 12px 16px;
            border-radius: 12px;
            max-width: 85%;
            word-wrap: break-word;
        }
        
        .message.system {
            background: rgba(33, 150, 243, 0.15);
            border-left: 4px solid #2196f3;
            align-self: center;
            max-width: 90%;
        }
        
        .message.user {
            background: rgba(76, 175, 80, 0.15);
            border-left: 4px solid #4caf50;
            align-self: flex-end;
        }
        
        .message.other {
            background: rgba(255, 152, 0, 0.15);
            border-left: 4px solid #ff9800;
            align-self: flex-start;
        }
        
        .message-sender {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 4px;
            color: #bb86fc;
        }
        
        .message-text {
            font-size: 0.95rem;
            line-height: 1.4;
        }
        
        .message-time {
            font-size: 0.7rem;
            opacity: 0.7;
            margin-top: 4px;
            text-align: right;
        }
        
        .chat-input {
            padding: 15px 20px;
            display: flex;
            gap: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .chat-input input {
            flex: 1;
            padding: 12px 18px;
            border: 2px solid #2196f3;
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 0.95rem;
            outline: none;
        }
        
        .chat-input input:focus {
            background: rgba(255, 255, 255, 0.15);
        }
        
        .chat-input input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }
        
        .send-btn {
            background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
            border: none;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            font-size: 1.1rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .send-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.4);
        }
        
        /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            z-index: 2000;
            animation: slideIn 0.3s ease-out;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            gap: 12px;
            max-width: 320px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .notification.error {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
        }
        
        .notification.warning {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
        }
        
        .notification.info {
            background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-30px) translateX(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0) translateX(0);
            }
        }
        
        /* –ü–æ–¥—Å–∫–∞–∑–∫–∞ */
        .hint-box {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(13, 27, 42, 0.85);
            padding: 12px 16px;
            border-radius: 12px;
            font-size: 0.85rem;
            border-left: 4px solid #4fc3f7;
            max-width: 260px;
            backdrop-filter: blur(10px);
            z-index: 50;
        }
        
        .hint-box i {
            color: #4fc3f7;
            margin-right: 8px;
        }
        
        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 768px) {
            .app-header {
                padding: 10px 14px;
            }
            
            .header-left h1 {
                font-size: 1.2rem;
            }
            
            .map-container {
                margin: 8px;
                border-width: 2px;
                border-radius: 14px;
            }
            
            .toolbar {
                padding: 10px;
                gap: 6px;
            }
            
            .tool-btn {
                min-width: 70px;
                padding: 8px 10px;
            }
            
            .tool-btn i {
                font-size: 1.2rem;
            }
            
            .tool-btn span {
                font-size: 0.75rem;
            }
            
            .marker {
                width: 48px;
                height: 48px;
                font-size: 1.4rem;
            }
            
            .stats {
                padding: 8px 10px;
            }
            
            .stat-value {
                font-size: 1.2rem;
            }
            
            .hint-box {
                bottom: 15px;
                left: 15px;
                font-size: 0.8rem;
                max-width: 220px;
            }
        }
        
        @media (max-width: 480px) {
            .toolbar {
                gap: 4px;
            }
            
            .tool-btn {
                min-width: 65px;
                padding: 6px 8px;
            }
            
            .marker {
                width: 44px;
                height: 44px;
                font-size: 1.3rem;
            }
            
            .online-stats {
                font-size: 0.75rem;
                gap: 10px;
            }
        }
        
        /* –£–ª—É—á—à–µ–Ω–∏–µ –¥–ª—è —Ç–∞—á-—É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
        @media (hover: none) and (pointer: coarse) {
            .tool-btn:hover {
                transform: none;
            }
            
            .marker:hover {
                transform: translate(-50%, -50%);
            }
            
            .marker:active {
                transform: translate(-50%, -50%) scale(1.1);
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- –•–µ–¥–µ—Ä -->
        <header class="app-header">
            <div class="header-left">
                <h1><i class="fas fa-traffic-light"></i> Traffic Patrol</h1>
                <div class="online-stats">
                    <span><i class="fas fa-users"></i> –û–Ω–ª–∞–π–Ω: <span id="onlineCount">1</span></span>
                    <span><i class="fas fa-map-marker-alt"></i> –ú–µ—Ç–æ–∫: <span id="markerCount">0</span></span>
                </div>
            </div>
            <div class="user-info">
                <div class="user-name" id="userName">–ò–≥—Ä–æ–∫</div>
                <div class="user-rank" id="userRank">–ù–æ–≤–∏—á–æ–∫ üö¶</div>
            </div>
        </header>

        <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∫–∞—Ä—Ç—ã -->
        <div class="map-container">
            <canvas id="mapCanvas"></canvas>
            <div id="markersContainer"></div>
            <div class="hint-box" id="hintBox">
                <i class="fas fa-lightbulb"></i>
                <span id="hintText">–í—ã–±–µ—Ä–∏—Ç–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –∏ –∫–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É</span>
            </div>
        </div>

        <!-- –ü–∞–Ω–µ–ª—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ -->
        <div class="toolbar">
            <button class="tool-btn active" onclick="selectTool('police')" id="toolPolice">
                <i class="fas fa-car"></i>
                <span>–ü–∞—Ç—Ä—É–ª—å</span>
            </button>
            
            <button class="tool-btn" onclick="selectTool('accident')" id="toolAccident">
                <i class="fas fa-car-crash"></i>
                <span>–î–¢–ü</span>
            </button>
            
            <button class="tool-btn" onclick="selectTool('hazard')" id="toolHazard">
                <i class="fas fa-exclamation-triangle"></i>
                <span>–û–ø–∞—Å–Ω–æ—Å—Ç—å</span>
            </button>
            
            <button class="tool-btn" onclick="selectTool('clear')" id="toolClear">
                <i class="fas fa-trash-alt"></i>
                <span>–£–¥–∞–ª–∏—Ç—å</span>
            </button>
            
            <button class="tool-btn" onclick="showChat()" id="toolChat">
                <i class="fas fa-comments"></i>
                <span>–ß–∞—Ç</span>
            </button>
        </div>

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="stats">
            <div class="stat-item">
                <span class="stat-value" id="statPoints">100</span>
                <span class="stat-label">–û—á–∫–∏</span>
            </div>
            <div class="stat-item">
                <span class="stat-value" id="statActivity">0</span>
                <span class="stat-label">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</span>
            </div>
            <div class="stat-item">
                <span class="stat-value" id="statProgress">100%</span>
                <span class="stat-label">–ü—Ä–æ–≥—Ä–µ—Å—Å</span>
            </div>
        </div>

        <!-- –ß–∞—Ç (—Å–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
        <div class="chat-overlay" id="chatOverlay">
            <div class="chat-modal">
                <div class="chat-header">
                    <h3><i class="fas fa-comments"></i> –ß–∞—Ç –ø–∞—Ç—Ä—É–ª—è</h3>
                    <button class="close-chat" onclick="hideChat()">√ó</button>
                </div>
                <div class="chat-messages" id="chatMessages">
                    <div class="message system">
                        <div class="message-sender"><i class="fas fa-info-circle"></i> –°–∏—Å—Ç–µ–º–∞</div>
                        <div class="message-text">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Traffic Patrol!</div>
                        <div class="message-text">–î–æ–±–∞–≤–ª—è–π—Ç–µ –º–µ—Ç–∫–∏, –ø–µ—Ä–µ–º–µ—â–∞–π—Ç–µ –∏—Ö –∏ —Å–ª–µ–¥–∏—Ç–µ –∑–∞ –¥–æ—Ä–æ–≥–æ–π!</div>
                        <div class="message-time">–¢–æ–ª—å–∫–æ —á—Ç–æ</div>
                    </div>
                </div>
                <div class="chat-input">
                    <input type="text" id="chatInput" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." maxlength="200">
                    <button class="send-btn" onclick="sendMessage()">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // –¢–†–ê–§–ò–ö –ü–ê–¢–†–û–õ–¨ - –ü–û–õ–ù–ê–Ø –ò–ì–†–ê –í –û–î–ù–û–ú –§–ê–ô–õ–ï
        // ============================================
        
        // –ì–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã
        const Game = {
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∏
            config: {
                centerLat: 55.459619,
                centerLon: 38.438920,
                initialZoom: 15,
                markerRadius: 25,
                minPoints: 0,
                maxPoints: 1000
            },
            
            // –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã
            state: {
                markers: [],
                selectedTool: 'police',
                userPoints: 100,
                userActivity: 0,
                totalMarkersAdded: 0,
                totalMarkersRemoved: 0,
                isDragging: false,
                draggingMarker: null,
                dragOffsetX: 0,
                dragOffsetY: 0,
                userName: '–ò–≥—Ä–æ–∫',
                chatMessages: [],
                lastMarkerId: 0
            },
            
            // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
            elements: {
                canvas: null,
                ctx: null,
                markersContainer: null
            },
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
            init() {
                console.log('üö¶ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Traffic Patrol...');
                
                // –ü–æ–ª—É—á–∞–µ–º DOM —ç–ª–µ–º–µ–Ω—Ç—ã
                this.elements.canvas = document.getElementById('mapCanvas');
                this.elements.ctx = this.elements.canvas.getContext('2d');
                this.elements.markersContainer = document.getElementById('markersContainer');
                
                // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã canvas
                this.setupCanvas();
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Telegram
                this.initTelegram();
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                this.loadGameData();
                
                // –†–∏—Å—É–µ–º –∫–∞—Ä—Ç—É
                this.drawMap();
                
                // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
                this.setupEventListeners();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º UI
                this.updateUI();
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞
                this.loadChatHistory();
                
                console.log('‚úÖ –ò–≥—Ä–∞ –≥–æ—Ç–æ–≤–∞!');
                this.showNotification('–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Traffic Patrol! üöì', 'success');
            },
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Telegram Web App
            initTelegram() {
                if (window.Telegram && window.Telegram.WebApp) {
                    const tg = window.Telegram.WebApp;
                    
                    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
                    tg.expand();
                    tg.enableClosingConfirmation();
                    tg.ready();
                    
                    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    if (tg.initDataUnsafe.user) {
                        const user = tg.initDataUnsafe.user;
                        this.state.userName = user.first_name || '–ò–≥—Ä–æ–∫';
                        document.getElementById('userName').textContent = this.state.userName;
                    }
                    
                    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–Ω–æ–ø–∫–∏ –Ω–∞–∑–∞–¥
                    tg.BackButton.show();
                    tg.BackButton.onClick(() => {
                        this.saveGameData();
                        tg.close();
                    });
                    
                    console.log('ü§ñ Telegram Web App –ø–æ–¥–∫–ª—é—á–µ–Ω');
                }
            },
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ canvas
            setupCanvas() {
                const resize = () => {
                    const container = this.elements.canvas.parentElement;
                    this.elements.canvas.width = container.clientWidth;
                    this.elements.canvas.height = container.clientHeight;
                    this.drawMap();
                    this.renderMarkers();
                };
                
                resize();
                window.addEventListener('resize', resize);
            },
            
            // –†–∏—Å–æ–≤–∞–Ω–∏–µ –∫–∞—Ä—Ç—ã (—Å–∏–º—É–ª—è—Ü–∏—è –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç)
            drawMap() {
                const ctx = this.elements.ctx;
                const width = this.elements.canvas.width;
                const height = this.elements.canvas.height;
                
                // –û—á–∏—Å—Ç–∫–∞ canvas
                ctx.clearRect(0, 0, width, height);
                
                // –§–æ–Ω - —Å–∏–Ω–∏–π –∫–∞–∫ —É –∫–∞—Ä—Ç—ã
                ctx.fillStyle = '#0d47a1';
                ctx.fillRect(0, 0, width, height);
                
                // –†–∏—Å—É–µ–º –¥–æ—Ä–æ–≥–∏
                this.drawRoads();
                
                // –†–∏—Å—É–µ–º –∑–¥–∞–Ω–∏—è/–æ—Ä–∏–µ–Ω—Ç–∏—Ä—ã
                this.drawLandmarks();
                
                // –†–∏—Å—É–µ–º —Å–µ—Ç–∫—É (–¥–ª—è –Ω–∞–≥–ª—è–¥–Ω–æ—Å—Ç–∏)
                this.drawGrid();
            },
            
            // –†–∏—Å–æ–≤–∞–Ω–∏–µ –¥–æ—Ä–æ–≥
            drawRoads() {
                const ctx = this.elements.ctx;
                const width = this.elements.canvas.width;
                const height = this.elements.canvas.height;
                
                // –û—Å–Ω–æ–≤–Ω—ã–µ –¥–æ—Ä–æ–≥–∏
                ctx.strokeStyle = '#37474f';
                ctx.lineWidth = 40;
                ctx.lineCap = 'round';
                
                // –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ –¥–æ—Ä–æ–≥–∏ (3 —à—Ç—É–∫–∏)
                const hRoads = 3;
                const hSpacing = height / (hRoads + 1);
                
                for (let i = 1; i <= hRoads; i++) {
                    const y = i * hSpacing;
                    
                    // –î–æ—Ä–æ–≥–∞
                    ctx.beginPath();
                    ctx.moveTo(-50, y);
                    ctx.lineTo(width + 50, y);
                    ctx.stroke();
                    
                    // –†–∞–∑–º–µ—Ç–∫–∞ (–ø—Ä–µ—Ä—ã–≤–∏—Å—Ç–∞—è –ª–∏–Ω–∏—è)
                    ctx.strokeStyle = '#ffd740';
                    ctx.lineWidth = 3;
                    ctx.setLineDash([25, 15]);
                    ctx.beginPath();
                    ctx.moveTo(0, y);
                    ctx.lineTo(width, y);
                    ctx.stroke();
                    
                    ctx.strokeStyle = '#37474f';
                    ctx.lineWidth = 40;
                    ctx.setLineDash([]);
                }
                
                // –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ –¥–æ—Ä–æ–≥–∏ (3 —à—Ç—É–∫–∏)
                const vRoads = 3;
                const vSpacing = width / (vRoads + 1);
                
                for (let i = 1; i <= vRoads; i++) {
                    const x = i * vSpacing;
                    
                    // –î–æ—Ä–æ–≥–∞
                    ctx.beginPath();
                    ctx.moveTo(x, -50);
                    ctx.lineTo(x, height + 50);
                    ctx.stroke();
                    
                    // –†–∞–∑–º–µ—Ç–∫–∞
                    ctx.strokeStyle = '#ffd740';
                    ctx.lineWidth = 3;
                    ctx.setLineDash([25, 15]);
                    ctx.beginPath();
                    ctx.moveTo(x, 0);
                    ctx.lineTo(x, height);
                    ctx.stroke();
                    
                    ctx.strokeStyle = '#37474f';
                    ctx.lineWidth = 40;
                    ctx.setLineDash([]);
                }
            },
            
            // –†–∏—Å–æ–≤–∞–Ω–∏–µ –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤ (–∑–¥–∞–Ω–∏–π, –ø–∞—Ä–∫–æ–≤ –∏ —Ç.–¥.)
            drawLandmarks() {
                const ctx = this.elements.ctx;
                const width = this.elements.canvas.width;
                const height = this.elements.canvas.height;
                
                // –ó–¥–∞–Ω–∏—è (–∫–≤–∞–¥—Ä–∞—Ç—ã)
                ctx.fillStyle = '#546e7a';
                const buildings = [
                    { x: width * 0.2, y: height * 0.2, size: 50 },
                    { x: width * 0.8, y: height * 0.2, size: 60 },
                    { x: width * 0.3, y: height * 0.7, size: 45 },
                    { x: width * 0.7, y: height * 0.7, size: 55 },
                    { x: width * 0.5, y: height * 0.5, size: 70 }
                ];
                
                buildings.forEach(building => {
                    // –ó–¥–∞–Ω–∏–µ
                    ctx.fillRect(
                        building.x - building.size/2,
                        building.y - building.size/2,
                        building.size,
                        building.size
                    );
                    
                    // –û–∫–Ω–∞
                    ctx.fillStyle = '#ffb74d';
                    const windowSize = 8;
                    const windowSpacing = 15;
                    
                    for (let i = 0; i < 3; i++) {
                        for (let j = 0; j < 3; j++) {
                            ctx.fillRect(
                                building.x - building.size/2 + windowSpacing * (i + 0.5),
                                building.y - building.size/2 + windowSpacing * (j + 0.5),
                                windowSize,
                                windowSize
                            );
                        }
                    }
                    
                    ctx.fillStyle = '#546e7a';
                });
                
                // –ü–∞—Ä–∫–∏ (–∑–µ–ª–µ–Ω—ã–µ –∫—Ä—É–≥–∏)
                ctx.fillStyle = '#388e3c';
                const parks = [
                    { x: width * 0.1, y: height * 0.9, radius: 30 },
                    { x: width * 0.9, y: height * 0.1, radius: 25 }
                ];
                
                parks.forEach(park => {
                    ctx.beginPath();
                    ctx.arc(park.x, park.y, park.radius, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // –î–µ—Ä–µ–≤—å—è –≤ –ø–∞—Ä–∫–µ
                    ctx.fillStyle = '#558b2f';
                    for (let i = 0; i < 5; i++) {
                        const angle = (i / 5) * Math.PI * 2;
                        const treeX = park.x + Math.cos(angle) * (park.radius * 0.6);
                        const treeY = park.y + Math.sin(angle) * (park.radius * 0.6);
                        
                        ctx.beginPath();
                        ctx.arc(treeX, treeY, 8, 0, Math.PI * 2);
                        ctx.fill();
                    }
                    ctx.fillStyle = '#388e3c';
                });
            },
            
            // –†–∏—Å–æ–≤–∞–Ω–∏–µ —Å–µ—Ç–∫–∏ (–¥–ª—è –Ω–∞–≥–ª—è–¥–Ω–æ—Å—Ç–∏)
            drawGrid() {
                const ctx = this.elements.ctx;
                const width = this.elements.canvas.width;
                const height = this.elements.canvas.height;
                
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
                ctx.lineWidth = 1;
                
                // –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏
                for (let x = 0; x <= width; x += 50) {
                    ctx.beginPath();
                    ctx.moveTo(x, 0);
                    ctx.lineTo(x, height);
                    ctx.stroke();
                }
                
                // –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏
                for (let y = 0; y <= height; y += 50) {
                    ctx.beginPath();
                    ctx.moveTo(0, y);
                    ctx.lineTo(width, y);
                    ctx.stroke();
                }
            },
            
            // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –º–∞—Ä–∫–µ—Ä–æ–≤
            renderMarkers() {
                const container = this.elements.markersContainer;
                container.innerHTML = '';
                
                this.state.markers.forEach(marker => {
                    const markerDiv = document.createElement('div');
                    markerDiv.className = `marker ${marker.type}`;
                    markerDiv.id = marker.id;
                    markerDiv.style.left = `${marker.x}px`;
                    markerDiv.style.top = `${marker.y}px`;
                    markerDiv.setAttribute('data-marker-id', marker.id);
                    markerDiv.title = `${marker.user}: ${this.getToolName(marker.type)}`;
                    
                    // –ò–∫–æ–Ω–∫–∞ –º–∞—Ä–∫–µ—Ä–∞
                    let icon = '';
                    switch(marker.type) {
                        case 'police': icon = 'üöì'; break;
                        case 'accident': icon = 'üí•'; break;
                        case 'hazard': icon = '‚ö†Ô∏è'; break;
                    }
                    markerDiv.innerHTML = icon;
                    
                    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
                    markerDiv.addEventListener('mousedown', (e) => this.startDrag(e, marker.id));
                    markerDiv.addEventListener('touchstart', (e) => this.startDragTouch(e, marker.id), { passive: false });
                    
                    container.appendChild(markerDiv);
                });
            },
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
            setupEventListeners() {
                const canvas = this.elements.canvas;
                
                // –ö–ª–∏–∫ –ø–æ –∫–∞—Ä—Ç–µ
                canvas.addEventListener('click', (e) => this.handleCanvasClick(e));
                
                // –¢–∞—á —Å–æ–±—ã—Ç–∏—è –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö
                canvas.addEventListener('touchend', (e) => this.handleCanvasTouch(e), { passive: false });
                
                // –°–æ–±—ã—Ç–∏—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
                document.addEventListener('mousemove', (e) => this.handleDrag(e));
                document.addEventListener('mouseup', () => this.stopDrag());
                document.addEventListener('touchmove', (e) => this.handleDragTouch(e), { passive: false });
                document.addEventListener('touchend', () => this.stopDrag());
                
                // –ß–∞—Ç
                const chatInput = document.getElementById('chatInput');
                if (chatInput) {
                    chatInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') this.sendMessage();
                    });
                }
                
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ –ø–æ –º–∞—Ä–∫–µ—Ä–∞–º –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è
                document.addEventListener('click', (e) => {
                    const markerElement = e.target.closest('.marker');
                    if (markerElement && this.state.selectedTool === 'clear') {
                        const markerId = markerElement.getAttribute('data-marker-id');
                        this.removeMarker(markerId);
                    }
                });
            },
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ –ø–æ canvas
            handleCanvasClick(e) {
                const rect = this.elements.canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                this.processMapClick(x, y);
            },
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–∞—á–∞ –ø–æ canvas
            handleCanvasTouch(e) {
                e.preventDefault();
                const rect = this.elements.canvas.getBoundingClientRect();
                const touch = e.changedTouches[0];
                const x = touch.clientX - rect.left;
                const y = touch.clientY - rect.top;
                
                this.processMapClick(x, y);
            },
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ –ø–æ –∫–∞—Ä—Ç–µ
            processMapClick(x, y) {
                // –ï—Å–ª–∏ –º—ã –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–µ–º –º–∞—Ä–∫–µ—Ä - –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∫–ª–∏–∫
                if (this.state.isDragging) {
                    this.state.isDragging = false;
                    if (this.state.draggingMarker) {
                        document.getElementById(this.state.draggingMarker.id)?.classList.remove('dragging');
                        this.state.draggingMarker = null;
                    }
                    return;
                }
                
                // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω —Ä–µ–∂–∏–º —É–¥–∞–ª–µ–Ω–∏—è - –ø—Ä–æ–≤–µ—Ä—è–µ–º, –ø–æ–ø–∞–ª–∏ –ª–∏ –≤ –º–∞—Ä–∫–µ—Ä
                if (this.state.selectedTool === 'clear') {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –º–∞—Ä–∫–µ—Ä –ø–æ–¥ –∫—É—Ä—Å–æ—Ä–æ–º
                    const clickedMarker = this.getMarkerAtPosition(x, y);
                    if (clickedMarker) {
                        this.removeMarker(clickedMarker.id);
                    } else {
                        this.showNotification('–ö–ª–∏–∫–Ω–∏—Ç–µ –ø–æ –º–µ—Ç–∫–µ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è', 'warning');
                    }
                } else {
                    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –º–∞—Ä–∫–µ—Ä
                    this.addMarker(x, y, this.state.selectedTool);
                }
            },
            
            // –ù–∞—á–∞–ª–æ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
            startDrag(e, markerId) {
                e.preventDefault();
                e.stopPropagation();
                
                const marker = this.state.markers.find(m => m.id === markerId);
                if (!marker) return;
                
                this.state.isDragging = true;
                this.state.draggingMarker = marker;
                
                const rect = this.elements.canvas.getBoundingClientRect();
                this.state.dragOffsetX = e.clientX - rect.left - marker.x;
                this.state.dragOffsetY = e.clientY - rect.top - marker.y;
                
                document.getElementById(markerId).classList.add('dragging');
            },
            
            startDragTouch(e, markerId) {
                e.preventDefault();
                if (e.touches[0]) {
                    this.startDrag(e.touches[0], markerId);
                }
            },
            
            // –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–∞
            handleDrag(e) {
                if (!this.state.isDragging || !this.state.draggingMarker) return;
                
                const rect = this.elements.canvas.getBoundingClientRect();
                const newX = e.clientX - rect.left - this.state.dragOffsetX;
                const newY = e.clientY - rect.top - this.state.dragOffsetY;
                
                // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –∫–∞—Ä—Ç—ã
                this.state.draggingMarker.x = Math.max(25, Math.min(newX, this.elements.canvas.width - 25));
                this.state.draggingMarker.y = Math.max(25, Math.min(newY, this.elements.canvas.height - 25));
                
                this.renderMarkers();
            },
            
            handleDragTouch(e) {
                e.preventDefault();
                if (e.touches[0]) {
                    this.handleDrag(e.touches[0]);
                }
            },
            
            // –û–∫–æ–Ω—á–∞–Ω–∏–µ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
            stopDrag() {
                if (this.state.isDragging && this.state.draggingMarker) {
                    // –ù–∞—á–∏—Å–ª—è–µ–º –æ—á–∫–∏ –∑–∞ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ
                    this.state.userPoints += 2;
                    this.state.userActivity++;
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–≥—Ä—É
                    this.saveGameData();
                    this.updateUI();
                    
                    const markerDiv = document.getElementById(this.state.draggingMarker.id);
                    if (markerDiv) {
                        markerDiv.classList.remove('dragging');
                        setTimeout(() => {
                            this.showNotification('–ú–µ—Ç–∫–∞ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∞! +2 –æ—á–∫–∞', 'info');
                        }, 100);
                    }
                }
                
                this.state.isDragging = false;
                this.state.draggingMarker = null;
            },
            
            // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–∞
            addMarker(x, y, type) {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–æ–∏–º–æ—Å—Ç—å
                const cost = this.getMarkerCost(type);
                if (this.state.userPoints < cost) {
                    this.showNotification(`–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –æ—á–∫–æ–≤! –ù—É–∂–Ω–æ ${cost}`, 'error');
                    return;
                }
                
                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º ID
                const markerId = `marker_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                
                // –°–æ–∑–¥–∞–µ–º –º–∞—Ä–∫–µ—Ä
                const marker = {
                    id: markerId,
                    x: x,
                    y: y,
                    type: type,
                    user: this.state.userName,
                    timestamp: Date.now(),
                    moved: false
                };
                
                // –î–æ–±–∞–≤–ª—è–µ–º –≤ –º–∞—Å—Å–∏–≤
                this.state.markers.push(marker);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                this.state.userPoints -= cost;
                this.state.userActivity++;
                this.state.totalMarkersAdded++;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                this.renderMarkers();
                this.updateUI();
                this.saveGameData();
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                this.showNotification(`${this.getToolName(type)} –¥–æ–±–∞–≤–ª–µ–Ω! -${cost} –æ—á–∫–æ–≤`, 'success');
                
                // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç
                this.addChatMessage('system', `${this.state.userName} –¥–æ–±–∞–≤–∏–ª ${this.getToolName(type)} –Ω–∞ –∫–∞—Ä—Ç—É`);
            },
            
            // –£–¥–∞–ª–µ–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–∞
            removeMarker(markerId) {
                const index = this.state.markers.findIndex(m => m.id === markerId);
                if (index === -1) return;
                
                const marker = this.state.markers[index];
                
                // –£–¥–∞–ª—è–µ–º –º–∞—Ä–∫–µ—Ä
                this.state.markers.splice(index, 1);
                
                // –ù–∞—á–∏—Å–ª—è–µ–º –æ—á–∫–∏
                this.state.userPoints += 5;
                this.state.userActivity++;
                this.state.totalMarkersRemoved++;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                this.renderMarkers();
                this.updateUI();
                this.saveGameData();
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                this.showNotification('–ú–µ—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–∞! +5 –æ—á–∫–æ–≤', 'success');
                
                // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç
                this.addChatMessage('system', `${this.state.userName} —É–¥–∞–ª–∏–ª ${this.getToolName(marker.type)} —Å –∫–∞—Ä—Ç—ã`);
            },
            
            // –ü–æ–∏—Å–∫ –º–∞—Ä–∫–µ—Ä–∞ –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º
            getMarkerAtPosition(x, y, threshold = 30) {
                for (let marker of this.state.markers) {
                    const distance = Math.sqrt(
                        Math.pow(marker.x - x, 2) + Math.pow(marker.y - y, 2)
                    );
                    if (distance < threshold) {
                        return marker;
                    }
                }
                return null;
            },
            
            // –í—ã–±–æ—Ä –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
            selectTool(tool) {
                this.state.selectedTool = tool;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
                document.querySelectorAll('.tool-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                const toolButtons = {
                    police: 'toolPolice',
                    accident: 'toolAccident',
                    hazard: 'toolHazard',
                    clear: 'toolClear'
                };
                
                const activeButton = document.getElementById(toolButtons[tool]);
                if (activeButton) {
                    activeButton.classList.add('active');
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É
                const hintText = document.getElementById('hintText');
                if (tool === 'clear') {
                    hintText.textContent = '–ö–ª–∏–∫–Ω–∏—Ç–µ –ø–æ –º–µ—Ç–∫–µ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è';
                } else {
                    hintText.textContent = '–ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–µ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –º–µ—Ç–∫–∏';
                }
                
                this.showNotification(`–í—ã–±—Ä–∞–Ω: ${this.getToolName(tool)}`, 'info');
            },
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI
            updateUI() {
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏
                document.getElementById('markerCount').textContent = this.state.markers.length;
                document.getElementById('statPoints').textContent = this.state.userPoints;
                document.getElementById('statActivity').textContent = this.state.userActivity;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
                const progress = Math.min(Math.max(this.state.userPoints / 100, 0), 1) * 100;
                document.getElementById('statProgress').textContent = Math.round(progress) + '%';
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–Ω–≥
                const rank = this.calculateRank();
                document.getElementById('userRank').textContent = rank;
            },
            
            // –†–∞—Å—á–µ—Ç —Ä–∞–Ω–≥–∞
            calculateRank() {
                const points = this.state.userPoints;
                if (points >= 1000) return '–ö–æ–º–∏—Å—Å–∞—Ä üëÆ‚Äç‚ôÇÔ∏è';
                if (points >= 500) return '–°–µ—Ä–∂–∞–Ω—Ç üëÆ';
                if (points >= 200) return '–û—Ñ–∏—Ü–µ—Ä üöî';
                if (points >= 100) return '–ü–∞—Ç—Ä—É–ª—å–Ω—ã–π üöì';
                return '–ù–æ–≤–∏—á–æ–∫ üö¶';
            },
            
            // –ü–æ–ª—É—á–µ–Ω–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
            getToolName(tool) {
                const names = {
                    police: '–ü–∞—Ç—Ä—É–ª—å üöì',
                    accident: '–î–¢–ü üí•',
                    hazard: '–û–ø–∞—Å–Ω–æ—Å—Ç—å ‚ö†Ô∏è',
                    clear: '–£–¥–∞–ª–µ–Ω–∏–µ üóëÔ∏è'
                };
                return names[tool] || tool;
            },
            
            // –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –º–∞—Ä–∫–µ—Ä–∞
            getMarkerCost(type) {
                const costs = {
                    police: 10,
                    accident: 15,
                    hazard: 8
                };
                return costs[type] || 10;
            },
            
            // –†–∞–±–æ—Ç–∞ —Å —á–∞—Ç–æ–º
            showChat() {
                document.getElementById('chatOverlay').style.display = 'flex';
                setTimeout(() => {
                    document.getElementById('chatInput').focus();
                }, 300);
            },
            
            hideChat() {
                document.getElementById('chatOverlay').style.display = 'none';
            },
            
            sendMessage() {
                const input = document.getElementById('chatInput');
                const message = input.value.trim();
                
                if (message) {
                    this.addChatMessage('user', message);
                    input.value = '';
                    this.saveChatHistory();
                }
            },
            
            addChatMessage(sender, text) {
                const messagesDiv = document.getElementById('chatMessages');
                
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${sender}`;
                
                const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                if (sender === 'system') {
                    messageDiv.innerHTML = `
                        <div class="message-sender"><i class="fas fa-info-circle"></i> –°–∏—Å—Ç–µ–º–∞</div>
                        <div class="message-text">${text}</div>
                        <div class="message-time">${time}</div>
                    `;
                } else {
                    messageDiv.innerHTML = `
                        <div class="message-sender">${this.state.userName}</div>
                        <div class="message-text">${text}</div>
                        <div class="message-time">${time}</div>
                    `;
                }
                
                messagesDiv.appendChild(messageDiv);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
                this.state.chatMessages.push({
                    sender: sender,
                    text: text,
                    time: Date.now(),
                    user: sender === 'user' ? this.state.userName : '–°–∏—Å—Ç–µ–º–∞'
                });
                
                // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é 100 —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
                if (this.state.chatMessages.length > 100) {
                    this.state.chatMessages.shift();
                }
            },
            
            // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
            saveGameData() {
                try {
                    const gameData = {
                        markers: this.state.markers,
                        userPoints: this.state.userPoints,
                        userActivity: this.state.userActivity,
                        totalMarkersAdded: this.state.totalMarkersAdded,
                        totalMarkersRemoved: this.state.totalMarkersRemoved,
                        userName: this.state.userName,
                        lastSave: Date.now()
                    };
                    
                    localStorage.setItem('traffic_patrol_game_data', JSON.stringify(gameData));
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–≥—Ä—ã:', error);
                }
            },
            
            loadGameData() {
                try {
                    const savedData = localStorage.getItem('traffic_patrol_game_data');
                    if (savedData) {
                        const data = JSON.parse(savedData);
                        
                        this.state.markers = data.markers || [];
                        this.state.userPoints = data.userPoints || 100;
                        this.state.userActivity = data.userActivity || 0;
                        this.state.totalMarkersAdded = data.totalMarkersAdded || 0;
                        this.state.totalMarkersRemoved = data.totalMarkersRemoved || 0;
                        this.state.userName = data.userName || '–ò–≥—Ä–æ–∫';
                        
                        document.getElementById('userName').textContent = this.state.userName;
                        
                        console.log('‚úÖ –ò–≥—Ä–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –∏–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–≥—Ä—ã:', error);
                }
            },
            
            saveChatHistory() {
                try {
                    localStorage.setItem('traffic_patrol_chat_history', JSON.stringify(this.state.chatMessages));
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —á–∞—Ç–∞:', error);
                }
            },
            
            loadChatHistory() {
                try {
                    const savedChat = localStorage.getItem('traffic_patrol_chat_history');
                    if (savedChat) {
                        this.state.chatMessages = JSON.parse(savedChat);
                        
                        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç–µ
                        const messagesDiv = document.getElementById('chatMessages');
                        messagesDiv.innerHTML = '';
                        
                        this.state.chatMessages.forEach(msg => {
                            const messageDiv = document.createElement('div');
                            messageDiv.className = `message ${msg.sender}`;
                            
                            const time = new Date(msg.time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                            
                            if (msg.sender === 'system') {
                                messageDiv.innerHTML = `
                                    <div class="message-sender"><i class="fas fa-info-circle"></i> ${msg.user}</div>
                                    <div class="message-text">${msg.text}</div>
                                    <div class="message-time">${time}</div>
                                `;
                            } else {
                                messageDiv.innerHTML = `
                                    <div class="message-sender">${msg.user}</div>
                                    <div class="message-text">${msg.text}</div>
                                    <div class="message-time">${time}</div>
                                `;
                            }
                            
                            messagesDiv.appendChild(messageDiv);
                        });
                        
                        messagesDiv.scrollTop = messagesDiv.scrollHeight;
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–∞:', error);
                }
            },
            
            // –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            showNotification(message, type = 'success') {
                // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
                const oldNotifications = document.querySelectorAll('.notification');
                oldNotifications.forEach(n => n.remove());
                
                // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.innerHTML = `
                    <i class="fas fa-${type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'check-circle'}"></i>
                    <span>${message}</span>
                `;
                
                document.body.appendChild(notification);
                
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–∫—Ä—ã—Ç–∏–µ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
                setTimeout(() => {
                    notification.style.opacity = '0';
                    notification.style.transform = 'translateY(-30px) translateX(30px)';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                }, 3000);
            }
        };
        
        // ============================================
        // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ò–ì–†–´ –ü–†–ò –ó–ê–ì–†–£–ó–ö–ï –°–¢–†–ê–ù–ò–¶–´
        // ============================================
        
        document.addEventListener('DOMContentLoaded', () => {
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∏–≥—Ä—É
            Game.init();
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ä—Ç–æ–≤—É—é –ø–æ–¥—Å–∫–∞–∑–∫—É
            setTimeout(() => {
                Game.showNotification('üöì –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–π—Ç–µ –º–µ—Ç–∫–∏ –Ω–∞ –Ω–æ–≤—ã–µ –º–µ—Å—Ç–∞!', 'info');
                Game.addChatMessage('system', '–ò–≥—Ä–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –î–æ–±–∞–≤–ª—è–π—Ç–µ –º–µ—Ç–∫–∏ –Ω–∞ –∫–∞—Ä—Ç—É!');
            }, 1000);
            
            // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫
            window.selectTool = (tool) => Game.selectTool(tool);
            window.showChat = () => Game.showChat();
            window.hideChat = () => Game.hideChat();
            window.sendMessage = () => Game.sendMessage();
        });
    </script>
</body>
</html>
