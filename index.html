<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üö® Traffic Patrol - –†–µ–∞–ª—å–Ω–∞—è –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç–∞</title>
    
    <!-- Telegram Web App -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- –ò–∫–æ–Ω–∫–∏ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç—ã —Å –≤–∞—à–∏–º —Ä–∞–±–æ—á–∏–º –∫–ª—é—á–æ–º -->
    <script src="https://api-maps.yandex.ru/2.1/?apikey=365e247d-d853-4425-b9cc-13bfa1169a49&lang=ru_RU"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a237e 0%, #311b92 100%);
            color: white;
            height: 100vh;
            overflow: hidden;
        }
        
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        
        /* –•–µ–¥–µ—Ä */
        .app-header {
            background: rgba(13, 27, 42, 0.95);
            padding: 15px 20px;
            border-bottom: 3px solid #2196f3;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(10px);
        }
        
        .header-left h1 {
            color: #4fc3f7;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .header-stats {
            font-size: 0.9rem;
            color: #81c784;
            margin-top: 5px;
        }
        
        .user-info {
            text-align: right;
        }
        
        .user-rank {
            background: rgba(33, 150, 243, 0.2);
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8rem;
            margin-top: 5px;
            border: 1px solid #2196f3;
        }
        
        /* –ö–∞—Ä—Ç–∞ */
        .map-container {
            flex: 1;
            margin: 10px;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 3px solid #2196f3;
            position: relative;
        }
        
        #yandex-map {
            width: 100%;
            height: 100%;
        }
        
        /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ */
        .map-loading {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(13, 27, 42, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }
        
        .map-loading i {
            font-size: 3rem;
            color: #4fc3f7;
            margin-bottom: 20px;
            animation: spin 2s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* –ü–∞–Ω–µ–ª—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ */
        .toolbar {
            display: flex;
            gap: 10px;
            padding: 15px;
            background: rgba(13, 27, 42, 0.95);
            border-top: 2px solid #2196f3;
            overflow-x: auto;
            justify-content: center;
            backdrop-filter: blur(10px);
        }
        
        .tool-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid transparent;
            border-radius: 12px;
            color: white;
            cursor: pointer;
            min-width: 85px;
            transition: all 0.3s;
        }
        
        .tool-btn:hover {
            background: rgba(255, 255, 255, 0.15);
        }
        
        .tool-btn.active {
            background: rgba(33, 150, 243, 0.3);
            border-color: #2196f3;
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(33, 150, 243, 0.4);
        }
        
        .tool-btn i {
            font-size: 1.5rem;
        }
        
        .tool-btn span {
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        /* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */
        .stats-panel {
            display: flex;
            justify-content: space-around;
            padding: 12px 15px;
            background: rgba(0, 0, 0, 0.4);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.9rem;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-value {
            display: block;
            font-size: 1.4rem;
            font-weight: bold;
            color: #4fc3f7;
        }
        
        .stat-label {
            font-size: 0.8rem;
            opacity: 0.8;
        }
        
        /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4caf50;
            color: white;
            padding: 15px 25px;
            border-radius: 12px;
            z-index: 2000;
            animation: slideIn 0.3s ease-out;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            gap: 12px;
            max-width: 300px;
        }
        
        .notification.error {
            background: #f44336;
        }
        
        .notification.warning {
            background: #ff9800;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã */
        .coords-info {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(13, 27, 42, 0.85);
            padding: 10px 15px;
            border-radius: 10px;
            font-size: 0.85rem;
            backdrop-filter: blur(10px);
            border-left: 4px solid #4fc3f7;
        }
        
        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 768px) {
            .app-header {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
            
            .user-info {
                text-align: center;
            }
            
            .toolbar {
                padding: 10px;
                justify-content: flex-start;
            }
            
            .tool-btn {
                min-width: 75px;
                padding: 10px 12px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- –•–µ–¥–µ—Ä -->
        <header class="app-header">
            <div class="header-left">
                <h1><i class="fas fa-traffic-light"></i> Traffic Patrol</h1>
                <div class="header-stats">
                    <span><i class="fas fa-users"></i> –û–Ω–ª–∞–π–Ω: 1</span> | 
                    <span><i class="fas fa-map-marker-alt"></i> –ú–µ—Ç–æ–∫: <span id="markerCount">0</span></span>
                </div>
            </div>
            <div class="user-info">
                <div style="font-weight: 600; font-size: 1.1rem;" id="userName">–ò–≥—Ä–æ–∫</div>
                <div class="user-rank" id="userRank">–ù–æ–≤–∏—á–æ–∫ üö¶</div>
            </div>
        </header>

        <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç -->
        <div class="map-container">
            <div id="yandex-map"></div>
            
            <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
            <div class="map-loading" id="mapLoading">
                <i class="fas fa-sync fa-spin"></i>
                <p>–ó–∞–≥—Ä—É–∑–∫–∞ –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç...</p>
                <p style="margin-top: 10px; font-size: 0.9rem; color: #81c784;">–ö–ª—é—á API: 365e247d-d853-4425-b9cc-13bfa1169a49</p>
                <p style="margin-top: 5px; font-size: 0.85rem;">–¶–µ–Ω—Ç—Ä: 55.459619, 38.438920</p>
            </div>
            
            <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞—Ö -->
            <div class="coords-info">
                <i class="fas fa-map-marker-alt"></i> –¶–µ–Ω—Ç—Ä –∫–∞—Ä—Ç—ã: 55.459619, 38.438920
            </div>
        </div>

        <!-- –ü–∞–Ω–µ–ª—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ -->
        <div class="toolbar">
            <button class="tool-btn active" onclick="Game.selectTool('police')" id="toolPolice">
                <i class="fas fa-car"></i>
                <span>–ü–∞—Ç—Ä—É–ª—å</span>
            </button>
            
            <button class="tool-btn" onclick="Game.selectTool('accident')" id="toolAccident">
                <i class="fas fa-car-crash"></i>
                <span>–î–¢–ü</span>
            </button>
            
            <button class="tool-btn" onclick="Game.selectTool('hazard')" id="toolHazard">
                <i class="fas fa-exclamation-triangle"></i>
                <span>–û–ø–∞—Å–Ω–æ—Å—Ç—å</span>
            </button>
            
            <button class="tool-btn" onclick="Game.selectTool('clear')" id="toolClear">
                <i class="fas fa-trash-alt"></i>
                <span>–£–¥–∞–ª–∏—Ç—å</span>
            </button>
            
            <button class="tool-btn" onclick="Game.centerToUser()" id="toolLocation">
                <i class="fas fa-location-arrow"></i>
                <span>–ú–æ—ë –º–µ—Å—Ç–æ</span>
            </button>
        </div>

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="stats-panel">
            <div class="stat-item">
                <span class="stat-value" id="statPoints">100</span>
                <span class="stat-label">–û—á–∫–∏</span>
            </div>
            <div class="stat-item">
                <span class="stat-value" id="statActivity">0</span>
                <span class="stat-label">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</span>
            </div>
            <div class="stat-item">
                <span class="stat-value" id="statProgress">100%</span>
                <span class="stat-label">–ü—Ä–æ–≥—Ä–µ—Å—Å</span>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // TRAFFIC PATROL - –ü–û–õ–ù–ê–Ø –ò–ì–†–ê –° –Ø–ù–î–ï–ö–°.–ö–ê–†–¢–ê–ú–ò
        // ============================================
        
        const Game = {
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∏
            config: {
                center: [55.459619, 38.438920], // –í–∞—à–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
                zoom: 15,
                minPoints: 0,
                maxPoints: 1000
            },
            
            // –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã
            state: {
                yandexMap: null,
                markers: [],
                selectedTool: 'police',
                userPoints: 100,
                userActivity: 0,
                markersAdded: 0,
                markersRemoved: 0,
                userName: '–ò–≥—Ä–æ–∫',
                isInitialized: false
            },
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–≥—Ä—ã
            async init() {
                console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Traffic Patrol...');
                console.log('üó∫Ô∏è API –∫–ª—é—á –Ø–Ω–¥–µ–∫—Å: 365e247d-d853-4425-b9cc-13bfa1169a49');
                console.log('üìç –¶–µ–Ω—Ç—Ä –∫–∞—Ä—Ç—ã:', this.config.center);
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram
                this.initTelegram();
                
                // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
                this.loadGameData();
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç
                await this.initYandexMap();
                
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
                this.updateUI();
                
                // –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                setTimeout(() => {
                    this.showNotification('‚úÖ –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç—ã —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã! –ö–ª–∏–∫–∞–π—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –º–µ—Ç–æ–∫.', 'success');
                }, 1000);
            },
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram
            initTelegram() {
                if (window.Telegram && window.Telegram.WebApp) {
                    const tg = window.Telegram.WebApp;
                    
                    tg.expand();
                    tg.enableClosingConfirmation();
                    tg.ready();
                    
                    if (tg.initDataUnsafe.user) {
                        this.state.userName = tg.initDataUnsafe.user.first_name || '–ò–≥—Ä–æ–∫';
                        document.getElementById('userName').textContent = this.state.userName;
                    }
                    
                    tg.BackButton.show();
                    tg.BackButton.onClick(() => {
                        this.saveGameData();
                        tg.close();
                    });
                    
                    console.log('ü§ñ Telegram Web App –ø–æ–¥–∫–ª—é—á–µ–Ω');
                }
            },
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç
            initYandexMap() {
                return new Promise((resolve, reject) => {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≥—Ä—É–∂–µ–Ω—ã –ª–∏ –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç—ã
                    if (!window.ymaps) {
                        console.error('‚ùå –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç—ã –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∏—Å—å');
                        this.showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç', 'error');
                        reject(new Error('Yandex Maps not loaded'));
                        return;
                    }
                    
                    // –ñ–¥–µ–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ API
                    ymaps.ready(() => {
                        try {
                            console.log('‚úÖ –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç—ã API –≥–æ—Ç–æ–≤');
                            
                            // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç—É
                            this.state.yandexMap = new ymaps.Map('yandex-map', {
                                center: this.config.center,
                                zoom: this.config.zoom,
                                controls: ['zoomControl', 'fullscreenControl', 'typeSelector']
                            });
                            
                            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
                            this.state.yandexMap.controls.get('zoomControl').options.set({
                                size: 'small',
                                position: { right: 10, top: 100 }
                            });
                            
                            // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª–æ–π –ø—Ä–æ–±–æ–∫
                            const trafficLayer = new ymaps.layer.TrafficLayer();
                            this.state.yandexMap.layers.add(trafficLayer);
                            
                            // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
                            this.setupMapEvents();
                            
                            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏
                            this.loadMarkersToMap();
                            
                            // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                            setTimeout(() => {
                                document.getElementById('mapLoading').style.display = 'none';
                            }, 500);
                            
                            this.state.isInitialized = true;
                            resolve();
                            
                        } catch (error) {
                            console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞—Ä—Ç—ã:', error);
                            this.showNotification('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞—Ä—Ç—ã', 'error');
                            reject(error);
                        }
                    });
                });
            },
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–æ–±—ã—Ç–∏–π –∫–∞—Ä—Ç—ã
            setupMapEvents() {
                const map = this.state.yandexMap;
                
                // –ö–ª–∏–∫ –ø–æ –∫–∞—Ä—Ç–µ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –º–µ—Ç–æ–∫
                map.events.add('click', (e) => {
                    const coords = e.get('coords');
                    
                    if (this.state.selectedTool === 'clear') {
                        this.removeNearestMarker(coords);
                    } else {
                        this.addMarker(coords, this.state.selectedTool);
                    }
                });
            },
            
            // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–µ—Ç–∫–∏ –Ω–∞ –∫–∞—Ä—Ç—É
            addMarker(coords, type) {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–æ–∏–º–æ—Å—Ç—å
                const cost = this.getMarkerCost(type);
                if (this.state.userPoints < cost) {
                    this.showNotification(`–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –æ—á–∫–æ–≤! –ù—É–∂–Ω–æ ${cost}`, 'error');
                    return;
                }
                
                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º ID
                const markerId = `marker_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                
                // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –º–µ—Ç–∫–∏
                let preset, iconColor, iconGlyph;
                switch(type) {
                    case 'police':
                        preset = 'islands#blueStretchyIcon';
                        iconColor = '#2196F3';
                        iconGlyph = 'car';
                        break;
                    case 'accident':
                        preset = 'islands#redStretchyIcon';
                        iconColor = '#F44336';
                        iconGlyph = 'crash';
                        break;
                    case 'hazard':
                        preset = 'islands#orangeStretchyIcon';
                        iconColor = '#FF9800';
                        iconGlyph = 'triangle';
                        break;
                }
                
                // –°–æ–∑–¥–∞–µ–º –º–µ—Ç–∫—É –Ø–Ω–¥–µ–∫—Å
                const placemark = new ymaps.Placemark(coords, {
                    hintContent: `${this.state.userName}: ${this.getToolName(type)}`,
                    balloonContent: `
                        <div style="padding: 10px; max-width: 250px;">
                            <strong style="color: #2196F3;">${this.getToolName(type)}</strong><br>
                            <small>–î–æ–±–∞–≤–∏–ª: ${this.state.userName}</small><br>
                            <small>–í—Ä–µ–º—è: ${new Date().toLocaleTimeString()}</small><br>
                            <button onclick="Game.removeMarkerById('${markerId}')" 
                                    style="margin-top: 8px; padding: 6px 12px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                –£–¥–∞–ª–∏—Ç—å
                            </button>
                        </div>
                    `,
                    markerId: markerId,
                    type: type,
                    user: this.state.userName
                }, {
                    preset: preset,
                    iconColor: iconColor,
                    draggable: true
                });
                
                // –°–æ–±—ã—Ç–∏–µ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
                placemark.events.add('dragend', (e) => {
                    const newCoords = placemark.geometry.getCoordinates();
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
                    const marker = this.state.markers.find(m => m.id === markerId);
                    if (marker) {
                        marker.coords = newCoords;
                        this.saveGameData();
                        this.showNotification('–ú–µ—Ç–∫–∞ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∞! +2 –æ—á–∫–∞', 'success');
                        
                        // –ù–∞—á–∏—Å–ª—è–µ–º –æ—á–∫–∏ –∑–∞ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ
                        this.state.userPoints += 2;
                        this.state.userActivity++;
                        this.updateUI();
                    }
                });
                
                // –î–æ–±–∞–≤–ª—è–µ–º –º–µ—Ç–∫—É –Ω–∞ –∫–∞—Ä—Ç—É
                this.state.yandexMap.geoObjects.add(placemark);
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏
                this.state.markers.push({
                    id: markerId,
                    type: type,
                    user: this.state.userName,
                    coords: coords,
                    timestamp: Date.now(),
                    yandexPlacemark: placemark
                });
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                this.state.userPoints -= cost;
                this.state.userActivity++;
                this.state.markersAdded++;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                this.updateUI();
                this.saveGameData();
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                this.showNotification(`${this.getToolName(type)} –¥–æ–±–∞–≤–ª–µ–Ω! -${cost} –æ—á–∫–æ–≤`, 'success');
            },
            
            // –£–¥–∞–ª–µ–Ω–∏–µ –±–ª–∏–∂–∞–π—à–µ–π –º–µ—Ç–∫–∏
            removeNearestMarker(coords) {
                const objects = this.state.yandexMap.geoObjects;
                let closestMarker = null;
                let minDistance = 0.0005; // ~50 –º–µ—Ç—Ä–æ–≤
                
                objects.each((object) => {
                    if (object.geometry && object.properties) {
                        const markerCoords = object.geometry.getCoordinates();
                        const distance = Math.sqrt(
                            Math.pow(markerCoords[0] - coords[0], 2) +
                            Math.pow(markerCoords[1] - coords[1], 2)
                        );
                        
                        if (distance < minDistance) {
                            minDistance = distance;
                            closestMarker = object;
                        }
                    }
                });
                
                if (closestMarker) {
                    const markerId = closestMarker.properties.get('markerId');
                    this.removeMarkerById(markerId);
                } else {
                    this.showNotification('–ú–µ—Ç–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ —Ä—è–¥–æ–º. –ü–æ–¥–≤–∏–Ω—å—Ç–µ—Å—å –±–ª–∏–∂–µ.', 'warning');
                }
            },
            
            // –£–¥–∞–ª–µ–Ω–∏–µ –º–µ—Ç–∫–∏ –ø–æ ID
            removeMarkerById(markerId) {
                // –ù–∞—Ö–æ–¥–∏–º –º–∞—Ä–∫–µ—Ä
                const index = this.state.markers.findIndex(m => m.id === markerId);
                if (index === -1) return;
                
                const marker = this.state.markers[index];
                
                // –£–¥–∞–ª—è–µ–º —Å –∫–∞—Ä—Ç—ã
                if (marker.yandexPlacemark) {
                    this.state.yandexMap.geoObjects.remove(marker.yandexPlacemark);
                }
                
                // –£–¥–∞–ª—è–µ–º –∏–∑ —Å–æ—Å—Ç–æ—è–Ω–∏—è
                this.state.markers.splice(index, 1);
                
                // –ù–∞—á–∏—Å–ª—è–µ–º –æ—á–∫–∏
                this.state.userPoints += 5;
                this.state.userActivity++;
                this.state.markersRemoved++;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º
                this.updateUI();
                this.saveGameData();
                
                this.showNotification('–ú–µ—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–∞! +5 –æ—á–∫–æ–≤', 'success');
            },
            
            // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –º–µ—Ç–æ–∫ –Ω–∞ –∫–∞—Ä—Ç—É
            loadMarkersToMap() {
                this.state.markers.forEach(markerData => {
                    let preset, iconColor;
                    switch(markerData.type) {
                        case 'police':
                            preset = 'islands#blueStretchyIcon';
                            iconColor = '#2196F3';
                            break;
                        case 'accident':
                            preset = 'islands#redStretchyIcon';
                            iconColor = '#F44336';
                            break;
                        case 'hazard':
                            preset = 'islands#orangeStretchyIcon';
                            iconColor = '#FF9800';
                            break;
                    }
                    
                    const placemark = new ymaps.Placemark(markerData.coords, {
                        hintContent: `${markerData.user}: ${this.getToolName(markerData.type)}`,
                        balloonContent: `
                            <div style="padding: 10px; max-width: 250px;">
                                <strong style="color: #2196F3;">${this.getToolName(markerData.type)}</strong><br>
                                <small>–î–æ–±–∞–≤–∏–ª: ${markerData.user}</small><br>
                                <button onclick="Game.removeMarkerById('${markerData.id}')" 
                                        style="margin-top: 8px; padding: 6px 12px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                    –£–¥–∞–ª–∏—Ç—å
                                </button>
                            </div>
                        `,
                        markerId: markerData.id,
                        type: markerData.type,
                        user: markerData.user
                    }, {
                        preset: preset,
                        iconColor: iconColor,
                        draggable: true
                    });
                    
                    placemark.events.add('dragend', (e) => {
                        const newCoords = placemark.geometry.getCoordinates();
                        markerData.coords = newCoords;
                        this.saveGameData();
                        this.showNotification('–ú–µ—Ç–∫–∞ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∞! +2 –æ—á–∫–∞', 'success');
                        
                        this.state.userPoints += 2;
                        this.state.userActivity++;
                        this.updateUI();
                    });
                    
                    this.state.yandexMap.geoObjects.add(placemark);
                    markerData.yandexPlacemark = placemark;
                });
            },
            
            // –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
            centerToUser() {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            const userCoords = [position.coords.latitude, position.coords.longitude];
                            this.state.yandexMap.setCenter(userCoords, 16);
                            this.showNotification('–ö–∞—Ä—Ç–∞ —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∞ –Ω–∞ –≤–∞—Å', 'success');
                        },
                        () => {
                            this.showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ', 'warning');
                            this.state.yandexMap.setCenter(this.config.center, this.config.zoom);
                        }
                    );
                } else {
                    this.showNotification('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è', 'warning');
                }
            },
            
            // –í—ã–±–æ—Ä –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
            selectTool(tool) {
                this.state.selectedTool = tool;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
                document.querySelectorAll('.tool-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                document.getElementById(`tool${tool.charAt(0).toUpperCase() + tool.slice(1)}`).classList.add('active');
                
                this.showNotification(`–í—ã–±—Ä–∞–Ω: ${this.getToolName(tool)}`, 'success');
            },
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI
            updateUI() {
                document.getElementById('markerCount').textContent = this.state.markers.length;
                document.getElementById('statPoints').textContent = this.state.userPoints;
                document.getElementById('statActivity').textContent = this.state.userActivity;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–Ω–≥
                const rank = this.calculateRank();
                document.getElementById('userRank').textContent = rank;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
                const progress = Math.min(Math.max(this.state.userPoints / 100, 0), 1) * 100;
                document.getElementById('statProgress').textContent = Math.round(progress) + '%';
            },
            
            // –†–∞—Å—á–µ—Ç —Ä–∞–Ω–≥–∞
            calculateRank() {
                const points = this.state.userPoints;
                if (points >= 1000) return '–ö–æ–º–∏—Å—Å–∞—Ä üëÆ‚Äç‚ôÇÔ∏è';
                if (points >= 500) return '–°–µ—Ä–∂–∞–Ω—Ç üëÆ';
                if (points >= 200) return '–û—Ñ–∏—Ü–µ—Ä üöî';
                if (points >= 100) return '–ü–∞—Ç—Ä—É–ª—å–Ω—ã–π üöì';
                return '–ù–æ–≤–∏—á–æ–∫ üö¶';
            },
            
            // –ü–æ–ª—É—á–µ–Ω–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
            getToolName(tool) {
                const names = {
                    police: '–ü–∞—Ç—Ä—É–ª—å üöì',
                    accident: '–î–¢–ü üí•',
                    hazard: '–û–ø–∞—Å–Ω–æ—Å—Ç—å ‚ö†Ô∏è',
                    clear: '–£–¥–∞–ª–µ–Ω–∏–µ üóëÔ∏è'
                };
                return names[tool] || tool;
            },
            
            // –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–æ–∏–º–æ—Å—Ç–∏
            getMarkerCost(type) {
                const costs = {
                    police: 10,
                    accident: 15,
                    hazard: 8
                };
                return costs[type] || 10;
            },
            
            // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
            saveGameData() {
                try {
                    const saveData = this.state.markers.map(marker => ({
                        id: marker.id,
                        type: marker.type,
                        user: marker.user,
                        coords: marker.coords,
                        timestamp: marker.timestamp
                    }));
                    
                    const gameData = {
                        markers: saveData,
                        userPoints: this.state.userPoints,
                        userActivity: this.state.userActivity,
                        markersAdded: this.state.markersAdded,
                        markersRemoved: this.state.markersRemoved,
                        userName: this.state.userName
                    };
                    
                    localStorage.setItem('traffic_patrol_data', JSON.stringify(gameData));
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
                }
            },
            
            // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
            loadGameData() {
                try {
                    const savedData = localStorage.getItem('traffic_patrol_data');
                    if (savedData) {
                        const data = JSON.parse(savedData);
                        
                        this.state.markers = data.markers || [];
                        this.state.userPoints = data.userPoints || 100;
                        this.state.userActivity = data.userActivity || 0;
                        this.state.markersAdded = data.markersAdded || 0;
                        this.state.markersRemoved = data.markersRemoved || 0;
                        this.state.userName = data.userName || '–ò–≥—Ä–æ–∫';
                        
                        document.getElementById('userName').textContent = this.state.userName;
                        
                        console.log('‚úÖ –ò–≥—Ä–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –∏–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
                }
            },
            
            // –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            showNotification(message, type = 'success') {
                // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ
                document.querySelectorAll('.notification').forEach(n => n.remove());
                
                // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–µ
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.innerHTML = `
                    <i class="fas fa-${type === 'error' ? 'exclamation-circle' : 'check-circle'}"></i>
                    ${message}
                `;
                
                document.body.appendChild(notification);
                
                // –ê–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏–µ
                setTimeout(() => {
                    notification.style.opacity = '0';
                    setTimeout(() => notification.remove(), 300);
                }, 3000);
            }
        };
        
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–π –¥–æ—Å—Ç—É–ø
        window.Game = Game;
        window.removeMarkerById = (id) => Game.removeMarkerById(id);
        
        // –ó–∞–ø—É—Å–∫ –∏–≥—Ä—ã
        document.addEventListener('DOMContentLoaded', () => {
            Game.init();
        });
    </script>
</body>
</html>
