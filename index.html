<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–æ–ª–∏—Ü–∏—è –ú–∞–π—è–º–∏üëÆ‚Äç‚ôÇÔ∏èüöîüëÆ‚Äç‚ôÇÔ∏è</title>
    
    <!-- Telegram Web App SDK -->
  <script>
    // ============ –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø FIREBASE ============
    const firebaseConfig = {
        apiKey: "AIzaSyD0zwcRZs7mI0RzPq3O18WOIWjhUO6yKZQ",
        authDomain: "miami-police-game.firebaseapp.com",
        databaseURL: "https://miami-police-game-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "miami-police-game",
        storageBucket: "miami-police-game.firebasestorage.app",
        messagingSenderId: "4861394604",
        appId: "1:4861394604:web:f2acb3a189f99396a66909"
    };
    
    // ============ –°–ò–°–¢–ï–ú–ê –ú–û–ù–ï–¢–ò–ó–ê–¶–ò–ò ============
    const TRIAL_PERIOD_DAYS = 30;
    const PREMIUM_FEATURES = {
        maxMarkers: 100,
        customIcons: true,
        prioritySync: true,
        noAds: true,
        analytics: true
    };
    
    // ============ –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ============
    const tg = window.Telegram.WebApp;
    let telegramUser = null;
    const EXPIRATION_TIME = 24 * 60 * 60 * 1000; // 24 —á–∞—Å–∞
    let MAX_MARKERS = 40;
    let autoDeleteInterval = null;
    let autoStartInterval = null;
    let countdownSeconds = 20;
    
    // –ò–≥—Ä–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    let ymap = null;
    let markers = [];
    let selectedTool = 'police';
    let points = 100;
    let activity = 0;
    let pendingCommentData = null;
    
    // Firebase
    let firebaseApp = null;
    let firebaseDatabase = null;
    let syncInterval = null;
    let onlinePlayers = {};
    let currentOnlineCount = 1;
    
    // ============ –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ============
    function getIconContent(type) {
        const icons = {
            'police': 'üö®',
            'accident': 'üöó',
            'help': 'üÜò',
            'hazard': 'üö¶'
        };
        return icons[type] || 'üìç';
    }
    
    function getIconColor(type) {
        const colors = {
            'police': '#2196F3',
            'accident': '#F44336',
            'help': '#4CAF50',
            'hazard': '#FF9800'
        };
        return colors[type] || '#2196F3';
    }
    
    function getBalloonTitle(type) {
        const titles = {
            'police': 'üö® –ü–∞—Ç—Ä—É–ª—å',
            'accident': 'üöó –î–¢–ü',
            'help': 'üÜò –ü–æ–º–æ—â—å',
            'hazard': 'üö¶ –ü—Ä–æ–±–∫–∞'
        };
        return titles[type] || 'üìç –ú–µ—Ç–∫–∞';
    }
    
    // ============ –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø TELEGRAM ============
    function initTelegram() {
        console.log('Initializing Telegram Web App...');
        
        tg.expand();
        tg.setHeaderColor('#0d1b2a');
        tg.setBackgroundColor('#0a1931');
        
        telegramUser = tg.initDataUnsafe?.user;
        
        if (telegramUser) {
            const userName = telegramUser.first_name || telegramUser.username || '–ò–≥—Ä–æ–∫';
            document.getElementById('userWelcome').textContent = `–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${userName}!`;
            window.userId = telegramUser.id.toString();
            window.userName = userName;
        } else {
            document.getElementById('userWelcome').textContent = '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –∏–≥—Ä—É!';
            window.userId = 'guest_' + Math.random().toString(36).substr(2, 9);
            window.userName = '–ì–æ—Å—Ç—å';
        }
        
        tg.BackButton.show();
        tg.BackButton.onClick(() => {
            tg.showConfirm('–ó–∞–∫—Ä—ã—Ç—å –∏–≥—Ä—É?', (confirmed) => {
                if (confirmed) tg.close();
            });
        });
        
        startAutoStartTimer();
        initFirebase();
    }
    
    // ============ –ü–†–û–í–ï–†–ö–ê –ü–û–î–ü–ò–°–ö–ò ============
    function checkSubscription() {
        const installDate = getInstallDate();
        const currentDate = new Date();
        const daysPassed = Math.floor((currentDate - installDate) / (1000 * 60 * 60 * 24));
        
        if (daysPassed <= TRIAL_PERIOD_DAYS) {
            return { 
                status: 'trial', 
                daysLeft: TRIAL_PERIOD_DAYS - daysPassed,
                features: PREMIUM_FEATURES 
            };
        } else {
            const subscription = checkActiveSubscription();
            return {
                status: subscription ? 'premium' : 'expired',
                daysLeft: 0,
                features: subscription ? PREMIUM_FEATURES : null
            };
        }
    }
    
    function getInstallDate() {
        let installDate = localStorage.getItem('app_install_date');
        if (!installDate) {
            installDate = new Date().toISOString();
            localStorage.setItem('app_install_date', installDate);
            console.log('–î–∞—Ç–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞:', installDate);
        }
        return new Date(installDate);
    }
    
    function checkActiveSubscription() {
        return localStorage.getItem('premium_subscription') === 'active';
    }
    
    function updatePremiumFeatures() {
        const subscription = checkSubscription();
        
        if (subscription.status === 'trial') {
            MAX_MARKERS = 40;
            document.getElementById('trialDays').textContent = subscription.daysLeft;
            document.getElementById('trialNotification').style.display = 'flex';
            document.getElementById('rulesMaxMarkers').textContent = '40';
            
            setTimeout(() => {
                document.getElementById('trialNotification').style.display = 'none';
            }, 5000);
        } else if (subscription.status === 'premium') {
            MAX_MARKERS = 100;
            document.getElementById('markerLimit').innerHTML = '‚≠ê –ü—Ä–µ–º–∏—É–º: 100 –º–µ—Ç–æ–∫';
            document.getElementById('maxMarkers').textContent = '100';
            document.getElementById('rulesMaxMarkers').textContent = '100';
            document.getElementById('trialNotification').style.display = 'none';
        } else if (subscription.status === 'expired') {
            MAX_MARKERS = 40;
            document.getElementById('rulesMaxMarkers').textContent = '40';
            setTimeout(() => {
                showSubscriptionModal();
            }, 2000);
        }
        
        document.getElementById('maxMarkers').textContent = MAX_MARKERS;
    }
    
    function purchaseSubscription(plan) {
        tg.showPopup({
            title: '–ü—Ä–µ–º–∏—É–º –ø–æ–¥–ø–∏—Å–∫–∞',
            message: '–î–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º —Ñ—É–Ω–∫—Ü–∏—è–º:\n‚Ä¢ 100 –º–µ—Ç–æ–∫ –≤–º–µ—Å—Ç–æ 40\n‚Ä¢ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è\n‚Ä¢ –ë–µ–∑ —Ä–µ–∫–ª–∞–º—ã\n‚Ä¢ –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞',
            buttons: [
                { id: 'monthly', type: 'default', text: '99‚ÇΩ/–º–µ—Å—è—Ü' },
                { id: 'yearly', type: 'default', text: '990‚ÇΩ/–≥–æ–¥' },
                { id: 'cancel', type: 'cancel' }
            ]
        }, function(buttonId) {
            if (buttonId === 'monthly' || buttonId === 'yearly') {
                initiateTelegramPayment(buttonId);
            }
        });
    }
    
    function initiateTelegramPayment(plan) {
        // –î–µ–º–æ-—Ä–µ–∂–∏–º –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        localStorage.setItem('premium_subscription', 'active');
        updatePremiumFeatures();
        alert('‚úÖ –ü—Ä–µ–º–∏—É–º –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω! –¢–µ–ø–µ—Ä—å —É –≤–∞—Å 100 –º–µ—Ç–æ–∫!');
    }
    
    function showSubscriptionModal() {
        const modal = document.createElement('div');
        modal.className = 'subscription-modal';
        modal.innerHTML = `
            <div class="modal-content">
                <div class="modal-header">
                    <h2><i class="fas fa-crown"></i> –ü—Ä–æ–±–Ω—ã–π –ø–µ—Ä–∏–æ–¥ –∑–∞–∫–æ–Ω—á–∏–ª—Å—è</h2>
                    <button class="modal-close" onclick="document.body.removeChild(this.parentElement.parentElement)">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <p>–î–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è –∏–≥—Ä—ã —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–¥–ø–∏—Å–∫–∞.</p>
                    <div class="features-list">
                        <div class="feature">
                            <i class="fas fa-check"></i> 100 –º–µ—Ç–æ–∫ –≤–º–µ—Å—Ç–æ 40
                        </div>
                        <div class="feature">
                            <i class="fas fa-check"></i> –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
                        </div>
                        <div class="feature">
                            <i class="fas fa-check"></i> –ë–µ–∑ —Ä–µ–∫–ª–∞–º—ã
                        </div>
                        <div class="feature">
                            <i class="fas fa-check"></i> –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                        </div>
                    </div>
                    <div class="pricing">
                        <button class="price-btn" onclick="purchaseSubscription('monthly')">
                            <div class="price">99‚ÇΩ</div>
                            <div class="period">–≤ –º–µ—Å—è—Ü</div>
                        </button>
                        <button class="price-btn recommended" onclick="purchaseSubscription('yearly')">
                            <div class="price">990‚ÇΩ</div>
                            <div class="period">–≤ –≥–æ–¥ (—ç–∫–æ–Ω–æ–º–∏—è 20%)</div>
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                document.body.removeChild(modal);
            }
        });
    }
    
    // ============ –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø FIREBASE ============
    function initFirebase() {
        try {
            firebaseApp = firebase.initializeApp(firebaseConfig);
            firebaseDatabase = firebase.database();
            
            console.log('‚úÖ Firebase —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω!');
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
            const connectedRef = firebaseDatabase.ref(".info/connected");
            connectedRef.on("value", (snap) => {
                if (snap.val() === true) {
                    console.log("üî• –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ Firebase –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏");
                    document.getElementById('onlineIndicator').innerHTML = 
                        '<i class="fas fa-wifi"></i> –û–Ω–ª–∞–π–Ω';
                    document.getElementById('onlineIndicator').style.color = '#4CAF50';
                } else {
                    console.log("‚ùå –û—Ç–∫–ª—é—á–µ–Ω–æ –æ—Ç Firebase");
                    document.getElementById('onlineIndicator').innerHTML = 
                        '<i class="fas fa-wifi-slash"></i> –û—Ñ–ª–∞–π–Ω';
                    document.getElementById('onlineIndicator').style.color = '#F44336';
                }
            });
            
            const syncStatus = document.getElementById('syncStatus');
            if (syncStatus) {
                syncStatus.textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ Firebase ‚úì';
                syncStatus.style.color = '#4CAF50';
            }
            
            startFirebaseSync();
            
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ Firebase:', error);
            
            const syncStatus = document.getElementById('syncStatus');
            if (syncStatus) {
                syncStatus.textContent = 'Firebase –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ';
                syncStatus.style.color = '#FF9800';
            }
            
            useLocalStorage();
        }
    }
    
    // ============ –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø –° FIREBASE ============
    function startFirebaseSync() {
        loadMarkersFromFirebase();
        listenToFirebaseChanges();
        syncInterval = setInterval(syncToFirebase, 5000); // –£–≤–µ–ª–∏—á–∏–ª–∏ —á–∞—Å—Ç–æ—Ç—É –¥–æ 5 —Å–µ–∫—É–Ω–¥
        updateOnlineStatus();
    }
    
    function loadMarkersFromFirebase() {
        try {
            const markersRef = firebaseDatabase.ref('markers');
            
            markersRef.once('value').then((snapshot) => {
                const firebaseMarkers = snapshot.val() || [];
                console.log(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${firebaseMarkers.length} –º–µ—Ç–æ–∫ –∏–∑ Firebase`);
                updateMarkersFromCloud(firebaseMarkers);
            });
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ Firebase:', error);
            useLocalStorage();
        }
    }
    
    function listenToFirebaseChanges() {
        try {
            const markersRef = firebaseDatabase.ref('markers');
            
            markersRef.on('value', (snapshot) => {
                const firebaseMarkers = snapshot.val() || [];
                console.log('–ü–æ–ª—É—á–µ–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ Firebase:', firebaseMarkers.length, '–º–µ—Ç–æ–∫');
                updateMarkersFromCloud(firebaseMarkers);
            });
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è Firebase:', error);
        }
    }
    
    function updateMarkersFromCloud(cloudMarkers) {
        if (!ymap) {
            console.log('–ö–∞—Ä—Ç–∞ –µ—â–µ –Ω–µ –≥–æ—Ç–æ–≤–∞, –æ—Ç–∫–ª–∞–¥—ã–≤–∞—é –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ...');
            setTimeout(() => updateMarkersFromCloud(cloudMarkers), 1000);
            return;
        }
        
        const now = Date.now();
        const activeCloudMarkers = cloudMarkers.filter(marker => 
            now - marker.timestamp <= EXPIRATION_TIME
        );
        
        console.log(`–ê–∫—Ç–∏–≤–Ω—ã—Ö –º–µ—Ç–æ–∫ –≤ –æ–±–ª–∞–∫–µ: ${activeCloudMarkers.length}`);
        
        // –£–¥–∞–ª—è–µ–º –º–µ—Ç–∫–∏, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ –æ–±–ª–∞–∫–µ
        markers.forEach(marker => {
            const existsInCloud = activeCloudMarkers.some(cm => cm.id === marker.id);
            if (!existsInCloud && marker.placemark) {
                ymap.geoObjects.remove(marker.placemark);
            }
        });
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–ª–∏ –¥–æ–±–∞–≤–ª—è–µ–º –º–µ—Ç–∫–∏ –∏–∑ –æ–±–ª–∞–∫–∞
        markers = activeCloudMarkers.map(markerData => {
            const existingIndex = markers.findIndex(m => m.id === markerData.id);
            
            if (existingIndex !== -1 && markers[existingIndex].placemark) {
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –º–µ—Ç–∫—É
                ymap.geoObjects.remove(markers[existingIndex].placemark);
            }
            
            // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –º–µ—Ç–∫—É
            const placemark = createPlacemark(markerData);
            ymap.geoObjects.add(placemark);
            
            return {
                ...markerData,
                placemark: placemark
            };
        });
        
        updateUI();
        checkMarkerLimit();
        
        console.log(`–û–±–Ω–æ–≤–ª–µ–Ω–æ ${markers.length} –º–µ—Ç–æ–∫ –Ω–∞ –∫–∞—Ä—Ç–µ`);
    }
    
    function syncToFirebase() {
        try {
            // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
            const markersData = markers.map(marker => ({
                id: marker.id,
                type: marker.type,
                coords: marker.coords,
                comment: marker.comment,
                timestamp: marker.timestamp,
                author: marker.author || window.userName,
                authorId: marker.authorId || window.userId,
                iconType: marker.type,
                iconContent: getIconContent(marker.type),
                iconColor: getIconColor(marker.type)
            }));
            
            firebaseDatabase.ref('markers').set(markersData)
                .then(() => {
                    console.log(`‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ ${markersData.length} –º–µ—Ç–æ–∫ —Å Firebase`);
                })
                .catch(error => {
                    console.error('‚ùå –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:', error);
                });
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:', error);
        }
    }
    
    function updateOnlineStatus() {
        try {
            const userStatusRef = firebaseDatabase.ref('online/' + window.userId);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–≤–æ–π —Å—Ç–∞—Ç—É—Å –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
            const updateMyStatus = () => {
                userStatusRef.set({
                    name: window.userName,
                    lastSeen: Date.now(),
                    userId: window.userId
                });
            };
            
            updateMyStatus();
            setInterval(updateMyStatus, 5000);
            
            // –£–¥–∞–ª—è–µ–º –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ
            userStatusRef.onDisconnect().remove();
            
            // –°–ª—É—à–∞–µ–º –¥—Ä—É–≥–∏—Ö –∏–≥—Ä–æ–∫–æ–≤
            const onlineRef = firebaseDatabase.ref('online');
            onlineRef.on('value', (snapshot) => {
                const users = snapshot.val() || {};
                onlinePlayers = users;
                
                const now = Date.now();
                const onlineUserIds = Object.keys(users).filter(id => {
                    const user = users[id];
                    return now - user.lastSeen < 30000; // 30 —Å–µ–∫—É–Ω–¥
                });
                
                currentOnlineCount = Math.max(1, onlineUserIds.length);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏
                document.getElementById('onlineCount').textContent = currentOnlineCount;
                document.getElementById('playersOnline').textContent = currentOnlineCount;
                document.getElementById('modalOnlineCount').textContent = currentOnlineCount;
                document.getElementById('onlineIndicator').innerHTML = 
                    `<i class="fas fa-wifi"></i> ${currentOnlineCount}`;
                    
                updatePlayersList(users);
            });
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –æ–Ω–ª–∞–π–Ω —Å—Ç–∞—Ç—É—Å–∞:', error);
        }
    }
    
    function updatePlayersList(users) {
        const playersList = document.getElementById('playersList');
        if (!playersList) return;
        
        const now = Date.now();
        const onlinePlayersArray = Object.entries(users)
            .filter(([id, user]) => now - user.lastSeen < 30000)
            .sort((a, b) => b[1].lastSeen - a[1].lastSeen);
        
        playersList.innerHTML = '';
        
        if (onlinePlayersArray.length === 0) {
            playersList.innerHTML = '<p style="text-align: center; color: #aaa;">–ù–µ—Ç –∏–≥—Ä–æ–∫–æ–≤ –æ–Ω–ª–∞–π–Ω</p>';
            return;
        }
        
        onlinePlayersArray.forEach(([id, user]) => {
            const isOnline = now - user.lastSeen < 30000;
            const playerName = user.name || '–ì–æ—Å—Ç—å';
            const isCurrentUser = id === window.userId;
            const playerItem = document.createElement('div');
            playerItem.className = `player-item ${isOnline ? '' : 'offline'}`;
            
            const initials = playerName.split(' ').map(n => n[0]).join('').toUpperCase() || '–ì';
            
            playerItem.innerHTML = `
                <div class="player-info">
                    <div class="player-avatar" style="${isCurrentUser ? 'background: linear-gradient(135deg, #FF9800, #F57C00);' : ''}">
                        ${initials}
                        ${isCurrentUser ? '‚≠ê' : ''}
                    </div>
                    <div>
                        <div class="player-name">
                            ${playerName} ${isCurrentUser ? '(–í—ã)' : ''}
                        </div>
                        <div class="player-status ${isOnline ? '' : 'offline'}">
                            ${isOnline ? 'üü¢ –û–Ω–ª–∞–π–Ω' : '‚ö´ –ù–µ –≤ —Å–µ—Ç–∏'}
                        </div>
                    </div>
                </div>
                ${!isCurrentUser ? `
                <div class="player-actions">
                    <button class="action-btn" onclick="sendMessageToPlayer('${id}', '${playerName}')">
                        <i class="fas fa-comment"></i>
                    </button>
                </div>
                ` : ''}
            `;
            
            playersList.appendChild(playerItem);
        });
    }
    
    function sendMessageToPlayer(playerId, playerName) {
        const message = prompt(`–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ ${playerName}:`, '');
        if (message && message.trim()) {
            alert(`–°–æ–æ–±—â–µ–Ω–∏–µ "${message}" –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ ${playerName}`);
        }
    }
    
    // ============ –õ–û–ö–ê–õ–¨–ù–û–ï –•–†–ê–ù–ò–õ–ò–©–ï ============
    function useLocalStorage() {
        console.log('–ò—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ...');
        
        try {
            const saved = localStorage.getItem('miami_police_shared');
            if (saved) {
                const data = JSON.parse(saved);
                if (data.markers) {
                    updateMarkersFromCloud(data.markers);
                }
            }
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞:', e);
        }
    }
    
    function saveToLocalStorage() {
        try {
            const data = {
                markers: markers.map(m => ({
                    id: m.id,
                    type: m.type,
                    coords: m.coords,
                    comment: m.comment,
                    timestamp: m.timestamp,
                    author: m.author || window.userName
                })),
                lastUpdate: Date.now()
            };
            
            localStorage.setItem('miami_police_shared', JSON.stringify(data));
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', e);
        }
    }
    
    // ============ –¢–ê–ô–ú–ï–† –ê–í–¢–û–ó–ê–ü–£–°–ö–ê ============
    function startAutoStartTimer() {
        const countdownElement = document.getElementById('countdown');
        countdownElement.textContent = countdownSeconds;
        
        autoStartInterval = setInterval(() => {
            countdownSeconds--;
            countdownElement.textContent = countdownSeconds;
            
            if (countdownSeconds <= 0) {
                clearInterval(autoStartInterval);
                if (document.getElementById('splashScreen').style.display !== 'none') {
                    startGame();
                }
            }
        }, 1000);
    }
    
    // ============ –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê ============
    function openRulesModal() {
        document.getElementById('rulesModal').style.display = 'flex';
    }
    
    function openPlayersModal() {
        document.getElementById('playersModal').style.display = 'flex';
    }
    
    function openControlsModal() {
        document.getElementById('controlsModal').style.display = 'flex';
    }
    
    function closeModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
    }
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –æ–∫–Ω–∞
    document.addEventListener('click', function(event) {
        const modals = ['rulesModal', 'playersModal', 'controlsModal'];
        modals.forEach(modalId => {
            const modal = document.getElementById(modalId);
            if (event.target === modal) {
                closeModal(modalId);
            }
        });
    });
    
    // ============ –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò –ò–ì–†–´ ============
    function skipIntro() {
        clearInterval(autoStartInterval);
        const splash = document.getElementById('splashScreen');
        const mainApp = document.getElementById('mainApp');
        
        splash.style.opacity = '0';
        splash.style.transition = 'opacity 0.3s ease';
        
        setTimeout(() => {
            splash.style.display = 'none';
            mainApp.classList.add('active');
            initGame();
        }, 300);
    }
    
    function startGame() {
        clearInterval(autoStartInterval);
        const splash = document.getElementById('splashScreen');
        const mainApp = document.getElementById('mainApp');
        
        splash.style.opacity = '0';
        splash.style.transition = 'opacity 0.5s ease';
        
        setTimeout(() => {
            splash.style.display = 'none';
            mainApp.classList.add('active');
            initGame();
        }, 500);
    }
    
    function initGame() {
        console.log('üöî –ó–∞–ø—É—Å–∫ –∏–≥—Ä—ã...');
        
        updatePremiumFeatures();
        loadUserData();
        startAutoDeleteChecker();
        
        if (window.ymaps) {
            ymaps.ready(initMap);
        } else {
            showError('‚ùå –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç—ã –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∏—Å—å');
        }
    }
    
    // ============ –ö–ê–†–¢–ê –ò –ì–ï–û–õ–û–ö–ê–¶–ò–Ø ============
    function initMap() {
        try {
            let center = [55.459619, 38.438920];
            let zoom = 15;
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        center = [position.coords.latitude, position.coords.longitude];
                        zoom = 17;
                        createMap(center, zoom);
                    },
                    function(error) {
                        console.warn('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞:', error);
                        createMap(center, zoom);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 5000,
                        maximumAge: 0
                    }
                );
            } else {
                createMap(center, zoom);
            }
            
            function createMap(centerCoords, zoomLevel) {
                ymap = new ymaps.Map('yandex-map', {
                    center: centerCoords,
                    zoom: zoomLevel,
                    controls: ['zoomControl', 'fullscreenControl', 'typeSelector']
                });
                
                const geolocationControl = new ymaps.control.GeolocationControl({
                    options: {
                        noPlacemark: true,
                        position: { right: 10, top: 80 }
                    }
                });
                ymap.controls.add(geolocationControl);
                
                document.getElementById('loading').style.display = 'none';
                
                ymap.events.add('click', function(e) {
                    const coords = e.get('coords');
                    
                    if (selectedTool === 'clear') {
                        removeNearMarker(coords);
                    } else if (selectedTool === 'help') {
                        pendingCommentData = { coords, type: selectedTool };
                        showCommentModal();
                    } else {
                        addMarker(coords, selectedTool, null);
                    }
                });
            }
            
            updateUI();
            checkMarkerLimit();
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∫–∞—Ä—Ç—ã:', error);
            showError('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç—ã');
        }
    }
    
    // ============ –°–û–ó–î–ê–ù–ò–ï –ú–ï–¢–û–ö ============
    function createPlacemark(markerData) {
        const iconContent = getIconContent(markerData.type);
        const iconColor = getIconColor(markerData.type);
        const balloonTitle = getBalloonTitle(markerData.type);
        const isMyMarker = markerData.authorId === window.userId;
        
        const placemark = new ymaps.Placemark(
            markerData.coords,
            {
                balloonContent: `
                    <div style="padding: 10px; max-width: 250px;">
                        <h3 style="margin: 0 0 10px 0; color: ${iconColor}">
                            ${balloonTitle}
                        </h3>
                        ${markerData.comment ? `<p><strong>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</strong> ${markerData.comment}</p>` : ''}
                        <p><strong>–ê–≤—Ç–æ—Ä:</strong> ${markerData.author || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</p>
                        <p><strong>–í—Ä–µ–º—è:</strong> ${new Date(markerData.timestamp).toLocaleString()}</p>
                        ${isMyMarker ? `
                            <button onclick="deleteMarkerFromBalloon('${markerData.id}')" 
                                    style="background: #f44336; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; margin-top: 10px;">
                                –£–¥–∞–ª–∏—Ç—å –º–æ—é –º–µ—Ç–∫—É
                            </button>
                        ` : ''}
                    </div>
                `,
                iconCaption: markerData.comment || ''
            },
            {
                preset: 'islands#circleIcon',
                iconColor: iconColor,
                iconLayout: 'default#imageWithContent',
                iconImageHref: '',
                iconImageSize: [40, 40],
                iconImageOffset: [-20, -40],
                iconContentOffset: [0, 10],
                iconContentLayout: ymaps.templateLayoutFactory.createClass(
                    `<div style="
                        font-size: 24px;
                        text-align: center;
                        width: 40px;
                        height: 40px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        background-color: ${iconColor};
                        border-radius: 50%;
                        border: 3px solid white;
                        box-shadow: 0 2px 5px rgba(0,0,0,0.3);
                        color: white;
                        position: relative;
                    ">
                        ${iconContent}
                        ${isMyMarker ? `
                        <div style="
                            position: absolute;
                            top: -5px;
                            right: -5px;
                            background: #f44336;
                            color: white;
                            border-radius: 50%;
                            width: 20px;
                            height: 20px;
                            font-size: 12px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            cursor: pointer;
                            border: 1px solid white;
                        " onclick="deleteMarker('${markerData.id}'); event.stopPropagation();">
                            √ó
                        </div>
                        ` : ''}
                    </div>`
                )
            }
        );
        
        placemark.events.add('click', function() {
            placemark.balloon.open();
        });
        
        return placemark;
    }
    
    function addMarker(coords, type, comment = null) {
        if (markers.length >= MAX_MARKERS) {
            alert(`‚ùå –î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç –≤ ${MAX_MARKERS} –º–µ—Ç–æ–∫!`);
            return;
        }
        
        const markerId = Date.now().toString() + Math.random().toString(36).substr(2, 9);
        const markerData = {
            id: markerId,
            type: type,
            coords: coords,
            comment: comment,
            timestamp: Date.now(),
            author: window.userName,
            authorId: window.userId,
            iconType: type,
            iconContent: getIconContent(type),
            iconColor: getIconColor(type)
        };
        
        const placemark = createPlacemark(markerData);
        const markerWithPlacemark = {
            ...markerData,
            placemark: placemark
        };
        
        markers.push(markerWithPlacemark);
        ymap.geoObjects.add(placemark);
        
        points += 10;
        activity += 1;
        
        updateUI();
        checkMarkerLimit();
        syncToFirebase();
        
        console.log(`‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –º–µ—Ç–∫–∞: ${type}`);
    }
    
    function deleteMarker(markerId) {
        const markerIndex = markers.findIndex(m => m.id === markerId);
        if (markerIndex !== -1) {
            const marker = markers[markerIndex];
            if (marker.placemark) {
                ymap.geoObjects.remove(marker.placemark);
            }
            
            markers.splice(markerIndex, 1);
            
            points += 5;
            updateUI();
            checkMarkerLimit();
            syncToFirebase();
            
            alert('üóëÔ∏è –ú–µ—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–∞');
        }
    }
    
    function deleteMarkerFromBalloon(markerId) {
        deleteMarker(markerId);
    }
    
    function removeNearMarker(coords) {
        if (!markers.length) {
            alert('–ù–µ—Ç –º–µ—Ç–æ–∫ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è');
            return;
        }
        
        let closestMarker = null;
        let minDistance = Infinity;
        
        markers.forEach(marker => {
            const distance = Math.sqrt(
                Math.pow(marker.coords[0] - coords[0], 2) + 
                Math.pow(marker.coords[1] - coords[1], 2)
            ) * 111000;
            
            if (distance < 50 && distance < minDistance) {
                minDistance = distance;
                closestMarker = marker;
            }
        });
        
        if (closestMarker) {
            deleteMarker(closestMarker.id);
        } else {
            alert('‚ùå –ù–µ—Ç –º–µ—Ç–æ–∫ —Ä—è–¥–æ–º');
        }
    }
    
    // ============ –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ============
    function selectTool(tool) {
        selectedTool = tool;
        document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
        event.target.closest('.tool-btn').classList.add('active');
    }
    
    function showCommentModal() {
        const comment = prompt('–í–≤–µ–¥–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –º–µ—Ç–∫–µ (–Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):', '');
        if (comment !== null) {
            addMarker(pendingCommentData.coords, pendingCommentData.type, comment.trim());
        }
        pendingCommentData = null;
    }
    
    function updateUI() {
        document.getElementById('markerCount').textContent = markers.length;
        document.getElementById('points').textContent = points;
        document.getElementById('activity').textContent = activity;
        
        const rank = calculateRank();
        document.getElementById('userRank').textContent = rank.name;
        document.getElementById('rankPoints').textContent = rank.progress + '%';
    }
    
    function calculateRank() {
        if (activity >= 100) return { name: '–ö–æ–º–∏—Å—Å–∞—Ä', progress: 100 };
        if (activity >= 50) return { name: '–î–µ—Ç–µ–∫—Ç–∏–≤', progress: Math.min(100, (activity - 50) * 2) };
        if (activity >= 20) return { name: '–°–µ—Ä–∂–∞–Ω—Ç', progress: Math.min(100, (activity - 20) * 3.33) };
        if (activity >= 5) return { name: '–ü–∞—Ç—Ä—É–ª—å–Ω—ã–π', progress: Math.min(100, (activity - 5) * 6.67) };
        return { name: '–ù–æ–≤–∏—á–æ–∫', progress: Math.min(100, activity * 20) };
    }
    
    function checkMarkerLimit() {
        const limitElement = document.getElementById('markerLimit');
        if (markers.length >= MAX_MARKERS * 0.9) {
            limitElement.style.display = 'block';
        } else {
            limitElement.style.display = 'none';
        }
    }
    
    function updateExpiringCount() {
        const now = Date.now();
        const expiringSoon = markers.filter(m => now - m.timestamp > EXPIRATION_TIME * 0.9).length;
        if (expiringSoon > 0) {
            console.log(`${expiringSoon} –º–µ—Ç–æ–∫ —Å–∫–æ—Ä–æ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã`);
        }
    }
    
    function startAutoDeleteChecker() {
        if (autoDeleteInterval) clearInterval(autoDeleteInterval);
        
        autoDeleteInterval = setInterval(() => {
            const now = Date.now();
            const initialCount = markers.length;
            
            markers = markers.filter(marker => {
                if (now - marker.timestamp > EXPIRATION_TIME) {
                    if (marker.placemark && ymap) {
                        ymap.geoObjects.remove(marker.placemark);
                    }
                    return false;
                }
                return true;
            });
            
            if (markers.length < initialCount) {
                updateUI();
                checkMarkerLimit();
                syncToFirebase();
                console.log(`–ê–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏–µ: —É–¥–∞–ª–µ–Ω–æ ${initialCount - markers.length} —Å—Ç–∞—Ä—ã—Ö –º–µ—Ç–æ–∫`);
            }
        }, 60000);
    }
    
    function loadUserData() {
        try {
            const savedData = localStorage.getItem('user_data_' + window.userId);
            if (savedData) {
                const data = JSON.parse(savedData);
                points = data.points || points;
                activity = data.activity || activity;
                updateUI();
            }
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', e);
        }
    }
    
    function showError(message) {
        document.getElementById('loading').innerHTML = `
            <i class="fas fa-exclamation-triangle" style="font-size: 2.5rem; margin-bottom: 20px; color: #f44336;"></i>
            <p style="color: #f44336; font-size: 1.1rem;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p>
            <p style="color: #ff9800; font-size: 0.9rem; margin-top: 10px;">${message}</p>
        `;
    }
    
    // ============ –ó–ê–ü–£–°–ö –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ============
    document.addEventListener('DOMContentLoaded', function() {
        initTelegram();
        
        setTimeout(() => {
            const subscription = checkSubscription();
            if (subscription.status === 'expired') {
                setTimeout(showSubscriptionModal, 2000);
            }
        }, 1000);
    });
    
    // –≠–∫—Å–ø–æ—Ä—Ç —Ñ—É–Ω–∫—Ü–∏–π –¥–ª—è –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
    window.startGame = startGame;
    window.skipIntro = skipIntro;
    window.selectTool = selectTool;
    window.openRulesModal = openRulesModal;
    window.openPlayersModal = openPlayersModal;
    window.openControlsModal = openControlsModal;
    window.closeModal = closeModal;
    window.deleteMarker = deleteMarker;
    window.deleteMarkerFromBalloon = deleteMarkerFromBalloon;
    window.purchaseSubscription = purchaseSubscription;
    window.showSubscriptionModal = showSubscriptionModal;
    window.sendMessageToPlayer = sendMessageToPlayer;
</script>
</body>
</html>
