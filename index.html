<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üö® Traffic Patrol - –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç—ã</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://api-maps.yandex.ru/2.1/?apikey=365e247d-d853-4425-b9cc-13bfa1169a49&lang=ru_RU"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: Arial, sans-serif; 
            background: #1a237e; 
            color: white;
            height: 100vh;
            overflow: hidden;
        }
        
        .app { display: flex; flex-direction: column; height: 100vh; }
        
        /* –•–µ–¥–µ—Ä */
        .header { 
            background: #0d1b2a; 
            padding: 15px; 
            text-align: center;
            border-bottom: 3px solid #2196f3;
        }
        
        .header h1 { 
            color: #4fc3f7; 
            margin: 0 0 5px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .header-stats {
            color: #81c784;
            font-size: 0.9rem;
        }
        
        /* –ö–∞—Ä—Ç–∞ */
        .map-container {
            flex: 1;
            margin: 10px;
            border: 3px solid #2196f3;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }
        
        #yandex-map {
            width: 100%;
            height: 100%;
        }
        
        /* –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã */
        .tools {
            display: flex;
            justify-content: center;
            gap: 10px;
            padding: 15px;
            background: #0d1b2a;
            flex-wrap: wrap;
        }
        
        .tool-btn {
            padding: 12px 20px;
            background: #2196f3;
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .tool-btn:hover {
            background: #1976d2;
        }
        
        .tool-btn.active {
            background: #1976d2;
            box-shadow: 0 0 15px #2196f3;
            transform: translateY(-2px);
        }
        
        /* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */
        .stats {
            display: flex;
            justify-content: space-around;
            padding: 10px;
            background: rgba(0,0,0,0.5);
            font-size: 0.9rem;
        }
        
        .stat-value {
            font-size: 1.3rem;
            font-weight: bold;
            color: #4fc3f7;
        }
        
        /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4caf50;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            z-index: 1000;
            animation: slideIn 0.3s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .notification.error { background: #f44336; }
        .notification.warning { background: #ff9800; }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="app">
        <div class="header">
            <h1><i class="fas fa-traffic-light"></i> Traffic Patrol</h1>
            <div class="header-stats">
                –ú–µ—Ç–æ–∫: <span id="markerCount">0</span> | –û—á–∫–∏: <span id="points">100</span>
            </div>
        </div>
        
        <div class="map-container">
            <div id="yandex-map"></div>
            <div id="loading" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                <i class="fas fa-sync fa-spin" style="font-size: 2rem; margin-bottom: 15px;"></i>
                <p>–ó–∞–≥—Ä—É–∑–∫–∞ –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç...</p>
            </div>
        </div>
        
        <div class="tools">
            <button class="tool-btn active" onclick="selectTool('police')">
                <i class="fas fa-car"></i> –ü–∞—Ç—Ä—É–ª—å
            </button>
            <button class="tool-btn" onclick="selectTool('accident')">
                <i class="fas fa-car-crash"></i> –î–¢–ü
            </button>
            <button class="tool-btn" onclick="selectTool('hazard')">
                <i class="fas fa-exclamation-triangle"></i> –û–ø–∞—Å–Ω–æ—Å—Ç—å
            </button>
            <button class="tool-btn" onclick="selectTool('clear')">
                <i class="fas fa-trash-alt"></i> –£–¥–∞–ª–∏—Ç—å
            </button>
        </div>
        
        <div class="stats">
            <div>
                <div class="stat-value" id="activity">0</div>
                <div>–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</div>
            </div>
            <div>
                <div class="stat-value" id="rankPoints">100%</div>
                <div>–ü—Ä–æ–≥—Ä–µ—Å—Å</div>
            </div>
            <div>
                <div class="stat-value" id="userRank">–ù–æ–≤–∏—á–æ–∫</div>
                <div>–†–∞–Ω–≥</div>
            </div>
        </div>
    </div>

    <script>
        // ============ –ü–†–û–°–¢–ê–Ø –†–ê–ë–û–ß–ê–Ø –í–ï–†–°–ò–Ø ============
        
        let ymap = null;
        let markers = [];
        let selectedTool = 'police';
        let points = 100;
        let activity = 0;
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        function init() {
            console.log('–ó–∞–ø—É—Å–∫ Traffic Patrol...');
            
            // Telegram
            if (window.Telegram?.WebApp) {
                const tg = window.Telegram.WebApp;
                tg.expand();
                console.log('Telegram OK');
            }
            
            // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–π
            loadGame();
            
            // –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç—ã
            if (window.ymaps) {
                ymaps.ready(initMap);
            } else {
                showError('–Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç—ã –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∏—Å—å');
            }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
        function initMap() {
            try {
                console.log('–°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ä—Ç—ã...');
                
                // –ü–†–û–°–¢–ê–Ø –ö–ê–†–¢–ê –ë–ï–ó TrafficLayer
                ymap = new ymaps.Map('yandex-map', {
                    center: [55.459619, 38.438920],
                    zoom: 15,
                    controls: ['zoomControl', 'fullscreenControl', 'typeSelector']
                });
                
                // –°–∫—Ä—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
                document.getElementById('loading').style.display = 'none';
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–æ–≤
                ymap.events.add('click', function(e) {
                    const coords = e.get('coords');
                    if (selectedTool === 'clear') {
                        removeNearMarker(coords);
                    } else {
                        addMarker(coords, selectedTool);
                    }
                });
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –º–∞—Ä–∫–µ—Ä—ã
                loadMarkers();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º UI
                updateUI();
                
                showNotification('‚úÖ –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã! –ö–ª–∏–∫–∞–π—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É');
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∫–∞—Ä—Ç—ã:', error);
                showError('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞—Ä—Ç—ã');
            }
        }
        
        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–∞
        function addMarker(coords, type) {
            const cost = getCost(type);
            if (points < cost) {
                showNotification(`–ù—É–∂–Ω–æ ${cost} –æ—á–∫–æ–≤!`, 'error');
                return;
            }
            
            const markerId = 'marker_' + Date.now();
            let iconColor;
            
            switch(type) {
                case 'police': iconColor = '#2196F3'; break;
                case 'accident': iconColor = '#F44336'; break;
                case 'hazard': iconColor = '#FF9800'; break;
            }
            
            // –°–æ–∑–¥–∞–µ–º –º–µ—Ç–∫—É
            const placemark = new ymaps.Placemark(coords, {
                hintContent: getToolName(type),
                balloonContent: `
                    <div style="padding: 10px; max-width: 200px;">
                        <strong>${getToolName(type)}</strong><br>
                        <button onclick="deleteMarker('${markerId}')" 
                                style="margin-top: 5px; padding: 5px 10px; background: #f44336; color: white; border: none; border-radius: 3px; cursor: pointer;">
                            –£–¥–∞–ª–∏—Ç—å
                        </button>
                    </div>
                `
            }, {
                preset: 'islands#icon',
                iconColor: iconColor,
                draggable: true
            });
            
            // –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ
            placemark.events.add('dragend', function() {
                const newCoords = placemark.geometry.getCoordinates();
                updateMarkerCoords(markerId, newCoords);
                showNotification('–ú–µ—Ç–∫–∞ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∞! +2 –æ—á–∫–∞');
                points += 2;
                activity++;
                updateUI();
                saveGame();
            });
            
            // –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞ –∫–∞—Ä—Ç—É
            ymap.geoObjects.add(placemark);
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º
            markers.push({
                id: markerId,
                type: type,
                coords: coords,
                placemark: placemark
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—á–∫–∏
            points -= cost;
            activity++;
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏ –æ–±–Ω–æ–≤–ª—è–µ–º
            saveGame();
            updateUI();
            showNotification(`${getToolName(type)} –¥–æ–±–∞–≤–ª–µ–Ω! -${cost} –æ—á–∫–æ–≤`);
        }
        
        // –£–¥–∞–ª–µ–Ω–∏–µ –±–ª–∏–∂–∞–π—à–µ–π –º–µ—Ç–∫–∏
        function removeNearMarker(coords) {
            if (!ymap) return;
            
            const objects = ymap.geoObjects;
            let closest = null;
            let minDist = 0.0005; // ~50 –º–µ—Ç—Ä–æ–≤
            
            objects.each(function(obj) {
                if (obj.geometry) {
                    const markerCoords = obj.geometry.getCoordinates();
                    const dist = Math.sqrt(
                        Math.pow(markerCoords[0] - coords[0], 2) +
                        Math.pow(markerCoords[1] - coords[1], 2)
                    );
                    
                    if (dist < minDist) {
                        minDist = dist;
                        closest = obj;
                    }
                }
            });
            
            if (closest) {
                // –£–¥–∞–ª—è–µ–º —Å –∫–∞—Ä—Ç—ã
                ymap.geoObjects.remove(closest);
                
                // –£–¥–∞–ª—è–µ–º –∏–∑ –º–∞—Å—Å–∏–≤–∞
                const markerId = findMarkerId(closest);
                if (markerId) {
                    markers = markers.filter(m => m.id !== markerId);
                    points += 5;
                    activity++;
                    saveGame();
                    updateUI();
                    showNotification('–ú–µ—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–∞! +5 –æ—á–∫–æ–≤');
                }
            } else {
                showNotification('–ö–ª–∏–∫–Ω–∏—Ç–µ –±–ª–∏–∂–µ –∫ –º–µ—Ç–∫–µ', 'warning');
            }
        }
        
        // –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ ID (–∏–∑ –±–∞–ª—É–Ω–∞)
        function deleteMarker(markerId) {
            const marker = markers.find(m => m.id === markerId);
            if (marker && marker.placemark) {
                ymap.geoObjects.remove(marker.placemark);
                markers = markers.filter(m => m.id !== markerId);
                points += 5;
                activity++;
                saveGame();
                updateUI();
                showNotification('–ú–µ—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–∞! +5 –æ—á–∫–æ–≤');
            }
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –º–∞—Ä–∫–µ—Ä–æ–≤
        function loadMarkers() {
            markers.forEach(markerData => {
                let iconColor;
                switch(markerData.type) {
                    case 'police': iconColor = '#2196F3'; break;
                    case 'accident': iconColor = '#F44336'; break;
                    case 'hazard': iconColor = '#FF9800'; break;
                }
                
                const placemark = new ymaps.Placemark(markerData.coords, {
                    hintContent: getToolName(markerData.type),
                    balloonContent: `
                        <div style="padding: 10px; max-width: 200px;">
                            <strong>${getToolName(markerData.type)}</strong><br>
                            <button onclick="deleteMarker('${markerData.id}')" 
                                    style="margin-top: 5px; padding: 5px 10px; background: #f44336; color: white; border: none; border-radius: 3px; cursor: pointer;">
                                –£–¥–∞–ª–∏—Ç—å
                            </button>
                        </div>
                    `
                }, {
                    preset: 'islands#icon',
                    iconColor: iconColor,
                    draggable: true
                });
                
                placemark.events.add('dragend', function() {
                    const newCoords = placemark.geometry.getCoordinates();
                    updateMarkerCoords(markerData.id, newCoords);
                    showNotification('–ú–µ—Ç–∫–∞ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∞! +2 –æ—á–∫–∞');
                    points += 2;
                    activity++;
                    updateUI();
                    saveGame();
                });
                
                ymap.geoObjects.add(placemark);
                markerData.placemark = placemark;
            });
        }
        
        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function findMarkerId(placemark) {
            const marker = markers.find(m => m.placemark === placemark);
            return marker ? marker.id : null;
        }
        
        function updateMarkerCoords(markerId, newCoords) {
            const marker = markers.find(m => m.id === markerId);
            if (marker) {
                marker.coords = newCoords;
                saveGame();
            }
        }
        
        function selectTool(tool) {
            selectedTool = tool;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏
            document.querySelectorAll('.tool-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            showNotification(`–í—ã–±—Ä–∞–Ω: ${getToolName(tool)}`);
        }
        
        function updateUI() {
            document.getElementById('markerCount').textContent = markers.length;
            document.getElementById('points').textContent = points;
            document.getElementById('activity').textContent = activity;
            
            // –†–∞–Ω–≥
            const rank = getRank();
            document.getElementById('userRank').textContent = rank;
            
            // –ü—Ä–æ–≥—Ä–µ—Å—Å
            const progress = Math.min(points / 100, 1) * 100;
            document.getElementById('rankPoints').textContent = Math.round(progress) + '%';
        }
        
        function getRank() {
            if (points >= 1000) return '–ö–æ–º–∏—Å—Å–∞—Ä';
            if (points >= 500) return '–°–µ—Ä–∂–∞–Ω—Ç';
            if (points >= 200) return '–û—Ñ–∏—Ü–µ—Ä';
            if (points >= 100) return '–ü–∞—Ç—Ä—É–ª—å–Ω—ã–π';
            return '–ù–æ–≤–∏—á–æ–∫';
        }
        
        function getToolName(tool) {
            return {
                police: '–ü–∞—Ç—Ä—É–ª—å',
                accident: '–î–¢–ü',
                hazard: '–û–ø–∞—Å–Ω–æ—Å—Ç—å',
                clear: '–£–¥–∞–ª–µ–Ω–∏–µ'
            }[tool] || tool;
        }
        
        function getCost(type) {
            return {
                police: 10,
                accident: 15,
                hazard: 8
            }[type] || 10;
        }
        
        function showNotification(message, type = 'success') {
            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ
            document.querySelectorAll('.notification').forEach(n => n.remove());
            
            // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–µ
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
        
        function showError(message) {
            document.getElementById('loading').innerHTML = `
                <i class="fas fa-exclamation-triangle" style="color: #f44336;"></i>
                <p>${message}</p>
                <button onclick="location.reload()" style="margin-top: 10px; padding: 8px 16px; background: #2196f3; color: white; border: none; border-radius: 5px; cursor: pointer;">
                    –û–±–Ω–æ–≤–∏—Ç—å
                </button>
            `;
        }
        
        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ/–∑–∞–≥—Ä—É–∑–∫–∞
        function saveGame() {
            try {
                const data = {
                    markers: markers.map(m => ({
                        id: m.id,
                        type: m.type,
                        coords: m.coords
                    })),
                    points: points,
                    activity: activity
                };
                localStorage.setItem('traffic_game', JSON.stringify(data));
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', e);
            }
        }
        
        function loadGame() {
            try {
                const saved = localStorage.getItem('traffic_game');
                if (saved) {
                    const data = JSON.parse(saved);
                    markers = data.markers || [];
                    points = data.points || 100;
                    activity = data.activity || 0;
                    
                    document.getElementById('markerCount').textContent = markers.length;
                    document.getElementById('points').textContent = points;
                    document.getElementById('activity').textContent = activity;
                }
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', e);
            }
        }
        
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        window.selectTool = selectTool;
        window.deleteMarker = deleteMarker;
        
        // –ó–∞–ø—É—Å–∫
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
