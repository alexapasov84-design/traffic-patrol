<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–æ–ª–∏—Ü–∏—è –ú–∞–π—è–º–∏üëÆ‚Äç‚ôÇÔ∏èüöîüëÆ‚Äç‚ôÇÔ∏è</title>
    
    <!-- Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://api-maps.yandex.ru/2.1/?apikey=365e247d-d853-4425-b9cc-13bfa1169a49&lang=ru_RU"></script>
    
    <style>
        /* Telegram –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è */
        :root {
            --tg-theme-bg-color: #0a1931;
            --tg-theme-text-color: #ffffff;
            --tg-theme-hint-color: #aaaaaa;
            --tg-theme-link-color: #4fc3f7;
            --tg-theme-button-color: #2196f3;
            --tg-theme-button-text-color: #ffffff;
        }
        
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent;
        }
        
        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }
        
        body {
            background: var(--tg-theme-bg-color, #0a1931);
            color: var(--tg-theme-text-color, white);
        }
        
        /* –ó–∞—Å—Ç–∞–≤–∫–∞ —Å –∫–∞—Ä—Ç–∏–Ω–∫–æ–π –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω */
        .splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        /* –ö–∞—Ä—Ç–∏–Ω–∫–∞ –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω */
        .splash-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 1;
        }
        
        /* –ó–∞—Ç–µ–º–Ω–µ–Ω–∏–µ –ø–æ–≤–µ—Ä—Ö –∫–∞—Ä—Ç–∏–Ω–∫–∏ */
        .image-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                to bottom,
                rgba(10, 25, 49, 0.9) 0%,
                rgba(10, 25, 49, 0.7) 30%,
                rgba(10, 25, 49, 0.5) 50%,
                rgba(10, 25, 49, 0.8) 100%
            );
            z-index: 2;
        }
        
        .splash-content {
            position: relative;
            z-index: 3;
            text-align: center;
            padding: 20px;
            display: flex;
            flex-direction: column;
            height: 100%;
            justify-content: space-between;
        }
        
        .splash-header {
            margin-top: 20px;
            animation: fadeInDown 0.8s ease;
        }
        
        .splash-title {
            font-size: 2.5rem;
            color: #4fc3f7;
            margin-bottom: 10px;
            text-shadow: 0 0 20px rgba(79, 195, 247, 0.5);
        }
        
        .splash-subtitle {
            color: #81c784;
            font-size: 1.2rem;
        }
        
        /* –ö–æ–Ω—Ç–µ–Ω—Ç –≤ —Ü–µ–Ω—Ç—Ä–µ */
        .splash-center {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            animation: fadeIn 1s ease;
        }
        
        /* –ú–µ–Ω—é –∫–Ω–æ–ø–∫–∏ –Ω–∞ –∑–∞—Å—Ç–∞–≤–∫–µ */
        .menu-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 90%;
            max-width: 400px;
            animation: fadeIn 1s ease;
        }
        
        .menu-btn {
            padding: 18px 25px;
            background: rgba(33, 150, 243, 0.2);
            border: 2px solid rgba(33, 150, 243, 0.5);
            border-radius: 15px;
            color: white;
            font-size: 1.1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            transition: all 0.3s;
            backdrop-filter: blur(5px);
        }
        
        .menu-btn:hover {
            background: rgba(33, 150, 243, 0.3);
            border-color: #2196f3;
            transform: translateY(-2px);
        }
        
        /* –ö–Ω–æ–ø–∫–∏ –≤–Ω–∏–∑—É */
        .splash-buttons {
            position: relative;
            z-index: 3;
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 100%;
            max-width: 400px;
            margin: 0 auto 15px;
            animation: fadeInUp 0.8s ease;
        }
        
        .start-btn {
            padding: 18px 35px;
            background: linear-gradient(90deg, #2196f3, #1976d2);
            border: none;
            border-radius: 30px;
            color: white;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            box-shadow: 0 10px 30px rgba(33, 150, 243, 0.6);
            transition: all 0.3s;
        }
        
        .start-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 12px 35px rgba(33, 150, 243, 0.8);
        }
        
        .skip-intro-btn {
            padding: 14px 25px;
            background: rgba(255, 255, 255, 0.15);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 25px;
            color: rgba(255, 255, 255, 0.9);
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s;
        }
        
        .skip-intro-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.5);
        }
        
        /* –ë–µ–π–¥–∂ Telegram –≤ —Å–∞–º–æ–º –Ω–∏–∑—É */
        .tg-badge-bottom {
            margin-top: 5px;
            padding: 8px 16px;
            background: rgba(33, 150, 243, 0.2);
            border-radius: 20px;
            font-size: 0.9rem;
            color: #4fc3f7;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }
        
        /* –¢–∞–π–º–µ—Ä –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–∞ */
        .auto-start-timer {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: #81c784;
            padding: 10px 18px;
            border-radius: 25px;
            font-size: 0.95rem;
            z-index: 4;
            border: 1px solid rgba(129, 199, 132, 0.4);
            backdrop-filter: blur(5px);
            animation: fadeIn 1s ease;
        }
        
        /* –û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å */
        .app { 
            display: flex; 
            flex-direction: column; 
            height: 100vh;
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        
        .app.active {
            opacity: 1;
        }
        
        .header { 
            padding: 15px 20px;
            text-align: center;
            background: rgba(13, 27, 42, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 3px solid #2196f3;
            position: relative;
        }
        
        .header h1 { 
            color: #4fc3f7; 
            margin: 0 0 8px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            font-size: 1.5rem;
        }
        
        .header-stats {
            color: #81c784;
            font-size: 0.9rem;
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .map-container {
            flex: 1;
            margin: 10px;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            border: 3px solid #2196f3;
        }
        
        #yandex-map {
            width: 100%;
            height: 100%;
        }
        
        /* –û–Ω–ª–∞–π–Ω –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä */
        .online-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: #81c784;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            z-index: 1000;
            border: 1px solid rgba(129, 199, 132, 0.4);
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .tools {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            padding: 12px;
            background: rgba(13, 27, 42, 0.95);
            backdrop-filter: blur(10px);
        }
        
        .tool-btn {
            padding: 10px 5px;
            background: rgba(33, 150, 243, 0.2);
            border: 2px solid #2196f3;
            border-radius: 8px;
            color: white;
            font-size: 0.75rem;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            transition: all 0.2s;
        }
        
        .tool-btn.active {
            background: #2196f3;
            box-shadow: 0 0 15px #2196f3;
        }
        
        .tool-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            border-color: #666;
        }
        
        .marker-limit {
            position: absolute;
            top: 5px;
            left: 5px;
            background: rgba(255, 152, 0, 0.9);
            color: white;
            padding: 5px 10px;
            border-radius: 10px;
            font-size: 0.8rem;
            z-index: 1000;
            animation: pulse 2s infinite;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            padding: 10px;
            background: rgba(13, 27, 42, 0.9);
            border-top: 2px solid #2196f3;
            text-align: center;
            font-size: 0.85rem;
        }
        
        .stat-value {
            font-size: 1.3rem;
            font-weight: bold;
            color: #4fc3f7;
        }
        
        /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 20000;
            backdrop-filter: blur(5px);
        }
        
        .modal-content {
            background: linear-gradient(135deg, #0d1b2a, #1b3a4b);
            border-radius: 20px;
            padding: 25px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            border: 3px solid #2196f3;
            position: relative;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(33, 150, 243, 0.3);
        }
        
        .modal-header h2 {
            color: #4fc3f7;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .modal-close {
            background: rgba(255, 0, 0, 0.2);
            border: 2px solid rgba(255, 0, 0, 0.5);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        
        .modal-close:hover {
            background: rgba(255, 0, 0, 0.3);
            border-color: #ff4444;
            transform: rotate(90deg);
        }
        
        .modal-body {
            color: #e0e0e0;
        }
        
        .rules-section {
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            border-left: 4px solid #2196f3;
        }
        
        .rules-section h3 {
            color: #81c784;
            margin-bottom: 10px;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .rules-section p {
            line-height: 1.5;
            font-size: 1rem;
        }
        
        /* –°–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤ */
        .players-list {
            max-height: 300px;
            overflow-y: auto;
            margin: 20px 0;
        }
        
        .player-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 15px;
            margin-bottom: 10px;
            background: rgba(33, 150, 243, 0.1);
            border-radius: 10px;
            border-left: 4px solid #4CAF50;
        }
        
        .player-item.offline {
            border-left-color: #757575;
            opacity: 0.7;
        }
        
        .player-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .player-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #2196f3, #1976d2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }
        
        .player-name {
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        .player-status {
            font-size: 0.8rem;
            color: #81c784;
        }
        
        .player-status.offline {
            color: #757575;
        }
        
        .player-actions {
            display: flex;
            gap: 8px;
        }
        
        .action-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            padding: 5px 10px;
            color: white;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s;
        }
        
        .action-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        /* –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –Ω–∞ –º–µ—Ç–∫–∞—Ö */
        .marker-delete-btn {
            position: absolute;
            top: -10px;
            right: -10px;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            transition: all 0.3s;
        }
        
        .marker-delete-btn:hover {
            background: #d32f2f;
            transform: scale(1.1);
        }
        
        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥–ø–∏—Å–∫–∏ */
        .subscription-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 30000;
            backdrop-filter: blur(10px);
        }
        
        .subscription-modal .modal-content {
            max-width: 400px;
            animation: scaleIn 0.3s ease;
        }
        
        .features-list {
            margin: 20px 0;
        }
        
        .feature {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
            padding: 10px;
            background: rgba(33, 150, 243, 0.1);
            border-radius: 8px;
        }
        
        .feature i {
            color: #4CAF50;
        }
        
        .pricing {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .price-btn {
            flex: 1;
            background: rgba(33, 150, 243, 0.2);
            border: 2px solid #2196f3;
            border-radius: 15px;
            padding: 15px;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .price-btn:hover {
            background: rgba(33, 150, 243, 0.3);
            transform: translateY(-3px);
        }
        
        .price-btn.recommended {
            background: rgba(255, 193, 7, 0.2);
            border-color: #FFC107;
        }
        
        .price-btn.recommended:hover {
            background: rgba(255, 193, 7, 0.3);
        }
        
        .price {
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .period {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ø—Ä–æ–±–Ω–æ–º –ø–µ—Ä–∏–æ–¥–µ */
        .trial-notification {
            position: fixed;
            top: 70px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(90deg, #FF9800, #F57C00);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            display: none;
            align-items: center;
            gap: 10px;
            z-index: 10000;
            box-shadow: 0 5px 20px rgba(255, 152, 0, 0.5);
            animation: slideDown 0.5s ease;
        }
        
        .trial-notification button {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid white;
            border-radius: 15px;
            color: white;
            padding: 5px 15px;
            cursor: pointer;
            margin-left: 10px;
            transition: all 0.3s;
        }
        
        .trial-notification button:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        /* –ê–Ω–∏–º–∞—Ü–∏—è —Å–∏—Ä–µ–Ω—ã */
        .fa-siren::before {
            content: "üö®";
            animation: siren 1s infinite alternate;
        }
        
        @keyframes siren {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        @keyframes scaleIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        @keyframes slideDown {
            from { transform: translate(-50%, -100%); opacity: 0; }
            to { transform: translate(-50%, 0); opacity: 1; }
        }
        
        /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes pulse {
            0% { opacity: 0.7; }
            50% { opacity: 1; }
            100% { opacity: 0.7; }
        }
        
        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-height: 700px) {
            .splash-title { font-size: 2rem; }
            .splash-subtitle { font-size: 1rem; }
            .menu-buttons { gap: 10px; }
            .menu-btn { padding: 14px 20px; font-size: 1rem; }
            .start-btn { padding: 16px 30px; font-size: 1.1rem; }
            .skip-intro-btn { padding: 12px 20px; font-size: 0.95rem; }
            .tools { grid-template-columns: repeat(3, 1fr); gap: 6px; }
            .tool-btn { font-size: 0.7rem; padding: 8px 3px; }
        }
        
        @media (max-height: 600px) {
            .splash-header { margin-top: 10px; }
            .splash-title { font-size: 1.8rem; }
            .splash-center { justify-content: flex-start; padding-top: 20px; }
            .tools { grid-template-columns: repeat(5, 1fr); }
            .tg-badge-bottom { margin-bottom: 5px; }
        }
        
        @media (max-width: 768px) {
            .splash-title { font-size: 2rem; }
            .tools { grid-template-columns: repeat(5, 1fr); }
            .pricing { flex-direction: column; }
        }
        
        @media (max-width: 480px) {
            .tools { grid-template-columns: repeat(3, 1fr); gap: 5px; }
            .tool-btn span { font-size: 0.65rem; }
            .header-stats { gap: 10px; font-size: 0.8rem; }
            .modal-content { padding: 15px; }
            .player-item { flex-direction: column; align-items: flex-start; gap: 10px; }
            .player-actions { width: 100%; justify-content: flex-end; }
        }
    </style>
</head>
<body>
    <!-- –ó–∞—Å—Ç–∞–≤–∫–∞ —Å –∫–∞—Ä—Ç–∏–Ω–∫–æ–π –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω -->
    <div id="splashScreen" class="splash-screen">
        <!-- –ö–∞—Ä—Ç–∏–Ω–∫–∞ –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω -->
        <img src="https://static.craftum.com/9F-qvclCZh6dtPwdnNtlBy-tW_0=/380x0/filters:no_upscale()/https://274418.selcdn.ru/cv08300-33250f0d-0664-43fc-9dbf-9d89738d114e/uploads/655846/14f3a178-0a4b-4df5-bf77-949d65a34e3a.jpg" 
             class="splash-image" 
             alt="–ü–æ–ª–∏—Ü–∏—è –ú–∞–π—è–º–∏"
             onerror="this.style.display='none'; document.querySelector('.image-overlay').style.background='#0a1931';">
        
        <!-- –ó–∞—Ç–µ–º–Ω–µ–Ω–∏–µ –ø–æ–≤–µ—Ä—Ö –∫–∞—Ä—Ç–∏–Ω–∫–∏ -->
        <div class="image-overlay"></div>
        
        <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –ø–æ–≤–µ—Ä—Ö –∫–∞—Ä—Ç–∏–Ω–∫–∏ -->
        <div class="splash-content">
            <!-- –¢–∞–π–º–µ—Ä –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–∞ -->
            <div class="auto-start-timer" id="autoStartTimer">
                –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑: <span id="countdown">20</span> —Å–µ–∫
            </div>
            
            <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å–≤–µ—Ä—Ö—É -->
            <div class="splash-header">
                <h1 class="splash-title">üëÆ‚Äç‚ôÇÔ∏è –ü–æ–ª–∏—Ü–∏—è –ú–∞–π—è–º–∏ üöî</h1>
                <p class="splash-subtitle" id="userWelcome">–ú—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä–Ω–∞—è –∏–≥—Ä–∞</p>
            </div>
            
            <!-- –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π –±–ª–æ–∫ —Å –∫–Ω–æ–ø–∫–∞–º–∏ –º–µ–Ω—é -->
            <div class="splash-center">
                <div class="menu-buttons">
                    <button class="menu-btn" onclick="openRulesModal()">
                        <i class="fas fa-book"></i> –ü—Ä–∞–≤–∏–ª–∞ –∏–≥—Ä—ã
                    </button>
                    <button class="menu-btn" onclick="openPlayersModal()">
                        <i class="fas fa-users"></i> –ò–≥—Ä–æ–∫–∏ –æ–Ω–ª–∞–π–Ω
                    </button>
                    <button class="menu-btn" onclick="openControlsModal()">
                        <i class="fas fa-gamepad"></i> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
                    </button>
                </div>
            </div>
            
            <!-- –ö–Ω–æ–ø–∫–∏ –≤–Ω–∏–∑—É -->
            <div class="splash-buttons">
                <button class="start-btn" onclick="startGame()">
                    <i class="fas fa-play-circle"></i>
                    –ù–ê–ß–ê–¢–¨ –ò–ì–†–£
                </button>
                
                <button class="skip-intro-btn" onclick="skipIntro()">
                    <i class="fas fa-forward"></i>
                    –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –∑–∞—Å—Ç–∞–≤–∫—É
                </button>
                
                <!-- –ë–µ–π–¥–∂ Telegram –≤ —Å–∞–º–æ–º –Ω–∏–∑—É -->
                <div class="tg-badge-bottom">
                    <i class="fab fa-telegram"></i> Telegram Mini App ‚Ä¢ –ú—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä
                </div>
            </div>
        </div>
    </div>
    
    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∏–≥—Ä–æ–≤–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å -->
    <div class="app" id="mainApp">
        <div class="header">
            <h1><i class="fas fa-police-car"></i> –ü–æ–ª–∏—Ü–∏—è –ú–∞–π—è–º–∏ üëÆ‚Äç‚ôÇÔ∏èüöî</h1>
            <div class="header-stats">
                <span>–ú–µ—Ç–æ–∫: <span id="markerCount">0</span>/<span id="maxMarkers">40</span></span>
                <span>–û—á–∫–∏: <span id="points">100</span></span>
                <span>–û–Ω–ª–∞–π–Ω: <span id="onlineCount">1</span></span>
            </div>
        </div>
        
        <div class="map-container">
            <div id="yandex-map"></div>
            <div id="loading" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                <i class="fas fa-sync fa-spin" style="font-size: 2.5rem; margin-bottom: 20px; color: #4fc3f7;"></i>
                <p style="color: #81c784; font-size: 1.1rem;">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç...</p>
                <p id="syncStatus" style="color: #4fc3f7; font-size: 0.9rem; margin-top: 10px;">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Firebase...</p>
            </div>
            <div class="marker-limit" id="markerLimit" style="display: none;">
                üî¥ –õ–∏–º–∏—Ç: 40 –º–µ—Ç–æ–∫
            </div>
            <div class="online-indicator" id="onlineIndicator">
                <i class="fas fa-wifi"></i> <span id="playersOnline">1</span>
            </div>
        </div>
        
        <div class="tools">
            <button class="tool-btn active" onclick="selectTool('police')">
                <i class="fas fa-siren" style="font-size: 1.2em;"></i>
                <span>–ü–∞—Ç—Ä—É–ª—å</span>
            </button>
            <button class="tool-btn" onclick="selectTool('accident')">
                <i class="fas fa-car-crash"></i>
                <span>–î–¢–ü</span>
            </button>
            <button class="tool-btn" onclick="selectTool('help')">
                <i class="fas fa-flag"></i>
                <span>–ü–æ–º–æ—â—å</span>
            </button>
            <button class="tool-btn" onclick="selectTool('hazard')">
                <i class="fas fa-traffic-light"></i>
                <span>–ü—Ä–æ–±–∫–∞</span>
            </button>
            <button class="tool-btn" onclick="selectTool('clear')">
                <i class="fas fa-trash-alt"></i>
                <span>–£–¥–∞–ª–∏—Ç—å</span>
            </button>
        </div>
        
        <div class="stats">
            <div>
                <div class="stat-value" id="activity">0</div>
                <div>–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</div>
            </div>
            <div>
                <div class="stat-value" id="rankPoints">100%</div>
                <div>–ü—Ä–æ–≥—Ä–µ—Å—Å</div>
            </div>
            <div>
                <div class="stat-value" id="userRank">–ù–æ–≤–∏—á–æ–∫</div>
                <div>–†–∞–Ω–≥</div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–∞–≤–∏–ª -->
    <div id="rulesModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-book"></i> –ü—Ä–∞–≤–∏–ª–∞ –∏–≥—Ä—ã</h2>
                <button class="modal-close" onclick="closeModal('rulesModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="rules-section">
                    <h3><i class="fas fa-exclamation-triangle"></i> –í–ê–ñ–ù–û–ï –£–í–ï–î–û–ú–õ–ï–ù–ò–ï</h3>
                    <p>–î–∞–Ω–Ω–∞—è –∏–≥—Ä–∞ —Å–æ–∑–¥–∞–Ω–∞ <strong>–∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ –≤ –æ–∑–Ω–∞–∫–æ–º–∏—Ç–µ–ª—å–Ω—ã—Ö —Ü–µ–ª—è—Ö –∏ –¥–ª—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π –ø–æ–º–æ—â–∏ –Ω–∞ –¥–æ—Ä–æ–≥–µ</strong>.</p>
                    <p style="color: #ff9800; margin-top: 10px;">
                        <strong>–ó–∞ –ª—é–±—ã–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ —Å–∏—Ç—É–∞—Ü–∏—è–º–∏, —Å–æ–±—ã—Ç–∏—è–º–∏ –∏–ª–∏ –ª–∏—Ü–∞–º–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏—è –∏–≥—Ä—ã –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –Ω–µ –Ω–µ—Å—ë—Ç.</strong>
                    </p>
                    <p style="margin-top: 10px;">–ò–≥—Ä–∞ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º –ø–æ–ª–∏—Ü–∏–∏ –∏ –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏ —ç–∫—Å—Ç—Ä–µ–Ω–Ω—ã—Ö —Å–ª—É–∂–±.</p>
                </div>
                
                <div class="rules-section">
                    <h3><i class="fas fa-users"></i> –ú—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä</h3>
                    <p>–í—Å–µ –∏–≥—Ä–æ–∫–∏ –≤–∏–¥—è—Ç –æ–¥–Ω–∏ –∏ —Ç–µ –∂–µ –º–µ—Ç–∫–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ —á–µ—Ä–µ–∑ Firebase Cloud.</p>
                    <p>–°–æ–∑–¥–∞–≤–∞–π—Ç–µ –º–µ—Ç–∫–∏, —á—Ç–æ–±—ã –ø—Ä–µ–¥—É–ø—Ä–µ–¥–∏—Ç—å –¥—Ä—É–≥–∏—Ö –∏–≥—Ä–æ–∫–æ–≤ –æ —Å–∏—Ç—É–∞—Ü–∏–∏ –Ω–∞ –¥–æ—Ä–æ–≥–µ.</p>
                </div>
                
                <div class="rules-section">
                    <h3><i class="fas fa-sync"></i> –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è</h3>
                    <p>–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</p>
                    <p>–ú–µ—Ç–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –æ–±–ª–∞–∫–µ –∏ –¥–æ—Å—Ç—É–ø–Ω—ã –≤—Å–µ–º –∏–≥—Ä–æ–∫–∞–º.</p>
                </div>
                
                <div class="rules-section">
                    <h3><i class="fas fa-database"></i> –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è</h3>
                    <p>–ú–∞–∫—Å–∏–º—É–º <span id="rulesMaxMarkers">40</span> –º–µ—Ç–æ–∫ –Ω–∞ –≤—Å—é –∏–≥—Ä—É.</p>
                    <p>–°—Ç–∞—Ä—ã–µ –º–µ—Ç–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ 24 —á–∞—Å–∞.</p>
                </div>
                
                <div class="rules-section">
                    <h3><i class="fas fa-trophy"></i> –†–µ–π—Ç–∏–Ω–≥</h3>
                    <p>–ó–∞—Ä–∞–±–∞—Ç—ã–≤–∞–π—Ç–µ –æ—á–∫–∏ –∑–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª–µ–∑–Ω—ã—Ö –º–µ—Ç–æ–∫.</p>
                    <p>–ß–µ–º –∞–∫—Ç–∏–≤–Ω–µ–µ –≤—ã –ø–æ–º–æ–≥–∞–µ—Ç–µ –¥—Ä—É–≥–∏–º –∏–≥—Ä–æ–∫–∞–º - —Ç–µ–º –≤—ã—à–µ –≤–∞—à —Ä–∞–Ω–≥!</p>
                    <p>–†–∞–Ω–≥–∏: –ù–æ–≤–∏—á–æ–∫ ‚Üí –ü–∞—Ç—Ä—É–ª—å–Ω—ã–π ‚Üí –°–µ—Ä–∂–∞–Ω—Ç ‚Üí –î–µ—Ç–µ–∫—Ç–∏–≤ ‚Üí –ö–æ–º–∏—Å—Å–∞—Ä</p>
                </div>
                
                <div class="rules-section">
                    <h3><i class="fas fa-shield-alt"></i> –ü—Ä–∞–≤–∏–ª–∞ –ø–æ–≤–µ–¥–µ–Ω–∏—è</h3>
                    <p>1. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∏–≥—Ä—É —Ç–æ–ª—å–∫–æ –≤ —Ä–∞–∑–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω—ã—Ö —Ü–µ–ª—è—Ö</p>
                    <p>2. –ù–µ —Å–æ–∑–¥–∞–≤–∞–π—Ç–µ –º–µ—Ç–∫–∏ —Å –æ—Å–∫–æ—Ä–±–∏—Ç–µ–ª—å–Ω—ã–º —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ–º</p>
                    <p>3. –ü–æ–º–æ–≥–∞–π—Ç–µ –¥—Ä—É–≥–∏–º –∏–≥—Ä–æ–∫–∞–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–º–∏ —Å–æ–≤–µ—Ç–∞–º–∏</p>
                    <p>4. –ù–µ –∑–ª–æ—É–ø–æ—Ç—Ä–µ–±–ª—è–π—Ç–µ —Å–∏—Å—Ç–µ–º–æ–π –º–µ—Ç–æ–∫</p>
                </div>
                
                <div class="rules-section">
                    <h3><i class="fas fa-phone"></i> –†–µ–∞–ª—å–Ω–∞—è –ø–æ–º–æ—â—å</h3>
                    <p>–í —Å–ª—É—á–∞–µ —Ä–µ–∞–ª—å–Ω–æ–π –∞–≤–∞—Ä–∏–∏ –∏–ª–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø–æ–º–æ—â–∏:</p>
                    <p style="color: #f44336;"><strong>–ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ –∑–≤–æ–Ω–∏—Ç–µ –ø–æ –Ω–æ–º–µ—Ä—É 112!</strong></p>
                    <p>–≠—Ç–∞ –∏–≥—Ä–∞ –ù–ï –∑–∞–º–µ–Ω—è–µ—Ç –≤—ã–∑–æ–≤ —Ä–µ–∞–ª—å–Ω—ã—Ö —ç–∫—Å—Ç—Ä–µ–Ω–Ω—ã—Ö —Å–ª—É–∂–±.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏–≥—Ä–æ–∫–æ–≤ -->
    <div id="playersModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-users"></i> –ò–≥—Ä–æ–∫–∏ –æ–Ω–ª–∞–π–Ω</h2>
                <button class="modal-close" onclick="closeModal('playersModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="players-list" id="playersList">
                    <!-- –°–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω –∑–¥–µ—Å—å -->
                    <p style="text-align: center; color: #aaa;">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –∏–≥—Ä–æ–∫–æ–≤...</p>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <p><i class="fas fa-info-circle"></i> –í—Å–µ–≥–æ –æ–Ω–ª–∞–π–Ω: <span id="modalOnlineCount">1</span> –∏–≥—Ä–æ–∫(–æ–≤)</p>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
    <div id="controlsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-gamepad"></i> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h2>
                <button class="modal-close" onclick="closeModal('controlsModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="rules-section">
                    <h3><i class="fas fa-mouse-pointer"></i> –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–µ—Ç–æ–∫</h3>
                    <p>–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –º–µ—Ç–∫–∏ –∏ –∫–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É –≤ –Ω—É–∂–Ω–æ–º –º–µ—Å—Ç–µ.</p>
                    <p><strong>–ü–∞—Ç—Ä—É–ª—å (üö®):</strong> –í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –ø–∞—Ç—Ä—É–ª–∏—Ä–æ–≤–∞–Ω–∏–µ - –±–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è</p>
                    <p><strong>–î–¢–ü (üöó):</strong> –û—Ç–º–µ—Ç–∫–∞ –∞–≤–∞—Ä–∏–∏</p>
                    <p><strong>–ü–æ–º–æ—â—å (üÜò):</strong> –ó–∞–ø—Ä–æ—Å –ø–æ–º–æ—â–∏ (—Ç—Ä–µ–±—É–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è)</p>
                    <p><strong>–ü—Ä–æ–±–∫–∞ (üö¶):</strong> –û–±–æ–∑–Ω–∞—á–µ–Ω–∏–µ –ø—Ä–æ–±–∫–∏</p>
                </div>
                
                <div class="rules-section">
                    <h3><i class="fas fa-trash-alt"></i> –£–¥–∞–ª–µ–Ω–∏–µ –º–µ—Ç–æ–∫</h3>
                    <p><strong>–°–ø–æ—Å–æ–± 1:</strong> –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "–£–¥–∞–ª–∏—Ç—å", –∑–∞—Ç–µ–º –∫–ª–∏–∫–Ω–∏—Ç–µ —Ä—è–¥–æ–º —Å –º–µ—Ç–∫–æ–π</p>
                    <p><strong>–°–ø–æ—Å–æ–± 2:</strong> –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫—Ä–µ—Å—Ç–∏–∫ (√ó) –Ω–∞ —Å–∞–º–æ–π –º–µ—Ç–∫–µ</p>
                    <p><strong>–°–ø–æ—Å–æ–± 3:</strong> –û—Ç–∫—Ä–æ–π—Ç–µ –±–∞–ª—É–Ω –º–µ—Ç–∫–∏ –∏ –Ω–∞–∂–º–∏—Ç–µ "–£–¥–∞–ª–∏—Ç—å –º–µ—Ç–∫—É"</p>
                </div>
                
                <div class="rules-section">
                    <h3><i class="fas fa-map-marked-alt"></i> –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è</h3>
                    <p>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –Ω–∞ –∫–∞—Ä—Ç–µ –¥–ª—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –∫ —Å–≤–æ–µ–º—É –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—é.</p>
                    <p>–ü—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –≤–∞—à–µ–π –≥–µ–æ–ø–æ–∑–∏—Ü–∏–∏.</p>
                </div>
                
                <div class="rules-section">
                    <h3><i class="fas fa-sync-alt"></i> –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è</h3>
                    <p>–ú–µ—Ç–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è —Å–æ –≤—Å–µ–º–∏ –∏–≥—Ä–æ–∫–∞–º–∏ –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥.</p>
                    <p>–í–∞—à–∏ –º–µ—Ç–∫–∏ –≤–∏–¥–Ω—ã –≤—Å–µ–º –∏–≥—Ä–æ–∫–∞–º –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏.</p>
                </div>
                
                <div class="rules-section">
                    <h3><i class="fas fa-star"></i> –°–∏—Å—Ç–µ–º–∞ –æ—á–∫–æ–≤</h3>
                    <p>+10 –æ—á–∫–æ–≤ –∑–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–µ—Ç–∫–∏</p>
                    <p>+5 –æ—á–∫–æ–≤ –∑–∞ —É–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä–æ–π –º–µ—Ç–∫–∏</p>
                    <p>–û—á–∫–∏ –≤–ª–∏—è—é—Ç –Ω–∞ –≤–∞—à —Ä–∞–Ω–≥ –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å</p>
                </div>
            </div>
        </div>
    </div>

    <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ø—Ä–æ–±–Ω–æ–º –ø–µ—Ä–∏–æ–¥–µ -->
    <div id="trialNotification" class="trial-notification">
        <i class="fas fa-clock"></i> 
        <span id="trialDays">30</span> –¥–Ω–µ–π –ø—Ä–æ–±–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞
        <button onclick="showSubscriptionModal()">‚≠ê –ü—Ä–µ–º–∏—É–º</button>
    </div>

    <script>
        // ============ –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø FIREBASE ============
        const firebaseConfig = {
            apiKey: "AIzaSyD0zwcRZs7mI0RzPq3O18WOIWjhUO6yKZQ",
            authDomain: "miami-police-game.firebaseapp.com",
            databaseURL: "https://miami-police-game-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "miami-police-game",
            storageBucket: "miami-police-game.firebasestorage.app",
            messagingSenderId: "4861394604",
            appId: "1:4861394604:web:f2acb3a189f99396a66909"
        };
        
        // ============ –°–ò–°–¢–ï–ú–ê –ú–û–ù–ï–¢–ò–ó–ê–¶–ò–ò ============
        const TRIAL_PERIOD_DAYS = 30;
        const PREMIUM_FEATURES = {
            maxMarkers: 100,
            customIcons: true,
            prioritySync: true,
            noAds: true,
            analytics: true
        };
        
        // ============ –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ============
        const tg = window.Telegram.WebApp;
        let telegramUser = null;
        const EXPIRATION_TIME = 24 * 60 * 60 * 1000; // 24 —á–∞—Å–∞
        let MAX_MARKERS = 40;
        let autoDeleteInterval = null;
        let autoStartInterval = null;
        let countdownSeconds = 20;
        
        // –ò–≥—Ä–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let ymap = null;
        let markers = [];
        let selectedTool = 'police';
        let points = 100;
        let activity = 0;
        let pendingCommentData = null;
        
        // Firebase
        let firebaseApp = null;
        let firebaseDatabase = null;
        let syncInterval = null;
        let onlinePlayers = {};
        let currentOnlineCount = 1;
        
        // ============ –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø TELEGRAM ============
        function initTelegram() {
            console.log('Initializing Telegram Web App...');
            
            tg.expand();
            tg.setHeaderColor('#0d1b2a');
            tg.setBackgroundColor('#0a1931');
            
            telegramUser = tg.initDataUnsafe?.user;
            
            if (telegramUser) {
                const userName = telegramUser.first_name || telegramUser.username || '–ò–≥—Ä–æ–∫';
                document.getElementById('userWelcome').textContent = `–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${userName}!`;
                window.userId = telegramUser.id.toString();
                window.userName = userName;
            } else {
                document.getElementById('userWelcome').textContent = '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –∏–≥—Ä—É!';
                window.userId = 'guest_' + Math.random().toString(36).substr(2, 9);
                window.userName = '–ì–æ—Å—Ç—å';
            }
            
            tg.BackButton.show();
            tg.BackButton.onClick(() => {
                tg.showConfirm('–ó–∞–∫—Ä—ã—Ç—å –∏–≥—Ä—É?', (confirmed) => {
                    if (confirmed) tg.close();
                });
            });
            
            startAutoStartTimer();
            initFirebase();
        }
        
        // ============ –ü–†–û–í–ï–†–ö–ê –ü–û–î–ü–ò–°–ö–ò ============
        function checkSubscription() {
            const installDate = getInstallDate();
            const currentDate = new Date();
            const daysPassed = Math.floor((currentDate - installDate) / (1000 * 60 * 60 * 24));
            
            if (daysPassed <= TRIAL_PERIOD_DAYS) {
                return { 
                    status: 'trial', 
                    daysLeft: TRIAL_PERIOD_DAYS - daysPassed,
                    features: PREMIUM_FEATURES 
                };
            } else {
                const subscription = checkActiveSubscription();
                return {
                    status: subscription ? 'premium' : 'expired',
                    daysLeft: 0,
                    features: subscription ? PREMIUM_FEATURES : null
                };
            }
        }
        
        function getInstallDate() {
            let installDate = localStorage.getItem('app_install_date');
            if (!installDate) {
                installDate = new Date().toISOString();
                localStorage.setItem('app_install_date', installDate);
                console.log('–î–∞—Ç–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞:', installDate);
            }
            return new Date(installDate);
        }
        
        function checkActiveSubscription() {
            return localStorage.getItem('premium_subscription') === 'active';
        }
        
        function updatePremiumFeatures() {
            const subscription = checkSubscription();
            
            if (subscription.status === 'trial') {
                MAX_MARKERS = 40;
                document.getElementById('trialDays').textContent = subscription.daysLeft;
                document.getElementById('trialNotification').style.display = 'flex';
                document.getElementById('rulesMaxMarkers').textContent = '40';
                
                setTimeout(() => {
                    document.getElementById('trialNotification').style.display = 'none';
                }, 5000);
            } else if (subscription.status === 'premium') {
                MAX_MARKERS = 100;
                document.getElementById('markerLimit').innerHTML = '‚≠ê –ü—Ä–µ–º–∏—É–º: 100 –º–µ—Ç–æ–∫';
                document.getElementById('maxMarkers').textContent = '100';
                document.getElementById('rulesMaxMarkers').textContent = '100';
                document.getElementById('trialNotification').style.display = 'none';
            } else if (subscription.status === 'expired') {
                MAX_MARKERS = 40;
                document.getElementById('rulesMaxMarkers').textContent = '40';
                setTimeout(() => {
                    showSubscriptionModal();
                }, 2000);
            }
            
            document.getElementById('maxMarkers').textContent = MAX_MARKERS;
        }
        
        function purchaseSubscription(plan) {
            tg.showPopup({
                title: '–ü—Ä–µ–º–∏—É–º –ø–æ–¥–ø–∏—Å–∫–∞',
                message: '–î–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º —Ñ—É–Ω–∫—Ü–∏—è–º:\n‚Ä¢ 100 –º–µ—Ç–æ–∫ –≤–º–µ—Å—Ç–æ 40\n‚Ä¢ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è\n‚Ä¢ –ë–µ–∑ —Ä–µ–∫–ª–∞–º—ã\n‚Ä¢ –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞',
                buttons: [
                    { id: 'monthly', type: 'default', text: '99‚ÇΩ/–º–µ—Å—è—Ü' },
                    { id: 'yearly', type: 'default', text: '990‚ÇΩ/–≥–æ–¥' },
                    { id: 'cancel', type: 'cancel' }
                ]
            }, function(buttonId) {
                if (buttonId === 'monthly' || buttonId === 'yearly') {
                    initiateTelegramPayment(buttonId);
                }
            });
        }
        
        function initiateTelegramPayment(plan) {
            // –î–µ–º–æ-—Ä–µ–∂–∏–º –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            localStorage.setItem('premium_subscription', 'active');
            updatePremiumFeatures();
            
            // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ Telegram Payments API
        }
        
        function showSubscriptionModal() {
            const modal = document.createElement('div');
            modal.className = 'subscription-modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2><i class="fas fa-crown"></i> –ü—Ä–æ–±–Ω—ã–π –ø–µ—Ä–∏–æ–¥ –∑–∞–∫–æ–Ω—á–∏–ª—Å—è</h2>
                    </div>
                    <div class="modal-body">
                        <p>–î–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è –∏–≥—Ä—ã —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–¥–ø–∏—Å–∫–∞.</p>
                        <div class="features-list">
                            <div class="feature">
                                <i class="fas fa-check"></i> 100 –º–µ—Ç–æ–∫ –≤–º–µ—Å—Ç–æ 40
                            </div>
                            <div class="feature">
                                <i class="fas fa-check"></i> –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
                            </div>
                            <div class="feature">
                                <i class="fas fa-check"></i> –ë–µ–∑ —Ä–µ–∫–ª–∞–º—ã
                            </div>
                            <div class="feature">
                                <i class="fas fa-check"></i> –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                            </div>
                        </div>
                        <div class="pricing">
                            <button class="price-btn" onclick="purchaseSubscription('monthly')">
                                <div class="price">99‚ÇΩ</div>
                                <div class="period">–≤ –º–µ—Å—è—Ü</div>
                            </button>
                            <button class="price-btn recommended" onclick="purchaseSubscription('yearly')">
                                <div class="price">990‚ÇΩ</div>
                                <div class="period">–≤ –≥–æ–¥ (—ç–∫–æ–Ω–æ–º–∏—è 20%)</div>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            });
        }
        
        // ============ –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø FIREBASE ============
        function initFirebase() {
            try {
                firebaseApp = firebase.initializeApp(firebaseConfig);
                firebaseDatabase = firebase.database();
                
                console.log('‚úÖ Firebase —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω!');
                
                const syncStatus = document.getElementById('syncStatus');
                if (syncStatus) {
                    syncStatus.textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ Firebase ‚úì';
                    syncStatus.style.color = '#4CAF50';
                }
                
                startFirebaseSync();
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ Firebase:', error);
                
                const syncStatus = document.getElementById('syncStatus');
                if (syncStatus) {
                    syncStatus.textContent = 'Firebase –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ';
                    syncStatus.style.color = '#FF9800';
                }
                
                useLocalStorage();
            }
        }
        
        // ============ –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø –° FIREBASE ============
        function startFirebaseSync() {
            loadMarkersFromFirebase();
            listenToFirebaseChanges();
            syncInterval = setInterval(syncToFirebase, 10000);
            updateOnlineStatus();
        }
        
        function loadMarkersFromFirebase() {
            try {
                const markersRef = firebaseDatabase.ref('markers');
                
                markersRef.once('value').then((snapshot) => {
                    const firebaseMarkers = snapshot.val() || [];
                    console.log(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${firebaseMarkers.length} –º–µ—Ç–æ–∫ –∏–∑ Firebase`);
                    updateMarkersFromCloud(firebaseMarkers);
                });
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ Firebase:', error);
                useLocalStorage();
            }
        }
        
        function listenToFirebaseChanges() {
            try {
                const markersRef = firebaseDatabase.ref('markers');
                
                markersRef.on('value', (snapshot) => {
                    const firebaseMarkers = snapshot.val() || [];
                    
                    if (JSON.stringify(firebaseMarkers) !== JSON.stringify(markers.map(m => ({...m, placemark: undefined})))) {
                        console.log('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–µ—Ç–æ–∫ –∏–∑ Firebase...');
                        updateMarkersFromCloud(firebaseMarkers);
                    }
                });
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è Firebase:', error);
            }
        }
        
        function updateMarkersFromCloud(cloudMarkers) {
            if (!ymap) return;
            
            const now = Date.now();
            
            markers.forEach(marker => {
                if (marker.placemark) {
                    ymap.geoObjects.remove(marker.placemark);
                }
            });
            
            markers = [];
            
            cloudMarkers.forEach(markerData => {
                if (now - markerData.timestamp > EXPIRATION_TIME) {
                    return;
                }
                
                addMarkerToMap(markerData);
                markers.push(markerData);
            });
            
            updateUI();
            updateExpiringCount();
            checkMarkerLimit();
            
            console.log(`–û–±–Ω–æ–≤–ª–µ–Ω–æ ${markers.length} –º–µ—Ç–æ–∫`);
        }
        
        function syncToFirebase() {
            try {
                const markersData = markers.map(marker => ({
                    id: marker.id,
                    type: marker.type,
                    coords: marker.coords,
                    comment: marker.comment,
                    timestamp: marker.timestamp,
                    author: marker.author || window.userName,
                    authorId: marker.authorId || window.userId
                }));
                
                firebaseDatabase.ref('markers').set(markersData)
                    .then(() => {
                        console.log('‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ —Å Firebase');
                    })
                    .catch(error => {
                        console.error('‚ùå –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:', error);
                    });
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:', error);
            }
        }
        
        function updateOnlineStatus() {
            try {
                const userStatusRef = firebaseDatabase.ref('online/' + window.userId);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–≤–æ–π —Å—Ç–∞—Ç—É—Å –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
                const updateMyStatus = () => {
                    userStatusRef.set({
                        name: window.userName,
                        lastSeen: Date.now(),
                        userId: window.userId
                    });
                };
                
                updateMyStatus();
                setInterval(updateMyStatus, 10000);
                
                // –£–¥–∞–ª—è–µ–º –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ
                userStatusRef.onDisconnect().remove();
                
                // –°–ª—É—à–∞–µ–º –¥—Ä—É–≥–∏—Ö –∏–≥—Ä–æ–∫–æ–≤
                const onlineRef = firebaseDatabase.ref('online');
                onlineRef.on('value', (snapshot) => {
                    const users = snapshot.val() || {};
                    onlinePlayers = users;
                    
                    const now = Date.now();
                    const onlineUserIds = Object.keys(users).filter(id => {
                        const user = users[id];
                        return now - user.lastSeen < 30000; // 30 —Å–µ–∫—É–Ω–¥
                    });
                    
                    currentOnlineCount = Math.max(1, onlineUserIds.length);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏
                    document.getElementById('onlineCount').textContent = currentOnlineCount;
                    document.getElementById('playersOnline').textContent = currentOnlineCount;
                    document.getElementById('modalOnlineCount').textContent = currentOnlineCount;
                    document.getElementById('onlineIndicator').innerHTML = 
                        `<i class="fas fa-wifi"></i> ${currentOnlineCount}`;
                        
                    updatePlayersList(users);
                });
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–Ω–ª–∞–π–Ω —Å—Ç–∞—Ç—É—Å–∞:', error);
            }
        }
        
        function updatePlayersList(users) {
            const playersList = document.getElementById('playersList');
            if (!playersList) return;
            
            const now = Date.now();
            const onlinePlayersArray = Object.entries(users)
                .filter(([id, user]) => now - user.lastSeen < 30000)
                .sort((a, b) => b[1].lastSeen - a[1].lastSeen);
            
            playersList.innerHTML = '';
            
            if (onlinePlayersArray.length === 0) {
                playersList.innerHTML = '<p style="text-align: center; color: #aaa;">–ù–µ—Ç –∏–≥—Ä–æ–∫–æ–≤ –æ–Ω–ª–∞–π–Ω</p>';
                return;
            }
            
            onlinePlayersArray.forEach(([id, user]) => {
                const isOnline = now - user.lastSeen < 30000;
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ "–ì–æ—Å—Ç—å" –µ—Å–ª–∏ –Ω–µ—Ç –∏–º–µ–Ω–∏
                const playerName = user.name || '–ì–æ—Å—Ç—å';
                const isCurrentUser = id === window.userId;
                const playerItem = document.createElement('div');
                playerItem.className = `player-item ${isOnline ? '' : 'offline'}`;
                
                const initials = playerName.split(' ').map(n => n[0]).join('').toUpperCase() || '–ì';
                
                playerItem.innerHTML = `
                    <div class="player-info">
                        <div class="player-avatar" style="${isCurrentUser ? 'background: linear-gradient(135deg, #FF9800, #F57C00);' : ''}">
                            ${initials}
                            ${isCurrentUser ? '‚≠ê' : ''}
                        </div>
                        <div>
                            <div class="player-name">
                                ${playerName} ${isCurrentUser ? '(–í—ã)' : ''}
                            </div>
                            <div class="player-status ${isOnline ? '' : 'offline'}">
                                ${isOnline ? 'üü¢ –û–Ω–ª–∞–π–Ω' : '‚ö´ –ù–µ –≤ —Å–µ—Ç–∏'}
                            </div>
                        </div>
                    </div>
                    ${!isCurrentUser ? `
                    <div class="player-actions">
                        <button class="action-btn" onclick="sendMessageToPlayer('${id}', '${playerName}')">
                            <i class="fas fa-comment"></i>
                        </button>
                    </div>
                    ` : ''}
                `;
                
                playersList.appendChild(playerItem);
            });
        }
        
        function sendMessageToPlayer(playerId, playerName) {
            const message = prompt(`–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ ${playerName}:`, '');
            if (message && message.trim()) {
                alert(`–°–æ–æ–±—â–µ–Ω–∏–µ "${message}" –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ ${playerName}`);
                // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É —á–µ—Ä–µ–∑ Firebase
            }
        }
        
        // ============ –õ–û–ö–ê–õ–¨–ù–û–ï –•–†–ê–ù–ò–õ–ò–©–ï ============
        function useLocalStorage() {
            console.log('–ò—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ...');
            
            try {
                const saved = localStorage.getItem('miami_police_shared');
                if (saved) {
                    const data = JSON.parse(saved);
                    if (data.markers) {
                        updateMarkersFromCloud(data.markers);
                    }
                }
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞:', e);
            }
        }
        
        function saveToLocalStorage() {
            try {
                const data = {
                    markers: markers.map(m => ({
                        id: m.id,
                        type: m.type,
                        coords: m.coords,
                        comment: m.comment,
                        timestamp: m.timestamp,
                        author: m.author || window.userName
                    })),
                    lastUpdate: Date.now()
                };
                
                localStorage.setItem('miami_police_shared', JSON.stringify(data));
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', e);
            }
        }
        
        // ============ –¢–ê–ô–ú–ï–† –ê–í–¢–û–ó–ê–ü–£–°–ö–ê ============
        function startAutoStartTimer() {
            const countdownElement = document.getElementById('countdown');
            countdownElement.textContent = countdownSeconds;
            
            autoStartInterval = setInterval(() => {
                countdownSeconds--;
                countdownElement.textContent = countdownSeconds;
                
                if (countdownSeconds <= 0) {
                    clearInterval(autoStartInterval);
                    if (document.getElementById('splashScreen').style.display !== 'none') {
                        startGame();
                    }
                }
            }, 1000);
        }
        
        // ============ –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê ============
        function openRulesModal() {
            document.getElementById('rulesModal').style.display = 'flex';
        }
        
        function openPlayersModal() {
            document.getElementById('playersModal').style.display = 'flex';
        }
        
        function openControlsModal() {
            document.getElementById('controlsModal').style.display = 'flex';
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –æ–∫–Ω–∞
        document.addEventListener('click', function(event) {
            const modals = ['rulesModal', 'playersModal', 'controlsModal'];
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (event.target === modal) {
                    closeModal(modalId);
                }
            });
        });
        
        // ============ –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò –ò–ì–†–´ ============
        function skipIntro() {
            clearInterval(autoStartInterval);
            const splash = document.getElementById('splashScreen');
            const mainApp = document.getElementById('mainApp');
            
            splash.style.opacity = '0';
            splash.style.transition = 'opacity 0.3s ease';
            
            setTimeout(() => {
                splash.style.display = 'none';
                mainApp.classList.add('active');
                initGame();
            }, 300);
        }
        
        function startGame() {
            clearInterval(autoStartInterval);
            const splash = document.getElementById('splashScreen');
            const mainApp = document.getElementById('mainApp');
            
            splash.style.opacity = '0';
            splash.style.transition = 'opacity 0.5s ease';
            
            setTimeout(() => {
                splash.style.display = 'none';
                mainApp.classList.add('active');
                initGame();
            }, 500);
        }
        
        function initGame() {
            console.log('üöî –ó–∞–ø—É—Å–∫ –∏–≥—Ä—ã...');
            
            updatePremiumFeatures();
            loadUserData();
            startAutoDeleteChecker();
            
            if (window.ymaps) {
                ymaps.ready(initMap);
            } else {
                showError('‚ùå –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç—ã –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∏—Å—å');
            }
        }
        
        // ============ –ö–ê–†–¢–ê –ò –ì–ï–û–õ–û–ö–ê–¶–ò–Ø ============
        function initMap() {
            try {
                let center = [55.459619, 38.438920];
                let zoom = 15;
                
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        function(position) {
                            center = [position.coords.latitude, position.coords.longitude];
                            zoom = 17;
                            createMap(center, zoom);
                        },
                        function(error) {
                            console.warn('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞:', error);
                            createMap(center, zoom);
                        },
                        {
                            enableHighAccuracy: true,
                            timeout: 5000,
                            maximumAge: 0
                        }
                    );
                } else {
                    createMap(center, zoom);
                }
                
                function createMap(centerCoords, zoomLevel) {
                    ymap = new ymaps.Map('yandex-map', {
                        center: centerCoords,
                        zoom: zoomLevel,
                        controls: ['zoomControl', 'fullscreenControl', 'typeSelector']
                    });
                    
                    const geolocationControl = new ymaps.control.GeolocationControl({
                        options: {
                            noPlacemark: true,
                            position: { right: 10, top: 80 }
                        }
                    });
                    ymap.controls.add(geolocationControl);
                    
                    document.getElementById('loading').style.display = 'none';
                    
                    ymap.events.add('click', function(e) {
                        const coords = e.get('coords');
                        
                        if (selectedTool === 'clear') {
                            removeNearMarker(coords);
                        } else if (selectedTool === 'help') {
                            pendingCommentData = { coords, type: selectedTool };
                            showCommentModal();
                        } else {
                            // –î–ª—è –ø–∞—Ç—Ä—É–ª—è –∏ –¥—Ä—É–≥–∏—Ö –º–µ—Ç–æ–∫ - –±–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
                            addMarker(coords, selectedTool, null);
                        }
                    });
                }
                
                updateUI();
                updateExpiringCount();
                checkMarkerLimit();
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∫–∞—Ä—Ç—ã:', error);
                showError('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç—ã');
            }
        }
        
        // ============ –ú–ï–¢–ö–ò ============
        function addMarker(coords, type, comment = null) {
            if (markers.length >= MAX_MARKERS) {
                alert(`‚ùå –î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç –≤ ${MAX_MARKERS} –º–µ—Ç–æ–∫!`);
                return;
            }
            
            const markerId = Date.now().toString() + Math.random().toString(36).substr(2, 9);
            const markerData = {
                id: markerId,
                type: type,
                coords: coords,
                comment: comment,
                timestamp: Date.now(),
                author: window.userName,
                authorId: window.userId
            };
            
            addMarkerToMap(markerData);
            markers.push(markerData);
            
            points += 10;
            activity += 1;
            
            updateUI();
            checkMarkerLimit();
            saveToLocalStorage();
            syncToFirebase();
            
            const typeNames = {
                'police': '–ü–∞—Ç—Ä—É–ª—å üö®',
                'accident': '–î–¢–ü üöó',
                'help': '–ü–æ–º–æ—â—å üÜò',
                'hazard': '–ü—Ä–æ–±–∫–∞ üö¶'
            };
            
            console.log(`‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –º–µ—Ç–∫–∞: ${typeNames[type]}`);
        }
        
        function addMarkerToMap(markerData) {
            if (!ymap) return;
            
            const iconColor = {
                'police': '#2196F3',
                'accident': '#F44336',
                'help': '#4CAF50',
                'hazard': '#FF9800'
            }[markerData.type] || '#2196F3';
            
            const iconContent = {
                'police': 'üö®',
                'accident': 'üöó',
                'help': 'üÜò',
                'hazard': 'üö¶'
            }[markerData.type] || 'üìç';
            
            const placemark = new ymaps.Placemark(
                markerData.coords,
                {
                    balloonContent: `
                        <div style="padding: 10px; max-width: 250px;">
                            <h3 style="margin: 0 0 10px 0; color: ${iconColor}">
                                ${markerData.type === 'police' ? 'üö® –ü–∞—Ç—Ä—É–ª—å' : 
                                  markerData.type === 'accident' ? 'üöó –î–¢–ü' :
                                  markerData.type === 'help' ? 'üÜò –ü–æ–º–æ—â—å' : 'üö¶ –ü—Ä–æ–±–∫–∞'}
                            </h3>
                            ${markerData.comment ? `<p><strong>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</strong> ${markerData.comment}</p>` : ''}
                            <p><strong>–ê–≤—Ç–æ—Ä:</strong> ${markerData.author}</p>
                            <p><strong>–í—Ä–µ–º—è:</strong> ${new Date(markerData.timestamp).toLocaleString()}</p>
                            <button onclick="deleteMarkerFromBalloon('${markerData.id}')" 
                                    style="background: #f44336; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; margin-top: 10px;">
                                –£–¥–∞–ª–∏—Ç—å –º–µ—Ç–∫—É
                            </button>
                        </div>
                    `,
                    iconCaption: markerData.comment || ''
                },
                {
                    preset: 'islands#icon',
                    iconColor: iconColor,
                    iconLayout: 'default#imageWithContent',
                    iconImageHref: '',
                    iconImageSize: [50, 50],
                    iconImageOffset: [-25, -50],
                    iconContentOffset: [0, 0],
                    iconContentLayout: ymaps.templateLayoutFactory.createClass(
                        `<div style="width: 50px; height: 50px; border-radius: 50%; background: ${iconColor}; display: flex; align-items: center; justify-content: center; font-size: 20px; position: relative;">
                            ${iconContent}
                            <button class="marker-delete-btn" onclick="deleteMarker('${markerData.id}')" 
                                    style="position: absolute; top: -5px; right: -5px; background: #f44336; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                                √ó
                            </button>
                        </div>`
                    )
                }
            );
            
            // –û—Ç–∫—Ä—ã–≤–∞–µ–º –±–∞–ª—É–Ω –ø—Ä–∏ –∫–ª–∏–∫–µ
            placemark.events.add('click', function() {
                placemark.balloon.open();
            });
            
            markerData.placemark = placemark;
            ymap.geoObjects.add(placemark);
        }
        
        function deleteMarker(markerId) {
            const markerIndex = markers.findIndex(m => m.id === markerId);
            if (markerIndex !== -1) {
                const marker = markers[markerIndex];
                if (marker.placemark) {
                    ymap.geoObjects.remove(marker.placemark);
                }
                
                markers.splice(markerIndex, 1);
                
                points += 5;
                updateUI();
                checkMarkerLimit();
                saveToLocalStorage();
                syncToFirebase();
                
                alert('üóëÔ∏è –ú–µ—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–∞');
            }
        }
        
        function deleteMarkerFromBalloon(markerId) {
            deleteMarker(markerId);
        }
        
        function removeNearMarker(coords) {
            if (!markers.length) {
                alert('–ù–µ—Ç –º–µ—Ç–æ–∫ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è');
                return;
            }
            
            let closestMarker = null;
            let minDistance = Infinity;
            
            markers.forEach(marker => {
                const distance = Math.sqrt(
                    Math.pow(marker.coords[0] - coords[0], 2) + 
                    Math.pow(marker.coords[1] - coords[1], 2)
                ) * 111000; // –ü—Ä–∏–º–µ—Ä–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –≤ –º–µ—Ç—Ä–∞—Ö
                
                if (distance < 50 && distance < minDistance) { // 50 –º–µ—Ç—Ä–æ–≤
                    minDistance = distance;
                    closestMarker = marker;
                }
            });
            
            if (closestMarker) {
                deleteMarker(closestMarker.id);
            } else {
                alert('‚ùå –ù–µ—Ç –º–µ—Ç–æ–∫ —Ä—è–¥–æ–º');
            }
        }
        
        // ============ –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ============
        function selectTool(tool) {
            selectedTool = tool;
            document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
            event.target.closest('.tool-btn').classList.add('active');
        }
        
        function showCommentModal() {
            const comment = prompt('–í–≤–µ–¥–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –º–µ—Ç–∫–µ (–Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):', '');
            if (comment !== null) {
                addMarker(pendingCommentData.coords, pendingCommentData.type, comment.trim());
            }
            pendingCommentData = null;
        }
        
        function updateUI() {
            document.getElementById('markerCount').textContent = markers.length;
            document.getElementById('points').textContent = points;
            document.getElementById('activity').textContent = activity;
            
            const rank = calculateRank();
            document.getElementById('userRank').textContent = rank.name;
            document.getElementById('rankPoints').textContent = rank.progress + '%';
        }
        
        function calculateRank() {
            if (activity >= 100) return { name: '–ö–æ–º–∏—Å—Å–∞—Ä', progress: 100 };
            if (activity >= 50) return { name: '–î–µ—Ç–µ–∫—Ç–∏–≤', progress: Math.min(100, (activity - 50) * 2) };
            if (activity >= 20) return { name: '–°–µ—Ä–∂–∞–Ω—Ç', progress: Math.min(100, (activity - 20) * 3.33) };
            if (activity >= 5) return { name: '–ü–∞—Ç—Ä—É–ª—å–Ω—ã–π', progress: Math.min(100, (activity - 5) * 6.67) };
            return { name: '–ù–æ–≤–∏—á–æ–∫', progress: Math.min(100, activity * 20) };
        }
        
        function checkMarkerLimit() {
            const limitElement = document.getElementById('markerLimit');
            if (markers.length >= MAX_MARKERS * 0.9) {
                limitElement.style.display = 'block';
            } else {
                limitElement.style.display = 'none';
            }
        }
        
        function updateExpiringCount() {
            const now = Date.now();
            const expiringSoon = markers.filter(m => now - m.timestamp > EXPIRATION_TIME * 0.9).length;
            if (expiringSoon > 0) {
                console.log(`${expiringSoon} –º–µ—Ç–æ–∫ —Å–∫–æ—Ä–æ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã`);
            }
        }
        
        function startAutoDeleteChecker() {
            if (autoDeleteInterval) clearInterval(autoDeleteInterval);
            
            autoDeleteInterval = setInterval(() => {
                const now = Date.now();
                const initialCount = markers.length;
                
                markers = markers.filter(marker => {
                    if (now - marker.timestamp > EXPIRATION_TIME) {
                        if (marker.placemark && ymap) {
                            ymap.geoObjects.remove(marker.placemark);
                        }
                        return false;
                    }
                    return true;
                });
                
                if (markers.length < initialCount) {
                    updateUI();
                    checkMarkerLimit();
                    syncToFirebase();
                    console.log(`–ê–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏–µ: —É–¥–∞–ª–µ–Ω–æ ${initialCount - markers.length} —Å—Ç–∞—Ä—ã—Ö –º–µ—Ç–æ–∫`);
                }
            }, 60000); // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
        }
        
        function loadUserData() {
            try {
                const savedData = localStorage.getItem('user_data_' + window.userId);
                if (savedData) {
                    const data = JSON.parse(savedData);
                    points = data.points || points;
                    activity = data.activity || activity;
                    updateUI();
                }
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', e);
            }
        }
        
        function showError(message) {
            document.getElementById('loading').innerHTML = `
                <i class="fas fa-exclamation-triangle" style="font-size: 2.5rem; margin-bottom: 20px; color: #f44336;"></i>
                <p style="color: #f44336; font-size: 1.1rem;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p>
                <p style="color: #ff9800; font-size: 0.9rem; margin-top: 10px;">${message}</p>
            `;
        }
        
        // ============ –ó–ê–ü–£–°–ö –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ============
        document.addEventListener('DOMContentLoaded', function() {
            initTelegram();
            
            setTimeout(() => {
                const subscription = checkSubscription();
                if (subscription.status === 'expired') {
                    setTimeout(showSubscriptionModal, 2000);
                }
            }, 1000);
        });
        
        // –≠–∫—Å–ø–æ—Ä—Ç —Ñ—É–Ω–∫—Ü–∏–π –¥–ª—è –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
        window.startGame = startGame;
        window.skipIntro = skipIntro;
        window.selectTool = selectTool;
        window.openRulesModal = openRulesModal;
        window.openPlayersModal = openPlayersModal;
        window.openControlsModal = openControlsModal;
        window.closeModal = closeModal;
        window.deleteMarker = deleteMarker;
        window.deleteMarkerFromBalloon = deleteMarkerFromBalloon;
        window.purchaseSubscription = purchaseSubscription;
        window.showSubscriptionModal = showSubscriptionModal;
        window.sendMessageToPlayer = sendMessageToPlayer;
    </script>
</body>
</html>
